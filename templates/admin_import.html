<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Importa√ß√£o de Banco de Dados - Sistema Financeiro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ecf0f1;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: #7f8c8d;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .mapping-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .mapping-table th,
        .mapping-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        .mapping-table th {
            background: #2c3e50;
            color: white;
            font-weight: 600;
        }

        .mapping-table tr:hover {
            background: #f8f9fa;
        }

        .score-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
        }

        .score-high {
            background: #d4edda;
            color: #155724;
        }

        .score-medium {
            background: #fff3cd;
            color: #856404;
        }

        .score-low {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
        }

        .status-concluido {
            background: #d4edda;
            color: #155724;
        }

        .status-erro {
            background: #f8d7da;
            color: #721c24;
        }

        .status-preparando {
            background: #cce5ff;
            color: #004085;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #ecf0f1;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 12px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <span>üîÑ</span>
            Importa√ß√£o de Banco de Dados
        </h1>
        <p class="subtitle">Sistema inteligente de importa√ß√£o com mapeamento autom√°tico e rollback</p>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('nova')">‚ûï Nova Importa√ß√£o</button>
            <button class="tab" onclick="switchTab('historico')">üìä Hist√≥rico</button>
            <button class="tab" onclick="switchTab('mapeamentos')">üîó Mapeamentos</button>
        </div>

        <!-- Tab: Nova Importa√ß√£o -->
        <div id="tab-nova" class="tab-content active">
            <div class="card">
                <div class="card-title">1Ô∏è‚É£ Origem dos Dados</div>
                
                <!-- Seletor de M√©todo -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">Escolha o m√©todo de importa√ß√£o:</label>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" id="btn-method-file" onclick="selectMethod('file')" style="flex: 1; background: #667eea; color: white;">
                            üìÅ Enviar Arquivo
                        </button>
                        <button class="btn" id="btn-method-db" onclick="selectMethod('db')" style="flex: 1; background: #95a5a6; color: white;">
                            üîå Conectar Banco Externo
                        </button>
                    </div>
                </div>

                <!-- Op√ß√£o 1: Upload de Arquivo -->
                <div id="method-file" style="display: block;">
                    <div style="padding: 20px; background: #f0f4ff; border-radius: 8px; border: 2px dashed #667eea; text-align: center;">
                        <p style="margin-bottom: 15px; color: #2c3e50;">
                            <strong>üì§ Envie um arquivo de backup do banco de dados</strong><br>
                            <span style="font-size: 13px; color: #7f8c8d;">Formatos suportados: .sql, .dump, .backup, .csv, .json, .db, .sqlite (at√© 100MB)</span>
                        </p>
                        <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 13px; color: #856404;">
                            üí° <strong>Dica SQLite:</strong> Se voc√™ tem arquivos .db-shm e .db-wal, envie-os tamb√©m para garantir consist√™ncia dos dados.
                        </div>
                        <input type="file" id="file-input" accept=".sql,.dump,.backup,.csv,.json,.db,.sqlite,.sqlite3,.db-shm,.db-wal"
                               style="display: none;" onchange="handleFileSelect(event)" multiple>
                        <button class="btn btn-primary" onclick="document.getElementById('file-input').click()">
                            üìé Selecionar Arquivo
                        </button>
                        <div id="file-info" style="margin-top: 15px; display: none;">
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: left;">
                                <p style="margin: 0;"><strong>Arquivo selecionado:</strong></p>
                                <p style="margin: 5px 0; color: #667eea;" id="file-name"></p>
                                <p style="margin: 5px 0; font-size: 13px; color: #7f8c8d;" id="file-size"></p>
                                <button class="btn btn-success" onclick="processFile()" style="margin-top: 10px;">
                                    üîç Analisar Arquivo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Op√ß√£o 2: Conex√£o Direta -->
                <div id="method-db" style="display: none;">
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Host</label>
                            <input type="text" id="ext-host" value="localhost" placeholder="localhost">
                        </div>
                        <div class="form-group">
                            <label>Porta</label>
                            <input type="number" id="ext-port" value="5432" placeholder="5432">
                        </div>
                    </div>

                    <div class="grid-2">
                        <div class="form-group">
                            <label>Banco de Dados</label>
                            <input type="text" id="ext-database" placeholder="nome_do_banco">
                        </div>
                        <div class="form-group">
                            <label>Usu√°rio</label>
                            <input type="text" id="ext-user" placeholder="postgres">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Senha</label>
                        <input type="password" id="ext-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>

                    <button class="btn btn-primary" onclick="testConnection()">üîå Testar Conex√£o e Obter Schema</button>
                </div>
            </div>

            <div id="schema-result" style="display: none;">
                <div class="card">
                    <div class="card-title">2Ô∏è‚É£ An√°lise do Schema Externo</div>
                    <div id="schema-info"></div>
                </div>

                <div class="card">
                    <div class="card-title">3Ô∏è‚É£ Configurar Mapeamento de Tabelas</div>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="generateMapping()" style="flex: 1;">
                            ü§ñ Gerar Mapeamento Autom√°tico
                        </button>
                        <button class="btn" onclick="showManualMapping()" style="flex: 1; background: #667eea; color: white;">
                            ‚úèÔ∏è Sele√ß√£o Manual
                        </button>
                    </div>
                    <div id="mapping-suggestions"></div>
                    <div id="manual-mapping-container" style="display: none;"></div>
                </div>

                <div class="card">
                    <div class="card-title">4Ô∏è‚É£ Configura√ß√£o da Importa√ß√£o</div>
                    <div class="form-group">
                        <label>Nome da Importa√ß√£o</label>
                        <input type="text" id="import-name" placeholder="Ex: Importa√ß√£o Cliente XYZ - Janeiro 2026">
                    </div>
                    <div class="form-group">
                        <label>Descri√ß√£o</label>
                        <textarea id="import-description" rows="3" placeholder="Descreva o objetivo desta importa√ß√£o"></textarea>
                    </div>
                    <button class="btn btn-success" onclick="executeImport()">‚ñ∂Ô∏è Executar Importa√ß√£o</button>
                </div>
            </div>
        </div>

        <!-- Tab: Hist√≥rico -->
        <div id="tab-historico" class="tab-content">
            <div class="card">
                <div class="card-title">Hist√≥rico de Importa√ß√µes</div>
                <button class="btn btn-primary" onclick="loadHistory()">üîÑ Atualizar</button>
                <div id="history-list"></div>
            </div>
        </div>

        <!-- Tab: Mapeamentos -->
        <div id="tab-mapeamentos" class="tab-content">
            <div class="card">
                <div class="card-title">Gerenciar Mapeamentos</div>
                <p>Visualize e edite mapeamentos salvos</p>
                <div id="mappings-list"></div>
            </div>
        </div>
    </div>

    <script>
        let externalSchema = null;
        let internalSchema = null;
        let currentMappings = [];
        let dbConfig = {};
        let empresaId = null;
        let empresaNome = '';
        let selectedFile = null;
        let importMethod = 'file'; // 'file' ou 'db'

        // Obter par√¢metros da URL
        window.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            empresaId = urlParams.get('empresa_id');
            empresaNome = urlParams.get('empresa_nome');
            
            if (empresaId && empresaNome) {
                // Atualizar t√≠tulo
                const subtitle = document.querySelector('.subtitle');
                subtitle.innerHTML = `üè¢ Importando dados para: <strong style="color: #667eea;">${empresaNome}</strong> (ID: ${empresaId})`;
            } else {
                alert('‚ö†Ô∏è Nenhuma empresa selecionada! Retorne ao painel e selecione uma empresa.');
                window.close();
            }
        });

        // Alternar tabs
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
        }

        // Selecionar m√©todo de importa√ß√£o
        function selectMethod(method) {
            importMethod = method;
            
            // Atualizar bot√µes
            document.getElementById('btn-method-file').style.background = method === 'file' ? '#667eea' : '#95a5a6';
            document.getElementById('btn-method-db').style.background = method === 'db' ? '#667eea' : '#95a5a6';
            
            // Mostrar/ocultar se√ß√µes
            document.getElementById('method-file').style.display = method === 'file' ? 'block' : 'none';
            document.getElementById('method-db').style.display = method === 'db' ? 'block' : 'none';
            
            // Resetar
            document.getElementById('schema-result').style.display = 'none';
        }

        // Manipular sele√ß√£o de arquivo
        function handleFileSelect(event) {
            const files = event.target.files;
            
            if (!files || files.length === 0) return;
            
            // Se m√∫ltiplos arquivos (SQLite com .db-shm e .db-wal)
            if (files.length > 1) {
                // Verificar se tem .db principal
                const hasDbFile = Array.from(files).some(f => 
                    f.name.endsWith('.db') || f.name.endsWith('.sqlite') || f.name.endsWith('.sqlite3')
                );
                
                if (!hasDbFile) {
                    alert('‚ö†Ô∏è Ao enviar m√∫ltiplos arquivos, √© necess√°rio incluir o arquivo .db principal!');
                    return;
                }
                
                // Usar o .db como principal
                selectedFile = Array.from(files).find(f => 
                    f.name.endsWith('.db') || f.name.endsWith('.sqlite') || f.name.endsWith('.sqlite3')
                );
                
                const totalSize = Array.from(files).reduce((sum, f) => sum + f.size, 0);
                
                document.getElementById('file-name').textContent = `${files.length} arquivos: ${Array.from(files).map(f => f.name).join(', ')}`;
                document.getElementById('file-size').textContent = `Tamanho total: ${(totalSize / 1024 / 1024).toFixed(2)} MB`;
                document.getElementById('file-info').style.display = 'block';
            } else {
                selectedFile = files[0];
                
                // Validar tamanho (100MB)
                const maxSize = 100 * 1024 * 1024;
                if (selectedFile.size > maxSize) {
                    alert('‚ö†Ô∏è Arquivo muito grande! Tamanho m√°ximo: 100MB');
                    selectedFile = null;
                    return;
                }
                
                // Exibir informa√ß√µes do arquivo
                document.getElementById('file-name').textContent = selectedFile.name;
                document.getElementById('file-size').textContent = `Tamanho: ${(selectedFile.size / 1024 / 1024).toFixed(2)} MB`;
                document.getElementById('file-info').style.display = 'block';
            }
        }

        // Processar arquivo
        async function processFile() {
            if (!selectedFile) {
                alert('Selecione um arquivo primeiro!');
                return;
            }

            const formData = new FormData();
            
            // Se m√∫ltiplos arquivos foram selecionados
            const fileInput = document.getElementById('file-input');
            if (fileInput.files.length > 1) {
                // Adicionar todos os arquivos
                Array.from(fileInput.files).forEach(file => {
                    formData.append('files[]', file);
                });
            } else {
                formData.append('file', selectedFile);
            }
            
            formData.append('empresa_id', empresaId);

            try {
                const response = await fetch('/api/admin/import/upload', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });

                const data = await response.json();

                if (data.success) {
                    externalSchema = data.schema;
                    
                    // Mostrar resultado
                    document.getElementById('schema-result').style.display = 'block';
                    
                    let schemaHtml = `
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px;">
                            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 32px; font-weight: 700; color: #1976d2;">${Object.keys(externalSchema).length}</div>
                                <div style="color: #555; margin-top: 5px;">Tabelas Detectadas</div>
                            </div>
                            <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 32px; font-weight: 700; color: #7b1fa2;">${Object.values(externalSchema).reduce((sum, t) => sum + t.columns.length, 0)}</div>
                                <div style="color: #555; margin-top: 5px;">Colunas Totais</div>
                            </div>
                            <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 32px; font-weight: 700; color: #388e3c;">${Object.values(externalSchema).reduce((sum, t) => sum + (t.total_registros || 0), 0).toLocaleString()}</div>
                                <div style="color: #555; margin-top: 5px;">Registros Totais</div>
                            </div>
                        </div>
                        <div style="margin-top: 20px; max-height: 300px; overflow-y: auto;">
                            <strong>Tabelas encontradas:</strong>
                            <ul style="margin-top: 10px;">
                                ${Object.entries(externalSchema).map(([table, info]) => 
                                    `<li style="padding: 8px; border-bottom: 1px solid #eee;">
                                        <strong>${table}</strong> - ${info.columns.length} colunas, ${info.total_registros || 0} registros
                                    </li>`
                                ).join('')}
                            </ul>
                        </div>
                    `;
                    document.getElementById('schema-info').innerHTML = schemaHtml;
                    
                    // Obter schema interno
                    await loadInternalSchema();
                    
                    alert('‚úÖ Arquivo processado com sucesso!');
                } else {
                    alert('‚ùå Erro ao processar arquivo: ' + data.error);
                }

            } catch (error) {
                alert('Erro: ' + error.message);
            }
        }

        // Carregar schema interno
        async function loadInternalSchema() {
            try {
                const response = await fetch('/api/admin/import/schema/interno', {
                    credentials: 'include'
                });
                const data = await response.json();
                internalSchema = data.schema;
                
                // Debug: Log das colunas da tabela categorias
                console.log('üîÑ loadInternalSchema() executado');
                if (internalSchema.categorias) {
                    console.log('üìã Tabela CATEGORIAS - Colunas recebidas:', internalSchema.categorias.columns);
                    console.log(`   Total de colunas: ${internalSchema.categorias.columns.length}`);
                    const subcategorias = internalSchema.categorias.columns.find(col => col.name === 'subcategorias');
                    if (subcategorias) {
                        console.log('   ‚úÖ Coluna subcategorias encontrada:', subcategorias);
                    } else {
                        console.warn('   ‚ö†Ô∏è Coluna subcategorias N√ÉO encontrada!');
                    }
                } else {
                    console.error('   ‚ùå Tabela categorias N√ÉO encontrada no internalSchema!');
                }
            } catch (error) {
                console.error('Erro ao carregar schema interno:', error);
            }
        }

        // Testar conex√£o e obter schema
        async function testConnection() {
            const host = document.getElementById('ext-host').value;
            const port = document.getElementById('ext-port').value;
            const database = document.getElementById('ext-database').value;
            const user = document.getElementById('ext-user').value;
            const password = document.getElementById('ext-password').value;

            if (!host || !database || !user || !password) {
                alert('Preencha todos os campos!');
                return;
            }

            dbConfig = { host, port: parseInt(port), database, user, password };

            try {
                // Obter schema externo
                const extResponse = await fetch('/api/admin/import/schema/externo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dbConfig),
                    credentials: 'include'
                });

                if (!extResponse.ok) throw new Error('Erro ao conectar no banco externo');
                const extData = await extResponse.json();
                externalSchema = extData.schema;

                // Obter schema interno
                const intResponse = await fetch('/api/admin/import/schema/interno', {
                    credentials: 'include'
                });
                const intData = await intResponse.json();
                internalSchema = intData.schema;
                
                // Debug: Log das colunas da tabela categorias
                if (internalSchema.categorias) {
                    console.log('üìã Tabela CATEGORIAS - Colunas recebidas:', internalSchema.categorias.columns);
                    console.log(`   Total de colunas: ${internalSchema.categorias.columns.length}`);
                    const subcategorias = internalSchema.categorias.columns.find(col => col.name === 'subcategorias');
                    if (subcategorias) {
                        console.log('   ‚úÖ Coluna subcategorias encontrada:', subcategorias);
                    } else {
                        console.warn('   ‚ö†Ô∏è Coluna subcategorias N√ÉO encontrada!');
                    }
                }

                // Mostrar resultado
                document.getElementById('schema-result').style.display = 'block';
                document.getElementById('schema-info').innerHTML = `
                    <div class="alert alert-success">
                        ‚úÖ Conex√£o estabelecida com sucesso!<br>
                        üìä Banco Externo: <strong>${extData.total_tabelas} tabelas</strong> com <strong>${extData.total_registros.toLocaleString('pt-BR')} registros</strong><br>
                        üè† Banco Interno: <strong>${intData.total_tabelas} tabelas</strong>
                    </div>
                `;

            } catch (error) {
                alert('Erro: ' + error.message);
            }
        }

        // Gerar mapeamento autom√°tico
        async function generateMapping() {
            try {
                const response = await fetch('/api/admin/import/sugestao-mapeamento', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        schema_externo: externalSchema,
                        schema_interno: internalSchema
                    }),
                    credentials: 'include'
                });

                const data = await response.json();
                currentMappings = data.sugestoes;

                // Renderizar sugest√µes
                let html = `
                    <table class="mapping-table">
                        <thead>
                            <tr>
                                <th>Tabela Origem</th>
                                <th>Tabela Destino</th>
                                <th>Similaridade</th>
                                <th>Registros</th>
                                <th>Colunas</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                currentMappings.forEach((map, index) => {
                    const scoreClass = map.score_similaridade >= 80 ? 'score-high' : 
                                     map.score_similaridade >= 50 ? 'score-medium' : 'score-low';
                    
                    html += `
                        <tr>
                            <td><strong>${map.tabela_origem}</strong></td>
                            <td><strong>${map.tabela_destino}</strong></td>
                            <td><span class="score-badge ${scoreClass}">${map.score_similaridade}%</span></td>
                            <td>${map.total_registros.toLocaleString('pt-BR')}</td>
                            <td>${map.colunas_origem} ‚Üí ${map.colunas_destino}</td>
                            <td>
                                <button class="btn btn-primary" onclick="viewColumnMapping(${index})">Ver Colunas</button>
                                <button class="btn btn-danger" onclick="removeMapping(${index})">Remover</button>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                document.getElementById('mapping-suggestions').innerHTML = html;

            } catch (error) {
                alert('Erro ao gerar mapeamento: ' + error.message);
            }
        }

        // Ver mapeamento de colunas
        function viewColumnMapping(index) {
            const mapping = currentMappings[index];
            let html = `
                <div style="margin-top: 20px;">
                    <h3>Mapeamento de Colunas: ${mapping.tabela_origem} ‚Üí ${mapping.tabela_destino}</h3>
                    <table class="mapping-table">
                        <thead>
                            <tr>
                                <th>Coluna Origem</th>
                                <th>Coluna Destino</th>
                                <th>Tipo Origem</th>
                                <th>Tipo Destino</th>
                                <th>Compat√≠vel</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            mapping.mapeamento_colunas.forEach(col => {
                html += `
                    <tr>
                        <td>${col.coluna_origem}</td>
                        <td>${col.coluna_destino}</td>
                        <td><code>${col.tipo_origem}</code></td>
                        <td><code>${col.tipo_destino}</code></td>
                        <td>${col.compativel ? '‚úÖ' : '‚ö†Ô∏è'}</td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            
            const modalDiv = document.createElement('div');
            modalDiv.innerHTML = html;
            modalDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-width: 90%; max-height: 80%; overflow: auto; z-index: 1000;';
            
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999;';
            overlay.onclick = () => {
                document.body.removeChild(modalDiv);
                document.body.removeChild(overlay);
            };
            
            document.body.appendChild(overlay);
            document.body.appendChild(modalDiv);
        }

        // Remover mapeamento
        function removeMapping(index) {
            if (confirm('Deseja remover este mapeamento?')) {
                currentMappings.splice(index, 1);
                generateMapping();
            }
        }

        // Executar importa√ß√£o
        async function executeImport() {
            const name = document.getElementById('import-name').value;
            const description = document.getElementById('import-description').value;

            if (!name) {
                alert('Digite um nome para a importa√ß√£o!');
                return;
            }

            // Verificar se tem mapeamentos manuais ou autom√°ticos
            let mappingsToUse = currentMappings;
            const manualMappings = collectManualMappings();
            
            if (manualMappings.length > 0) {
                mappingsToUse = manualMappings;
                console.log('üìã Usando mapeamentos manuais:', manualMappings);
            } else if (currentMappings.length > 0) {
                console.log('ü§ñ Usando mapeamentos autom√°ticos:', currentMappings);
            } else {
                alert('‚ö†Ô∏è Configure os mapeamentos primeiro!\n\nUse a op√ß√£o "Sele√ß√£o Manual" ou "Gerar Mapeamento Autom√°tico".');
                return;
            }

            if (!empresaId) {
                alert('‚ö†Ô∏è Empresa n√£o selecionada!');
                return;
            }

            if (!confirm(`Confirma a importa√ß√£o para ${empresaNome}?\n\n${mappingsToUse.length} tabelas ser√£o importadas.\nEsta a√ß√£o pode ser revertida posteriormente.`)) {
                return;
            }

            try {
                // Criar importa√ß√£o
                const createResponse = await fetch('/api/admin/import/criar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        empresa_id: empresaId,
                        mapeamentos: mappingsToUse,
                        schema_externo: externalSchema
                    }),
                    credentials: 'include'
                });

                const createData = await createResponse.json();
                
                if (!createData.success) {
                    alert('‚ùå Erro ao criar importa√ß√£o: ' + (createData.error || 'Erro desconhecido'));
                    return;
                }
                
                const importId = createData.import_id;

                // Executar importa√ß√£o
                const executeResponse = await fetch(`/api/admin/import/executar/${importId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        arquivo_path: selectedFile ? `/tmp/import_${session.usuario_id}_${selectedFile.name}` : null
                    }),
                    credentials: 'include'
                });

                const executeData = await executeResponse.json();

                if (executeData.success) {
                    alert(`‚úÖ Importa√ß√£o conclu√≠da para ${empresaNome}!\n\nID da Importa√ß√£o: ${importId}`);
                    switchTab('historico');
                    loadHistory();
                } else {
                    alert('‚ùå Erro na importa√ß√£o: ' + (executeData.error || 'Erro desconhecido'));
                }

            } catch (error) {
                alert('Erro: ' + error.message);
            }
        }

        // Carregar hist√≥rico
        async function loadHistory() {
            try {
                const response = await fetch('/api/admin/import/listar', {
                    credentials: 'include'
                });
                const data = await response.json();

                let html = '<table class="mapping-table"><thead><tr><th>Nome</th><th>Data</th><th>Status</th><th>Registros</th><th>Tempo</th><th>A√ß√µes</th></tr></thead><tbody>';

                data.imports.forEach(imp => {
                    const statusClass = imp.status.includes('concluido') ? 'status-concluido' : 
                                      imp.status.includes('erro') ? 'status-erro' : 'status-preparando';
                    
                    html += `
                        <tr>
                            <td><strong>${imp.nome}</strong><br><small>${imp.descricao || ''}</small></td>
                            <td>${new Date(imp.data_importacao).toLocaleString('pt-BR')}</td>
                            <td><span class="status-badge ${statusClass}">${imp.status}</span></td>
                            <td>${imp.registros_importados || 0} / ${imp.registros_erro || 0} erros</td>
                            <td>${imp.tempo_execucao || 0}s</td>
                            <td>
                                <button class="btn btn-primary" onclick="viewDetails(${imp.id})">Ver</button>
                                ${imp.status === 'concluido' ? `<button class="btn btn-warning" onclick="rollbackImport(${imp.id})">Reverter</button>` : ''}
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                document.getElementById('history-list').innerHTML = html;

            } catch (error) {
                alert('Erro ao carregar hist√≥rico: ' + error.message);
            }
        }

        // Ver detalhes
        async function viewDetails(importId) {
            try {
                const response = await fetch(`/api/admin/import/detalhes/${importId}`, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                alert(JSON.stringify(data, null, 2));
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        }

        // Mostrar interface de sele√ß√£o manual
        function showManualMapping() {
            if (!externalSchema || !internalSchema) {
                alert('‚ö†Ô∏è Carregue os schemas primeiro!');
                return;
            }

            document.getElementById('mapping-suggestions').style.display = 'none';
            const container = document.getElementById('manual-mapping-container');
            container.style.display = 'block';

            let html = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h3 style="margin-bottom: 20px;">üîó Sele√ß√£o Manual de Mapeamento</h3>
                    <div id="manual-mappings"></div>
                    <button class="btn btn-success" onclick="addManualMapping()" style="margin-top: 15px;">
                        ‚ûï Adicionar Mapeamento
                    </button>
                </div>
            `;

            container.innerHTML = html;
            
            // Adicionar um mapeamento vazio inicial
            addManualMapping();
        }

        let manualMappingCounter = 0;

        // Adicionar um novo mapeamento manual
        function addManualMapping() {
            const mappingsDiv = document.getElementById('manual-mappings');
            const id = ++manualMappingCounter;

            console.log('üÜï addManualMapping() - ID:', id);
            console.log('   internalSchema dispon√≠vel?', !!internalSchema);
            console.log('   Tabelas internas:', Object.keys(internalSchema));
            console.log('   categorias existe?', 'categorias' in internalSchema);

            // Criar op√ß√µes de tabelas externas
            let externalTablesOptions = '<option value="">-- Selecione tabela origem --</option>';
            Object.keys(externalSchema).forEach(table => {
                externalTablesOptions += `<option value="${table}">${table} (${externalSchema[table].total_registros || 0} registros)</option>`;
            });

            // Criar op√ß√µes de tabelas internas
            let internalTablesOptions = '<option value="">-- Selecione tabela destino --</option>';
            Object.keys(internalSchema).forEach(table => {
                internalTablesOptions += `<option value="${table}">${table}</option>`;
            });

            const html = `
                <div id="mapping-${id}" style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #ddd;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0;">Mapeamento #${id}</h4>
                        <button class="btn btn-danger" onclick="removeManualMapping(${id})" style="padding: 5px 15px;">
                            üóëÔ∏è Remover
                        </button>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 50px 1fr; gap: 15px; align-items: center;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 5px;">üì§ Tabela Origem (Arquivo Importado)</label>
                            <select id="ext-table-${id}" onchange="loadExternalColumns(${id})" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
                                ${externalTablesOptions}
                            </select>
                            <div id="ext-columns-${id}" style="margin-top: 10px; max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px; display: none;">
                                <strong>Colunas:</strong><br>
                            </div>
                        </div>

                        <div style="text-align: center; font-size: 24px; color: #667eea;">
                            ‚û°Ô∏è
                        </div>

                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 5px;">üì• Tabela Destino (Sistema)</label>
                            <select id="int-table-${id}" onchange="loadInternalColumns(${id})" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
                                ${internalTablesOptions}
                            </select>
                            <div id="int-columns-${id}" style="margin-top: 10px; max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px; display: none;">
                                <strong>Colunas:</strong><br>
                            </div>
                        </div>
                    </div>

                    <div id="column-mapping-${id}" style="margin-top: 15px; display: none;">
                        <h5>üîó Mapeamento de Colunas</h5>
                        <div id="column-pairs-${id}"></div>
                    </div>
                </div>
            `;

            mappingsDiv.insertAdjacentHTML('beforeend', html);
        }

        // Carregar colunas da tabela externa selecionada
        function loadExternalColumns(mappingId) {
            const select = document.getElementById(`ext-table-${mappingId}`);
            const tableName = select.value;
            const columnsDiv = document.getElementById(`ext-columns-${mappingId}`);

            if (!tableName) {
                columnsDiv.style.display = 'none';
                return;
            }

            const columns = externalSchema[tableName].columns;
            let html = '<strong>Colunas:</strong><br>';
            
            columns.forEach(col => {
                html += `<span style="display: inline-block; margin: 3px; padding: 5px 10px; background: #e3f2fd; border-radius: 5px; font-size: 12px;">
                    ${col.name} <span style="color: #666;">(${col.type})</span>
                </span>`;
            });

            columnsDiv.innerHTML = html;
            columnsDiv.style.display = 'block';
            
            // Verificar se ambas tabelas est√£o selecionadas para mostrar mapeamento de colunas
            checkShowColumnMapping(mappingId);
        }

        // Carregar colunas da tabela interna selecionada
        function loadInternalColumns(mappingId) {
            console.log('üéØ loadInternalColumns() CHAMADA! mappingId:', mappingId);
            
            const select = document.getElementById(`int-table-${mappingId}`);
            console.log('   Select element:', select);
            
            const tableName = select.value;
            const columnsDiv = document.getElementById(`int-columns-${mappingId}`);

            console.log('üîç loadInternalColumns() chamado para mappingId:', mappingId);
            console.log('   Tabela selecionada:', tableName);

            if (!tableName) {
                columnsDiv.style.display = 'none';
                return;
            }

            const columns = internalSchema[tableName].columns;
            console.log(`   Colunas de ${tableName}:`, columns);
            console.log(`   Total: ${columns.length}`);
            
            // Debug espec√≠fico para categorias
            if (tableName === 'categorias') {
                const subcategorias = columns.find(col => col.name === 'subcategorias');
                console.log('   üîé subcategorias na lista:', subcategorias ? '‚úÖ ENCONTRADA' : '‚ùå N√ÉO ENCONTRADA', subcategorias);
            }
            
            let html = '<strong>Colunas:</strong><br>';
            
            columns.forEach(col => {
                html += `<span style="display: inline-block; margin: 3px; padding: 5px 10px; background: #fff3cd; border-radius: 5px; font-size: 12px;">
                    ${col.name} <span style="color: #666;">(${col.type})</span>
                </span>`;
            });

            columnsDiv.innerHTML = html;
            columnsDiv.style.display = 'block';
            
            console.log('   ‚úÖ HTML renderizado:', html.substring(0, 200) + '...');
            
            // Verificar se ambas tabelas est√£o selecionadas para mostrar mapeamento de colunas
            checkShowColumnMapping(mappingId);
        }

        // Verificar e mostrar mapeamento de colunas se ambas tabelas estiverem selecionadas
        function checkShowColumnMapping(mappingId) {
            const extTable = document.getElementById(`ext-table-${mappingId}`).value;
            const intTable = document.getElementById(`int-table-${mappingId}`).value;
            const columnMappingDiv = document.getElementById(`column-mapping-${mappingId}`);

            if (extTable && intTable) {
                columnMappingDiv.style.display = 'block';
                generateColumnPairs(mappingId, extTable, intTable);
            } else {
                columnMappingDiv.style.display = 'none';
            }
        }

        // Gerar pares de mapeamento de colunas
        function generateColumnPairs(mappingId, extTable, intTable) {
            const extColumns = externalSchema[extTable].columns;
            const intColumns = internalSchema[intTable].columns;
            const pairsDiv = document.getElementById(`column-pairs-${mappingId}`);

            let html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Coluna Origem</th>
                            <th style="padding: 10px; text-align: center; border: 1px solid #ddd; width: 50px;">‚û°Ô∏è</th>
                            <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Coluna Destino</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            extColumns.forEach((extCol, index) => {
                let internalOptions = '<option value="">-- N√£o mapear --</option>';
                intColumns.forEach(intCol => {
                    const selected = intCol.name.toLowerCase() === extCol.name.toLowerCase() ? 'selected' : '';
                    internalOptions += `<option value="${intCol.name}" ${selected}>${intCol.name} (${intCol.type})</option>`;
                });

                html += `
                    <tr>
                        <td style="padding: 10px; border: 1px solid #ddd;">
                            <strong>${extCol.name}</strong><br>
                            <span style="font-size: 11px; color: #666;">${extCol.type}</span>
                        </td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">‚û°Ô∏è</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">
                            <select id="col-map-${mappingId}-${index}" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                                ${internalOptions}
                            </select>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            pairsDiv.innerHTML = html;
        }

        // Remover mapeamento manual
        function removeManualMapping(id) {
            const element = document.getElementById(`mapping-${id}`);
            if (element) {
                element.remove();
            }
        }

        // Coletar mapeamentos manuais
        function collectManualMappings() {
            const mappings = [];
            const mappingsDiv = document.getElementById('manual-mappings');
            
            if (!mappingsDiv) return [];

            for (let i = 1; i <= manualMappingCounter; i++) {
                const extTableSelect = document.getElementById(`ext-table-${i}`);
                const intTableSelect = document.getElementById(`int-table-${i}`);
                
                if (!extTableSelect || !intTableSelect) continue;

                const extTable = extTableSelect.value;
                const intTable = intTableSelect.value;

                if (!extTable || !intTable) continue;

                // Coletar mapeamentos de colunas
                const columns = [];
                const extColumns = externalSchema[extTable].columns;
                
                extColumns.forEach((extCol, index) => {
                    const colSelect = document.getElementById(`col-map-${i}-${index}`);
                    if (colSelect && colSelect.value) {
                        columns.push({
                            origem: extCol.name,
                            destino: colSelect.value,
                            transformacao: null
                        });
                    }
                });

                if (columns.length > 0) {
                    mappings.push({
                        tabela_origem: extTable,
                        tabela_destino: intTable,
                        colunas: columns
                    });
                }
            }

            return mappings;
        }

        // Reverter importa√ß√£o
        async function rollbackImport(importId) {
            if (!confirm('‚ö†Ô∏è ATEN√á√ÉO!\n\nIsto ir√° reverter TODOS os dados importados!\n\nConfirma?')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/import/reverter/${importId}`, {
                    method: 'POST',
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ Importa√ß√£o revertida com sucesso!');
                    loadHistory();
                } else {
                    alert('‚ùå Erro ao reverter importa√ß√£o!');
                }
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        }

        // Carregar hist√≥rico ao abrir a tab
        window.addEventListener('load', () => {
            // Pode adicionar carregamento inicial aqui
        });
    </script>
</body>
</html>
