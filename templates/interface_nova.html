<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- CSRF Token para prote√ß√£o de requisi√ß√µes -->
    <meta name="csrf-token" content="{{ csrf_token() }}">
    
    <!-- Meta tags anti-cache - Updated: 2026-01-16 CLIENTES FIX -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <title>Sistema Financeiro</title>
    
    <!-- üî• BUILD: {{ build_timestamp }} - SEMPRE ATUALIZADO üî• -->
    
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    
    <!-- CSS Externo com Sistema de Responsividade Completo v2.0 -->
    <link rel="stylesheet" href="/static/style.css?v={{ build_timestamp }}">
    
    <!-- CSS M√≥dulo Remessa Pagamento -->
    <link rel="stylesheet" href="/static/remessa_pagamento.css?v={{ build_timestamp }}">
    
    <!-- SUPRESSOR DE ERROS DE EXTENS√ïES - DEVE SER A PRIMEIRA COISA -->
    <script>
        (function() {
            window.addEventListener('error', function(e) {
                if (e.message && (e.message.includes('message channel closed') || 
                                  e.message.includes('Extension context invalidated') ||
                                  e.message.includes('chrome-extension'))) {
                    e.stopPropagation();
                    e.preventDefault();
                    return true;
                }
            }, true);
            
            window.addEventListener('unhandledrejection', function(e) {
                if (e.reason && e.reason.message && 
                    (e.reason.message.includes('message channel closed') || 
                     e.reason.message.includes('Extension context invalidated') ||
                     e.reason.message.includes('chrome-extension'))) {
                    e.stopPropagation();
                    e.preventDefault();
                }
            }, true);
        })();
    </script>
    
    <!-- Fun√ß√µes essenciais dispon√≠veis imediatamente -->
    <script>
        // Fun√ß√£o para toggle de submenus - COM DEBUG E PROTE√á√ÉO DE ERRO
        window.toggleSubmenu = function(submenuId) {
            try {
                console.log('üîç toggleSubmenu chamada com ID:', submenuId);
                
                const submenu = document.getElementById('submenu-' + submenuId);
                const button = document.getElementById('btn-' + submenuId);
                
                console.log('üìç Submenu element:', submenu);
                console.log('üìç Button element:', button);
                
                if (!submenu || !button) {
                    console.error('‚ùå Elementos n√£o encontrados!');
                    console.error('   submenu ID procurado:', 'submenu-' + submenuId);
                    console.error('   button ID procurado:', 'btn-' + submenuId);
                    return;
                }
                
                // Verificar estado atual
                const currentDisplay = window.getComputedStyle(submenu).display;
                const isHidden = currentDisplay === 'none';
                
                console.log('üìä Display atual:', currentDisplay);
                console.log('üìä Est√° oculto?', isHidden);
                
                if (isHidden) {
                    console.log('‚û°Ô∏è Mostrando submenu...');
                    submenu.style.display = 'block';
                    button.classList.add('active');
                } else {
                    console.log('‚û°Ô∏è Ocultando submenu...');
                    submenu.style.display = 'none';
                    button.classList.remove('active');
                }
                
                console.log('‚úÖ Toggle conclu√≠do. Novo display:', submenu.style.display);
            } catch (error) {
                console.error('üí• ERRO em toggleSubmenu:', error);
                console.error('Stack:', error.stack);
            }
        };
        
        // Garantir que est√° no escopo global
        console.log('‚úÖ toggleSubmenu definida no escopo window');
        
        // Fun√ß√£o para mostrar se√ß√µes
        function showSection(sectionId) {
            console.log('üìÇ Navegando para se√ß√£o:', sectionId);
            
            // Ocultar todas as se√ß√µes
            const sections = document.querySelectorAll('.content-card');
            sections.forEach(section => section.classList.add('hidden'));
            
            // Mostrar a se√ß√£o selecionada
            const targetSection = document.getElementById(sectionId + '-section');
            if (targetSection) {
                targetSection.classList.remove('hidden');
                console.log('‚úÖ Se√ß√£o exibida:', sectionId);
            } else {
                console.error('‚ùå Se√ß√£o n√£o encontrada:', sectionId + '-section');
            }
            
            // Atualizar bot√µes de navega√ß√£o
            const navButtons = document.querySelectorAll('.nav-button');
            navButtons.forEach(button => button.classList.remove('active'));
            
            // Carregar dados da se√ß√£o
            const loadFunctions = {
                'dashboard': 'loadDashboard',
                'contas': 'loadContas',
                'categorias': 'loadCategorias',
                'clientes': 'loadClientes',
                'fornecedores': 'loadFornecedores',
                'contas-receber': 'loadContasReceber',
                'contas-pagar': 'loadContasPagar',
                'extrato-bancario': 'loadExtratos',
                'fluxo-caixa': 'loadFluxoCaixa',
                'analise-categorias': 'loadAnaliseCategorias',
                'inadimplencia': 'loadInadimplencia',
                'fluxo-projetado': 'loadFluxoProjetado',
                'analise-contas': 'loadAnaliseContas',
                'kits': 'loadKits',
                'contratos': 'loadContratos',
                'sessoes': 'loadSessoes',
                'comissoes': 'loadComissoes',
                'funcionarios': 'loadFuncionariosRH',
                'remessa-pagamento': 'loadRemessaPagamento',
                'nfse': 'loadNFSeSection',
                'plano-contas': 'loadPlanoContas',
                'fiscal': 'loadFiscalSection',
                'empresa': 'carregarDadosEmpresa'
            };
            
            const loadFunctionName = loadFunctions[sectionId];
            if (loadFunctionName && typeof window[loadFunctionName] === 'function') {
                console.log(`üîÑ Carregando dados: ${loadFunctionName}()`);
                try {
                    window[loadFunctionName]();
                } catch (error) {
                    console.error(`‚ùå Erro ao carregar ${loadFunctionName}:`, error);
                }
            } else if (loadFunctionName) {
                console.warn(`‚ö†Ô∏è Fun√ß√£o ${loadFunctionName} n√£o encontrada`);
            }
        }
        
        // Expor globalmente
        window.showSection = showSection;
    </script>
    
    <style>
        /* ============================================================================
           ESTILOS ESPEC√çFICOS DA INTERFACE - Complemento ao style.css
           ============================================================================ */

        /* For√ßa mai√∫sculas em todos os inputs e textareas, exceto email e password */
        input[type="text"],
        input:not([type="date"]):not([type="month"]):not([type="email"]):not([type="password"]):not([type="number"]):not([id*="calc"]),
        textarea {
            text-transform: uppercase !important;
        }

        input[type="email"] {
            text-transform: lowercase !important;
        }

        /* Containers espec√≠ficos da p√°gina */
        .container {
            display: flex;
            min-height: 100vh;
        }

        .content-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .hidden {
            display: none !important;
        }

        .fiscal-tab-content {
            display: block;
        }

        .fiscal-tab-content.hidden {
            display: none !important;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.show {
            display: flex !important;
        }

        .modal-dialog {
            background: white;
            border-radius: 10px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px 10px 0 0;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .close-modal:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Estilos de status de lan√ßamentos */
        .status-pago {
            color: #27ae60;
            font-weight: 600;
            background: #d5f4e6;
            padding: 5px 12px;
            border-radius: 6px;
            display: inline-block;
        }

        .status-pendente {
            color: #f39c12;
            font-weight: 600;
            background: #fef5e7;
            padding: 5px 12px;
            border-radius: 6px;
            display: inline-block;
        }

        .status-vencido {
            color: #e74c3c;
            font-weight: 600;
            background: #fadbd8;
            padding: 5px 12px;
            border-radius: 6px;
            display: inline-block;
            animation: pulse 2s infinite;
        }

        .status-cancelado {
            color: #95a5a6;
            font-weight: 600;
            background: #ecf0f1;
            padding: 5px 12px;
            border-radius: 6px;
            display: inline-block;
            text-decoration: line-through;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Loading state */
        .loading {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 30px;
        }

        /* TODOS OS DEMAIS ESTILOS EST√ÉO NO style.css EXTERNO */
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 700px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #3498db;
        }

        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            color: #95a5a6;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: #e74c3c;
        }

        /* Form */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #000000;
            font-weight: 600;
            font-size: 14px;
        }

        input:not([type="checkbox"]), select, textarea {
            width: 100%;
            padding: 12px;
            border: 3px solid #2c3e50;
            border-radius: 8px;
            font-size: 14px;
            transition: border 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer !important;
            margin: 0;
            padding: 0;
            display: inline-block;
            position: relative;
            flex-shrink: 0;
            pointer-events: auto !important;
            vertical-align: middle;
        }

        input[type="checkbox"]:hover:not(:disabled) {
            opacity: 0.8;
        }

        input[type="checkbox"]:checked {
            accent-color: #3498db;
        }

        input[type="checkbox"]:disabled {
            opacity: 0.3;
            cursor: not-allowed !important;
        }

        /* Estilo para label do checkbox */
        td label {
            cursor: pointer !important;
            user-select: none;
            margin: 0 !important;
            padding: 0 !important;
        }

        td label:hover .checkbox-icon {
            transform: scale(1.2);
            transition: transform 0.2s;
        }

        input:not([type="checkbox"]):focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
            border-width: 3px;
            box-shadow: 0 3px 8px rgba(52, 152, 219, 0.3);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* Dashboard Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
        }

        /* Filters */
        .filters {
            background: #f8f9fa;
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 8px;
            border: none;
        }

        .filters select,
        .filters input[type="date"],
        .filters input[type="text"],
        .filters input[type="number"] {
            border: 1px solid #ddd;
            background: white;
            padding: 6px 10px;
            font-size: 13px;
        }

        .filters label {
            font-size: 12px;
            margin-bottom: 4px;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 8px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #95a5a6;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            min-width: 300px;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.4s ease-out;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .toast::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
        }

        .toast-success {
            background: white;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .toast-success .toast-icon {
            color: #28a745;
            font-size: 24px;
        }

        .toast-error {
            background: white;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .toast-error .toast-icon {
            color: #dc3545;
            font-size: 24px;
        }

        .toast-info {
            background: white;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .toast-info .toast-icon {
            color: #17a2b8;
            font-size: 24px;
        }

        .toast-warning {
            background: white;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        .toast-warning .toast-icon {
            color: #ffc107;
            font-size: 24px;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .toast.hiding {
            animation: slideOutRight 0.3s ease-in forwards;
        }

        /* Confirm Dialog */
        .confirm-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 0.2s;
        }

        .confirm-dialog {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: scaleIn 0.3s ease-out;
        }

        .confirm-icon {
            font-size: 48px;
            text-align: center;
            margin-bottom: 20px;
        }

        .confirm-title {
            font-size: 22px;
            font-weight: bold;
            color: #2c3e50;
            text-align: center;
            margin-bottom: 12px;
        }

        .confirm-message {
            font-size: 16px;
            color: #7f8c8d;
            text-align: center;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .confirm-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .confirm-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .confirm-btn-yes {
            background: #e74c3c;
            color: white;
        }

        .confirm-btn-yes:hover {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        .confirm-btn-no {
            background: #ecf0f1;
            color: #2c3e50;
        }

        .confirm-btn-no:hover {
            background: #bdc3c7;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
        }

        /* Badge de inadimpl√™ncia */
        .badge-inadimplencia {
            display: inline-block;
            background: #95a5a6;
            color: white;
            font-size: 11px;
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 12px;
            margin-left: 8px;
            min-width: 20px;
            text-align: center;
        }

        /* Old alerts - hidden */
        .alert {
            display: none !important;
        }

        /* Hidden */
        .hidden {
            display: none;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 5px;
        }

        /* Tab Buttons */
        .tab-button {
            padding: 12px 30px;
            border: none;
            background: transparent;
            color: #666;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .tab-button:hover {
            color: #3498db;
            background: rgba(52, 152, 219, 0.05);
        }

        .tab-button.active {
            color: #3498db;
            border-bottom-color: #3498db;
            background: rgba(52, 152, 219, 0.1);
        }

        /* Tabs */
        .tab-button {
            padding: 12px 24px;
            border: none;
            background: transparent;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-button:hover {
            color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        body.dark-mode .indicador-analise p {
            color: #e0e0e0 !important;
        }

        body.dark-mode .indicador-analise strong {
            color: #64b5f6 !important;
        }

        /* Diminuir fonte das tabelas de contas a pagar e receber */
        #contas-receber-section table,
        #contas-pagar-section table {
            font-size: 13px;
        }

        #contas-receber-section table th,
        #contas-pagar-section table th {
            font-size: 13px;
            padding: 10px 8px;
        }

        #contas-receber-section table td,
        #contas-pagar-section table td {
            font-size: 13px;
            padding: 8px;
        }

        #contas-receber-section .btn-small,
        #contas-pagar-section .btn-small {
            padding: 4px 8px;
            font-size: 12px;
        }

        /* Badges para status */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .badge-success {
            background: #27ae60;
            color: white;
        }

        .badge-danger {
            background: #e74c3c;
            color: white;
        }

        .badge-warning {
            background: #f39c12;
            color: white;
        }

        .badge-info {
            background: #3498db;
            color: white;
        }

        /* Bot√µes pequenos para a√ß√µes */
        .btn-sm {
            padding: 5px 10px;
            font-size: 14px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 2px;
        }

        .btn-sm:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        /* Modal espec√≠fico */
        .modal .form-group label span[style*="color: red"] {
            font-weight: bold;
        }

        .modal .form-group small {
            display: block;
            margin-top: 5px;
        }

        /* ============================================================================
           OTIMIZA√á√ïES RESPONSIVAS INLINE - COMPLEMENTO AO style.css
           ============================================================================ */
        
        /* Ajustes de sidebar para mobile */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: relative;
                height: auto;
                transform: none !important;
            }
            
            .sidebar.hidden {
                display: none;
            }
            
            .content-wrapper {
                margin-left: 0 !important;
                width: 100% !important;
            }
            
            /* Ajustar cards do dashboard */
            .cards-grid {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }
            
            /* Tabelas com scroll horizontal */
            .table-container,
            .table-scroll-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 600px;
            }
            
            /* Reduzir padding em c√©lulas */
            th, td {
                padding: 8px 6px !important;
                font-size: 12px !important;
            }
            
            /* Bot√µes de a√ß√£o em coluna */
            .action-buttons,
            .btn-group {
                display: flex;
                flex-direction: column;
                gap: 5px;
            }
            
            .action-buttons button,
            .btn-group button {
                width: 100%;
                margin: 2px 0 !important;
            }
        }
        
        /* Tablets */
        @media (min-width: 769px) and (max-width: 1024px) {
            .sidebar {
                width: 220px;
            }
            
            .content-wrapper {
                margin-left: 220px;
            }
            
            th, td {
                padding: 10px 8px !important;
                font-size: 13px !important;
            }
        }
        
        /* Ajustes espec√≠ficos para inputs mobile */
        @media (max-width: 768px) {
            input[type="text"],
            input[type="number"],
            input[type="email"],
            input[type="date"],
            select,
            textarea {
                font-size: 16px !important; /* Previne zoom no iOS */
                padding: 12px !important;
            }
            
            /* Modais full-screen em mobile */
            .modal-content,
            .modal-subcategorias-content {
                width: 95% !important;
                max-width: none !important;
                margin: 10px !important;
                max-height: 90vh !important;
            }
            
            .modal-body {
                max-height: 60vh !important;
                overflow-y: auto !important;
            }
        }
        
        /* Ocultar elementos em telas pequenas */
        @media (max-width: 480px) {
            .hide-mobile {
                display: none !important;
            }
            
            /* Compactar cabe√ßalhos */
            h1, h2 {
                font-size: 18px !important;
            }
            
            h3 {
                font-size: 16px !important;
            }
            
            /* Badges menores */
            .badge,
            .subcategoria-badge {
                font-size: 10px !important;
                padding: 2px 6px !important;
            }
        }
        
        /* Estilos para headers clic√°veis da tabela NFS-e */
        #table-nfse thead th[onclick] {
            transition: background-color 0.2s ease;
        }
        
        #table-nfse thead th[onclick]:hover {
            background-color: #34495e !important;
            color: white !important;
        }
        
        #table-nfse thead th[onclick]:active {
            background-color: #2c3e50 !important;
        }
    </style>
    
    <!-- FullCalendar CSS e JS -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.10/locales/pt-br.global.min.js'></script>
    
    <!-- Estilos personalizados para o calend√°rio -->
    <style>
        /* FullCalendar - Estilo Windows Moderno Compacto */
        .fc {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            font-size: 13px;
        }
        
        /* Toolbar compacto */
        .fc .fc-toolbar {
            margin-bottom: 10px;
            padding: 6px 0;
        }
        
        .fc .fc-toolbar-title {
            font-size: 1.1em;
            font-weight: 500;
            color: #1f1f1f;
            text-transform: lowercase;
        }
        
        .fc .fc-toolbar-title::first-letter {
            text-transform: uppercase;
        }
        
        /* Bot√µes estilo Windows minimalista */
        .fc .fc-button {
            background: transparent;
            border: 1px solid #d1d1d1;
            color: #1f1f1f;
            padding: 5px 10px;
            font-weight: 400;
            font-size: 12px;
            border-radius: 3px;
            transition: background 0.15s ease;
        }
        
        .fc .fc-button:hover {
            background: #f3f3f3;
            border-color: #adadad;
        }
        
        .fc .fc-button-primary:not(:disabled).fc-button-active,
        .fc .fc-button:focus {
            background: #e5e5e5;
            border-color: #adadad;
            box-shadow: none;
        }
        
        /* Grid limpo */
        .fc-theme-standard .fc-scrollgrid {
            border-color: #e0e0e0;
            border-width: 1px;
            table-layout: fixed !important;
            width: 100% !important;
        }
        
        .fc-scrollgrid-sync-table {
            table-layout: fixed !important;
            width: 100% !important;
        }
        
        .fc-theme-standard td,
        .fc-theme-standard th {
            border-color: #e0e0e0;
        }
        
        /* Remove qualquer padding/margin que cause desalinhamento */
        .fc-scrollgrid-section-header > * {
            border: 0 !important;
        }
        
        .fc-col-header-cell {
            border-left: 1px solid #e0e0e0 !important;
            border-right: 0 !important;
        }
        
        .fc-col-header-cell:first-child {
            border-left: 0 !important;
        }
        
        /* For√ßa largura igual para todas as colunas */
        .fc-scrollgrid col {
            width: 14.285% !important;
        }
        
        .fc-col-header col {
            width: 14.285% !important;
        }
        
        .fc-daygrid-body col {
            width: 14.285% !important;
        }
        
        /* Cabe√ßalho dos dias compacto e alinhado */
        .fc-col-header-cell {
            background: #fafafa;
            font-weight: 600;
            color: #666;
            padding: 8px 0 !important;
            font-size: 11px;
            text-transform: uppercase;
            text-align: center !important;
            vertical-align: middle !important;
            width: 14.285% !important; /* 100% / 7 dias = exatamente 1/7 */
            box-sizing: border-box !important;
        }
        
        .fc-col-header-cell-cushion {
            display: block !important;
            padding: 0 !important;
            margin: 0 !important;
            text-align: center !important;
            width: 100% !important;
        }
        
        .fc-scrollgrid-sync-table {
            width: 100% !important;
        }
        
        .fc-col-header {
            width: 100% !important;
        }
        
        /* Cabe√ßalho dos dias - deve ficar acima dos eventos */
        .fc-col-header {
            position: relative;
            z-index: 100 !important;
            background: white !important;
        }
        
        /* C√©lulas dos dias com largura exata */
        .fc-daygrid-day {
            padding: 2px;
            width: 14.285% !important; /* 100% / 7 dias */
            position: relative;
            z-index: 1;
            box-sizing: border-box !important;
        }
        
        .fc-daygrid-day-frame {
            min-height: 65px;
            position: relative;
            z-index: 1;
        }
        
        .fc-daygrid-day-top {
            flex-direction: row;
            justify-content: center;
        }
        
        .fc-daygrid-day-events {
            position: relative;
            z-index: 2;
            margin-top: 4px;
        }
        
        .fc-daygrid-day-bg {
            z-index: 0;
        }
        
        .fc-daygrid-day-number {
            color: #1f1f1f;
            font-weight: 400;
            font-size: 13px;
            padding: 4px;
            text-align: center;
            width: 100%;
        }
        
        /* Dia de hoje - estilo Windows (c√≠rculo azul) */
        .fc-daygrid-day.fc-day-today {
            background-color: transparent !important;
        }
        
        .fc-daygrid-day.fc-day-today .fc-daygrid-day-number {
            background: #0078d4;
            color: white;
            border-radius: 50%;
            width: 26px;
            height: 26px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            font-weight: 500;
            margin: 2px auto;
        }
        
        /* Dias fora do m√™s atual */
        .fc-day-other .fc-daygrid-day-number {
            color: #999;
        }
        
        /* Eventos compactos e limpos */
        .fc-event {
            border-radius: 2px;
            padding: 2px 5px;
            margin: 1px 2px;
            font-size: 11px;
            font-weight: 500;
            border-left-width: 3px;
            box-shadow: none;
            position: relative;
            z-index: 5 !important;
            display: block !important;
        }
        
        .fc-daygrid-event {
            position: relative !important;
            z-index: 5 !important;
        }
        
        .fc-daygrid-block-event {
            position: relative !important;
        }
        
        .fc-event:hover {
            filter: brightness(0.92);
            box-shadow: 0 1px 2px rgba(0,0,0,0.15);
        }
        
        .fc-event-title {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.3;
            max-width: 100%;
            display: block;
        }
        
        .fc-event-title-container {
            overflow: hidden;
            max-width: 100%;
        }
        
        .fc-event-main-frame {
            overflow: hidden;
            max-width: 100%;
        }
        
        /* Link "mais eventos" */
        .fc-daygrid-more-link {
            color: #0078d4;
            font-size: 10px;
            font-weight: 600;
            padding: 1px 3px;
            margin: 1px;
        }
        
        .fc-daygrid-more-link:hover {
            background: #f0f0f0;
            border-radius: 2px;
        }
        
        /* Lista view */
        .fc-list-event:hover td {
            background-color: #f5f5f5;
        }
        
        /* Container do calend√°rio - mais compacto */
        #calendar-container {
            background: white;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            max-width: 900px;
            margin: 0 auto;
        }
    </style>
    
    <!-- Google Calendar API -->
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body style="background: #f5f7fa !important; color: #2c3e50 !important;">
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">üí∞ Sistema Financeiro</div>
            
            <!-- User Info Header -->
            <div class="user-info" style="padding: 15px 20px; border-bottom: 1px solid #34495e; margin-bottom: 15px;">
                <div style="color: #fff; font-size: 14px; margin-bottom: 8px;">
                    <strong id="userNameSidebar" style="color: #fff;">üë§ Carregando...</strong>
                </div>
                <div style="color: #fff; font-size: 12px; margin-bottom: 10px;">
                    <span id="userTypeSidebar" style="color: #fff;">-</span>
                </div>
                
                <!-- Seletor de Empresa Multi-Empresa -->
                <div id="empresaSelectorContainer" style="margin-bottom: 10px; display: none;">
                    <select id="empresaSelector" onchange="switchEmpresa()" style="width: 100%; padding: 6px 8px; background: #1a252f; color: #fff; border: 1px solid #34495e; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        <option value="">üè¢ Carregando empresas...</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                    <button id="themeToggleBtn" onclick="toggleTheme()" style="flex: 1; min-width: 70px; padding: 6px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Alternar Tema Claro/Escuro">üåì Tema</button>
                    <button id="adminBtn" onclick="window.location.href='/admin'" style="display: none; flex: 1; padding: 6px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">‚öôÔ∏è Admin</button>
                    <button onclick="logoutUser()" style="flex: 1; padding: 6px; background: #34495e; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">üö™ Sair</button>
                </div>
            </div>
            
            <button class="nav-button active" onclick="showSection('dashboard')" data-permission="dashboard">
                üìä Dashboard
            </button>
            
            <!-- Menu Financeiro com Submenu -->
            <button class="nav-button" onclick="console.log('üñ±Ô∏è BOT√ÉO FINANCEIRO CLICADO!'); toggleSubmenu('financeiro')" id="btn-financeiro" data-permission="lancamentos_view">
                üí∞ Financeiro ‚ñº
            </button>
            <div class="submenu" id="submenu-financeiro" style="display: none;">
                <button class="submenu-button" onclick="showSection('contas-receber')" data-permission="lancamentos_view">üíµ Contas a Receber</button>
                <button class="submenu-button" onclick="showSection('contas-pagar')" data-permission="lancamentos_view">üí≥ Contas a Pagar</button>
                <button class="submenu-button" onclick="showSection('remessa-pagamento')" data-permission="remessa_view">üì§ Remessa Pagamentos</button>
                <button class="submenu-button" onclick="showSection('extrato-bancario')" data-permission="lancamentos_view">üè¶ Extrato Banc√°rio</button>
            </div>
            
            <!-- Menu Contabilidade com Submenu -->
            <button class="nav-button" onclick="toggleSubmenu('contabilidade')" id="btn-contabilidade" data-permission="lancamentos_view">
                üìí Contabilidade ‚ñº
            </button>
            <div class="submenu" id="submenu-contabilidade" style="display: none;">
                <button class="submenu-button" onclick="showSection('plano-contas')" data-permission="lancamentos_view">üìä Plano de Contas</button>
                <button class="submenu-button" onclick="showSection('integra-contador')" data-permission="lancamentos_view">üîó Integra Contador</button>
                <button class="submenu-button" onclick="showSection('dre')" data-permission="lancamentos_view">üìà DRE (Demonstra√ß√£o do Resultado)</button>
                <button class="submenu-button" onclick="showSection('dashboard-gerencial')" data-permission="lancamentos_view">üìä Dashboard Gerencial</button>
            </div>
            
            <!-- Menu de Relat√≥rios com Submenu -->
            <button class="nav-button" onclick="console.log('üñ±Ô∏è BOT√ÉO RELAT√ìRIOS CLICADO!'); toggleSubmenu('relatorios')" id="btn-relatorios" data-permission="relatorios_view">
                üìä Relat√≥rios ‚ñº
            </button>
            <div class="submenu" id="submenu-relatorios" style="display: none;">
                <button class="submenu-button" onclick="showSection('fluxo-caixa')" data-permission="relatorios_view">üìà Fluxo de Caixa</button>
                <button class="submenu-button" onclick="showSection('analise-detalhada')" data-permission="relatorios_view">üìä An√°lise Detalhada</button>
                <button class="submenu-button" onclick="showSection('comparativo-periodos')" data-permission="relatorios_view">üìâ Comparativo de Per√≠odos</button>
                <button class="submenu-button" onclick="showSection('inadimplencia')" data-permission="relatorios_view">‚ö†Ô∏è Inadimpl√™ncia <span id="badge-inadimplencia" class="badge-inadimplencia">0</span></button>
                <button class="submenu-button" onclick="showSection('fiscal')" data-permission="relatorios_view">üìë NF-e e CT-e - Documentos Fiscais</button>
                <button class="submenu-button" onclick="showSection('nfse')" data-permission="nfse_view">üìÑ NFS-e - Notas Fiscais</button>
            </div>
            
            <!-- Menu de Cadastros com Submenu -->
            <button class="nav-button" onclick="toggleSubmenu('cadastros')" id="btn-cadastros" data-permission="cadastros_view">
                üìã Cadastros ‚ñº
            </button>
            <div class="submenu" id="submenu-cadastros" style="display: none;">
                <button class="submenu-button" onclick="showSection('empresa')" data-permission="cadastros_view">üè¢ Empresa - Certificado Digital</button>
                <button class="submenu-button" onclick="showSection('contas-bancarias')" data-permission="contas_view">üè¶ Contas Banc√°rias</button>
                <button class="submenu-button" onclick="showSection('categorias')" data-permission="categorias_view">üìÅ Categorias</button>
                <button class="submenu-button" onclick="showSection('clientes')" data-permission="clientes_view">üë§ Clientes</button>
                <button class="submenu-button" onclick="showSection('fornecedores')" data-permission="fornecedores_view">üè≠ Fornecedores</button>
                <button class="submenu-button" onclick="showSection('tags-trabalho')" data-permission="operacional_view">üè∑Ô∏è Tags</button>
            </div>
            
            <!-- Menu Operacional com Submenu -->
            <button class="nav-button" onclick="toggleSubmenu('operacional')" id="btn-operacional" data-permission="operacional_view">
                ‚öôÔ∏è Operacional ‚ñº
            </button>
            <div class="submenu" id="submenu-operacional" style="display: none;">
                <button class="submenu-button" onclick="showSection('contratos')" data-permission="contratos_view">üìã Contratos e Sess√µes</button>
                <button class="submenu-button" onclick="showSection('agenda-fotografia')" data-permission="agenda_view">üì∑ Agenda de Fotografia</button>
                <button class="submenu-button" onclick="showSection('kits-equipamentos')" data-permission="estoque_view">üéí Kits de Equipamentos</button>
                <button class="submenu-button" onclick="showSection('eventos')" data-permission="eventos_view">üéâ Eventos</button>
            </div>
            
            <!-- Menu Recursos Humanos com Submenu -->
            <button class="nav-button" onclick="toggleSubmenu('recursos-humanos')" id="btn-recursos-humanos" data-permission="folha_pagamento_view">
                üë• Recursos Humanos ‚ñº
            </button>
            <div class="submenu" id="submenu-recursos-humanos" style="display: none;">
                <button class="submenu-button" onclick="showSection('folha-pagamento')" data-permission="folha_pagamento_view">üë• Folha de Pagamento</button>
            </div>
        </div>

        <!-- Bot√£o Toggle Sidebar -->
        <button class="toggle-sidebar-btn" onclick="toggleSidebar()" title="Ocultar/Mostrar Menu">
            ¬´
        </button>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Toast Container -->
            <div id="toast-container" class="toast-container"></div>

            <!-- Dashboard -->
            <div id="dashboard-section" class="content-card">
                <h2 style="color: #000000 !important; font-weight: 700;">üìä Dashboard Financeiro</h2>
                
                <!-- Filtros -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                    <div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
                        <div style="flex: 0 0 auto;">
                            <label style="font-weight: 600; margin-bottom: 8px; display: block; color: white; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">üìÖ Ano</label>
                            <input type="number" id="filter-ano-dashboard" placeholder="√öltimos 12 meses" min="2000" max="2100" 
                                   style="width: 150px; padding: 12px 16px; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; 
                                          box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s; outline: none; background: white;"
                                   onfocus="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)'; this.style.transform='translateY(-2px)';"
                                   onblur="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'; this.style.transform='translateY(0)';">
                        </div>
                        <div style="flex: 0 0 auto;">
                            <label style="font-weight: 600; margin-bottom: 8px; display: block; color: white; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">üìÜ M√™s</label>
                            <select id="filter-mes-dashboard" 
                                    style="width: 200px; padding: 12px 16px; border: none; border-radius: 8px; font-size: 15px; font-weight: 600;
                                           box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s; outline: none; cursor: pointer; background: white;
                                           appearance: none; -webkit-appearance: none; -moz-appearance: none; 
                                           background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2712%27 height=%278%27%3e%3cpath fill=%27%23667eea%27 d=%27M0 0l6 8 6-8z%27/%3e%3c/svg%3e');
                                           background-repeat: no-repeat; background-position: right 12px center; padding-right: 36px;"
                                    onfocus="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)'; this.style.transform='translateY(-2px)';"
                                    onblur="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'; this.style.transform='translateY(0)';">
                                <option value="">√öltimos 12 meses</option>
                                <option value="1">Janeiro</option>
                                <option value="2">Fevereiro</option>
                                <option value="3">Mar√ßo</option>
                                <option value="4">Abril</option>
                                <option value="5">Maio</option>
                                <option value="6">Junho</option>
                                <option value="7">Julho</option>
                                <option value="8">Agosto</option>
                                <option value="9">Setembro</option>
                                <option value="10">Outubro</option>
                                <option value="11">Novembro</option>
                                <option value="12">Dezembro</option>
                            </select>
                        </div>
                        <button onclick="carregarDashboard()" 
                                style="padding: 12px 32px; font-size: 15px; font-weight: 700; border: none; border-radius: 8px; 
                                       background: white; color: #667eea; cursor: pointer; transition: all 0.3s; 
                                       box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-transform: uppercase; letter-spacing: 0.5px;
                                       display: flex; align-items: center; gap: 8px; height: 43px;"
                                onmouseover="this.style.background='#f8f9fa'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';"
                                onmouseout="this.style.background='white'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)';"
                                onmousedown="this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 4px rgba(0,0,0,0.1)';"
                                onmouseup="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';">
                            <span style="font-size: 18px;">üîç</span>
                            <span>Atualizar</span>
                        </button>
                    </div>
                </div>
                
                <!-- Gr√°fico de Crescimento -->
                <div style="background: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <h3 style="margin: 0 0 20px 0; color: #2c3e50; font-size: 18px;">üìà Evolu√ß√£o Financeira (Pagamentos Realizados)</h3>
                    <canvas id="grafico-crescimento" style="max-height: 400px;"></canvas>
                </div>
                
                <!-- Cards de Contas Pendentes -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 25px;">
                    <!-- Contas a Receber -->
                    <div style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3); color: white;">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                            <div style="width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                                üí∞
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 13px; opacity: 0.9; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Contas a Receber</div>
                                <div id="dashboard-contas-receber" style="font-size: 28px; font-weight: 700; margin-top: 5px;">R$ 0,00</div>
                            </div>
                        </div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
                            üìä Receitas pendentes de recebimento
                        </div>
                    </div>
                    
                    <!-- Contas a Pagar -->
                    <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3); color: white;">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                            <div style="width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                                üí≥
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 13px; opacity: 0.9; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Contas a Pagar</div>
                                <div id="dashboard-contas-pagar" style="font-size: 28px; font-weight: 700; margin-top: 5px;">R$ 0,00</div>
                            </div>
                        </div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
                            üí∏ Despesas pendentes de pagamento
                        </div>
                    </div>
                    
                    <!-- Contas Vencidas -->
                    <div style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(243, 156, 18, 0.3); color: white;">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                            <div style="width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                                ‚ö†Ô∏è
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 13px; opacity: 0.9; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Contas Vencidas</div>
                                <div id="dashboard-contas-vencidas" style="font-size: 28px; font-weight: 700; margin-top: 5px;">R$ 0,00</div>
                            </div>
                        </div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
                            üìÖ Pagamentos atrasados
                        </div>
                    </div>
                    
                    <!-- Saldo Total -->
                    <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3); color: white;">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                            <div style="width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                                üè¶
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 13px; opacity: 0.9; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Saldo Total</div>
                                <div id="dashboard-saldo-total" style="font-size: 28px; font-weight: 700; margin-top: 5px;">R$ 0,00</div>
                            </div>
                        </div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
                            üíµ Saldo atual em contas banc√°rias
                        </div>
                    </div>
                </div>
                
                <!-- An√°lises Detalhadas -->
                <div id="dashboard-analises-content"></div>
            </div>

            <!-- Contas a Receber -->
            <div id="contas-receber-section" class="content-card hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">Contas a Receber</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="openModalReceita()" style="padding: 8px 16px; font-size: 13px;">‚ûï Nova Receita</button>
                        <button class="btn btn-primary" onclick="exportarContasReceberPDF()" style="padding: 8px 16px; font-size: 13px; background: #e74c3c;">üìù PDF</button>
                        <button class="btn btn-primary" onclick="exportarContasReceberExcel()" style="padding: 8px 16px; font-size: 13px; background: #27ae60;">üìä Excel</button>
                    </div>
                </div>
                
                <div class="filters">
                    <div class="filter-row">
                        <div class="form-group">
                            <label>Status:</label>
                            <select id="filter-status-receber" onchange="loadContasReceber()">
                                <option value="" selected>Todos</option>
                                <option value="PENDENTE">Pendentes</option>
                                <option value="PAGO">Pagos</option>
                                <option value="CANCELADO">Cancelados</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Categoria:</label>
                            <select id="filter-categoria-receber" onchange="loadContasReceber()">
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Raz√£o Social:</label>
                            <select id="filter-cliente" onchange="loadContasReceber()">
                                <option value="">Todos</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-row">
                        <div class="form-group">
                            <label>Ano:</label>
                            <input type="number" id="filter-ano-receber" placeholder="2025" min="2000" max="2100" onchange="loadContasReceber()">
                        </div>
                        <div class="form-group">
                            <label>M√™s:</label>
                            <select id="filter-mes-receber" onchange="loadContasReceber()">
                                <option value="">Todos</option>
                                <option value="01">Janeiro</option>
                                <option value="02">Fevereiro</option>
                                <option value="03">Mar√ßo</option>
                                <option value="04">Abril</option>
                                <option value="05">Maio</option>
                                <option value="06">Junho</option>
                                <option value="07">Julho</option>
                                <option value="08">Agosto</option>
                                <option value="09">Setembro</option>
                                <option value="10">Outubro</option>
                                <option value="11">Novembro</option>
                                <option value="12">Dezembro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Data Inicial:</label>
                            <input type="date" id="filter-data-inicio-receber" onchange="loadContasReceber()">
                        </div>
                        <div class="form-group">
                            <label>Data Final:</label>
                            <input type="date" id="filter-data-fim-receber" onchange="loadContasReceber()">
                        </div>
                    </div>
                </div>

                <!-- Informa√ß√µes de Saldo -->
                <div style="margin-bottom: 8px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 20px;">
                            <div style="flex: 0 0 auto;">
                                <div style="font-size: 13px; opacity: 0.9; margin-bottom: 5px;">üí∞ Saldo Total dos Bancos</div>
                                <div id="saldo-total-bancos-receber" style="font-size: 28px; font-weight: bold;">R$ 0,00</div>
                            </div>
                            <div style="flex: 1; max-width: 500px;">
                                <div style="font-size: 12px; opacity: 0.9; margin-bottom: 6px;">üè¶ Consultar Saldo por Banco:</div>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <select id="select-banco-receber" onchange="atualizarSaldoBanco('receber')" style="flex: 1; padding: 10px; border: none; border-radius: 6px; font-size: 14px; background: rgba(255,255,255,0.9); color: #2c3e50; cursor: pointer;">
                                        <option value="">Selecione um banco</option>
                                    </select>
                                    <div id="saldo-banco-selecionado-receber" style="min-width: 150px; font-size: 22px; font-weight: 700; text-align: right; display: none;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 5px; display: flex; gap: 10px; align-items: center;">
                    <button class="btn btn-success" onclick="liquidarEmMassa('RECEITA')" style="display: none;" id="btn-liquidar-massa-receber">üí∞ Liquidar Selecionados</button>
                    <button class="btn btn-danger" onclick="excluirEmMassa('RECEITA')" style="display: none;" id="btn-excluir-massa-receber">üóëÔ∏è Excluir Selecionados</button>
                    <div id="soma-selecionados-receber" style="display: none; margin-left: auto; padding: 8px 16px; background: #e3f2fd; border: 2px solid #2196F3; border-radius: 4px; font-weight: bold; color: #1976D2; font-size: 14px;">
                        Total Selecionado: <span id="valor-soma-receber">R$ 0,00</span>
                    </div>
                </div>

                <div style="max-height: 950px; overflow-y: auto; overflow-x: auto; border: 1px solid #ddd; border-radius: 4px;">
                    <table id="table-receber">
                        <thead>
                            <tr>
                                <th style="width: 40px;"><input type="checkbox" id="select-all-receber" onchange="toggleSelectAll('receber')"></th>
                                <th>Vencimento</th>
                                <th>Raz√£o Social</th>
                                <th>N¬∫ Documento</th>
                                <th>Descri√ß√£o</th>
                                <th>Categoria</th>
                                <th>Subcategoria</th>
                                <th>Valor</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-receber">
                            <tr><td colspan="10" class="loading">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Contas a Pagar -->
            <div id="contas-pagar-section" class="content-card hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">Contas a Pagar</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="openModalDespesa()" style="padding: 8px 16px; font-size: 13px;">‚ûï Nova Despesa</button>
                        <button class="btn btn-primary" onclick="exportarContasPagarPDF()" style="padding: 8px 16px; font-size: 13px; background: #e74c3c;">üìù PDF</button>
                        <button class="btn btn-primary" onclick="exportarContasPagarExcel()" style="padding: 8px 16px; font-size: 13px; background: #27ae60;">üìä Excel</button>
                    </div>
                </div>
                
                <div class="filters">
                    <div class="filter-row">
                        <div class="form-group">
                            <label>Status:</label>
                            <select id="filter-status-pagar" onchange="loadContasPagar()">
                                <option value="" selected>Todos</option>
                                <option value="PENDENTE">Pendentes</option>
                                <option value="PAGO">Pagos</option>
                                <option value="CANCELADO">Cancelados</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Categoria:</label>
                            <select id="filter-categoria-pagar" onchange="loadContasPagar()">
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Raz√£o Social:</label>
                            <select id="filter-fornecedor" onchange="loadContasPagar()">
                                <option value="">Todos</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-row">
                        <div class="form-group">
                            <label>Ano:</label>
                            <input type="number" id="filter-ano-pagar" placeholder="2025" min="2000" max="2100" onchange="loadContasPagar()">
                        </div>
                        <div class="form-group">
                            <label>M√™s:</label>
                            <select id="filter-mes-pagar" onchange="loadContasPagar()">
                                <option value="">Todos</option>
                                <option value="01">Janeiro</option>
                                <option value="02">Fevereiro</option>
                                <option value="03">Mar√ßo</option>
                                <option value="04">Abril</option>
                                <option value="05">Maio</option>
                                <option value="06">Junho</option>
                                <option value="07">Julho</option>
                                <option value="08">Agosto</option>
                                <option value="09">Setembro</option>
                                <option value="10">Outubro</option>
                                <option value="11">Novembro</option>
                                <option value="12">Dezembro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Data Inicial:</label>
                            <input type="date" id="filter-data-inicio-pagar" onchange="loadContasPagar()">
                        </div>
                        <div class="form-group">
                            <label>Data Final:</label>
                            <input type="date" id="filter-data-fim-pagar" onchange="loadContasPagar()">
                        </div>
                    </div>
                </div>

                <!-- Informa√ß√µes de Saldo -->
                <div style="margin-bottom: 8px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 20px;">
                            <div style="flex: 0 0 auto;">
                                <div style="font-size: 13px; opacity: 0.9; margin-bottom: 5px;">üí∞ Saldo Total dos Bancos</div>
                                <div id="saldo-total-bancos-pagar" style="font-size: 28px; font-weight: bold;">R$ 0,00</div>
                            </div>
                            <div style="flex: 1; max-width: 500px;">
                                <div style="font-size: 12px; opacity: 0.9; margin-bottom: 6px;">üè¶ Consultar Saldo por Banco:</div>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <select id="select-banco-pagar" onchange="atualizarSaldoBanco('pagar')" style="flex: 1; padding: 10px; border: none; border-radius: 6px; font-size: 14px; background: rgba(255,255,255,0.9); color: #2c3e50; cursor: pointer;">
                                        <option value="">Selecione um banco</option>
                                    </select>
                                    <div id="saldo-banco-selecionado-pagar" style="min-width: 150px; font-size: 22px; font-weight: 700; text-align: right; display: none;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 5px; display: flex; gap: 10px; align-items: center;">
                    <button class="btn btn-success" onclick="liquidarEmMassa('DESPESA')" style="display: none;" id="btn-liquidar-massa-pagar">üí∞ Liquidar Selecionados</button>
                    <button class="btn btn-danger" onclick="excluirEmMassa('DESPESA')" style="display: none;" id="btn-excluir-massa-pagar">üóëÔ∏è Excluir Selecionados</button>
                    <div id="soma-selecionados-pagar" style="display: none; margin-left: auto; padding: 8px 16px; background: #ffebee; border: 2px solid #f44336; border-radius: 4px; font-weight: bold; color: #c62828; font-size: 14px;">
                        Total Selecionado: <span id="valor-soma-pagar">R$ 0,00</span>
                    </div>
                </div>

                <div style="max-height: 950px; overflow-y: auto; overflow-x: auto; border: 1px solid #ddd; border-radius: 4px;">
                    <table id="table-pagar">
                        <thead>
                            <tr>
                                <th style="width: 40px;"><input type="checkbox" id="select-all-pagar" onchange="toggleSelectAll('pagar')"></th>
                                <th>Vencimento</th>
                                <th>Raz√£o Social</th>
                                <th>N¬∫ Documento</th>
                                <th>Descri√ß√£o</th>
                                <th>Categoria</th>
                                <th>Subcategoria</th>
                                <th>Valor</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-pagar">
                            <tr><td colspan="10" class="loading">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Remessa de Pagamentos -->
            {% include 'remessa_pagamento.html' %}
            
            <!-- ============================================
                 REGRAS DE AUTO-CONCILIA√á√ÉO
                 ============================================ -->
            {% include 'template_regras_conciliacao.html' %}

            <!-- Extrato Banc√°rio -->
            <div id="extrato-bancario-section" class="content-card hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px;">
                    <h2 style="margin: 0; color: #2c3e50;">üè¶ Extrato Banc√°rio - Importa√ß√£o OFX</h2>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="abrirConfiguracaoRegras()" class="btn btn-secondary" style="padding: 10px 20px; background: #9b59b6; color: white; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s;"
                                onmouseover="this.style.background='#8e44ad'"
                                onmouseout="this.style.background='#9b59b6'">
                            ‚öôÔ∏è Configura√ß√£o de Extrato
                        </button>
                        <button onclick="abrirConciliacaoGeral()" class="btn btn-success" style="padding: 10px 20px; background: #27ae60; font-weight: bold;">
                            üîÑ Concilia√ß√£o Geral
                        </button>
                    </div>
                </div>

                <!-- Upload de Arquivo OFX -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px dashed #3498db;">
                    <h3 style="margin-top: 0; color: #2c3e50;">üì§ Importar Arquivo OFX</h3>
                    <div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 250px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Conta Banc√°ria:</label>
                            <select id="conta-bancaria-extrato" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" required>
                                <option value="">Selecione a conta...</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 250px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Arquivo OFX:</label>
                            <input type="file" id="arquivo-ofx" accept=".ofx" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" required>
                        </div>
                        <button onclick="uploadExtratoOFX(event)" class="btn btn-primary" style="padding: 10px 30px; background: #3498db; border: none; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; font-size: 14px;">
                            ‚¨ÜÔ∏è Enviar Arquivo
                        </button>
                    </div>
                    <p style="margin-top: 15px; margin-bottom: 0; color: #666; font-size: 13px;">
                        üí° <strong>Dica:</strong> Baixe o arquivo OFX do seu internet banking e importe aqui para visualizar suas transa√ß√µes banc√°rias.
                    </p>
                </div>

                <!-- Filtros -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin-top: 0; color: #2c3e50;">üîç Filtros</h3>
                    <div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Conta:</label>
                            <select id="filtro-conta-extrato" onchange="loadExtratoTransacoes()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">Todas as contas</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Data In√≠cio:</label>
                            <input type="date" id="filtro-data-inicio-extrato" onchange="loadExtratoTransacoes()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Data Fim:</label>
                            <input type="date" id="filtro-data-fim-extrato" onchange="loadExtratoTransacoes()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Status:</label>
                            <select id="filtro-conciliado-extrato" onchange="loadExtratoTransacoes()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">Todos</option>
                                <option value="true">Conciliados</option>
                                <option value="false">N√£o conciliados</option>
                            </select>
                        </div>
                        <button onclick="limparFiltrosExtratoOFX()" class="btn btn-secondary" style="padding: 8px 20px; background: #95a5a6; border: none; border-radius: 4px; color: white; cursor: pointer;">
                            üîÑ Limpar
                        </button>
                        <button onclick="deletarExtratoFiltradoOFX()" class="btn btn-danger" style="padding: 8px 20px; background: #e74c3c; border: none; border-radius: 4px; color: white; cursor: pointer; font-weight: bold;">
                            üóëÔ∏è Deletar Extrato
                        </button>
                    </div>
                </div>

                <!-- Tabela de Transa√ß√µes -->
                <div class="table-container" style="background: white; overflow-x: auto; -webkit-overflow-scrolling: touch;">
                    <table class="table resizable-table" id="table-extrato" style="background: white; min-width: 1000px;">
                        <colgroup id="colgroup-extrato">
                            <col data-column="data" style="width: 100px; min-width: 70px;">
                            <col data-column="descricao" style="width: 350px; min-width: 150px;">
                            <col data-column="valor" style="width: 130px; min-width: 90px;">
                            <col data-column="tipo" style="width: 100px; min-width: 80px;">
                            <col data-column="saldo" style="width: 130px; min-width: 90px;">
                            <col data-column="conta" style="width: 180px; min-width: 120px;">
                            <col data-column="status" style="width: 120px; min-width: 90px;">
                            <col data-column="acoes" style="width: auto; min-width: 140px;">
                        </colgroup>
                        <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <tr>
                                <th data-column="data" style="position: relative; user-select: none;">
                                    <div class="th-content">
                                        üìÖ Data
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th data-column="descricao" style="position: relative; user-select: none;">
                                    <div class="th-content">
                                        üìù Descri√ß√£o
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th data-column="valor" style="position: relative; user-select: none; text-align: right;">
                                    <div class="th-content">
                                        üí∞ Valor
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th data-column="tipo" style="position: relative; user-select: none; text-align: center;">
                                    <div class="th-content">
                                        üìä Tipo
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th data-column="saldo" style="position: relative; user-select: none; text-align: right;">
                                    <div class="th-content">
                                        üíµ Saldo
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th data-column="conta" style="position: relative; user-select: none;">
                                    <div class="th-content">
                                        üè¶ Conta
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th data-column="status" style="position: relative; user-select: none; text-align: center;">
                                    <div class="th-content">
                                        ‚ö° Status
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th data-column="acoes" style="position: relative; user-select: none; text-align: center;">
                                    <div class="th-content">
                                        ‚öôÔ∏è A√ß√µes
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tbody-extrato" style="background: white;">
                            <tr style="background: white;"><td colspan="8" class="loading" style="background: white; color: #2c3e50;">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <style>
                    /* Estilos para melhorar a responsividade da tabela de extrato */
                    #extrato-bancario-section .table-container {
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                        border-radius: 8px;
                        margin-bottom: 20px;
                    }
                    
                    /* Tabela com colunas redimension√°veis */
                    .resizable-table {
                        border-collapse: collapse;
                        width: 100%;
                    }
                    
                    .resizable-table th {
                        position: relative;
                        padding: 14px 12px;
                        font-weight: 600;
                        font-size: 13px;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        border-right: 2px solid rgba(255, 255, 255, 0.2);
                    }
                    
                    .resizable-table th:last-child {
                        border-right: none;
                    }
                    
                    .resizable-table .th-content {
                        position: relative;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                    }
                    
                    /* Resizer - barra de redimensionamento */
                    .resizable-table .resizer {
                        position: absolute;
                        top: 0;
                        right: -10px;
                        width: 20px;
                        height: 100%;
                        cursor: col-resize;
                        z-index: 100;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                    
                    .resizable-table .resizer::before {
                        content: '';
                        width: 4px;
                        height: 70%;
                        background: rgba(255, 255, 255, 0.4);
                        border-radius: 2px;
                        transition: all 0.2s ease;
                    }
                    
                    .resizable-table .resizer:hover::before {
                        background: rgba(255, 255, 255, 0.9);
                        width: 5px;
                        height: 85%;
                        box-shadow: 0 0 8px rgba(255, 255, 255, 0.6);
                    }
                    
                    .resizable-table .resizer.resizing::before {
                        background: #fff;
                        width: 6px;
                        height: 100%;
                        box-shadow: 0 0 12px rgba(255, 255, 255, 0.9);
                    }
                    
                    .resizable-table th.resizing {
                        background: rgba(255, 255, 255, 0.15);
                    }
                    
                    #tbody-extrato td {
                        padding: 12px 12px;
                        border-bottom: 1px solid #f0f0f0;
                        vertical-align: middle;
                    }
                    
                    #tbody-extrato tr:hover {
                        background: #f8f9fa;
                    }
                    
                    /* Coluna de descri√ß√£o com quebra de texto */
                    #tbody-extrato td:nth-child(2) {
                        white-space: normal;
                        word-wrap: break-word;
                        word-break: break-word;
                        line-height: 1.5;
                        max-width: 400px;
                    }
                    
                    /* Outras colunas sem quebra */
                    #tbody-extrato td:not(:nth-child(2)) {
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                    }
                    
                    /* Alinhamento de valores */
                    #tbody-extrato td:nth-child(3),
                    #tbody-extrato td:nth-child(5) {
                        text-align: right;
                        font-weight: 600;
                        font-family: 'Courier New', monospace;
                    }
                    
                    /* Centralizar tipo e status */
                    #tbody-extrato td:nth-child(4),
                    #tbody-extrato td:nth-child(7) {
                        text-align: center;
                    }
                    
                    /* A√ß√µes centralizadas */
                    #tbody-extrato td:nth-child(8) {
                        text-align: center;
                    }
                    
                    /* Scroll suave */
                    #extrato-bancario-section .table-container::-webkit-scrollbar {
                        height: 8px;
                    }
                    
                    #extrato-bancario-section .table-container::-webkit-scrollbar-track {
                        background: #f1f1f1;
                        border-radius: 4px;
                    }
                    
                    #extrato-bancario-section .table-container::-webkit-scrollbar-thumb {
                        background: #667eea;
                        border-radius: 4px;
                    }
                    
                    #extrato-bancario-section .table-container::-webkit-scrollbar-thumb:hover {
                        background: #764ba2;
                    }
                    
                    /* Responsividade para telas pequenas */
                    @media (max-width: 768px) {
                        #extrato-bancario-section .table-container table {
                            min-width: 900px;
                            font-size: 13px;
                        }
                        
                        #tbody-extrato td {
                            padding: 8px 6px;
                        }
                    }
                </style>
                
                <script>
                    // Sistema de redimensionamento de colunas OTIMIZADO
                    function initializeColumnResizer() {
                        const table = document.getElementById('table-extrato');
                        if (!table) {
                            setTimeout(initializeColumnResizer, 500);
                            return;
                        }
                        
                        const colgroup = document.getElementById('colgroup-extrato');
                        const resizers = table.querySelectorAll('.resizer');
                        if (!colgroup || resizers.length === 0) {
                            setTimeout(initializeColumnResizer, 500);
                            return;
                        }
                        
                        console.log('‚úÖ Sistema de redimensionamento iniciado - ' + resizers.length + ' colunas');
                        
                        // Guardar minWidths originais de cada coluna
                        const originalMinWidths = {};
                        colgroup.querySelectorAll('col[data-column]').forEach(col => {
                            const column = col.getAttribute('data-column');
                            const minWidth = parseInt(col.style.minWidth) || 70;
                            originalMinWidths[column] = minWidth;
                        });
                        
                        // Restaurar larguras salvas
                        const savedWidths = localStorage.getItem('extrato-column-widths');
                        if (savedWidths) {
                            try {
                                const widths = JSON.parse(savedWidths);
                                colgroup.querySelectorAll('col[data-column]').forEach(col => {
                                    const column = col.getAttribute('data-column');
                                    if (widths[column] && widths[column] >= originalMinWidths[column]) {
                                        col.style.width = widths[column] + 'px';
                                        console.log('üìè Restaurada: ' + column + ' = ' + widths[column] + 'px');
                                    }
                                });
                            } catch (e) {
                                console.error('Erro ao restaurar larguras:', e);
                            }
                        }
                        
                        // Vari√°veis de controle do drag
                        let currentResizer = null;
                        let currentCol = null;
                        let currentTh = null;
                        let startX = 0;
                        let startWidth = 0;
                        let minWidth = 70;
                        
                        // Adicionar event listeners em cada resizer
                        resizers.forEach((resizer) => {
                            resizer.addEventListener('mousedown', function(e) {
                                // Encontrar o TH pai e o COL correspondente
                                currentTh = resizer.closest('th');
                                if (!currentTh) return;
                                
                                const column = currentTh.getAttribute('data-column');
                                if (!column) return;
                                
                                currentCol = colgroup.querySelector('col[data-column="' + column + '"]');
                                if (!currentCol) return;
                                
                                currentResizer = resizer;
                                startX = e.pageX;
                                startWidth = currentCol.offsetWidth || parseInt(currentCol.style.width) || 100;
                                minWidth = originalMinWidths[column] || 70;
                                
                                console.log('üñ±Ô∏è Redimensionando: ' + column + ' (largura atual: ' + startWidth + 'px, min: ' + minWidth + 'px)');
                                
                                // Visual feedback
                                currentTh.classList.add('resizing');
                                currentResizer.classList.add('resizing');
                                document.body.style.cursor = 'col-resize';
                                document.body.style.userSelect = 'none';
                                
                                // Attach event listeners
                                document.addEventListener('mousemove', onMouseMove);
                                document.addEventListener('mouseup', onMouseUp);
                                
                                e.preventDefault();
                                e.stopPropagation();
                            });
                        });
                        
                        function onMouseMove(e) {
                            if (!currentCol || !currentResizer) return;
                            
                            const diff = e.pageX - startX;
                            const newWidth = Math.max(minWidth, startWidth + diff);
                            
                            // Aplicar nova largura no COL (afeta TH e todos os TDs automaticamente)
                            currentCol.style.width = newWidth + 'px';
                            
                            e.preventDefault();
                        }
                        
                        function onMouseUp(e) {
                            if (currentTh && currentCol) {
                                currentTh.classList.remove('resizing');
                                currentResizer.classList.remove('resizing');
                                
                                const finalWidth = parseInt(currentCol.style.width) || startWidth;
                                const column = currentCol.getAttribute('data-column');
                                
                                console.log('‚úÖ Coluna ' + column + ' redimensionada para: ' + finalWidth + 'px');
                                
                                // Salvar todas as larguras
                                const widths = {};
                                colgroup.querySelectorAll('col[data-column]').forEach(col => {
                                    const colName = col.getAttribute('data-column');
                                    const width = parseInt(col.style.width) || 100;
                                    widths[colName] = width;
                                });
                                localStorage.setItem('extrato-column-widths', JSON.stringify(widths));
                                console.log('üíæ Larguras salvas');
                            }
                            
                            // Cleanup
                            document.body.style.cursor = '';
                            document.body.style.userSelect = '';
                            document.removeEventListener('mousemove', onMouseMove);
                            document.removeEventListener('mouseup', onMouseUp);
                            
                            currentResizer = null;
                            currentCol = null;
                            currentTh = null;
                            
                            if (e) e.preventDefault();
                        }
                    }
                    
                    // Inicializar quando o DOM estiver pronto
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', initializeColumnResizer);
                    } else {
                        initializeColumnResizer();
                    }
                    
                    // Tamb√©m reinicializar quando mudar de aba
                    window.addEventListener('hashchange', function() {
                        if (window.location.hash === '#extrato-bancario') {
                            setTimeout(initializeColumnResizer, 300);
                        }
                    });
                </script>
            </div>

            <!-- Folha de Pagamento -->
            <div id="folha-pagamento-section" class="content-card hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #000000 !important; font-weight: 700;">üë• Folha de Pagamento - Funcion√°rios</h2>
                    <button onclick="abrirModalFuncionario()" class="btn btn-primary" style="padding: 10px 20px; background: #3498db;">
                        ‚ûï Novo Funcion√°rio
                    </button>
                </div>

                <!-- Filtros e Busca -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <input type="text" id="busca-funcionario" placeholder="üîç Buscar por nome, CPF ou email..." 
                           style="flex: 1; min-width: 300px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"
                           onkeyup="filtrarFuncionariosRH()">
                    
                    <select id="filtro-status-funcionario" onchange="filtrarFuncionariosRH()" 
                            style="padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">üìä Todos</option>
                        <option value="true">‚úÖ Ativos</option>
                        <option value="false">‚ùå Inativos</option>
                    </select>

                    <button onclick="abrirRelatorioCPFs()" class="btn" 
                            style="padding: 10px 20px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                        üîê Validar CPFs
                    </button>

                    <button onclick="exportarFuncionariosExcel()" class="btn btn-success" 
                            style="padding: 10px 20px; background: #27ae60;">
                        üì• Exportar Excel
                    </button>
                    
                    <span style="margin-left: 15px; font-size: 14px; color: #666;">
                        üìä Total: <strong id="total-funcionarios">0</strong> | 
                        ‚úÖ Ativos: <strong id="total-ativos" style="color: #27ae60;">0</strong> | 
                        ‚ùå Inativos: <strong id="total-inativos" style="color: #e74c3c;">0</strong>
                    </span>
                </div>

                <!-- Tabela de Funcion√°rios -->
                <div class="table-container" style="overflow-x: auto; width: 100%; border: 1px solid #ddd; border-radius: 4px;">
                    <table style="width: 100%; border-collapse: collapse; min-width: 2000px; table-layout: fixed;">
                        <thead>
                            <tr style="background-color: #f5f5f5 !important;">
                                <th style="color: #000000 !important; font-weight: 700; padding: 12px 8px; text-align: left; width: 200px; position: sticky; left: 0; background: #f5f5f5; z-index: 10;">Nome</th>
                                <th style="color: #000000 !important; font-weight: 700; padding: 12px 8px; text-align: left; width: 120px;">CPF</th>
                                <th style="color: #000000 !important; font-weight: 700; padding: 12px 8px; text-align: left; width: 100px;">Nacionalidade</th>
                                <th style="color: #000000 !important; font-weight: 700; padding: 12px 8px; text-align: left; width: 100px;">Estado Civil</th>
                                <th style="color: #000000 !important; font-weight: 700; padding: 12px 8px; text-align: left; width: 100px;">Data Nasc.</th>
                                <th style="color: #000000 !important; font-weight: 700; padding: 12px 8px; text-align: center; width: 60px;">Idade</th>
                                <th style="color: #000000 !important; font-weight: 700; padding: 12px 8px; text-align: left; width: 150px;">Profiss√£o</th>
                                <th style="color: #000000 !important; font-weight: 700; padding: 12px 8px; text-align: left; width: 250px;">Endere√ßo</th>
                                <th style="color: #000000 !important; font-weight: 700; padding: 12px 8px; text-align: left; width: 100px;">CEP</th>
                                <th style="color: #000000 !important; font-weight: 700; padding: 12px 8px; text-align: left; width: 200px;">E-mail</th>
                                <th style="color: #000000 !important; font-weight: 700; padding: 12px 8px; text-align: left; width: 120px;">Celular</th>
                                <th style="color: #000000 !important; font-weight: 700; padding: 12px 8px; text-align: left; width: 150px;">Chave PIX</th>
                                <th style="color: #000000 !important; font-weight: 700; padding: 12px 8px; text-align: left; width: 120px;">PIS/PASEP</th>
                                <th style="color: #000000 !important; font-weight: 700; padding: 12px 8px; text-align: center; width: 80px;">Status</th>
                                <th style="color: #000000 !important; font-weight: 700; padding: 12px 8px; text-align: center; width: 120px;">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-funcionarios">
                            <tr><td colspan="15" class="loading" style="text-align: center; padding: 20px;">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Modal Funcion√°rio -->
            <div id="modal-funcionario" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3 id="modal-funcionario-title">Novo Funcion√°rio</h3>
                        <span class="close" onclick="fecharModalFuncionario()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <!-- Abas -->
                        <div style="display: flex; gap: 5px; border-bottom: 2px solid #ddd; margin-bottom: 20px;">
                            <button type="button" class="tab-btn active" data-aba="dados-pessoais" onclick="mudarAbaFuncionario('dados-pessoais')" 
                                    style="padding: 10px 20px; border: none; background: rgba(52, 152, 219, 0.1); cursor: pointer; border-bottom: 3px solid #3498db;">
                                üë§ Dados Pessoais
                            </button>
                            <button type="button" class="tab-btn" data-aba="endereco" onclick="mudarAbaFuncionario('endereco')" 
                                    style="padding: 10px 20px; border: none; background: none; cursor: pointer; border-bottom: 3px solid transparent;">
                                üìç Endere√ßo
                            </button>
                            <button type="button" class="tab-btn" data-aba="profissional" onclick="mudarAbaFuncionario('profissional')" 
                                    style="padding: 10px 20px; border: none; background: none; cursor: pointer; border-bottom: 3px solid transparent;">
                                üíº Profissional
                            </button>
                            <button type="button" class="tab-btn" data-aba="pagamento" onclick="mudarAbaFuncionario('pagamento')" 
                                    style="padding: 10px 20px; border: none; background: none; cursor: pointer; border-bottom: 3px solid transparent;">
                                üí∞ Pagamento
                            </button>
                        </div>

                        <form id="form-funcionario" onsubmit="salvarFuncionario(event); return false;">
                            <input type="hidden" id="funcionario-id">
                            
                            <!-- Aba: Dados Pessoais -->
                            <div id="aba-dados-pessoais" class="tab-content">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group" style="grid-column: 1 / -1;">
                                        <label for="funcionario-nome">Nome Completo: <span style="color: red;">*</span></label>
                                        <input type="text" id="funcionario-nome" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>

                                    <div class="form-group">
                                        <label for="funcionario-cpf">CPF: <span style="color: red;">*</span></label>
                                        <input type="text" id="funcionario-cpf" required maxlength="14" placeholder="000.000.000-00" 
                                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>

                                    <div class="form-group">
                                        <label for="funcionario-email">E-mail:</label>
                                        <input type="email" id="funcionario-email" placeholder="exemplo@email.com" 
                                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>

                                    <div class="form-group">
                                        <label for="funcionario-celular">Celular:</label>
                                        <input type="text" id="funcionario-celular" placeholder="(00) 00000-0000" maxlength="15"
                                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>

                                    <div class="form-group">
                                        <label for="funcionario-data-nascimento">Data de Nascimento:</label>
                                        <input type="date" id="funcionario-data-nascimento" 
                                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>

                                    <div class="form-group">
                                        <label for="funcionario-nacionalidade">Nacionalidade:</label>
                                        <input type="text" id="funcionario-nacionalidade" placeholder="Ex: Brasileira" 
                                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>

                                    <div class="form-group">
                                        <label for="funcionario-estado-civil">Estado Civil:</label>
                                        <select id="funcionario-estado-civil" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                            <option value="">Selecione...</option>
                                            <option value="Solteiro(a)">Solteiro(a)</option>
                                            <option value="Casado(a)">Casado(a)</option>
                                            <option value="Divorciado(a)">Divorciado(a)</option>
                                            <option value="Vi√∫vo(a)">Vi√∫vo(a)</option>
                                            <option value="Uni√£o Est√°vel">Uni√£o Est√°vel</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Aba: Endere√ßo -->
                            <div id="aba-endereco" class="tab-content" style="display: none;">
                                <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label for="funcionario-rua">Rua/Avenida:</label>
                                        <input type="text" id="funcionario-rua" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>

                                    <div class="form-group">
                                        <label for="funcionario-numero">N√∫mero:</label>
                                        <input type="text" id="funcionario-numero" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label for="funcionario-complemento">Complemento:</label>
                                        <input type="text" id="funcionario-complemento" placeholder="Apto, Bloco, etc." 
                                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>

                                    <div class="form-group">
                                        <label for="funcionario-bairro">Bairro:</label>
                                        <input type="text" id="funcionario-bairro" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>

                                    <div class="form-group">
                                        <label for="funcionario-cidade">Cidade:</label>
                                        <input type="text" id="funcionario-cidade" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>

                                    <div class="form-group">
                                        <label for="funcionario-estado">Estado:</label>
                                        <select id="funcionario-estado" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                            <option value="">Selecione...</option>
                                            <option value="AC">Acre</option>
                                            <option value="AL">Alagoas</option>
                                            <option value="AP">Amap√°</option>
                                            <option value="AM">Amazonas</option>
                                            <option value="BA">Bahia</option>
                                            <option value="CE">Cear√°</option>
                                            <option value="DF">Distrito Federal</option>
                                            <option value="ES">Esp√≠rito Santo</option>
                                            <option value="GO">Goi√°s</option>
                                            <option value="MA">Maranh√£o</option>
                                            <option value="MT">Mato Grosso</option>
                                            <option value="MS">Mato Grosso do Sul</option>
                                            <option value="MG">Minas Gerais</option>
                                            <option value="PA">Par√°</option>
                                            <option value="PB">Para√≠ba</option>
                                            <option value="PR">Paran√°</option>
                                            <option value="PE">Pernambuco</option>
                                            <option value="PI">Piau√≠</option>
                                            <option value="RJ">Rio de Janeiro</option>
                                            <option value="RN">Rio Grande do Norte</option>
                                            <option value="RS">Rio Grande do Sul</option>
                                            <option value="RO">Rond√¥nia</option>
                                            <option value="RR">Roraima</option>
                                            <option value="SC">Santa Catarina</option>
                                            <option value="SP">S√£o Paulo</option>
                                            <option value="SE">Sergipe</option>
                                            <option value="TO">Tocantins</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label for="funcionario-cep">CEP:</label>
                                        <input type="text" id="funcionario-cep" placeholder="00000-000" maxlength="9"
                                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                </div>
                            </div>

                            <!-- Aba: Profissional -->
                            <div id="aba-profissional" class="tab-content" style="display: none;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label for="funcionario-profissao">Profiss√£o/Cargo:</label>
                                        <input type="text" id="funcionario-profissao" placeholder="Ex: Analista, T√©cnico..." 
                                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>

                                    <div class="form-group">
                                        <label for="funcionario-data-admissao">Data de Admiss√£o:</label>
                                        <input type="date" id="funcionario-data-admissao" 
                                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>

                                    <div class="form-group">
                                        <label for="funcionario-data-demissao">Data de Demiss√£o:</label>
                                        <input type="date" id="funcionario-data-demissao" 
                                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>

                                    <div class="form-group">
                                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                            <input type="checkbox" id="funcionario-ativo" checked 
                                                   style="width: 20px; height: 20px; cursor: pointer;">
                                            <span>Funcion√°rio Ativo</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="form-group" style="margin-top: 15px;">
                                    <label for="funcionario-observacoes">Observa√ß√µes:</label>
                                    <textarea id="funcionario-observacoes" rows="4" placeholder="Informa√ß√µes adicionais sobre o funcion√°rio..." 
                                              style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                                </div>
                            </div>

                            <!-- Aba: Pagamento -->
                            <div id="aba-pagamento" class="tab-content" style="display: none;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label for="funcionario-pis">PIS/PASEP:</label>
                                        <input type="text" id="funcionario-pis" placeholder="000.00000.00-0" maxlength="14"
                                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>

                                    <div class="form-group">
                                        <label for="funcionario-chave-pix">Chave PIX:</label>
                                        <input type="text" id="funcionario-chave-pix" placeholder="CPF, email, telefone ou chave aleat√≥ria" 
                                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                </div>
                            </div>

                            <div style="display: flex; gap: 10px; margin-top: 30px; padding-top: 20px; border-top: 2px solid #ddd;">
                                <button type="submit" class="btn btn-primary" style="flex: 1; padding: 12px; background: #27ae60; font-size: 16px;">
                                    üíæ Salvar
                                </button>
                                <button type="button" onclick="fecharModalFuncionario()" class="btn btn-secondary" 
                                        style="flex: 1; padding: 12px; background: #95a5a6; font-size: 16px;">
                                    ‚ùå Cancelar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- üîê Modal Relat√≥rio de CPFs -->
            <div id="modal-relatorio-cpfs" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header" style="background gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 20px; border-radius: 8px 8px 0 0;">
                        <h3 style="margin: 0; font-size: 24px;">üîê Relat√≥rio de Valida√ß√£o de CPFs</h3>
                        <span class="close" onclick="fecharModalRelatorioCPFs()" style="cursor: pointer; font-size: 28px;">&times;</span>
                    </div>
                    <div class="modal-body" style="padding: 20px;">
                        
                        <!-- Loading -->
                        <div id="cpf-relatorio-loading" style="text-align: center; padding: 40px;">
                            <div style="font-size: 48px;">‚è≥</div>
                            <div style="margin-top: 10px; font-size: 16px; color: #666;">Analisando CPFs...</div>
                        </div>

                        <!-- Conte√∫do do Relat√≥rio -->
                        <div id="cpf-relatorio-conteudo" style="display: none;">
                            
                            <!-- Estat√≠sticas -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                                <!-- Total -->
                                <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 32px; font-weight: bold;" id="cpf-total">0</div>
                                    <div style="font-size: 14px; margin-top: 5px;">üìä Total de Funcion√°rios</div>
                                </div>
                                
                                <!-- V√°lidos -->
                                <div style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 32px; font-weight: bold;" id="cpf-validos">0</div>
                                    <div style="font-size: 14px; margin-top: 5px;">‚úÖ CPFs V√°lidos</div>
                                    <div style="font-size: 12px; margin-top: 5px; opacity: 0.9;" id="cpf-taxa-validos">0%</div>
                                </div>
                                
                                <!-- Inv√°lidos -->
                                <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 32px; font-weight: bold;" id="cpf-invalidos">0</div>
                                    <div style="font-size: 14px; margin-top: 5px;">‚ùå CPFs Inv√°lidos</div>
                                    <div style="font-size: 12px; margin-top: 5px; opacity: 0.9;" id="cpf-taxa-invalidos">0%</div>
                                </div>
                                
                                <!-- Ausentes -->
                                <div style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 32px; font-weight: bold;" id="cpf-ausentes">0</div>
                                    <div style="font-size: 14px; margin-top: 5px;">‚ö†Ô∏è CPFs Ausentes</div>
                                </div>
                            </div>

                            <!-- Tabela de Problemas -->
                            <div id="cpf-problemas-container">
                                <h4 style="margin: 20px 0 15px 0; color: #2c3e50;">üîç Funcion√°rios com Problemas no CPF</h4>
                                
                                <div style="overflow-x: auto; border: 1px solid #ddd; border-radius: 8px; background: white;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="background: #f5f5f5;">
                                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Nome</th>
                                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">CPF</th>
                                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Email</th>
                                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Status</th>
                                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Erro</th>
                                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd; width: 100px;">A√ß√£o</th>
                                            </tr>
                                        </thead>
                                        <tbody id="cpf-problemas-lista">
                                            <!-- Preenchido dinamicamente -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Mensagem de Sucesso (todos CPFs v√°lidos) -->
                            <div id="cpf-todos-validos" style="display: none; text-align: center; padding: 40px;">
                                <div style="font-size: 64px;">‚úÖ</div>
                                <div style="font-size: 20px; color: #27ae60; margin-top: 15px; font-weight: bold;">Todos os CPFs est√£o v√°lidos!</div>
                                <div style="font-size: 14px; color: #666; margin-top: 10px;">Parab√©ns! N√£o h√° problemas de valida√ß√£o de CPF.</div>
                            </div>

                        </div>

                    </div>
                    <div class="modal-footer" style="padding: 15px; border-top: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
                        <div style="color: #666; font-size: 12px;" id="cpf-data-analise">An√°lise realizada em: --</div>
                        <div>
                            <button type="button" id="btn-corrigir-cpfs" onclick="abrirCorrecaoAutomatica()" class="btn" 
                                    style="padding: 10px 20px; background: #f39c12; color: white; margin-right: 10px; display: none;">
                                üîß Corrigir Automaticamente
                            </button>
                            <button type="button" onclick="fecharModalRelatorioCPFs()" class="btn btn-secondary" 
                                    style="padding: 10px 30px; background: #95a5a6;">
                                Fechar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- üîß Modal Corre√ß√£o Autom√°tica de CPFs -->
            <div id="modal-correcao-cpfs" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; padding: 20px; border-radius: 8px 8px 0 0;">
                        <h3 style="margin: 0; font-size: 24px;">üîß Corre√ß√£o Autom√°tica de CPFs</h3>
                        <span class="close" onclick="fecharModalCorrecaoCPFs()" style="cursor: pointer; font-size: 28px;">&times;</span>
                    </div>
                    <div class="modal-body" style="padding: 20px;">
                        
                        <!-- Loading -->
                        <div id="correcao-loading" style="text-align: center; padding: 40px;">
                            <div style="font-size: 48px;">üîß</div>
                            <div style="margin-top: 10px; font-size: 16px; color: #666;">Analisando corre√ß√µes poss√≠veis...</div>
                        </div>

                        <!-- Conte√∫do da Corre√ß√£o -->
                        <div id="correcao-conteudo" style="display: none;">
                            
                            <!-- Estat√≠sticas de Corre√ß√£o -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                                <!-- Total Inv√°lidos -->
                                <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 32px; font-weight: bold;" id="correcao-total-invalidos">0</div>
                                    <div style="font-size: 14px; margin-top: 5px;">‚ùå CPFs Inv√°lidos</div>
                                </div>
                                
                                <!-- Pass√≠veis de Corre√ß√£o -->
                                <div style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 32px; font-weight: bold;" id="correcao-corrigidos">0</div>
                                    <div style="font-size: 14px; margin-top: 5px;">üîß Corrig√≠veis</div>
                                    <div style="font-size: 12px; margin-top: 5px; opacity: 0.9;" id="correcao-taxa">0%</div>
                                </div>
                                
                                <!-- N√£o Corrig√≠veis -->
                                <div style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 32px; font-weight: bold;" id="correcao-nao-corrigidos">0</div>
                                    <div style="font-size: 14px; margin-top: 5px;">‚ö†Ô∏è Imposs√≠veis</div>
                                </div>
                            </div>

                            <!-- Tabela de Corre√ß√µes Sugeridas -->
                            <div id="correcoes-container">
                                <h4 style="margin: 20px 0 15px 0; color: #2c3e50;">üîß Corre√ß√µes Sugeridas</h4>
                                
                                <div style="overflow-x: auto; border: 1px solid #ddd; border-radius: 8px; background: white;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="background: #f5f5f5;">
                                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Nome</th>
                                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">CPF Original</th>
                                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">CPF Corrigido</th>
                                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Tipo</th>
                                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Confian√ßa</th>
                                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Recomenda√ß√£o</th>
                                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd; width: 150px;">A√ß√£o</th>
                                            </tr>
                                        </thead>
                                        <tbody id="correcoes-lista">
                                            <!-- Preenchido dinamicamente -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Mensagem quando n√£o h√° corre√ß√µes -->
                            <div id="sem-correcoes" style="display: none; text-align: center; padding: 40px;">
                                <div style="font-size: 64px;">‚ö†Ô∏è</div>
                                <div style="font-size: 20px; color: #f39c12; margin-top: 15px; font-weight: bold;">Nenhuma corre√ß√£o autom√°tica poss√≠vel</div>
                                <div style="font-size: 14px; color: #666; margin-top: 10px;">Os CPFs inv√°lidos precisam ser corrigidos manualmente.</div>
                            </div>

                        </div>

                    </div>
                    <div class="modal-footer" style="padding: 15px; border-top: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
                        <div style="color: #666; font-size: 12px;" id="correcao-data-analise">An√°lise realizada em: --</div>
                        <div>
                            <button type="button" id="btn-aplicar-todas-correcoes" onclick="aplicarTodasCorrecoes()" class="btn" 
                                    style="padding: 10px 20px; background: #27ae60; color: white; margin-right: 10px; display: none;">
                                ‚úÖ Aplicar Corre√ß√µes Seguras
                            </button>
                            <button type="button" onclick="fecharModalCorrecaoCPFs()" class="btn btn-secondary" 
                                    style="padding: 10px 30px; background: #95a5a6;">
                                Fechar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Eventos -->
            <div id="eventos-section" class="content-card hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">üéâ Eventos Operacionais</h2>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="abrirModalFuncoes()" class="btn btn-secondary" style="padding: 10px 20px; background: #9b59b6;">
                            üëî Fun√ß√µes
                        </button>
                        <button onclick="abrirModalSetores()" class="btn btn-secondary" style="padding: 10px 20px; background: #95a5a6;">
                            üè¢ Setores
                        </button>
                        <button onclick="abrirModalEvento()" class="btn btn-primary" style="padding: 10px 20px; background: #3498db;">
                            ‚ûï Novo Evento
                        </button>
                    </div>
                </div>

                <!-- Filtros -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 150px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Data In√≠cio:</label>
                            <input type="date" id="filtro-data-inicio-evento" onchange="loadEventos()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Data Fim:</label>
                            <input type="date" id="filtro-data-fim-evento" onchange="loadEventos()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Status:</label>
                            <select id="filtro-status-evento" onchange="loadEventos()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">Todos</option>
                                <option value="PENDENTE">Pendente</option>
                                <option value="EM_ANDAMENTO">Em Andamento</option>
                                <option value="CONCLUIDO">Conclu√≠do</option>
                                <option value="CANCELADO">Cancelado</option>
                            </select>
                        </div>
                        <button onclick="limparFiltrosEvento()" class="btn btn-secondary" style="padding: 8px 20px; background: #95a5a6;">
                            üîÑ Limpar
                        </button>
                    </div>
                </div>

                <!-- Tabela de Eventos -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 200px;">Nome Evento</th>
                                <th style="width: 100px;">Data</th>
                                <th style="width: 120px;">NF Associada</th>
                                <th style="width: 130px;">Valor L√≠quido NF</th>
                                <th style="width: 130px;">Custo do Evento</th>
                                <th style="width: 120px;">Margem</th>
                                <th style="width: 100px;">Lucro em %</th>
                                <th style="width: 130px;">Tipo de Evento</th>
                                <th style="width: 110px;">Status</th>
                                <th style="width: 150px;">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-eventos">
                            <tr><td colspan="10" class="loading">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Modal Evento -->
            <div id="modal-evento" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h3 id="modal-evento-title">Novo Evento</h3>
                        <span class="close" onclick="fecharModalEvento()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="form-evento" onsubmit="salvarEvento(event); return false;">
                            <input type="hidden" id="evento-id">
                            
                            <div class="form-group">
                                <label for="evento-nome">Nome do Evento: <span style="color: red;">*</span></label>
                                <input type="text" id="evento-nome" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>

                            <div class="form-group">
                                <label for="evento-data">Data do Evento: <span style="color: red;">*</span></label>
                                <input type="date" id="evento-data" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>

                            <div class="form-group">
                                <label for="evento-nf">NF- Associada:</label>
                                <input type="text" id="evento-nf" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>

                            <div class="form-group">
                                <label for="evento-valor-liquido">Valor L√≠quido NF:</label>
                                <input type="number" id="evento-valor-liquido" step="0.01" onchange="calcularMargemEvento()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>

                            <div class="form-group">
                                <label for="evento-custo">Custo do Evento:</label>
                                <input type="number" id="evento-custo" step="0.01" onchange="calcularMargemEvento()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>

                            <div class="form-group">
                                <label for="evento-margem">Margem:</label>
                                <input type="number" id="evento-margem" step="0.01" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5;">
                                <small style="color: #666;">Calculado automaticamente: Valor L√≠quido - Custo</small>
                            </div>

                            <div class="form-group">
                                <label for="evento-tipo">Tipo de Evento:</label>
                                <input type="text" id="evento-tipo" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>

                            <div class="form-group">
                                <label for="evento-status">Status:</label>
                                <select id="evento-status" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="PENDENTE">Pendente</option>
                                    <option value="EM_ANDAMENTO">Em Andamento</option>
                                    <option value="CONCLUIDO">Conclu√≠do</option>
                                    <option value="CANCELADO">Cancelado</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="evento-observacoes">Observa√ß√µes:</label>
                                <textarea id="evento-observacoes" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                            </div>

                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="submit" class="btn btn-primary" style="flex: 1; padding: 10px; background: #27ae60;">üíæ Salvar</button>
                                <button type="button" onclick="fecharModalEvento()" class="btn btn-secondary" style="flex: 1; padding: 10px; background: #95a5a6;">‚ùå Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Modal Aloca√ß√£o de Equipe no Evento -->
            <div id="modal-equipe-evento" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 1200px;">
                    <div class="modal-header">
                        <h3 id="modal-equipe-title">üë• Alocar Equipe no Evento</h3>
                        <span class="close" onclick="fecharModalEquipeEvento()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="equipe-evento-id">
                        
                        <!-- Info do Evento -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #3498db;">
                            <h4 style="margin: 0 0 10px 0; color: #2c3e50;">üìã <span id="equipe-evento-nome">Nome do Evento</span></h4>
                            <div style="display: flex; gap: 20px; flex-wrap: wrap; color: #555;">
                                <span>üìÖ Data: <strong id="equipe-evento-data">-</strong></span>
                                <span>üí∞ Custo Atual: <strong id="equipe-evento-custo-atual">R$ 0,00</strong></span>
                            </div>
                        </div>

                        <!-- Abas: Individual / Em Massa / Fornecedores / Assinatura / Credenciamento -->
                        <div style="margin-bottom: 20px; display: flex; gap: 10px; border-bottom: 2px solid #ddd;">
                            <button id="tab-individual" onclick="trocarAbaEquipe('individual')" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-bottom: 3px solid #3498db; cursor: pointer; font-weight: bold;">üë§ Individual</button>
                            <button id="tab-massa" onclick="trocarAbaEquipe('massa')" style="padding: 10px 20px; background: #ecf0f1; color: #555; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: bold;">üë• Em Massa</button>
                            <button id="tab-fornecedores" onclick="trocarAbaEquipe('fornecedores')" style="padding: 10px 20px; background: #ecf0f1; color: #555; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: bold;">üè¢ Fornecedores</button>
                            <button id="tab-assinatura" onclick="trocarAbaEquipe('assinatura')" style="padding: 10px 20px; background: #ecf0f1; color: #555; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: bold;">‚úçÔ∏è Assinatura</button>
                            <button id="tab-credenciamento" onclick="trocarAbaEquipe('credenciamento')" style="padding: 10px 20px; background: #ecf0f1; color: #555; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: bold;">üé´ Credenciamento</button>
                        </div>

                        <!-- Formul√°rio Individual -->
                        <div id="form-container-individual" style="background: #fff; padding: 20px; border: 2px dashed #ddd; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 15px 0; color: #2c3e50;">‚ûï Adicionar Funcion√°rio √† Equipe</h4>
                            <form id="form-adicionar-funcionario-evento" onsubmit="adicionarFuncionarioEvento(event); return false;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Cooperado: <span style="color: red;">*</span></label>
                                        <input type="text" id="equipe-search-funcionario" placeholder="üîç Pesquisar cooperado..." oninput="filtrarFuncionarios('individual')" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 5px;">
                                        <select id="equipe-select-funcionario" required size="20" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; max-height: 280px;">
                                            <option value="">Selecione...</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Fun√ß√£o: <span style="color: red;">*</span></label>
                                        <div style="display: flex; gap: 5px; margin-bottom: 5px;">
                                            <select id="equipe-select-funcao" required style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                                <option value="">Selecione...</option>
                                            </select>
                                            <button type="button" onclick="abrirModalNovaFuncao()" class="btn btn-sm btn-secondary" title="Cadastrar nova fun√ß√£o" style="padding: 8px 12px; background: #95a5a6;">‚ûï</button>
                                        </div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Setor:</label>
                                        <div style="display: flex; gap: 5px;">
                                            <select id="equipe-select-setor" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                                <option value="">Nenhum</option>
                                            </select>
                                            <button type="button" onclick="abrirModalSetores()" class="btn btn-sm btn-secondary" title="Gerenciar setores" style="padding: 8px 12px; background: #95a5a6;">‚ûï</button>
                                        </div>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Hor√°rios e Valor:</label>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 5px;">
                                            <div>
                                                <label style="display: block; margin-bottom: 3px; font-size: 12px; color: #777;">In√≠cio:</label>
                                                <input type="time" id="equipe-hora-inicio" onchange="calcularSaldoHoras()" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                                            </div>
                                            <div>
                                                <label style="display: block; margin-bottom: 3px; font-size: 12px; color: #777;">Fim:</label>
                                                <input type="time" id="equipe-hora-fim" onchange="calcularSaldoHoras()" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                                            </div>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <label style="display: block; margin-bottom: 3px; font-size: 12px; color: #777;">Saldo Horas:</label>
                                            <input type="text" id="equipe-saldo-horas" readonly style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa; font-weight: bold; text-align: center;" placeholder="--:--">
                                        </div>
                                        <div style="display: flex; gap: 10px; align-items: flex-end;">
                                            <div style="flex: 1;">
                                                <label style="display: block; margin-bottom: 3px; font-size: 12px; color: #777;">Valor (R$): <span style="color: red;">*</span></label>
                                                <input type="number" id="equipe-valor" step="0.01" min="0" required style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                                            </div>
                                            <button type="submit" class="btn btn-primary" style="padding: 9px 30px; background: #27ae60; white-space: nowrap; height: 36px;">‚ûï Adicionar</button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <!-- Formul√°rio Em Massa -->
                        <div id="form-container-massa" style="display: none; background: #fff; padding: 20px; border: 2px dashed #9b59b6; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 15px 0; color: #2c3e50;">üë• Cadastrar M√∫ltiplos Funcion√°rios</h4>
                            <form id="form-adicionar-massa-evento" onsubmit="adicionarFuncionariosMassa(event); return false;">
                                <div style="display: grid; gap: 15px;">
                                    <!-- Selecionar Fun√ß√£o -->
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Fun√ß√£o (aplicada a todos): <span style="color: red;">*</span></label>
                                        <div style="display: flex; gap: 5px;">
                                            <select id="equipe-select-funcao-massa" required style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                                <option value="">Selecione...</option>
                                            </select>
                                            <button type="button" onclick="abrirModalNovaFuncao()" class="btn btn-sm btn-secondary" title="Cadastrar nova fun√ß√£o" style="padding: 8px 12px; background: #95a5a6;">‚ûï</button>
                                        </div>
                                    </div>

                                    <!-- Selecionar Setor -->
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Setor (aplicado a todos):</label>
                                        <div style="display: flex; gap: 5px;">
                                            <select id="equipe-select-setor-massa" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                                <option value="">Nenhum</option>
                                            </select>
                                            <button type="button" onclick="abrirModalSetores()" class="btn btn-sm btn-secondary" title="Gerenciar setores" style="padding: 8px 12px; background: #95a5a6;">‚ûï</button>
                                        </div>
                                    </div>

                                    <!-- Selecionar M√∫ltiplos Funcion√°rios -->
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Cooperados (selecione m√∫ltiplos): <span style="color: red;">*</span></label>
                                        <input type="text" id="equipe-search-funcionarios-massa" placeholder="üîç Pesquisar cooperados..." oninput="filtrarFuncionarios('massa')" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 5px;">
                                        <select id="equipe-select-funcionarios-massa" multiple required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-height: 200px;">
                                            <!-- Preenchido via JS -->
                                        </select>
                                        <small style="color: #777; display: block; margin-top: 5px;">üí° Segure Ctrl (Windows) ou Cmd (Mac) para selecionar m√∫ltiplos</small>
                                    </div>

                                    <!-- Hor√°rios (Aplicados a Todos) -->
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Hor√°rios (aplicados a todos):</label>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                                            <div>
                                                <label style="display: block; margin-bottom: 5px; font-size: 13px; color: #777;">Hora In√≠cio:</label>
                                                <input type="time" id="equipe-hora-inicio-massa" onchange="calcularSaldoHorasMassa()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                            </div>
                                            <div>
                                                <label style="display: block; margin-bottom: 5px; font-size: 13px; color: #777;">Hora Fim:</label>
                                                <input type="time" id="equipe-hora-fim-massa" onchange="calcularSaldoHorasMassa()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                            </div>
                                            <div>
                                                <label style="display: block; margin-bottom: 5px; font-size: 13px; color: #777;">Saldo de Horas:</label>
                                                <input type="text" id="equipe-saldo-horas-massa" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa; font-weight: bold; text-align: center;" placeholder="--:--">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Valor √önico (Opcional) -->
                                    <div>
                                        <label style="display: flex; align-items: center; gap: 10px; font-weight: bold; color: #555; margin-bottom: 5px;">
                                            <input type="checkbox" id="equipe-aplicar-valor-massa" onchange="toggleValorMassa()" style="width: 18px; height: 18px; cursor: pointer;">
                                            <span>Aplicar o mesmo valor para todos</span>
                                        </label>
                                        <input type="number" id="equipe-valor-massa" step="0.01" min="0" disabled style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="R$ 0,00">
                                        <small style="color: #777; display: block; margin-top: 5px;">‚ö†Ô∏è Se desmarcado, o valor ser√° R$ 0,00 para todos (editar depois individualmente)</small>
                                    </div>

                                    <!-- Bot√£o Adicionar -->
                                    <div style="display: flex; gap: 10px;">
                                        <button type="submit" class="btn btn-primary" style="flex: 1; padding: 12px; background: #9b59b6; font-size: 16px; font-weight: bold;">üë• Adicionar Todos</button>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <!-- Formul√°rio Fornecedores -->
                        <div id="form-container-fornecedores" style="display: none; background: #fff; padding: 20px; border: 2px dashed #f39c12; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 15px 0; color: #2c3e50;">üè¢ Adicionar Fornecedor ao Evento</h4>
                            <form id="form-adicionar-fornecedor-evento" onsubmit="adicionarFornecedorEvento(event); return false;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Fornecedor: <span style="color: red;">*</span></label>
                                        <select id="fornecedor-select-fornecedor" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                            <option value="">Selecione...</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Categoria:</label>
                                        <select id="fornecedor-select-categoria" onchange="carregarSubcategoriasFornecedorEvento()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                            <option value="">Selecione...</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Subcategoria:</label>
                                        <select id="fornecedor-select-subcategoria" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                            <option value="">Selecione...</option>
                                        </select>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 15px; margin-bottom: 15px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Valor (R$): <span style="color: red;">*</span></label>
                                        <input type="number" id="fornecedor-valor" step="0.01" min="0" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Observa√ß√£o:</label>
                                        <input type="text" id="fornecedor-observacao" placeholder="Descri√ß√£o do servi√ßo..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary" style="padding: 10px 30px; background: #f39c12;">‚ûï Adicionar Fornecedor</button>
                            </form>

                            <!-- Lista de Fornecedores do Evento -->
                            <div style="margin-top: 30px;">
                                <h4 style="margin: 0 0 15px 0; color: #2c3e50;">üè¢ Fornecedores do Evento</h4>
                                <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                                    <table style="width: 100%;">
                                        <thead>
                                            <tr style="background: #f8f9fa;">
                                                <th style="padding: 10px; text-align: left;">Fornecedor</th>
                                                <th style="padding: 10px; text-align: left;">Categoria</th>
                                                <th style="padding: 10px; text-align: left;">Subcategoria</th>
                                                <th style="padding: 10px; text-align: right;">Valor</th>
                                                <th style="padding: 10px; text-align: left;">Observa√ß√£o</th>
                                                <th style="padding: 10px; text-align: center; width: 80px;">A√ß√µes</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tbody-fornecedores-evento">
                                            <tr><td colspan="6" style="text-align: center; padding: 30px; color: #999;">Nenhum fornecedor adicionado</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Total de Fornecedores -->
                            <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #f39c12;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <strong style="font-size: 16px; color: #2c3e50;">üí∞ Custo Total com Fornecedores:</strong>
                                    <strong style="font-size: 20px; color: #f39c12;" id="fornecedores-custo-total">R$ 0,00</strong>
                                </div>
                            </div>
                        </div>

                        <!-- Aba Assinatura -->
                        <div id="form-container-assinatura" style="display: none; background: #fff; padding: 20px; border: 2px dashed #e67e22; border-radius: 8px; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h4 style="margin: 0; color: #2c3e50;">‚úçÔ∏è Lista de Assinaturas</h4>
                                <div style="display: flex; gap: 10px;">
                                    <button onclick="exportarAssinaturaPDF()" class="btn btn-danger" style="padding: 8px 16px; background: #e74c3c;">üìÑ Exportar PDF</button>
                                    <button onclick="exportarAssinaturaExcel()" class="btn btn-success" style="padding: 8px 16px; background: #27ae60;">üìä Exportar Excel</button>
                                </div>
                            </div>

                            <!-- Preview da Lista -->
                            <div id="assinatura-preview" style="background: white; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
                                <!-- Cabe√ßalho -->
                                <div style="text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #333;">
                                    <h2 style="margin: 0 0 10px 0; color: #2c3e50;">üìã Lista de Presen√ßa - Evento</h2>
                                    <h3 id="assinatura-evento-nome" style="margin: 0 0 5px 0; color: #555;">Nome do Evento</h3>
                                    <p id="assinatura-evento-data" style="margin: 0; color: #777; font-size: 14px;">Data: -</p>
                                </div>

                                <!-- Tabela de Assinaturas -->
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #f8f9fa; border-bottom: 2px solid #333;">
                                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd; width: 5%;">#</th>
                                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd; width: 25%;">Funcion√°rio</th>
                                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd; width: 15%;">Chave PIX</th>
                                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd; width: 15%;">Fun√ß√£o</th>
                                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd; width: 15%;">Setor</th>
                                            <!-- ‚ö†Ô∏è IMPORTANTE: Coluna "Valor (R$)" REMOVIDA do preview de Assinatura! S√≥ no Excel! -->
                                            <th style="padding: 12px; text-align: center; border: 1px solid #ddd; width: 25%;">Assinatura</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody-assinatura-evento">
                                        <tr><td colspan="6" style="text-align: center; padding: 30px; color: #999;">Nenhum funcion√°rio alocado</td></tr>
                                    </tbody>
                                </table>

                                <!-- Rodap√© -->
                                <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; color: #777; font-size: 12px;">
                                    <p style="margin: 0;">Documento gerado em <span id="assinatura-data-geracao"></span></p>
                                </div>
                            </div>
                        </div>

                        <!-- Lista da Equipe Alocada -->
                        <div>
                            <h4 style="margin: 0 0 15px 0; color: #2c3e50;">üë• Equipe Alocada</h4>
                            <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                                <table style="width: 100%;">
                                    <thead>
                                        <tr style="background: #f8f9fa;">
                                            <th style="padding: 10px; text-align: left;">Funcion√°rio</th>
                                            <th style="padding: 10px; text-align: left;">Fun√ß√£o</th>
                                            <th style="padding: 10px; text-align: left;">Setor</th>
                                            <th style="padding: 10px; text-align: center;">Saldo Horas</th>
                                            <th style="padding: 10px; text-align: right;">Valor</th>
                                            <th style="padding: 10px; text-align: center; width: 80px;">A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody-equipe-evento">
                                        <tr><td colspan="6" style="text-align: center; padding: 30px; color: #999;">Nenhum funcion√°rio alocado</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Total -->
                        <div style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 8px; border-left: 4px solid #27ae60;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <strong style="font-size: 16px; color: #2c3e50;">üí∞ Custo Total da Equipe:</strong>
                                <strong style="font-size: 20px; color: #27ae60;" id="equipe-custo-total">R$ 0,00</strong>
                            </div>
                        </div>

                        <!-- Aba Credenciamento -->
                        <div id="form-container-credenciamento" style="display: none;">
                            <div class="table-container" style="max-height: 600px; overflow-y: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #f8f9fa; position: sticky; top: 0; z-index: 1;">
                                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Cooperado</th>
                                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">CPF</th>
                                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Chave PIX</th>
                                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">E-mail</th>
                                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Fun√ß√£o</th>
                                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Setor</th>
                                            <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Hora In√≠cio</th>
                                            <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Hora Fim</th>
                                            <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Total Trabalhado</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody-credenciamento-evento">
                                        <tr><td colspan="9" style="text-align: center; padding: 30px; color: #999;">Carregando credenciamentos...</td></tr>
                                    </tbody>
                                </table>
                            </div>

                            <div style="margin-top: 20px; padding: 15px; background: #e8f4fd; border-radius: 8px; border-left: 4px solid #3498db;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <strong style="font-size: 16px; color: #2c3e50;">üë• Total de Cooperados:</strong>
                                    <strong style="font-size: 18px; color: #3498db;" id="credenciamento-total-cooperados">0</strong>
                                </div>
                            </div>

                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="button" onclick="exportarCredenciamento()" class="btn btn-success" style="flex: 1; padding: 10px; background: #27ae60;">üì• Exportar Excel</button>
                                <button type="button" onclick="imprimirCredenciamento()" class="btn btn-primary" style="flex: 1; padding: 10px; background: #3498db;">üñ®Ô∏è Imprimir</button>
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="button" onclick="fecharModalEquipeEvento()" class="btn btn-secondary" style="flex: 1; padding: 10px; background: #95a5a6;">‚ùå Fechar</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Nova Fun√ß√£o -->
            <div id="modal-nova-funcao" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>‚ûï Cadastrar Nova Fun√ß√£o</h3>
                        <span class="close" onclick="fecharModalNovaFuncao()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="form-nova-funcao-modal-antigo" onsubmit="salvarNovaFuncao(event); return false;">
                            <div class="form-group">
                                <label for="nova-funcao-nome-modal-antigo">Nome da Fun√ß√£o: <span style="color: red;">*</span></label>
                                <input type="text" id="nova-funcao-nome-modal-antigo" required placeholder="Ex: Motorista, Fot√≥grafo, etc." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>

                            <div class="form-group">
                                <label for="nova-funcao-descricao-modal-antigo">Descri√ß√£o:</label>
                                <textarea id="nova-funcao-descricao-modal-antigo" rows="3" placeholder="Descreva as responsabilidades desta fun√ß√£o..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                            </div>

                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="submit" class="btn btn-primary" style="flex: 1; padding: 10px; background: #27ae60;">üíæ Salvar</button>
                                <button type="button" onclick="fecharModalNovaFuncao()" class="btn btn-secondary" style="flex: 1; padding: 10px; background: #95a5a6;">‚ùå Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Modal Setores -->
            <!-- Modal de Fun√ß√µes -->
            <div id="modal-funcoes" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3>üëî Gerenciar Fun√ß√µes</h3>
                        <span class="close" onclick="fecharModalFuncoes()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <!-- Formul√°rio de Nova Fun√ß√£o -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 15px 0;">‚ûï Cadastrar Nova Fun√ß√£o</h4>
                            <form id="form-nova-funcao" onsubmit="salvarNovaFuncao(event); return false;">
                                <div style="display: grid; gap: 10px; margin-bottom: 10px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Nome da Fun√ß√£o: <span style="color: red;">*</span></label>
                                        <input type="text" id="nova-funcao-nome" required placeholder="Ex: Fot√≥grafo, Cinegrafista, Produtor..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Descri√ß√£o:</label>
                                        <textarea id="nova-funcao-descricao" placeholder="Descri√ß√£o da fun√ß√£o (opcional)" rows="2" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <button type="submit" class="btn btn-primary" style="padding: 9px 20px; background: #27ae60;">üíæ Salvar</button>
                                </div>
                            </form>
                        </div>

                        <!-- Lista de Fun√ß√µes -->
                        <div>
                            <h4 style="margin: 0 0 15px 0;">üìã Fun√ß√µes Cadastradas</h4>
                            <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                                <table style="width: 100%;">
                                    <thead>
                                        <tr style="background: #f8f9fa;">
                                            <th style="padding: 10px; text-align: left;">Fun√ß√£o</th>
                                            <th style="padding: 10px; text-align: left;">Descri√ß√£o</th>
                                            <th style="padding: 10px; text-align: center; width: 100px;">A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody-funcoes">
                                        <tr><td colspan="3" style="text-align: center; padding: 30px; color: #999;">Carregando...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="button" onclick="fecharModalFuncoes()" class="btn btn-secondary" style="flex: 1; padding: 10px; background: #95a5a6;">‚ùå Fechar</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal de Setores -->
            <div id="modal-setores" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h3>üè¢ Gerenciar Setores</h3>
                        <span class="close" onclick="fecharModalSetores()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <!-- Formul√°rio de Novo Setor -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 15px 0;">‚ûï Cadastrar Novo Setor</h4>
                            <form id="form-novo-setor" onsubmit="salvarNovoSetor(event); return false;">
                                <div style="display: flex; gap: 10px; align-items: end;">
                                    <div style="flex: 1;">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Nome do Setor: <span style="color: red;">*</span></label>
                                        <input type="text" id="novo-setor-nome" required placeholder="Ex: Fotografia, Filmagem, Produ√ß√£o..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                    <div>
                                        <button type="submit" class="btn btn-primary" style="padding: 9px 20px; background: #27ae60;">üíæ Salvar</button>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <!-- Lista de Setores -->
                        <div>
                            <h4 style="margin: 0 0 15px 0;">üìã Setores Cadastrados</h4>
                            <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                                <table style="width: 100%;">
                                    <thead>
                                        <tr style="background: #f8f9fa;">
                                            <th style="padding: 10px; text-align: left;">Setor</th>
                                            <th style="padding: 10px; text-align: center; width: 100px;">Status</th>
                                            <th style="padding: 10px; text-align: center; width: 100px;">A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody-setores">
                                        <tr><td colspan="3" style="text-align: center; padding: 30px; color: #999;">Carregando...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="button" onclick="fecharModalSetores()" class="btn btn-secondary" style="flex: 1; padding: 10px; background: #95a5a6;">‚ùå Fechar</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal: Configurar Munic√≠pios NFS-e -->
            <div id="modal-config-municipios" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h3>‚öôÔ∏è Configurar Munic√≠pios NFS-e</h3>
                        <span class="close" onclick="fecharModalConfigMunicipios()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <!-- Certificado Digital A1 -->
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; color: white;">
                            <h4 style="margin: 0 0 15px 0; color: white;">üîê Certificado Digital A1</h4>
                            
                            <!-- Status do Certificado Atual -->
                            <div id="cert-status-container" style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <div id="cert-status" style="text-align: center;">
                                    <span style="font-size: 14px;">‚è≥ Verificando certificado...</span>
                                </div>
                            </div>
                            
                            <!-- Upload de Novo Certificado -->
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                                <h5 style="margin: 0 0 10px 0; color: white; font-size: 13px;">üì§ Carregar Certificado (.pfx / .p12)</h5>
                                <form id="form-upload-certificado" onsubmit="uploadCertificadoNFSe(event); return false;">
                                    <div style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap;">
                                        <div style="flex: 2; min-width: 200px;">
                                            <label style="display: block; margin-bottom: 4px; font-size: 12px; color: rgba(255,255,255,0.8);">Arquivo do Certificado:</label>
                                            <input type="file" id="cert-arquivo" accept=".pfx,.p12" required 
                                                style="width: 100%; padding: 8px; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; background: rgba(255,255,255,0.2); color: white; font-size: 13px;">
                                        </div>
                                        <div style="flex: 1; min-width: 150px;">
                                            <label style="display: block; margin-bottom: 4px; font-size: 12px; color: rgba(255,255,255,0.8);">Senha do Certificado:</label>
                                            <input type="password" id="cert-senha" required placeholder="Digite a senha" 
                                                style="width: 100%; padding: 8px; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; background: rgba(255,255,255,0.2); color: white; font-size: 13px;">
                                        </div>
                                        <div>
                                            <button type="submit" id="btn-upload-cert" class="btn btn-primary" 
                                                style="padding: 8px 20px; background: #27ae60; border: none; color: white; border-radius: 4px; cursor: pointer; font-size: 13px; height: 38px; white-space: nowrap;">
                                                üîë Enviar Certificado
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Formul√°rio de Novo Munic√≠pio -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 15px 0;">‚ûï Adicionar Munic√≠pio</h4>
                            <form id="form-novo-municipio-nfse" onsubmit="salvarMunicipioNFSe(event); return false;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">CNPJ: <span style="color: red;">*</span></label>
                                        <input type="text" id="config-cnpj" required placeholder="00.000.000/0000-00" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">C√≥digo IBGE: <span style="color: red;">*</span></label>
                                        <input type="text" id="config-codigo-municipio" required placeholder="5002704" maxlength="7" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Nome do Munic√≠pio: <span style="color: red;">*</span></label>
                                        <input type="text" id="config-nome-municipio" required placeholder="Campo Grande" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">UF: <span style="color: red;">*</span></label>
                                        <select id="config-uf" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                            <option value="">Selecione...</option>
                                            <option value="AC">AC</option>
                                            <option value="AL">AL</option>
                                            <option value="AP">AP</option>
                                            <option value="AM">AM</option>
                                            <option value="BA">BA</option>
                                            <option value="CE">CE</option>
                                            <option value="DF">DF</option>
                                            <option value="ES">ES</option>
                                            <option value="GO">GO</option>
                                            <option value="MA">MA</option>
                                            <option value="MT">MT</option>
                                            <option value="MS">MS</option>
                                            <option value="MG">MG</option>
                                            <option value="PA">PA</option>
                                            <option value="PB">PB</option>
                                            <option value="PR">PR</option>
                                            <option value="PE">PE</option>
                                            <option value="PI">PI</option>
                                            <option value="RJ">RJ</option>
                                            <option value="RN">RN</option>
                                            <option value="RS">RS</option>
                                            <option value="RO">RO</option>
                                            <option value="RR">RR</option>
                                            <option value="SC">SC</option>
                                            <option value="SP">SP</option>
                                            <option value="SE">SE</option>
                                            <option value="TO">TO</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Inscri√ß√£o Municipal: <span style="color: red;">*</span></label>
                                        <input type="text" id="config-inscricao-municipal" required placeholder="123456" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Provedor:</label>
                                        <select id="config-provedor" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                            <option value="">Auto-detectar</option>
                                            <option value="GINFES">GINFES</option>
                                            <option value="ISSNET">ISS.NET</option>
                                            <option value="BETHA">BETHA</option>
                                            <option value="EISS">eISS</option>
                                            <option value="WEBISS">WEBISS</option>
                                            <option value="SIMPLISS">SIMPLISS</option>
                                        </select>
                                    </div>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">URL Customizada (opcional):</label>
                                    <input type="url" id="config-url-customizada" placeholder="https://nfse.municipio.com.br/ws" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <small style="color: #666;">Deixe em branco para usar a URL padr√£o do provedor.</small>
                                </div>
                                <div style="display: flex; justify-content: flex-end;">
                                    <button type="submit" class="btn btn-primary" style="padding: 10px 30px; background: #27ae60;">üíæ Salvar Configura√ß√£o</button>
                                </div>
                            </form>
                        </div>

                        <!-- Lista de Munic√≠pios Configurados -->
                        <div>
                            <h4 style="margin: 0 0 15px 0;">üìã Munic√≠pios Configurados</h4>
                            <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                                <table style="width: 100%;">
                                    <thead>
                                        <tr style="background: #f8f9fa;">
                                            <th style="padding: 10px; text-align: left;">Munic√≠pio</th>
                                            <th style="padding: 10px; text-align: center;">UF</th>
                                            <th style="padding: 10px; text-align: center;">C√≥d. IBGE</th>
                                            <th style="padding: 10px; text-align: center;">Provedor</th>
                                            <th style="padding: 10px; text-align: center;">Status</th>
                                            <th style="padding: 10px; text-align: center; width: 100px;">A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody-municipios-nfse">
                                        <tr><td colspan="6" style="text-align: center; padding: 30px; color: #999;">Nenhum munic√≠pio configurado.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="button" onclick="fecharModalConfigMunicipios()" class="btn btn-secondary" style="flex: 1; padding: 10px; background: #95a5a6;">‚ùå Fechar</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal: Detalhes NFS-e -->
            <div id="modal-detalhes-nfse" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h3>üìÑ Detalhes da NFS-e</h3>
                        <span class="close" onclick="fecharModalDetalhesNFSe()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div id="detalhes-nfse-content">
                            <p style="text-align: center; color: #999; padding: 30px;">Carregando detalhes...</p>
                        </div>

                        <!-- Abas: Dados / XML -->
                        <div style="margin-top: 20px;">
                            <div style="display: flex; border-bottom: 2px solid #e0e0e0; margin-bottom: 15px;">
                                <button id="tab-dados-nfse" onclick="mostrarAbaDetalhesNFSe('dados')" style="padding: 10px 20px; border: none; background: #3498db; color: white; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 5px;">üìã Dados</button>
                                <button id="tab-xml-nfse" onclick="mostrarAbaDetalhesNFSe('xml')" style="padding: 10px 20px; border: none; background: #95a5a6; color: white; cursor: pointer; border-radius: 5px 5px 0 0;">üìÑ XML</button>
                            </div>

                            <!-- Conte√∫do: Dados -->
                            <div id="conteudo-dados-nfse" style="display: block;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #666;">N√∫mero NFS-e:</label>
                                        <p id="det-numero" style="margin: 0; padding: 8px; background: #f8f9fa; border-radius: 4px;">-</p>
                                    </div>
                                    <div>
                                        <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #666;">C√≥digo de Verifica√ß√£o:</label>
                                        <p id="det-codigo-verificacao" style="margin: 0; padding: 8px; background: #f8f9fa; border-radius: 4px; font-family: monospace; font-size: 12px;">-</p>
                                    </div>
                                    <div>
                                        <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #666;">Data Emiss√£o:</label>
                                        <p id="det-data-emissao" style="margin: 0; padding: 8px; background: #f8f9fa; border-radius: 4px;">-</p>
                                    </div>
                                    <div>
                                        <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #666;">Situa√ß√£o:</label>
                                        <p id="det-situacao" style="margin: 0; padding: 8px; background: #f8f9fa; border-radius: 4px;">-</p>
                                    </div>
                                </div>

                                <hr style="margin: 20px 0; border: none; border-top: 2px solid #e0e0e0;">

                                <h4 style="margin: 0 0 10px 0;">üè¢ Prestador</h4>
                                <div style="display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 20px;">
                                    <div>
                                        <label style="font-weight: bold; color: #666;">CNPJ:</label>
                                        <span id="det-cnpj-prestador">-</span>
                                    </div>
                                </div>

                                <h4 style="margin: 0 0 10px 0;">üë§ Tomador</h4>
                                <div style="display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 20px;">
                                    <div>
                                        <label style="font-weight: bold; color: #666;">CNPJ/CPF:</label>
                                        <span id="det-cnpj-tomador">-</span>
                                    </div>
                                    <div>
                                        <label style="font-weight: bold; color: #666;">Raz√£o Social:</label>
                                        <span id="det-razao-social-tomador">-</span>
                                    </div>
                                </div>

                                <h4 style="margin: 0 0 10px 0;">üí∞ Valores</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Valor Servi√ßo</div>
                                        <div id="det-valor-servico" style="font-size: 20px; font-weight: bold; color: #27ae60;">R$ 0,00</div>
                                    </div>
                                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Dedu√ß√µes</div>
                                        <div id="det-valor-deducoes" style="font-size: 20px; font-weight: bold; color: #f39c12;">R$ 0,00</div>
                                    </div>
                                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ISS</div>
                                        <div id="det-valor-iss" style="font-size: 20px; font-weight: bold; color: #3498db;">R$ 0,00</div>
                                    </div>
                                </div>

                                <h4 style="margin: 0 0 10px 0;">üìù Servi√ßo</h4>
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #666;">Discrimina√ß√£o:</label>
                                    <p id="det-discriminacao" style="margin: 0; padding: 10px; background: #f8f9fa; border-radius: 4px; white-space: pre-wrap;">-</p>
                                </div>
                            </div>

                            <!-- Conte√∫do: XML -->
                            <div id="conteudo-xml-nfse" style="display: none;">
                                <div style="background: #282c34; color: #abb2bf; padding: 15px; border-radius: 8px; max-height: 500px; overflow-y: auto;">
                                    <pre id="det-xml-content" style="margin: 0; font-family: 'Courier New', monospace; font-size: 12px; white-space: pre-wrap; word-wrap: break-word;">-</pre>
                                </div>
                                <div style="margin-top: 10px; text-align: right;">
                                    <button onclick="copiarXMLNFSe()" class="btn btn-secondary" style="padding: 8px 16px; background: #7f8c8d;">üìã Copiar XML</button>
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="button" onclick="fecharModalDetalhesNFSe()" class="btn btn-secondary" style="flex: 1; padding: 10px; background: #95a5a6;">‚ùå Fechar</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Relat√≥rios (mantido para compatibilidade, mas n√£o usado) -->
            <div id="relatorios-section" class="content-card hidden">
                <h2 style="color: #000000 !important; font-weight: 700;">Relat√≥rios</h2>
                <p>Use o menu lateral para acessar os relat√≥rios dispon√≠veis.</p>
            </div>

            <!-- Fluxo de Caixa -->
            <div id="fluxo-caixa-section" class="content-card hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">üìà Fluxo de Caixa</h2>
                    
                    <!-- Bot√µes de Exporta√ß√£o -->
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="exportarFluxoCaixaPDF()" style="padding: 8px 16px; font-size: 13px; background: #e74c3c;">üìù PDF</button>
                        <button class="btn btn-primary" onclick="exportarFluxoCaixaExcel()" style="padding: 8px 16px; font-size: 13px; background: #27ae60;">üìä Excel</button>
                    </div>
                </div>
                
                <!-- Filtros -->
                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <!-- Filtro de Per√≠odo -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <label style="display: block; margin-bottom: 10px; font-weight: bold; color: #2c3e50; font-size: 14px;">Filtrar Per√≠odo:</label>
                        <div style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap;">
                            <div style="display: flex; flex-direction: column;">
                                <label style="font-size: 12px; margin-bottom: 4px; color: #666;">Ano:</label>
                                <input type="number" id="filter-ano-fluxo" value="2026" placeholder="2026" min="2000" max="2100" style="width: 80px; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="display: flex; flex-direction: column;">
                                <label style="font-size: 12px; margin-bottom: 4px; color: #666;">M√™s:</label>
                                <select id="filter-mes-fluxo" style="width: 120px; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">Todos</option>
                                    <option value="01">Janeiro</option>
                                    <option value="02">Fevereiro</option>
                                    <option value="03">Mar√ßo</option>
                                    <option value="04">Abril</option>
                                    <option value="05">Maio</option>
                                    <option value="06">Junho</option>
                                    <option value="07">Julho</option>
                                    <option value="08">Agosto</option>
                                    <option value="09">Setembro</option>
                                    <option value="10">Outubro</option>
                                    <option value="11">Novembro</option>
                                    <option value="12">Dezembro</option>
                                </select>
                            </div>
                            <div style="display: flex; flex-direction: column;">
                                <label style="font-size: 12px; margin-bottom: 4px; color: #666;">Data Inicial:</label>
                                <input type="date" id="filter-data-inicial-fluxo" style="width: 140px; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="display: flex; flex-direction: column;">
                                <label style="font-size: 12px; margin-bottom: 4px; color: #666;">Data Final:</label>
                                <input type="date" id="filter-data-final-fluxo" style="width: 140px; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filtro de Banco -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <label style="display: block; margin-bottom: 10px; font-weight: bold; color: #2c3e50; font-size: 14px;">Filtrar Banco:</label>
                        <div style="display: flex; gap: 10px; align-items: flex-end;">
                            <div style="display: flex; flex-direction: column;">
                                <label style="font-size: 12px; margin-bottom: 4px; color: #666;">Banco:</label>
                                <select id="filter-banco-fluxo" style="width: 180px; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bot√µes -->
                    <div style="display: flex; flex-direction: column; justify-content: flex-end; gap: 8px;">
                        <button class="btn btn-primary" onclick="carregarFluxoCaixa()" style="padding: 6px 12px; font-size: 13px;">üîç Pesquisar</button>
                        <button class="btn btn-primary" onclick="limparFiltrosFluxo()" style="padding: 6px 12px; font-size: 13px;">üîÑ Limpar</button>
                    </div>
                </div>
                
                <div id="fluxo-caixa-content">
                    <!-- Cards de Resumo -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;" id="cards-resumo-fluxo">
                        <div style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(39,174,96,0.3); color: white;">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; font-weight: bold;">üí∞ Total Entradas</div>
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;" id="card-total-entradas">R$ 0,00</div>
                            <div style="font-size: 12px; opacity: 0.8;">Receitas do per√≠odo</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(231,76,60,0.3); color: white;">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; font-weight: bold;">üí∏ Total Sa√≠das</div>
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;" id="card-total-saidas">R$ 0,00</div>
                            <div style="font-size: 12px; opacity: 0.8;">Despesas do per√≠odo</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(52,152,219,0.3); color: white;">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; font-weight: bold;">üìä Saldo do Per√≠odo</div>
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;" id="card-saldo-periodo">R$ 0,00</div>
                            <div style="font-size: 12px; opacity: 0.8;">Entradas - Sa√≠das</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(155,89,182,0.3); color: white;">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; font-weight: bold;">üè¶ Saldo Atual</div>
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;" id="card-saldo-atual">R$ 0,00</div>
                            <div style="font-size: 12px; opacity: 0.8;" id="card-saldo-atual-label">Saldo em conta</div>
                        </div>
                    </div>
                    
                    <!-- Tabela de Transa√ß√µes Detalhadas -->
                    <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="padding: 20px; background: #f8f9fa; border-bottom: 2px solid #e0e0e0;">
                            <h3 style="margin: 0; color: #2c3e50; font-size: 18px;">üìã Transa√ß√µes Detalhadas</h3>
                        </div>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                <thead>
                                    <tr style="background: #34495e; color: white;">
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Data</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Descri√ß√£o</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Categoria</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Subcategoria</th>
                                        <th style="padding: 12px; text-align: right; font-weight: 600;">Entrada</th>
                                        <th style="padding: 12px; text-align: right; font-weight: 600;">Sa√≠da</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Conta</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600; min-width: 200px;">Associa√ß√£o</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-transacoes-fluxo">
                                    <tr>
                                        <td colspan="8" style="text-align: center; padding: 60px 20px; color: #7f8c8d;">
                                            <div style="font-size: 48px; margin-bottom: 20px;">üìä</div>
                                            <h3 style="color: #34495e; margin-bottom: 10px;">Fluxo de Caixa</h3>
                                            <p style="margin: 0; font-size: 14px;">Selecione o per√≠odo acima e clique em <strong>üîç Pesquisar</strong> para visualizar as transa√ß√µes.</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Integra Contador SERPRO -->
            <div id="integra-contador-section" class="content-card hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">üîó Integra Contador - API SERPRO</h2>
                </div>

                <!-- Informa√ß√µes da API -->
                <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="color: #1976d2; margin: 0 0 10px 0; font-size: 16px;">‚ÑπÔ∏è Sobre o Integra Contador</h3>
                    <p style="margin: 5px 0; font-size: 13px; color: #424242;">API do SERPRO para integra√ß√£o com sistemas governamentais de contabilidade e obriga√ß√µes fiscais.</p>
                    <p style="margin: 5px 0; font-size: 12px; color: #666;"><strong>Base URL:</strong> https://gateway.apiserpro.serpro.gov.br/integra-contador/v1/</p>
                </div>

                <!-- Seletor de Tipo de Opera√ß√£o -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0; color: #2c3e50; font-size: 16px;">üìã Selecione o Tipo de Opera√ß√£o</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <button onclick="selecionarTipoOperacao('Apoiar')" class="btn btn-primary" style="padding: 15px; background: #3498db; font-size: 14px; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                            <span style="font-size: 24px;">üõ†Ô∏è</span>
                            <span>Apoiar</span>
                            <span style="font-size: 11px; opacity: 0.9;">Servi√ßos auxiliares</span>
                        </button>
                        <button onclick="selecionarTipoOperacao('Consultar')" class="btn btn-primary" style="padding: 15px; background: #27ae60; font-size: 14px; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                            <span style="font-size: 24px;">üîç</span>
                            <span>Consultar</span>
                            <span style="font-size: 11px; opacity: 0.9;">Consultas</span>
                        </button>
                        <button onclick="selecionarTipoOperacao('Declarar')" class="btn btn-primary" style="padding: 15px; background: #e74c3c; font-size: 14px; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                            <span style="font-size: 24px;">üìÑ</span>
                            <span>Declarar</span>
                            <span style="font-size: 11px; opacity: 0.9;">Transmitir declara√ß√£o</span>
                        </button>
                        <button onclick="selecionarTipoOperacao('Emitir')" class="btn btn-primary" style="padding: 15px; background: #9b59b6; font-size: 14px; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                            <span style="font-size: 24px;">üìÉ</span>
                            <span>Emitir</span>
                            <span style="font-size: 11px; opacity: 0.9;">Emitir documentos</span>
                        </button>
                        <button onclick="selecionarTipoOperacao('Monitorar')" class="btn btn-primary" style="padding: 15px; background: #f39c12; font-size: 14px; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                            <span style="font-size: 24px;">üìä</span>
                            <span>Monitorar</span>
                            <span style="font-size: 11px; opacity: 0.9;">Monitora√ß√£o</span>
                        </button>
                    </div>
                </div>

                <!-- Formul√°rio de Requisi√ß√£o -->
                <div id="form-integra-contador" style="display: none;">
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
                        <h3 style="color: #2c3e50; margin: 0 0 15px 0; font-size: 16px;">üîó Tipo Selecionado: <span id="tipo-operacao-selecionado" style="color: #3498db;"></span></h3>
                        
                        <!-- Dados do Contratante -->
                        <div style="border: 1px solid #e0e0e0; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #555; font-size: 14px;">üë§ Contratante</h4>
                            <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 10px;">
                                <div>
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">CNPJ (14 d√≠gitos):</label>
                                    <input type="text" id="ic-contratante-numero" placeholder="00000000000000" maxlength="14" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">Tipo:</label>
                                    <select id="ic-contratante-tipo" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                                        <option value="2" selected>2 - CNPJ</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Dados do Autor do Pedido -->
                        <div style="border: 1px solid #e0e0e0; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #555; font-size: 14px;">‚úçÔ∏è Autor do Pedido</h4>
                            <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 10px;">
                                <div>
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">CPF/CNPJ:</label>
                                    <input type="text" id="ic-autor-numero" placeholder="CPF (11) ou CNPJ (14)" maxlength="14" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">Tipo:</label>
                                    <select id="ic-autor-tipo" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                                        <option value="1">1 - CPF</option>
                                        <option value="2">2 - CNPJ</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Dados do Contribuinte -->
                        <div style="border: 1px solid #e0e0e0; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #555; font-size: 14px;">üè¢ Contribuinte</h4>
                            <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 10px;">
                                <div>
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">CPF/CNPJ:</label>
                                    <input type="text" id="ic-contribuinte-numero" placeholder="CPF (11) ou CNPJ (14)" maxlength="14" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">Tipo:</label>
                                    <select id="ic-contribuinte-tipo" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                                        <option value="1">1 - CPF</option>
                                        <option value="2">2 - CNPJ</option>
                                        <option value="3">3 - Lista PF</option>
                                        <option value="4">4 - Lista PJ</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Dados da Requisi√ß√£o -->
                        <div style="border: 1px solid #e0e0e0; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #555; font-size: 14px;">üìã Pedido de Dados</h4>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px;">
                                <div>
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">ID Sistema:</label>
                                    <input type="text" id="ic-id-sistema" placeholder="Ex: eSocial" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">ID Servi√ßo:</label>
                                    <input type="text" id="ic-id-servico" placeholder="Ex: consultar-folha" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">Vers√£o:</label>
                                    <input type="text" id="ic-versao-sistema" placeholder="Ex: 1.0" value="1.0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                                </div>
                            </div>
                            <div>
                                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">Dados (JSON):</label>
                                <textarea id="ic-dados-json" placeholder='{"cnpjBasico": "23478643", "pa": "202001"}' rows="4" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; font-family: monospace;"></textarea>
                                <small style="color: #666; font-size: 11px;">‚ö†Ô∏è Ser√° convertido para escaped string automaticamente</small>
                            </div>
                        </div>

                        <!-- Bot√µes de A√ß√£o -->
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="limparFormIntegra()" class="btn btn-secondary" style="padding: 10px 20px; background: #95a5a6;">üîÑ Limpar</button>
                            <button onclick="enviarRequisicaoIntegra()" class="btn btn-primary" style="padding: 10px 20px; background: #27ae60;">üöÄ Enviar Requisi√ß√£o</button>
                        </div>
                    </div>
                </div>

                <!-- Resposta da API -->
                <div id="resposta-integra-contador" style="display: none;">
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #2c3e50; margin: 0 0 15px 0; font-size: 16px;">üì• Resposta da API</h3>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 6px; border: 1px solid #e0e0e0; overflow-x: auto;">
                            <pre id="resposta-integra-json" style="margin: 0; font-family: monospace; font-size: 12px; white-space: pre-wrap; word-wrap: break-word;"></pre>
                        </div>
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button onclick="copiarResposta()" class="btn btn-secondary" style="padding: 8px 16px; background: #3498db;">üìã Copiar</button>
                            <button onclick="downloadResposta()" class="btn btn-secondary" style="padding: 8px 16px; background: #27ae60;">üíæ Download JSON</button>
                        </div>
                    </div>
                </div>

                <!-- Estado Inicial -->
                <div id="integra-empty-state" style="text-align: center; padding: 60px 20px; color: #7f8c8d;">
                    <div style="font-size: 48px; margin-bottom: 20px;">üîó</div>
                    <h3 style="color: #34495e; margin-bottom: 10px;">Integra Contador - API SERPRO</h3>
                    <p style="margin: 0; font-size: 14px;">Selecione um <strong>Tipo de Opera√ß√£o</strong> acima para come√ßar.</p>
                </div>
            </div>

            <!-- An√°lise Detalhada Unificada -->
            <div id="analise-detalhada-section" class="content-card hidden">
                <h2 style="margin: 0 0 20px 0;">üìä An√°lise Detalhada</h2>
                
                <!-- Abas de Navega√ß√£o -->
                <div style="border-bottom: 2px solid #e0e0e0; margin-bottom: 20px;">
                    <button class="tab-button active" onclick="trocarAbaAnalise('parceiros')" id="tab-parceiros" style="padding: 12px 24px; border: none; background: transparent; font-size: 14px; font-weight: 600; color: #666; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s;">
                        üìá Por Cliente/Fornecedor
                    </button>
                    <button class="tab-button" onclick="trocarAbaAnalise('categorias')" id="tab-categorias" style="padding: 12px 24px; border: none; background: transparent; font-size: 14px; font-weight: 600; color: #666; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s;">
                        üìÅ Por Categoria
                    </button>
                </div>
                
                <!-- Conte√∫do Aba Parceiros -->
                <div id="content-parceiros" class="tab-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #555; font-size: 18px;">Resumo por Cliente/Fornecedor</h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="exportarResumoParceirosPDF()" style="padding: 8px 16px; font-size: 13px; background: #e74c3c;">üìù PDF</button>
                            <button class="btn btn-primary" onclick="exportarResumoParceirosExcel()" style="padding: 8px 16px; font-size: 13px; background: #27ae60;">üìä Excel</button>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
                            <div>
                                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">Ano:</label>
                                <input type="number" id="filter-ano-parceiros" placeholder="2025" style="width: 100px; padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; height: 38px;">
                            </div>
                            <div>
                                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">M√™s:</label>
                                <select id="filter-mes-parceiros" style="padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; height: 38px; min-width: 150px;">
                                    <option value="">Ano inteiro</option>
                                    <option value="1">Janeiro</option>
                                    <option value="2">Fevereiro</option>
                                    <option value="3">Mar√ßo</option>
                                    <option value="4">Abril</option>
                                    <option value="5">Maio</option>
                                    <option value="6">Junho</option>
                                    <option value="7">Julho</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Setembro</option>
                                    <option value="10">Outubro</option>
                                    <option value="11">Novembro</option>
                                    <option value="12">Dezembro</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 0;">
                                <label style="font-size: 12px; color: transparent; display: block; margin-bottom: 4px; user-select: none;">&#8203;</label>
                                <button class="btn btn-primary" onclick="carregarResumoParceiros()" style="padding: 8px 16px; height: 38px; font-size: 14px;">üîç Gerar Relat√≥rio</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="resumo-parceiros-content" style="text-align: center; padding: 60px 20px; color: #7f8c8d;">
                        <div style="font-size: 48px; margin-bottom: 20px;">üìá</div>
                        <h3 style="color: #34495e; margin-bottom: 10px;">Resumo por Cliente/Fornecedor</h3>
                        <p style="margin: 0; font-size: 14px;">Configure o per√≠odo acima e clique em <strong>üîç Gerar Relat√≥rio</strong> para ver o resumo detalhado.</p>
                    </div>
                </div>
                
                <!-- Conte√∫do Aba Categorias -->
                <div id="content-categorias" class="tab-content" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #555; font-size: 18px;">An√°lise por Categoria</h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="exportarAnaliseCategoriasPDF()" style="padding: 8px 16px; font-size: 13px; background: #e74c3c;">üìù PDF</button>
                            <button class="btn btn-primary" onclick="exportarAnaliseCategoriasExcel()" style="padding: 8px 16px; font-size: 13px; background: #27ae60;">üìä Excel</button>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
                            <div>
                                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">Ano:</label>
                                <input type="number" id="filter-ano-categorias" value="2026" placeholder="2026" style="width: 100px; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">M√™s:</label>
                                <select id="filter-mes-categorias" style="padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">Ano inteiro</option>
                                    <option value="1">Janeiro</option>
                                    <option value="2">Fevereiro</option>
                                    <option value="3">Mar√ßo</option>
                                    <option value="4">Abril</option>
                                    <option value="5">Maio</option>
                                    <option value="6">Junho</option>
                                    <option value="7">Julho</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Setembro</option>
                                    <option value="10">Outubro</option>
                                    <option value="11">Novembro</option>
                                    <option value="12">Dezembro</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="carregarAnaliseCategorias()" style="padding: 6px 16px;">üîç Gerar An√°lise</button>
                        </div>
                    </div>
                    
                    <div id="analise-categorias-content" style="text-align: center; padding: 60px 20px; color: #7f8c8d;">
                        <div style="font-size: 48px; margin-bottom: 20px;">üìÅ</div>
                        <h3 style="color: #34495e; margin-bottom: 10px;">An√°lise por Categoria</h3>
                        <p style="margin: 0; font-size: 14px;">Selecione o per√≠odo e clique em <strong>üîç Gerar Relat√≥rio</strong> para analisar receitas e despesas por categoria.</p>
                    </div>
                </div>
            </div>

            <!-- Comparativo Per√≠odos -->
            <div id="comparativo-periodos-section" class="content-card hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">üìâ Comparativo de Per√≠odos</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="exportarComparativoPDF()" style="padding: 8px 16px; font-size: 13px; background: #e74c3c;">üìù PDF</button>
                        <button class="btn btn-primary" onclick="exportarComparativoExcel()" style="padding: 8px 16px; font-size: 13px; background: #27ae60;">üìä Excel</button>
                    </div>
                </div>
                
                <!-- Filtros -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h4 style="margin: 0 0 10px 0; color: #3498db;">Per√≠odo 1:</h4>
                            <div style="display: flex; gap: 10px;">
                                <div style="flex: 1;">
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">Ano:</label>
                                    <input type="number" id="filter-ano1" placeholder="2025" min="2000" max="2100" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div style="flex: 1;">
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">M√™s:</label>
                                    <select id="filter-mes1" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">Ano inteiro</option>
                                        <option value="1">Janeiro</option>
                                        <option value="2">Fevereiro</option>
                                        <option value="3">Mar√ßo</option>
                                        <option value="4">Abril</option>
                                        <option value="5">Maio</option>
                                        <option value="6">Junho</option>
                                        <option value="7">Julho</option>
                                        <option value="8">Agosto</option>
                                        <option value="9">Setembro</option>
                                        <option value="10">Outubro</option>
                                        <option value="11">Novembro</option>
                                        <option value="12">Dezembro</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h4 style="margin: 0 0 10px 0; color: #e74c3c;">Per√≠odo 2:</h4>
                            <div style="display: flex; gap: 10px;">
                                <div style="flex: 1;">
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">Ano:</label>
                                    <input type="number" id="filter-ano2" placeholder="2025" min="2000" max="2100" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div style="flex: 1;">
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">M√™s:</label>
                                    <select id="filter-mes2" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">Ano inteiro</option>
                                        <option value="1">Janeiro</option>
                                        <option value="2">Fevereiro</option>
                                        <option value="3">Mar√ßo</option>
                                        <option value="4">Abril</option>
                                        <option value="5">Maio</option>
                                        <option value="6">Junho</option>
                                        <option value="7">Julho</option>
                                        <option value="8">Agosto</option>
                                        <option value="9">Setembro</option>
                                        <option value="10">Outubro</option>
                                        <option value="11">Novembro</option>
                                        <option value="12">Dezembro</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="carregarComparativoPeriodos()" style="padding: 6px 16px; margin-top: 15px;">üîç Comparar Per√≠odos</button>
                </div>
                
                <div id="comparativo-periodos-content" style="text-align: center; padding: 60px 20px; color: #7f8c8d;">
                    <div style="font-size: 48px; margin-bottom: 20px;">üìä</div>
                    <h3 style="color: #34495e; margin-bottom: 10px;">Compare Per√≠odos Financeiros</h3>
                    <p style="margin: 0; font-size: 14px;">Selecione os per√≠odos acima e clique em <strong>üîç Comparar Per√≠odos</strong> para visualizar a an√°lise comparativa.</p>
                </div>
            </div>

            <!-- Empresa - Certificado Digital -->
            <div id="empresa-section" class="content-card hidden">
                <h2 style="margin-bottom: 20px;">üè¢ Dados da Empresa e Certificado Digital</h2>

                <!-- Dados da Empresa -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 10px; color: white; margin-bottom: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h3 style="margin: 0 0 15px 0; font-size: 24px;">üìä <span id="empresa-razao-social">Carregando...</span></h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; font-size: 14px;">
                                <div>
                                    <strong style="opacity: 0.8;">CNPJ:</strong><br>
                                    <span id="empresa-cnpj" style="font-size: 16px;">-</span>
                                </div>
                                <div>
                                    <strong style="opacity: 0.8;">UF/Estado:</strong><br>
                                    <span id="empresa-estado" style="font-size: 16px; text-transform: uppercase;">-</span>
                                    <button onclick="editarEstadoEmpresa()" style="margin-left: 8px; padding: 2px 8px; border: 1px solid rgba(255,255,255,0.5); background: rgba(255,255,255,0.2); color: white; border-radius: 4px; cursor: pointer; font-size: 11px;" title="Editar UF">‚úèÔ∏è Editar</button>
                                </div>
                                <div>
                                    <strong style="opacity: 0.8;">Email:</strong><br>
                                    <span id="empresa-email" style="font-size: 16px;">-</span>
                                </div>
                                <div>
                                    <strong style="opacity: 0.8;">Telefone:</strong><br>
                                    <span id="empresa-telefone" style="font-size: 16px;">-</span>
                                </div>
                                <div>
                                    <strong style="opacity: 0.8;">Plano:</strong><br>
                                    <span id="empresa-plano" style="font-size: 16px; text-transform: uppercase;">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Certificado Digital -->
                <div style="background: white; padding: 25px; border-radius: 10px; border: 2px solid #e0e0e0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">üîê Certificado Digital A1 (Padr√£o Brasil)</h3>
                        <button class="btn btn-primary" onclick="abrirModalCertificadoEmpresa()" id="btn-adicionar-certificado">
                            ‚ûï Cadastrar Certificado
                        </button>
                    </div>

                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <p style="margin: 0; font-size: 13px; color: #666; line-height: 1.6;">
                            <strong>‚ÑπÔ∏è Sobre o Certificado Digital:</strong><br>
                            O certificado A1 ser√° utilizado para buscar automaticamente suas NF-e, CT-e e NFS-e diretamente da SEFAZ e prefeituras.<br>
                            ‚Ä¢ <strong>Formato:</strong> Arquivo .PFX ou .P12<br>
                            ‚Ä¢ <strong>Validade:</strong> 1 ano<br>
                            ‚Ä¢ <strong>Seguran√ßa:</strong> Criptografado no banco de dados<br>
                            ‚Ä¢ <strong>Uso:</strong> Consulta autom√°tica de documentos fiscais
                        </p>
                    </div>

                    <!-- Certificado Cadastrado -->
                    <div id="empresa-cert-container">
                        <p style="text-align: center; color: #999; padding: 40px 0;">
                            <span style="font-size: 48px; display: block; margin-bottom: 10px;">üîí</span>
                            Nenhum certificado cadastrado.<br>
                            <small>Cadastre um certificado A1 para come√ßar a importar documentos fiscais.</small>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Modal: Certificado Empresa -->
            <div id="modal-certificado-empresa" class="modal-overlay" onclick="fecharModalCertificadoEmpresa()">
                <div class="modal-dialog" onclick="event.stopPropagation()" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>üîê Cadastrar Certificado Digital A1</h3>
                        <button class="close-modal" onclick="fecharModalCertificadoEmpresa()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 12px; margin-bottom: 20px; border-radius: 4px;">
                            <small style="color: #1565c0; line-height: 1.5;">
                                <strong>üìå Importante:</strong> Este certificado ser√° vinculado √† sua empresa e usado para buscar NF-e, CT-e e NFS-e.
                            </small>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Nome/Identifica√ß√£o do Certificado</label>
                            <input type="text" id="cert-emp-nome" placeholder="Ser√° preenchido automaticamente..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            <small style="color: #4caf50;">‚ú® Preenchido automaticamente a partir do certificado</small>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Arquivo Certificado (.PFX ou .P12)</label>
                            <input type="file" id="cert-emp-arquivo" accept=".pfx,.p12" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            <small style="color: #666;">Selecione o arquivo do certificado digital A1</small>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Senha do Certificado</label>
                            <input type="password" id="cert-emp-senha" placeholder="Digite a senha do certificado" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            <small style="color: #666;">Senha definida ao gerar o certificado</small>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">UF (Estado)</label>
                            <select id="cert-emp-cuf" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">Selecione o estado...</option>
                                <option value="11">Rond√¥nia (11)</option>
                                <option value="12">Acre (12)</option>
                                <option value="13">Amazonas (13)</option>
                                <option value="14">Roraima (14)</option>
                                <option value="15">Par√° (15)</option>
                                <option value="16">Amap√° (16)</option>
                                <option value="17">Tocantins (17)</option>
                                <option value="21">Maranh√£o (21)</option>
                                <option value="22">Piau√≠ (22)</option>
                                <option value="23">Cear√° (23)</option>
                                <option value="24">Rio Grande do Norte (24)</option>
                                <option value="25">Para√≠ba (25)</option>
                                <option value="26">Pernambuco (26)</option>
                                <option value="27">Alagoas (27)</option>
                                <option value="28">Sergipe (28)</option>
                                <option value="29">Bahia (29)</option>
                                <option value="31">Minas Gerais (31)</option>
                                <option value="32">Esp√≠rito Santo (32)</option>
                                <option value="33">Rio de Janeiro (33)</option>
                                <option value="35">S√£o Paulo (35)</option>
                                <option value="41">Paran√° (41)</option>
                                <option value="42">Santa Catarina (42)</option>
                                <option value="43">Rio Grande do Sul (43)</option>
                                <option value="50">Mato Grosso do Sul (50)</option>
                                <option value="51">Mato Grosso (51)</option>
                                <option value="52">Goi√°s (52)</option>
                                <option value="53">Distrito Federal (53)</option>
                            </select>
                            <small style="color: #4caf50;">‚ú® Preenchido automaticamente a partir do certificado</small>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Ambiente</label>
                            <select id="cert-emp-ambiente" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="producao" selected>‚úÖ Produ√ß√£o (Documentos Reais)</option>
                                <option value="homologacao">üß™ Homologa√ß√£o (Testes)</option>
                            </select>
                            <small style="color: #666;">Selecione Produ√ß√£o para documentos reais</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="fecharModalCertificadoEmpresa()">Cancelar</button>
                        <button id="btn-salvar-cert-empresa" class="btn btn-primary" onclick="salvarCertificadoEmpresa()">üíæ Salvar Certificado</button>
                    </div>
                </div>
            </div>

            <!-- NF-e e CT-e - Documentos Fiscais -->
            <div id="fiscal-section" class="content-card hidden">
                <h2 style="margin-bottom: 20px;">üìë Relat√≥rios Fiscais - NF-e e CT-e</h2>

                <!-- Estat√≠sticas -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; color: white;">
                        <p style="margin: 0; opacity: 0.9; font-size: 13px;">Total de Documentos</p>
                        <h3 id="fiscal-statTotalDocs" style="margin: 10px 0 0 0; font-size: 28px; font-weight: 700;">-</h3>
                    </div>
                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 10px; color: white;">
                        <p style="margin: 0; opacity: 0.9; font-size: 13px;">NF-e Baixadas</p>
                        <h3 id="fiscal-statTotalNFes" style="margin: 10px 0 0 0; font-size: 28px; font-weight: 700;">-</h3>
                    </div>
                    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; border-radius: 10px; color: white;">
                        <p style="margin: 0; opacity: 0.9; font-size: 13px;">Valor Total NF-e</p>
                        <h3 id="fiscal-statValorTotal" style="margin: 10px 0 0 0; font-size: 28px; font-weight: 700;">R$ 0,00</h3>
                    </div>
                </div>

                <!-- Tabs -->
                <div style="border-bottom: 2px solid #e0e0e0; margin-bottom: 20px;">
                    <button class="tab-button active" onclick="showFiscalTab('busca')" id="fiscal-tab-busca">
                        üîç Buscar Documentos
                    </button>
                    <button class="tab-button" onclick="showFiscalTab('documentos')" id="fiscal-tab-documentos">
                        üìÑ Documentos
                    </button>
                    <button class="tab-button" onclick="showFiscalTab('nsu')" id="fiscal-tab-nsu">
                        üìä Status NSU
                    </button>
                </div>

                <!-- Tab Content: Busca -->
                <div id="fiscal-content-busca" class="fiscal-tab-content">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                        <!-- Busca Autom√°tica -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                            <h4>üîÑ Busca Autom√°tica (NSU)</h4>
                            <p class="text-muted" style="font-size: 13px;">Busca incremental de documentos na SEFAZ usando o √∫ltimo NSU processado. O certificado configurado em NFS-e √© usado automaticamente.</p>
                            <button class="btn btn-primary" onclick="executarBuscaAutomaticaFiscal()" style="width: 100%; margin-top: 10px;">
                                üîÑ Iniciar Busca Autom√°tica
                            </button>
                            <div id="fiscal-buscaAutoResultado" style="margin-top: 15px;"></div>
                        </div>

                        <!-- Consultar por Chave -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                            <h4>üîç Consultar por Chave</h4>
                            <p class="text-muted" style="font-size: 13px;">Consulta uma NF-e ou CT-e espec√≠fica pela chave de acesso de 44 d√≠gitos. O certificado configurado em NFS-e √© usado automaticamente.</p>
                            <div style="margin: 15px 0;">
                                <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 600;">Chave de Acesso (44 d√≠gitos)</label>
                                <input type="text" id="fiscal-buscaChave" maxlength="44" placeholder="35260112345678000190550010000001001123456781" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;">
                            </div>
                            <button class="btn btn-primary" onclick="consultarPorChaveFiscal()" style="width: 100%;">
                                üîç Consultar Chave
                            </button>
                            <div id="fiscal-buscaChaveResultado" style="margin-top: 15px;"></div>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Documentos -->
                <div id="fiscal-content-documentos" class="fiscal-tab-content hidden">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>Documentos Fiscais</h3>
                        <button class="btn btn-success" onclick="exportarExcelFiscal()">
                            üìä Exportar Excel
                        </button>
                    </div>
                    
                    <!-- Filtros -->
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 600;">Data In√≠cio</label>
                            <input type="date" id="fiscal-filtroDataInicio" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 600;">Data Fim</label>
                            <input type="date" id="fiscal-filtroDataFim" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 600;">Tipo</label>
                            <select id="fiscal-filtroTipo" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">Todos</option>
                                <option value="NFe">NF-e</option>
                                <option value="CTe">CT-e</option>
                                <option value="Evento">Eventos</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 600;">&nbsp;</label>
                            <button class="btn btn-primary" onclick="carregarDocumentosFiscais()">
                                üîç Filtrar
                            </button>
                        </div>
                    </div>

                    <!-- Tabela -->
                    <div class="table-scroll-container">
                        <table id="fiscal-tabelaDocumentos">
                            <thead>
                                <tr>
                                    <th>NSU</th>
                                    <th>Chave</th>
                                    <th>Tipo</th>
                                    <th>N√∫mero</th>
                                    <th>S√©rie</th>
                                    <th>Valor</th>
                                    <th>Emitente</th>
                                    <th>Data Emiss√£o</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="fiscal-tabelaDocumentosBody">
                                <tr>
                                    <td colspan="9" style="text-align: center; color: #999;">Carregue os documentos usando os filtros acima</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab Content: NSU Status -->
                <div id="fiscal-content-nsu" class="fiscal-tab-content hidden">
                    <h3>Status de NSU dos Certificados</h3>
                    <div id="fiscal-nsuStatusContainer" style="margin-top: 15px;">
                        <p class="text-muted">Carregando status...</p>
                    </div>
                </div>
            </div>

            <!-- Modal: Novo Certificado Fiscal -->
            <div id="modal-novo-certificado-fiscal" class="modal-overlay" onclick="fecharModalNovoCertificadoFiscal()">
                <div class="modal-dialog" onclick="event.stopPropagation()" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>üîê Cadastrar Certificado Digital</h3>
                        <button class="close-modal" onclick="fecharModalNovoCertificadoFiscal()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Arquivo .PFX *</label>
                            <input type="file" id="fiscal-certArquivo" accept=".pfx,.p12" onchange="extrairDadosCertificado()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <small class="text-muted">Selecione o arquivo do certificado digital</small>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Senha do Certificado *</label>
                            <input type="password" id="fiscal-certSenha" onchange="extrairDadosCertificado()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <small class="text-muted">Digite a senha e aguarde o preenchimento autom√°tico</small>
                        </div>
                        <div id="fiscal-cert-loading" style="display: none; padding: 10px; background: #e3f2fd; border-radius: 4px; margin-bottom: 15px; text-align: center;">
                            <span style="color: #1976d2;">‚è≥ Extraindo dados do certificado...</span>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Nome do Certificado</label>
                            <input type="text" id="fiscal-certNome" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5;">
                            <small class="text-muted">Preenchido automaticamente</small>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">CNPJ</label>
                            <input type="text" id="fiscal-certCNPJ" readonly maxlength="14" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5;">
                            <small class="text-muted">Extra√≠do do certificado</small>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">UF (Estado)</label>
                            <input type="text" id="fiscal-certCUF" placeholder="Ser√° preenchido automaticamente ou informe o c√≥digo IBGE" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5;">
                            <small class="text-muted" id="fiscal-certUF-hint">UF da empresa ser√° detectada automaticamente</small>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Ambiente *</label>
                            <select id="fiscal-certAmbiente" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="producao">Produ√ß√£o</option>
                                <option value="homologacao">Homologa√ß√£o</option>
                            </select>
                        </div>
                        <div id="fiscal-cert-info" style="display: none; padding: 10px; background: #d4edda; border-radius: 4px; margin-top: 10px; font-size: 13px;"></div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="fecharModalNovoCertificadoFiscal()">Cancelar</button>
                        <button class="btn btn-primary" onclick="salvarCertificadoFiscal()">üíæ Salvar</button>
                    </div>
                </div>
            </div>

            <!-- Inadimpl√™ncia -->
            <div id="inadimplencia-section" class="content-card hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">‚ö†Ô∏è Inadimpl√™ncia</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="exportarInadimplenciaPDF()" style="padding: 8px 16px; font-size: 13px; background: #e74c3c;">üìù PDF</button>
                        <button class="btn btn-primary" onclick="exportarInadimplenciaExcel()" style="padding: 8px 16px; font-size: 13px; background: #27ae60;">üìä Excel</button>
                    </div>
                </div>
                <div id="inadimplencia-content" style="text-align: center; padding: 60px 20px; color: #7f8c8d;">
                    <div style="font-size: 48px; margin-bottom: 20px;">‚ö†Ô∏è</div>
                    <h3 style="color: #34495e; margin-bottom: 10px;">An√°lise de Inadimpl√™ncia</h3>
                    <p style="margin: 0; font-size: 14px;">Esta se√ß√£o carrega automaticamente os dados de contas a receber vencidas e em atraso.</p>
                </div>
            </div>

            <!-- ================================================================= -->
            <!-- CONTABILIDADE - PLANO DE CONTAS -->
            <!-- ================================================================= -->
            <div id="plano-contas-section" class="content-card hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">üìí Plano de Contas</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="abrirModalVersaoPlano()" style="padding: 8px 16px; font-size: 13px; background: #95a5a6;">üìã Vers√µes</button>
                        <button class="btn btn-success" onclick="importarPlanoPadrao()" style="padding: 8px 16px; font-size: 13px; background: #9b59b6;">üì¶ Importar Plano Padr√£o</button>
                        <button class="btn btn-primary" onclick="importarPlanoContas()" style="padding: 8px 16px; font-size: 13px; background: #3498db;">üì• Importar CSV</button>
                        <button class="btn btn-primary" onclick="exportarPlanoContas()" style="padding: 8px 16px; font-size: 13px; background: #27ae60;">üì§ Exportar</button>
                        <button class="btn btn-primary" onclick="abrirModalConta()" style="padding: 8px 16px; font-size: 13px; background: #2980b9;">‚ûï Nova Conta</button>
                    </div>
                </div>

                <!-- Filtros -->
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <div style="flex: 1; min-width: 200px;">
                        <label style="font-size: 12px; font-weight: 600; color: #555;">Vers√£o:</label>
                        <select id="pcVersaoFiltro" onchange="carregarPlanoContas()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                            <option value="">-- Selecione --</option>
                        </select>
                    </div>
                    <div style="flex: 1; min-width: 180px;">
                        <label style="font-size: 12px; font-weight: 600; color: #555;">Classifica√ß√£o:</label>
                        <select id="pcClassificacaoFiltro" onchange="carregarPlanoContas()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                            <option value="">Todas</option>
                            <option value="ativo">Ativo</option>
                            <option value="passivo">Passivo</option>
                            <option value="patrimonio_liquido">Patrim√¥nio L√≠quido</option>
                            <option value="receita">Receita</option>
                            <option value="despesa">Despesa</option>
                            <option value="compensacao">Compensa√ß√£o</option>
                        </select>
                    </div>
                    <div style="flex: 1; min-width: 180px;">
                        <label style="font-size: 12px; font-weight: 600; color: #555;">Tipo:</label>
                        <select id="pcTipoFiltro" onchange="carregarPlanoContas()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                            <option value="">Todos</option>
                            <option value="sintetica">Sint√©tica</option>
                            <option value="analitica">Anal√≠tica</option>
                        </select>
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <label style="font-size: 12px; font-weight: 600; color: #555;">Buscar:</label>
                        <input type="text" id="pcBusca" placeholder="C√≥digo ou descri√ß√£o..." 
                               onkeyup="if(event.key==='Enter') carregarPlanoContas()"
                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                    </div>
                    <div style="display: flex; gap: 8px; align-items: flex-end; padding-top: 18px;">
                        <button onclick="carregarPlanoContas()" style="padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">üîç Filtrar</button>
                        <button onclick="toggleVisualizacao()" id="btnToggleViz" style="padding: 8px 16px; background: #8e44ad; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">üå≤ √Årvore</button>
                    </div>
                </div>

                <!-- Estat√≠sticas -->
                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <div style="flex: 1; background: #e8f4fd; padding: 12px 16px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 22px; font-weight: 700; color: #2980b9;" id="pcTotalContas">0</div>
                        <div style="font-size: 12px; color: #555;">Total de Contas</div>
                    </div>
                    <div style="flex: 1; background: #fef3e2; padding: 12px 16px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 22px; font-weight: 700; color: #e67e22;" id="pcTotalSinteticas">0</div>
                        <div style="font-size: 12px; color: #555;">Sint√©ticas</div>
                    </div>
                    <div style="flex: 1; background: #e8f8e8; padding: 12px 16px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 22px; font-weight: 700; color: #27ae60;" id="pcTotalAnaliticas">0</div>
                        <div style="font-size: 12px; color: #555;">Anal√≠ticas</div>
                    </div>
                    <div style="flex: 1; background: #fde8e8; padding: 12px 16px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 22px; font-weight: 700; color: #e74c3c;" id="pcTotalBloqueadas">0</div>
                        <div style="font-size: 12px; color: #555;">Bloqueadas</div>
                    </div>
                </div>

                <!-- Visualiza√ß√£o em Lista (padr√£o) -->
                <div id="pcVisualizacaoLista" style="display: block;">
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <thead>
                                <tr style="background: #2c3e50; color: white;">
                                    <th style="padding: 10px 12px; text-align: left; cursor: pointer;" onclick="ordenarPlanoContas('codigo')">C√≥digo</th>
                                    <th style="padding: 10px 12px; text-align: left; cursor: pointer;" onclick="ordenarPlanoContas('descricao')">Descri√ß√£o</th>
                                    <th style="padding: 10px 12px; text-align: center; cursor: pointer;" onclick="ordenarPlanoContas('tipo_conta')">Tipo</th>
                                    <th style="padding: 10px 12px; text-align: center; cursor: pointer;" onclick="ordenarPlanoContas('classificacao')">Classifica√ß√£o</th>
                                    <th style="padding: 10px 12px; text-align: center; cursor: pointer;" onclick="ordenarPlanoContas('natureza')">Natureza</th>
                                    <th style="padding: 10px 12px; text-align: center;">Status</th>
                                    <th style="padding: 10px 12px; text-align: center; width: 120px;">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="pcTabelaBody">
                                <tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">Selecione uma vers√£o para visualizar o plano de contas</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Visualiza√ß√£o em √Årvore -->
                <div id="pcVisualizacaoArvore" style="display: none;">
                    <div id="pcArvoreContainer" style="background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; min-height: 200px;">
                        <p style="text-align: center; color: #999;">Selecione uma vers√£o para visualizar a √°rvore</p>
                    </div>
                </div>
            </div>

            <!-- Modal Nova Conta / Editar Conta -->
            <div id="modalConta" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
                <div style="background: white; border-radius: 12px; padding: 30px; width: 550px; max-width: 95vw; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 id="modalContaTitulo" style="margin: 0;">‚ûï Nova Conta</h3>
                        <button onclick="fecharModalConta()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">‚úï</button>
                    </div>
                    <input type="hidden" id="contaEditId">
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <div style="display: flex; gap: 15px;">
                            <div style="flex: 1;">
                                <label style="font-size: 12px; font-weight: 600; color: #555;">C√≥digo *</label>
                                <input type="text" id="contaCodigo" placeholder="Ex: 1.1.2.03" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            </div>
                            <div style="flex: 2;">
                                <label style="font-size: 12px; font-weight: 600; color: #555;">Descri√ß√£o *</label>
                                <input type="text" id="contaDescricao" placeholder="Nome da conta" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            </div>
                        </div>
                        <div style="display: flex; gap: 15px;">
                            <div style="flex: 1;">
                                <label style="font-size: 12px; font-weight: 600; color: #555;">Tipo de Conta *</label>
                                <select id="contaTipoConta" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                    <option value="analitica">Anal√≠tica (Moviment√°vel)</option>
                                    <option value="sintetica">Sint√©tica (Agrupadora)</option>
                                </select>
                            </div>
                            <div style="flex: 1;">
                                <label style="font-size: 12px; font-weight: 600; color: #555;">Classifica√ß√£o *</label>
                                <select id="contaClassificacao" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                    <option value="ativo">Ativo</option>
                                    <option value="passivo">Passivo</option>
                                    <option value="patrimonio_liquido">Patrim√¥nio L√≠quido</option>
                                    <option value="receita">Receita</option>
                                    <option value="despesa">Despesa</option>
                                    <option value="compensacao">Compensa√ß√£o</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: flex; gap: 15px;">
                            <div style="flex: 1;">
                                <label style="font-size: 12px; font-weight: 600; color: #555;">Natureza *</label>
                                <select id="contaNatureza" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                    <option value="devedora">Devedora</option>
                                    <option value="credora">Credora</option>
                                </select>
                            </div>
                            <div style="flex: 1;">
                                <label style="font-size: 12px; font-weight: 600; color: #555;">Conta Pai</label>
                                <select id="contaParentId" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                    <option value="">-- Raiz (N√≠vel 1) --</option>
                                </select>
                            </div>
                        </div>
                        <!-- Campos de Integra√ß√£o Speed -->
                        <div style="background: #e8f5e9; padding: 12px; border-radius: 6px; border-left: 3px solid #4caf50;">
                            <div style="font-size: 11px; font-weight: 700; color: #388e3c; margin-bottom: 8px; text-transform: uppercase;">üîó Integra√ß√£o Speed</div>
                            <div style="display: flex; gap: 10px;">
                                <div style="flex: 1;">
                                    <label style="font-size: 12px; font-weight: 600; color: #555;">C√≥digo Speed</label>
                                    <input type="text" id="contaCodigoSpeed" placeholder="Ex: 1.1.01.001" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                                    <span style="font-size: 10px; color: #666;">C√≥digo no sistema Speed</span>
                                </div>
                                <div style="flex: 1;">
                                    <label style="font-size: 12px; font-weight: 600; color: #555;">C√≥digo Referencial</label>
                                    <input type="text" id="contaCodigoReferencial" placeholder="Ex: 1.01.01.01.01" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                                    <span style="font-size: 10px; color: #666;">Plano RFB (SPED)</span>
                                </div>
                                <div style="flex: 0.6;">
                                    <label style="font-size: 12px; font-weight: 600; color: #555;">Nat. SPED</label>
                                    <select id="contaNaturezaSped" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                                        <option value="01">01-Ativo</option>
                                        <option value="02">02-Passivo</option>
                                        <option value="03">03-PL</option>
                                        <option value="04">04-Rec. Credora</option>
                                        <option value="05">05-Rec. Devedora</option>
                                        <option value="09">09-Outras</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 15px;">
                            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                <input type="checkbox" id="contaBloqueada"> Bloqueada
                            </label>
                            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                <input type="checkbox" id="contaCentroCusto"> Requer Centro de Custo
                            </label>
                            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                <input type="checkbox" id="contaPermiteLancamento" checked> Permite Lan√ßamento
                            </label>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px;">
                            <button onclick="fecharModalConta()" style="padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">Cancelar</button>
                            <button onclick="salvarConta()" style="padding: 10px 20px; background: #2980b9; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">üíæ Salvar</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Vers√µes -->
            <div id="modalVersoes" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
                <div style="background: white; border-radius: 12px; padding: 30px; width: 600px; max-width: 95vw; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">üìã Vers√µes do Plano de Contas</h3>
                        <button onclick="fecharModalVersoes()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">‚úï</button>
                    </div>
                    
                    <!-- Form Nova Vers√£o -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 14px;">Nova Vers√£o</h4>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <input type="text" id="novaVersaoNome" placeholder="Nome (ex: Plano 2026)" style="flex: 2; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                            <input type="number" id="novaVersaoExercicio" placeholder="Exerc√≠cio" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                            <button onclick="criarVersaoPlano()" style="padding: 8px 16px; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">‚ûï Criar</button>
                        </div>
                    </div>

                    <!-- Lista de Vers√µes -->
                    <div id="listaVersoes" style="min-height: 100px;">
                        <p style="text-align: center; color: #999; padding: 20px;">Carregando...</p>
                    </div>
                </div>
            </div>

            <!-- Modal Importar CSV -->
            <div id="modalImportar" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
                <div style="background: white; border-radius: 12px; padding: 30px; width: 500px; max-width: 95vw; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">üì• Importar Plano de Contas (CSV)</h3>
                        <button onclick="fecharModalImportar()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">‚úï</button>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <p style="font-size: 13px; color: #555; margin-bottom: 10px;">
                            O CSV deve ter as colunas:<br>
                            <strong>codigo, descricao, tipo_conta, classificacao, natureza</strong>
                        </p>
                        <input type="file" id="csvImportFile" accept=".csv" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="fecharModalImportar()" style="padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 6px; cursor: pointer;">Cancelar</button>
                        <button onclick="processarImportCSV()" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer;">üì• Importar</button>
                    </div>
                </div>
            </div>

            <!-- ================================================================= -->
            <!-- DRE - DEMONSTRA√á√ÉO DO RESULTADO DO EXERC√çCIO -->
            <!-- ================================================================= -->
            <div id="dre-section" class="content-card hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">üìà DRE - Demonstra√ß√£o do Resultado do Exerc√≠cio</h2>
                    <button onclick="abrirModalConfiguracaoDRE()" class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px; background: #9b59b6; color: white;">
                        ‚öôÔ∏è Configurar Mapeamento
                    </button>
                </div>

                <!-- Filtros -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end;">
                        <div>
                            <label style="font-size: 12px; font-weight: 600; color: #555; display: block; margin-bottom: 5px;">Data In√≠cio:</label>
                            <input type="date" id="dreDataInicio" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                        </div>
                        <div>
                            <label style="font-size: 12px; font-weight: 600; color: #555; display: block; margin-bottom: 5px;">Data Fim:</label>
                            <input type="date" id="dreDataFim" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                        </div>
                        <div>
                            <label style="font-size: 12px; font-weight: 600; color: #555; display: block; margin-bottom: 5px;">Vers√£o do Plano:</label>
                            <select id="dreVersaoPlano" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                                <option value="">Todas as vers√µes</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Bot√µes de Per√≠odo R√°pido -->
                    <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                        <button id="drePeriodoMesAtual" class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px; background: #95a5a6;">üìÖ M√™s Atual</button>
                        <button id="drePeriodoMesAnterior" class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px; background: #95a5a6;">‚èÆÔ∏è M√™s Anterior</button>
                        <button id="drePeriodoTrimestre" class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px; background: #95a5a6;">üìä Trimestre Atual</button>
                        <button id="drePeriodoAnoAtual" class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px; background: #95a5a6;">üìÜ Ano Atual</button>
                    </div>
                    
                    <!-- Op√ß√µes adicionais -->
                    <div style="margin-top: 15px; display: flex; align-items: center; gap: 15px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="dreCompararPeriodo" style="width: 18px; height: 18px;">
                            <span style="font-size: 13px; color: #555; font-weight: 500;">Comparar com per√≠odo anterior</span>
                        </label>
                        <button onclick="gerarDRECompleta()" class="btn btn-primary" style="padding: 10px 24px; font-size: 14px; background: #3498db; margin-left: auto;">üöÄ Gerar DRE</button>
                    </div>
                </div>

                <!-- Resultado da DRE -->
                <div id="dreResultado" style="display: none;">
                    <!-- Ser√° preenchido dinamicamente pelo JavaScript -->
                </div>
            </div>

            <!-- ================================================================= -->
            <!-- MODAL: CONFIGURA√á√ÉO DE MAPEAMENTO DRE -->
            <!-- ================================================================= -->
            <div id="modalConfiguracaoDRE" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; overflow-y: auto; padding: 30px 15px; box-sizing: border-box;">
                <div style="background: white; border-radius: 12px; max-width: 1160px; width: 100%; margin: 0 auto; padding: 0; box-shadow: 0 20px 60px rgba(0,0,0,0.3); position: relative; box-sizing: border-box; display: flex; flex-direction: column; max-height: calc(100vh - 60px);">
                    
                    <!-- CONTE√öDO SCROLLABLE -->
                    <div style="flex: 1; overflow-y: auto; padding: 30px;">
                    
                    <!-- CABE√áALHO -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #9b59b6; padding-bottom: 15px;">
                        <div style="flex: 1;">
                            <h2 style="margin: 0; color: #9b59b6; font-size: 24px;">‚öôÔ∏è Configura√ß√£o de Mapeamento DRE</h2>
                            <p style="margin: 5px 0 0 0; font-size: 14px; color: #777;">
                                Vincule suas subcategorias √†s contas do plano de contas do DRE
                            </p>
                        </div>
                        <button onclick="fecharModalConfiguracaoDRE()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #999; line-height: 1; padding: 8px 12px; min-width: 40px; min-height: 40px; border-radius: 6px; transition: all 0.2s; flex-shrink: 0; margin-left: 20px;" onmouseover="this.style.background='#f0f0f0'; this.style.color='#333';" onmouseout="this.style.background='none'; this.style.color='#999';">‚úï</button>
                    </div>

                    <!-- INSTRU√á√ïES -->
                    <div style="background: #f0f3ff; border-left: 4px solid #9b59b6; padding: 15px; border-radius: 6px; margin-bottom: 25px;">
                        <p style="margin: 0; font-size: 13px; color: #555; line-height: 1.6;">
                            <strong>üìå Como funciona:</strong><br>
                            ‚Ä¢ Ao mapear uma subcategoria para uma conta do DRE, todos os lan√ßamentos dessa subcategoria ser√£o inclu√≠dos no DRE<br>
                            ‚Ä¢ Cada subcategoria s√≥ pode ser mapeada para UMA conta do plano de contas<br>
                            ‚Ä¢ As contas v√°lidas s√£o: <strong>4.x</strong> (Receitas), <strong>5.x</strong> (Custos), <strong>6.x</strong> (Despesas Operacionais), <strong>7.x</strong> (Resultado Financeiro)
                        </p>
                    </div>

                    <!-- FORMUL√ÅRIO DE NOVO MAPEAMENTO -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #333;">‚ûï Novo Mapeamento</h3>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 120px; gap: 15px; align-items: end;">
                            <div>
                                <label style="font-size: 12px; font-weight: 600; color: #555; display: block; margin-bottom: 5px;">
                                    Subcategoria:
                                </label>
                                <select id="novoMapSubcategoria" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                                    <option value="">Selecione uma subcategoria...</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="font-size: 12px; font-weight: 600; color: #555; display: block; margin-bottom: 5px;">
                                    Conta do DRE:
                                </label>
                                <select id="novoMapPlanoContas" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                                    <option value="">Selecione uma conta...</option>
                                </select>
                            </div>
                            
                            <button onclick="salvarNovoMapeamento()" class="btn btn-primary" style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; height: 42px;">
                                ‚úì Adicionar
                            </button>
                        </div>
                    </div>

                    <!-- LISTA DE MAPEAMENTOS EXISTENTES -->
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0; font-size: 16px; color: #333;">üìã Mapeamentos Atuais</h3>
                            <span id="totalMapeamentos" style="font-size: 13px; color: #777; font-weight: 600;">0 mapeamentos</span>
                        </div>
                        
                        <div id="listaMapeamentosDRE" style="min-height: 150px;">
                            <!-- Ser√° preenchido dinamicamente -->
                            <div style="text-align: center; padding: 40px; color: #999;">
                                <div style="font-size: 48px; margin-bottom: 10px;">üìÇ</div>
                                <p>Nenhum mapeamento configurado ainda</p>
                                <p style="font-size: 12px; margin-top: 5px;">Adicione um mapeamento acima para come√ßar</p>
                            </div>
                        </div>
                    </div>
                    </div>
                    
                    <!-- RODAP√â FIXO -->
                    <div style="border-top: 1px solid #e0e0e0; padding: 20px 30px; background: #f8f9fa; border-radius: 0 0 12px 12px; display: flex; justify-content: flex-end; gap: 10px;">
                        <button onclick="fecharModalConfiguracaoDRE()" class="btn btn-secondary" style="padding: 10px 28px; background: #95a5a6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#7f8c8d';" onmouseout="this.style.background='#95a5a6';">
                            Fechar
                        </button>
                    </div>
                </div>
            </div>

            <!-- ================================================================= -->
            <!-- DASHBOARD GERENCIAL -->
            <!-- ================================================================= -->
            <div id="dashboard-gerencial-section" class="content-card hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">üìä Dashboard Gerencial</h2>
                    <button onclick="carregarDashboardGerencial()" class="btn btn-primary" style="padding: 8px 16px; font-size: 13px; background: #3498db;">üîÑ Atualizar</button>
                </div>

                <!-- Filtros -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: flex; gap: 15px; align-items: end; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-size: 12px; font-weight: 600; color: #555; display: block; margin-bottom: 5px;">M√™s de Refer√™ncia:</label>
                            <input type="month" id="dashboardMesReferencia" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-size: 12px; font-weight: 600; color: #555; display: block; margin-bottom: 5px;">Vers√£o do Plano:</label>
                            <select id="dashboardVersaoPlano" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                                <option value="">Todas as vers√µes</option>
                            </select>
                        </div>
                        <button onclick="carregarDashboardGerencial()" class="btn btn-success" style="padding: 10px 24px; font-size: 14px; background: #27ae60;">üìä Carregar Dashboard</button>
                    </div>
                </div>

                <!-- Resultado do Dashboard -->
                <div id="dashboardResultado" style="display: none;">
                    <!-- Ser√° preenchido dinamicamente pelo JavaScript -->
                </div>
            </div>

            <!-- NFS-e - Notas Fiscais de Servi√ßo Eletr√¥nica -->
            <div id="nfse-section" class="content-card hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">üìÑ NFS-e - Notas Fiscais de Servi√ßo</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="mostrarConfigMunicipiosNFSe()" data-permission="nfse_config" style="padding: 8px 16px; font-size: 13px; background: #95a5a6;">‚öôÔ∏è Configurar Munic√≠pios</button>
                        <button class="btn btn-primary" onclick="exportarNFSeExcel()" data-permission="nfse_export" style="padding: 8px 16px; font-size: 13px; background: #27ae60;">üìä Exportar Excel</button>
                        <button class="btn btn-primary" onclick="exportarNFSeXMLs()" data-permission="nfse_export" style="padding: 8px 16px; font-size: 13px; background: #3498db;">üìÑ Baixar XMLs</button>
                        <button class="btn btn-danger" onclick="apagarTodasNFSe()" data-permission="nfse_delete" style="padding: 8px 16px; font-size: 13px; background: #e74c3c;">üóëÔ∏è Apagar Todas</button>
                    </div>
                </div>

                <!-- Filtros de Busca -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
                        <div>
                            <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">Data Inicial:</label>
                            <input type="date" id="nfse-data-inicial" style="padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; height: 38px; width: 150px;">
                        </div>
                        <div>
                            <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">Data Final:</label>
                            <input type="date" id="nfse-data-final" style="padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; height: 38px; width: 150px;">
                        </div>
                        <div>
                            <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">Munic√≠pio:</label>
                            <select id="nfse-municipio" style="padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; height: 38px; min-width: 200px;">
                                <option value="">Todos os munic√≠pios</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">Registros por p√°gina:</label>
                            <select id="nfse-registros-por-pagina" onchange="atualizarRegistrosPorPagina()" style="padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; height: 38px; min-width: 120px;">
                                <option value="50">50</option>
                                <option value="100" selected>100</option>
                                <option value="500">500</option>
                                <option value="1000">1000</option>
                                <option value="10000">10000</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">M√©todo de Busca:</label>
                            <select id="nfse-metodo" style="padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; height: 38px; min-width: 250px;">
                                <option value="ambiente_nacional" selected>üåê Ambiente Nacional (Recomendado)</option>
                                <option value="soap">üì° APIs SOAP Municipais</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 12px; color: transparent; display: block; margin-bottom: 4px; user-select: none;">&#8203;</label>
                            <button class="btn btn-primary" onclick="consultarNFSeLocal()" data-permission="nfse_view" style="padding: 8px 16px; height: 38px; font-size: 14px;">üîç Consultar Banco Local</button>
                        </div>
                        <div>
                            <label style="font-size: 12px; color: transparent; display: block; margin-bottom: 4px; user-select: none;">&#8203;</label>
                            <button class="btn btn-info" onclick="diagnosticarOmissoesNFSe()" data-permission="nfse_view" style="padding: 8px 16px; height: 38px; font-size: 14px; background: #3498db; border-color: #3498db;">üîç Diagn√≥stico</button>
                        </div>
                        <div>
                            <label style="font-size: 12px; color: transparent; display: block; margin-bottom: 4px; user-select: none;">&#8203;</label>
                            <button class="btn btn-success" onclick="buscarNFSeAPI()" data-permission="nfse_buscar" style="padding: 8px 16px; height: 38px; font-size: 14px; background: #27ae60;">‚¨áÔ∏è Baixar NFS-e</button>
                        </div>
                    </div>
                </div>

                <!-- Cards de Resumo -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); text-align: center;">
                        <div style="font-size: 12px; color: rgba(255,255,255,0.9); margin-bottom: 5px; font-weight: 600;">üìÑ TOTAL DE NOTAS</div>
                        <div id="total-nfse" style="font-size: 32px; color: white; font-weight: bold;">0</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 12px; box-shadow: 0 5px 15px rgba(245, 87, 108, 0.3); text-align: center;">
                        <div style="font-size: 12px; color: rgba(255,255,255,0.9); margin-bottom: 5px; font-weight: 600;">üí∞ VALOR TOTAL</div>
                        <div id="valor-total-nfse" style="font-size: 32px; color: white; font-weight: bold;">R$ 0,00</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; border-radius: 12px; box-shadow: 0 5px 15px rgba(79, 172, 254, 0.3); text-align: center;">
                        <div style="font-size: 12px; color: rgba(255,255,255,0.9); margin-bottom: 5px; font-weight: 600;">üèõÔ∏è ISS TOTAL</div>
                        <div id="iss-total-nfse" style="font-size: 32px; color: white; font-weight: bold;">R$ 0,00</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 20px; border-radius: 12px; box-shadow: 0 5px 15px rgba(67, 233, 123, 0.3); text-align: center;">
                        <div style="font-size: 12px; color: rgba(255,255,255,0.9); margin-bottom: 5px; font-weight: 600;">üèôÔ∏è MUNIC√çPIOS</div>
                        <div id="municipios-nfse" style="font-size: 32px; color: white; font-weight: bold;">0</div>
                    </div>
                </div>

                <!-- Loading Indicator -->
                <div id="loading-nfse" style="display: none; text-align: center; padding: 20px; background: #fff3cd; border-radius: 8px; margin-bottom: 20px;">
                    <div style="font-size: 24px; margin-bottom: 10px;">‚è≥</div>
                    <p style="margin: 0; color: #856404; font-weight: 500;">Buscando NFS-e...</p>
                    <p style="margin: 5px 0 0 0; color: #856404; font-size: 14px;">Isso pode levar alguns minutos dependendo da quantidade de notas.</p>
                </div>

                <!-- Pagina√ß√£o -->
                <div id="nfse-paginacao" style="display: none; margin-bottom: 20px; text-align: center;">
                    <div style="display: inline-flex; gap: 10px; align-items: center; background: #f8f9fa; padding: 10px 20px; border-radius: 8px;">
                        <button id="nfse-primeira-pagina" onclick="irPaginaNFSe(1)" class="btn btn-secondary" style="padding: 6px 12px;">‚èÆÔ∏è</button>
                        <button id="nfse-pagina-anterior" onclick="mudarPaginaNFSe(-1)" class="btn btn-secondary" style="padding: 6px 12px;">‚óÄÔ∏è</button>
                        <span id="nfse-info-pagina" style="font-size: 14px; font-weight: 500; color: #2c3e50; min-width: 200px;">P√°gina 1 de 1</span>
                        <button id="nfse-proxima-pagina" onclick="mudarPaginaNFSe(1)" class="btn btn-secondary" style="padding: 6px 12px;">‚ñ∂Ô∏è</button>
                        <button id="nfse-ultima-pagina" onclick="irPaginaNFSe('ultima')" class="btn btn-secondary" style="padding: 6px 12px;">‚è≠Ô∏è</button>
                    </div>
                </div>

                <!-- Tabela de Resultados -->
                <div class="table-scroll-container">
                    <table id="table-nfse">
                        <thead>
                            <tr>
                                <th onclick="ordenarNFSe('numero_nfse')" style="width: 100px; cursor: pointer; font-size: 14px; user-select: none;" title="Clique para ordenar">N√∫mero <span id="sort-numero_nfse"></span></th>
                                <th onclick="ordenarNFSe('data_emissao')" style="width: 120px; cursor: pointer; font-size: 14px; user-select: none;" title="Clique para ordenar">Data Emiss√£o <span id="sort-data_emissao"></span></th>
                                <th onclick="ordenarNFSe('razao_social_tomador')" style="width: 250px; cursor: pointer; font-size: 14px; user-select: none;" title="Clique para ordenar">Tomador <span id="sort-razao_social_tomador"></span></th>
                                <th onclick="ordenarNFSe('nome_municipio')" style="width: 180px; cursor: pointer; font-size: 14px; user-select: none;" title="Clique para ordenar">Munic√≠pio <span id="sort-nome_municipio"></span></th>
                                <th onclick="ordenarNFSe('valor_servico')" style="width: 120px; cursor: pointer; font-size: 14px; user-select: none;" title="Clique para ordenar">Valor Servi√ßo <span id="sort-valor_servico"></span></th>
                                <th onclick="ordenarNFSe('valor_iss')" style="width: 100px; cursor: pointer; font-size: 14px; user-select: none;" title="Clique para ordenar">ISS <span id="sort-valor_iss"></span></th>
                                <th onclick="ordenarNFSe('valor_liquido')" style="width: 110px; cursor: pointer; font-size: 14px; user-select: none;" title="Clique para ordenar">Valor L√≠quido <span id="sort-valor_liquido"></span></th>
                                <th onclick="ordenarNFSe('situacao')" style="width: 100px; cursor: pointer; font-size: 14px; user-select: none;" title="Clique para ordenar">Situa√ß√£o <span id="sort-situacao"></span></th>
                                <th style="width: 140px; font-size: 14px;">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-nfse">
                            <tr>
                                <td colspan="9" style="text-align: center; padding: 60px; color: #7f8c8d;">
                                    <div style="font-size: 48px; margin-bottom: 20px;">üìÑ</div>
                                    <h3 style="color: #34495e; margin-bottom: 10px;">NFS-e - Notas Fiscais de Servi√ßo</h3>
                                    <p style="margin: 0; font-size: 14px;">Selecione o per√≠odo e clique em <strong>üîç Consultar Banco Local</strong> para ver as NFS-e j√° baixadas.</p>
                                    <p style="margin: 5px 0 0 0; font-size: 14px;">Ou clique em <strong>‚¨áÔ∏è Baixar via API SOAP</strong> para buscar novas notas nos servidores municipais.</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Contas Banc√°rias -->
            <div id="contas-bancarias-section" class="content-card hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">Contas Banc√°rias</h2>
                    <div style="display: flex; gap: 20px; align-items: center;">
                        <div style="text-align: center;">
                            <label style="display: block; font-size: 14px; color: #2c3e50; font-weight: bold; margin-bottom: 8px;">Filtro por Banco</label>
                            <select id="filtro-banco" onchange="filtrarPorBanco()" style="padding: 8px 15px; border: 2px solid #3498db; border-radius: 8px; font-size: 14px; background: white; cursor: pointer;">
                                <option value="">Todos os Bancos</option>
                            </select>
                        </div>
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); text-align: center; min-width: 200px;">
                            <div style="font-size: 12px; color: rgba(255,255,255,0.9); margin-bottom: 5px; font-weight: 600;">üí∞ SALDO TOTAL</div>
                            <div id="saldo-total-display" style="font-size: 24px; color: white; font-weight: bold;">R$ 0,00</div>
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="openModalConta()">‚ûï Nova Conta</button>
                <div class="table-scroll-container">
                    <table id="table-contas">
                        <thead>
                            <tr>
                                <th>Banco</th>
                                <th>Ag√™ncia</th>
                                <th>Conta</th>
                                <th>Saldo Inicial</th>
                                <th>Saldo Atual</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-contas">
                            <tr><td colspan="6" class="loading">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Categorias -->
            <div id="categorias-section" class="content-card hidden">
                <h2 style="color: #000000 !important; font-weight: 700;">Categorias</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="openModalCategoria()">‚ûï Nova Categoria</button>
                    <button class="btn btn-secondary" onclick="abrirModalImportarCategorias()" style="background: #6c757d;">
                        üì• Importar de Outra Empresa
                    </button>
                </div>
                
                <!-- Abas de Categorias -->
                <div style="margin: 20px 0; border-bottom: 2px solid #e0e0e0;">
                    <button class="tab-button active" onclick="showCategoriaTab('receita')" id="tab-receita">
                        üí∞ Categorias de Receitas
                    </button>
                    <button class="tab-button" onclick="showCategoriaTab('despesa')" id="tab-despesa">
                        üí∏ Categorias de Despesas
                    </button>
                </div>

                <!-- Tabela de Categorias de Receita -->
                <div id="categorias-receita-container">
                    <div class="table-scroll-container">
                        <table id="table-categorias-receita">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-categorias-receita">
                                <tr><td colspan="2" class="loading">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tabela de Categorias de Despesa -->
                <div id="categorias-despesa-container" class="hidden">
                    <div class="table-scroll-container">
                        <table id="table-categorias-despesa">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-categorias-despesa">
                                <tr><td colspan="2" class="loading">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Clientes -->
            <div id="clientes-section" class="content-card hidden">
                <h2 style="color: #000000 !important; font-weight: 700;">Clientes</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="openModalCliente()">‚ûï Novo Cliente</button>
                    <button class="btn" onclick="exportarClientesPDF()" style="background: #e74c3c; color: white;">üìÑ Exportar PDF</button>
                    <button class="btn" onclick="exportarClientesExcel()" style="background: #27ae60; color: white;">üìä Exportar Excel</button>
                </div>
                
                <!-- Tabs de Status -->
                <div style="display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 2px solid #ddd;">
                    <button class="tab-button active" onclick="showClienteTab('ativos')" id="tab-clientes-ativos" style="padding: 10px 20px; border: none; background: #9b59b6; color: white; cursor: pointer; border-radius: 5px 5px 0 0; font-weight: bold;">
                        Ativos
                    </button>
                    <button class="tab-button" onclick="showClienteTab('inativos')" id="tab-clientes-inativos" style="padding: 10px 20px; border: none; background: #bdc3c7; color: #555; cursor: pointer; border-radius: 5px 5px 0 0;">
                        Inativos
                    </button>
                </div>
                
                <div class="table-scroll-container">
                    <table id="table-clientes">
                        <thead>
                            <tr>
                                <th>Raz√£o Social</th>
                                <th>Nome Fantasia</th>
                                <th>CNPJ</th>
                                <th>Cidade</th>
                                <th>Telefone</th>
                                <th id="th-data-inativacao-cliente" style="display: none;">Data Inativa√ß√£o</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-clientes">
                            <tr><td colspan="7" class="loading">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Fornecedores -->
            <div id="fornecedores-section" class="content-card hidden">
                <h2 style="color: #000000 !important; font-weight: 700;">Fornecedores</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="openModalFornecedor()">‚ûï Novo Fornecedor</button>
                    <button class="btn" onclick="exportarFornecedoresPDF()" style="background: #e74c3c; color: white;">üìÑ Exportar PDF</button>
                    <button class="btn" onclick="exportarFornecedoresExcel()" style="background: #27ae60; color: white;">üìä Exportar Excel</button>
                </div>
                
                <!-- Tabs de Status -->
                <div style="display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 2px solid #ddd;">
                    <button class="tab-button active" onclick="showFornecedorTab('ativos')" id="tab-fornecedores-ativos" style="padding: 10px 20px; border: none; background: #9b59b6; color: white; cursor: pointer; border-radius: 5px 5px 0 0; font-weight: bold;">
                        Ativos
                    </button>
                    <button class="tab-button" onclick="showFornecedorTab('inativos')" id="tab-fornecedores-inativos" style="padding: 10px 20px; border: none; background: #bdc3c7; color: #555; cursor: pointer; border-radius: 5px 5px 0 0;">
                        Inativos
                    </button>
                </div>
                
                <div class="table-scroll-container">
                    <table id="table-fornecedores">
                        <thead>
                            <tr>
                                <th>Raz√£o Social</th>
                                <th>Nome Fantasia</th>
                                <th>CNPJ</th>
                                <th>Cidade</th>
                                <th>Telefone</th>
                                <th id="th-data-inativacao-fornecedor" style="display: none;">Data Inativa√ß√£o</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-fornecedores">
                            <tr><td colspan="7" class="loading">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Gerenciamento de Tags -->
            <div id="tags-trabalho-section" class="content-card hidden">
                <h2 style="color: #000000 !important; font-weight: 700;">üè∑Ô∏è Gerenciamento de Tags</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="openModalAdicionarTag('management')">‚ûï Nova Tag</button>
                </div>
                
                <div class="table-scroll-container">
                    <table id="table-tags">
                        <thead>
                            <tr>
                                <th style="width: 40%;">Nome</th>
                                <th style="width: 15%;">Cor</th>
                                <th style="width: 15%;">√çcone</th>
                                <th style="width: 15%;">Status</th>
                                <th style="width: 15%;">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-tags">
                            <tr><td colspan="5" class="loading">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Gerenciamento de Usu√°rios (Admin) -->
            <div id="usuarios-section" class="content-card hidden">
                <h2 style="color: #000000 !important; font-weight: 700;">üîê Gerenciamento de Usu√°rios</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="openModalUsuario()">‚ûï Novo Usu√°rio</button>
                    <button class="btn" onclick="refreshUsuarios()" style="background: #3498db; color: white;">üîÑ Atualizar</button>
                </div>
                
                <!-- Tabs -->
                <div style="display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 2px solid #ddd;">
                    <button class="tab-button active" onclick="showUsuariosTab('ativos')" id="tab-usuarios-ativos" style="padding: 10px 20px; border: none; background: #27ae60; color: white; cursor: pointer; border-radius: 5px 5px 0 0; font-weight: bold;">
                        ‚úÖ Ativos
                    </button>
                    <button class="tab-button" onclick="showUsuariosTab('inativos')" id="tab-usuarios-inativos" style="padding: 10px 20px; border: none; background: #bdc3c7; color: #555; cursor: pointer; border-radius: 5px 5px 0 0;">
                        ‚ùå Inativos
                    </button>
                    <button class="tab-button" onclick="showUsuariosTab('todos')" id="tab-usuarios-todos" style="padding: 10px 20px; border: none; background: #bdc3c7; color: #555; cursor: pointer; border-radius: 5px 5px 0 0;">
                        üìã Todos
                    </button>
                </div>
                
                <div class="table-scroll-container">
                    <table id="table-usuarios">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Nome Completo</th>
                                <th>E-mail</th>
                                <th>Tipo</th>
                                <th>Cliente Associado</th>
                                <th>Status</th>
                                <th>√öltima Sess√£o</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-usuarios">
                            <tr><td colspan="9" class="loading">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Permiss√µes (Admin) -->
            <div id="permissoes-section" class="content-card hidden">
                <h2 style="color: #000000 !important; font-weight: 700;">üîê Gerenciamento de Permiss√µes</h2>
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-left: 4px solid #3498db; border-radius: 5px;">
                    <p style="margin: 0; color: #555;">
                        <strong>‚ÑπÔ∏è Informa√ß√£o:</strong> Selecione um usu√°rio para visualizar e editar suas permiss√µes.
                    </p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label for="select-usuario-permissao" style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                        Selecionar Usu√°rio:
                    </label>
                    <select id="select-usuario-permissao" onchange="loadUsuarioPermissoes()" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px;">
                        <option value="">-- Selecione um usu√°rio --</option>
                    </select>
                </div>
                
                <div id="permissoes-usuario-container" style="display: none;">
                    <h3 style="margin-bottom: 15px; color: #2c3e50;">Permiss√µes do Usu√°rio</h3>
                    <div id="permissoes-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
                        <!-- Permiss√µes ser√£o carregadas via JavaScript -->
                    </div>
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="salvarPermissoes()">üíæ Salvar Altera√ß√µes</button>
                        <button class="btn" onclick="cancelarEdicaoPermissoes()" style="background: #95a5a6; color: white;">‚ùå Cancelar</button>
                    </div>
                </div>
            </div>

            <!-- Logs de Acesso (Admin) -->
            <div id="logs-section" class="content-card hidden">
                <h2 style="color: #000000 !important; font-weight: 700;">üìã Logs de Acesso</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="btn" onclick="refreshLogs()" style="background: #3498db; color: white;">üîÑ Atualizar</button>
                    <input type="date" id="filter-log-data-inicio" onchange="filterLogs()" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    <input type="date" id="filter-log-data-fim" onchange="filterLogs()" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    <select id="filter-log-usuario" onchange="filterLogs()" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="">Todos os usu√°rios</option>
                    </select>
                </div>
                
                <div class="table-scroll-container">
                    <table id="table-logs">
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th>Usu√°rio</th>
                                <th>Tipo</th>
                                <th>A√ß√£o</th>
                                <th>IP</th>
                                <th>Navegador</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-logs">
                            <tr><td colspan="7" class="loading">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Contratos e Sess√µes -->
            <div id="contratos-section" class="content-card hidden">
                <h2 style="color: #000000 !important; font-weight: 700;">Contratos e Sess√µes</h2>
                
                <!-- Tabs -->
                <div style="display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 2px solid #ddd;">
                    <button class="tab-button active" onclick="showContratoTab('resumo')" id="tab-resumo" style="padding: 10px 20px; border: none; background: #9b59b6; color: white; cursor: pointer; border-radius: 5px 5px 0 0; font-weight: bold;">
                        üìä Resumo
                    </button>
                    <button class="tab-button" onclick="showContratoTab('contratos')" id="tab-contratos" style="padding: 10px 20px; border: none; background: #bdc3c7; color: #555; cursor: pointer; border-radius: 5px 5px 0 0;">
                        Contratos
                    </button>
                    <button class="tab-button" onclick="showContratoTab('sessoes')" id="tab-sessoes" style="padding: 10px 20px; border: none; background: #bdc3c7; color: #555; cursor: pointer; border-radius: 5px 5px 0 0;">
                        Sess√µes
                    </button>
                </div>

                <!-- Tab Resumo -->
                <div id="tab-content-resumo">
                    <!-- KPIs Cards -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); color: white;">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">üí∞ Receita Total</div>
                            <div style="font-size: 28px; font-weight: 700;" id="kpi-receita-total">R$ 0,00</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); color: white;">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">üí∏ Custos Totais</div>
                            <div style="font-size: 28px; font-weight: 700;" id="kpi-custos-totais">R$ 0,00</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); color: white;">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">üìà Lucro L√≠quido</div>
                            <div style="font-size: 28px; font-weight: 700;" id="kpi-lucro-liquido">R$ 0,00</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); color: white;">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">üìä Margem de Lucro</div>
                            <div style="font-size: 28px; font-weight: 700;" id="kpi-margem-lucro">0%</div>
                        </div>
                    </div>

                    <!-- Gr√°fico -->
                    <div style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 30px;">
                        <h3 style="color: #000000 !important; font-weight: 700; margin-bottom: 20px;">üìä An√°lise de Receitas vs Custos</h3>
                        <canvas id="chart-contratos-lucro" style="max-height: 400px;"></canvas>
                    </div>

                    <!-- Tabela Detalhada -->
                    <div style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #000000 !important; font-weight: 700; margin-bottom: 20px;">üìã An√°lise Detalhada por Contrato</h3>
                        <div class="table-scroll-container">
                            <table id="table-resumo-contratos">
                                <thead>
                                    <tr style="background-color: #f5f5f5 !important;">
                                        <th style="color: #000000 !important; font-weight: 700; padding: 12px 15px; text-align: left;">Contrato</th>
                                        <th style="color: #000000 !important; font-weight: 700; padding: 12px 15px; text-align: left;">Cliente</th>
                                        <th style="color: #000000 !important; font-weight: 700; padding: 12px 15px; text-align: right;">Receita Bruta</th>
                                        <th style="color: #000000 !important; font-weight: 700; padding: 12px 15px; text-align: right;">Impostos</th>
                                        <th style="color: #000000 !important; font-weight: 700; padding: 12px 15px; text-align: right;">Comiss√µes</th>
                                        <th style="color: #000000 !important; font-weight: 700; padding: 12px 15px; text-align: right;">Custos Sess√µes</th>
                                        <th style="color: #000000 !important; font-weight: 700; padding: 12px 15px; text-align: right;">Receita L√≠quida</th>
                                        <th style="color: #000000 !important; font-weight: 700; padding: 12px 15px; text-align: right;">Resultado</th>
                                        <th style="color: #000000 !important; font-weight: 700; padding: 12px 15px; text-align: center;">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-resumo-contratos">
                                    <tr><td colspan="9" class="loading">Carregando an√°lise...</td></tr>
                                </tbody>
                                <tfoot style="background: #f8f9fa; font-weight: 700;">
                                    <tr>
                                        <td colspan="2" style="padding: 12px 15px; text-align: right;">TOTAIS:</td>
                                        <td style="padding: 12px 15px; text-align: right;" id="total-receita-bruta">R$ 0,00</td>
                                        <td style="padding: 12px 15px; text-align: right;" id="total-impostos">R$ 0,00</td>
                                        <td style="padding: 12px 15px; text-align: right;" id="total-comissoes">R$ 0,00</td>
                                        <td style="padding: 12px 15px; text-align: right;" id="total-custos-sessoes">R$ 0,00</td>
                                        <td style="padding: 12px 15px; text-align: right;" id="total-receita-liquida">R$ 0,00</td>
                                        <td style="padding: 12px 15px; text-align: right;" id="total-resultado">R$ 0,00</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Tab Contratos -->
                <div id="tab-content-contratos" style="display: none;">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button class="btn btn-primary" onclick="openModalContrato()">‚ûï Novo Contrato</button>
                        <button class="btn" onclick="exportarContratosPDF()" style="background: #e74c3c; color: white;">üìÑ Exportar PDF</button>
                    </div>
                    <div class="table-scroll-container">
                        <table id="table-contratos">
                            <thead>
                                <tr>
                                    <th>N√∫mero</th>
                                    <th>Cliente</th>
                                    <th>Tipo</th>
                                    <th>Nome Contrato</th>
                                    <th>Valor Mensal</th>
                                    <th>Meses</th>
                                    <th>Valor Total</th>
                                    <th>Data In√≠cio</th>
                                    <th>Forma Pgto</th>
                                    <th>Status</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-contratos">
                                <tr><td colspan="11" class="loading">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab Sess√µes -->
                <div id="tab-content-sessoes" style="display: none;">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button class="btn btn-primary" onclick="openModalSessao()">‚ûï Nova Sess√£o</button>
                        <button class="btn" onclick="exportarSessoesPDF()" style="background: #e74c3c; color: white;">üìÑ Exportar PDF</button>
                    </div>
                    <div class="table-scroll-container">
                        <table id="table-sessoes">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Hor√°rio</th>
                                    <th>Cliente</th>
                                    <th>Contrato</th>
                                    <th>Local</th>
                                    <th>Tipo Capta√ß√£o</th>
                                    <th>Prazo Entrega</th>
                                    <th>Status</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-sessoes">
                                <tr><td colspan="9" class="loading">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Agenda de Fotografia -->
            <div id="agenda-fotografia-section" class="content-card hidden">
                <h2 style="color: #000000 !important; font-weight: 700;">üì∑ Agenda de Fotografia</h2>
                
                <!-- Bot√µes de A√ß√£o -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                    <button class="btn btn-primary" onclick="showSection('contratos'); setTimeout(() => document.querySelector('[onclick*=sessoes]').click(), 100)" style="font-weight: 600;">
                        ‚ûï Nova Sess√£o
                    </button>
                    <button class="btn" onclick="toggleCalendarView()" style="background: #3498db; color: white; font-weight: 500;">
                        <span id="toggle-view-icon">üìã</span> <span id="toggle-view-text">Ver Lista</span>
                    </button>
                    <button class="btn" onclick="syncGoogleCalendar()" style="background: #DB4437; color: white; font-weight: 500;">
                        üîÑ Sync Google Calendar
                    </button>
                    <button class="btn" onclick="openEmailSettings()" style="background: #9b59b6; color: white; font-weight: 500;">
                        ‚öôÔ∏è Configura√ß√µes
                    </button>
                    
                    <!-- Info r√°pida -->
                    <div style="margin-left: auto; padding: 8px 16px; background: #ecf0f1; border-radius: 6px; font-size: 14px; color: #7f8c8d;">
                        <span id="agenda-total-sessoes">Carregando...</span>
                    </div>
                </div>

                <!-- Legenda de Status -->
                <div style="display: flex; gap: 20px; margin-bottom: 20px; padding: 12px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);">
                    <div style="color: white; font-weight: 600; font-size: 14px; margin-right: 10px;">Status:</div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 20px; height: 20px; background: #27ae60; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>
                        <span style="color: white; font-size: 13px; font-weight: 500;">No Prazo</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 20px; height: 20px; background: #f39c12; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>
                        <span style="color: white; font-size: 13px; font-weight: 500;">Pr√≥ximo (‚â§3 dias)</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 20px; height: 20px; background: #e74c3c; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>
                        <span style="color: white; font-size: 13px; font-weight: 500;">Atrasado</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 20px; height: 20px; background: #95a5a6; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>
                        <span style="color: white; font-size: 13px; font-weight: 500;">Finalizado</span>
                    </div>
                </div>

                <!-- Calend√°rio FullCalendar -->
                <div id="calendar-view" style="display: block;">
                    <div id="calendar-container"></div>
                </div>

                <!-- Visualiza√ß√£o em Lista (oculta por padr√£o) -->
                <div id="list-view" style="display: none;">
                    <div class="table-scroll-container">
                        <table id="table-agenda">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Hor√°rio</th>
                                    <th>Cliente</th>
                                    <th>Local</th>
                                    <th>Tipo Capta√ß√£o</th>
                                    <th>Prazo Entrega</th>
                                    <th>Status</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-agenda">
                                <tr><td colspan="8" class="loading">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Kits de Equipamentos -->
            <div id="kits-equipamentos-section" class="content-card hidden">
                <h2 style="color: #000000 !important; font-weight: 700;">Kits de Equipamentos</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="openModalKit()">‚ûï Novo Kit</button>
                </div>
                <div class="table-scroll-container">
                    <table id="table-kits">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Descri√ß√£o</th>
                                <th>Itens</th>
                                <th>Valor Total</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-kits">
                            <tr><td colspan="5" class="loading">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <!-- Modals (continua√ß√£o no pr√≥ximo arquivo devido ao limite de tamanho) -->
    
    <!-- Modal Visualizar Motivo Inativa√ß√£o -->
    <div id="modal-motivo-inativacao" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <div style="display: flex; align-items: center; margin-bottom: 20px;">
                <span style="font-size: 48px; margin-right: 15px;">‚ÑπÔ∏è</span>
                <h2 style="margin: 0; color: #34495e;">Informa√ß√µes da Inativa√ß√£o</h2>
            </div>
            
            <div style="background: #ecf0f1; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <div style="margin-bottom: 15px;">
                    <label style="font-weight: bold; color: #7f8c8d; font-size: 12px; text-transform: uppercase;">Nome:</label>
                    <p id="motivo-nome" style="margin: 5px 0 0 0; font-size: 16px; color: #2c3e50;"></p>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="font-weight: bold; color: #7f8c8d; font-size: 12px; text-transform: uppercase;">Data de Inativa√ß√£o:</label>
                    <p id="motivo-data" style="margin: 5px 0 0 0; font-size: 16px; color: #2c3e50;"></p>
                </div>
                
                <div>
                    <label style="font-weight: bold; color: #7f8c8d; font-size: 12px; text-transform: uppercase;">Motivo:</label>
                    <p id="motivo-texto" style="margin: 5px 0 0 0; font-size: 16px; color: #2c3e50; line-height: 1.6; white-space: pre-wrap;"></p>
                </div>
            </div>
            
            <div style="display: flex; justify-content: flex-end;">
                <button onclick="closeModalMotivoInativacao()" style="padding: 12px 30px; border: none; background: #3498db; color: white; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 14px;">
                    Fechar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal Inativar Cliente -->
    <div id="modal-inativar-cliente" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <h2 style="margin-top: 0; color: #e74c3c;">‚õî Inativar Cliente</h2>
            
            <p style="margin-bottom: 20px; color: #555;">
                Cliente: <strong id="inativar-cliente-nome"></strong>
            </p>
            
            <div class="form-group">
                <label>Motivo da Inativa√ß√£o: <span style="color: red;">*</span></label>
                <textarea id="inativar-cliente-motivo" rows="4" required 
                    style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-family: inherit; resize: vertical;"
                    placeholder="Descreva o motivo da inativa√ß√£o..."></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button onclick="closeModalInativarCliente()" style="padding: 10px 20px; border: 2px solid #95a5a6; background: white; color: #555; border-radius: 5px; cursor: pointer; font-weight: bold;">
                    Cancelar
                </button>
                <button onclick="confirmarInativarCliente()" style="padding: 10px 20px; border: none; background: #e74c3c; color: white; border-radius: 5px; cursor: pointer; font-weight: bold;">
                    Inativar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal Inativar Fornecedor -->
    <div id="modal-inativar-fornecedor" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <h2 style="margin-top: 0; color: #e74c3c;">‚õî Inativar Fornecedor</h2>
            
            <p style="margin-bottom: 20px; color: #555;">
                Fornecedor: <strong id="inativar-fornecedor-nome"></strong>
            </p>
            
            <div class="form-group">
                <label>Motivo da Inativa√ß√£o: <span style="color: red;">*</span></label>
                <textarea id="inativar-fornecedor-motivo" rows="4" required 
                    style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-family: inherit; resize: vertical;"
                    placeholder="Descreva o motivo da inativa√ß√£o..."></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button onclick="closeModalInativarFornecedor()" style="padding: 10px 20px; border: 2px solid #95a5a6; background: white; color: #555; border-radius: 5px; cursor: pointer; font-weight: bold;">
                    Cancelar
                </button>
                <button onclick="confirmarInativarFornecedor()" style="padding: 10px 20px; border: none; background: #e74c3c; color: white; border-radius: 5px; cursor: pointer; font-weight: bold;">
                    Inativar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal Concilia√ß√£o Geral Extrato -->
    <div id="modal-conciliacao-geral" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; overflow-y: auto; padding: 20px;">
        <div style="background: white; margin: 0 auto; border-radius: 12px; max-width: 1200px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <div style="padding: 25px; border-bottom: 2px solid #ecf0f1;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0; color: #27ae60;">üîÑ Concilia√ß√£o Geral de Extrato</h2>
                    <button onclick="fecharConciliacaoGeral()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #95a5a6;">&times;</button>
                </div>
                <p style="margin: 10px 0 0 0; color: #7f8c8d; font-size: 14px;">Selecione as transa√ß√µes e configure categoria/subcategoria para criar lan√ßamentos automaticamente</p>
            </div>
            
            <div style="padding: 25px;">
                <div id="conciliacao-transacoes-lista" style="margin-bottom: 20px;">
                    <!-- Conte√∫do ser√° preenchido via JavaScript -->
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: flex-end; padding-top: 20px; border-top: 2px solid #ecf0f1;">
                    <button onclick="fecharConciliacaoGeral()" class="btn btn-secondary" style="padding: 12px 30px;">
                        Cancelar
                    </button>
                    <button onclick="processarConciliacaoGeral()" class="btn btn-success" style="padding: 12px 30px; background: #27ae60; font-weight: bold;">
                        ‚úÖ Conciliar Selecionados
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Concilia√ß√£o Individual -->
    <div id="modal-conciliacao" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; overflow-y: auto; padding: 20px;">
        <div style="background: white; margin: 0 auto; border-radius: 12px; max-width: 1000px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <div style="padding: 25px; border-bottom: 2px solid #ecf0f1;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0; color: #3498db;">üîÑ Conciliar Transa√ß√£o</h2>
                    <button onclick="closeModal('modal-conciliacao')" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #95a5a6;">&times;</button>
                </div>
                <p style="margin: 10px 0 0 0; color: #7f8c8d; font-size: 14px;">Configure categoria/subcategoria e raz√£o social para conciliar</p>
            </div>
            
            <div style="padding: 25px;">
                <div id="transacao-conciliacao-form">
                    <!-- Preenchido via JavaScript -->
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: flex-end; padding-top: 20px; border-top: 2px solid #ecf0f1; margin-top: 20px;">
                    <button onclick="closeModal('modal-conciliacao')" class="btn btn-secondary" style="padding: 12px 30px;">
                        Cancelar
                    </button>
                    <button onclick="conciliarTransacaoIndividual()" class="btn btn-success" style="padding: 12px 30px; background: #27ae60; font-weight: bold;">
                        ‚úÖ Conciliar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Tipo de Sess√£o -->
    <div id="modal-tipo-sessao" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <h2 style="margin-top: 0; color: #9b59b6;">üì∏ Tipo de Sess√£o</h2>
            
            <input type="hidden" id="tipo-sessao-id">
            
            <div class="form-group">
                <label>Nome do Tipo:</label>
                <input type="text" id="tipo-sessao-nome" required placeholder="Ex: Ensaio Newborn" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" id="tipo-sessao-ativa" checked>
                    Tipo Ativo
                </label>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeModalTipoSessao()">Cancelar</button>
                <button class="btn btn-success" onclick="salvarTipoSessao()">üíæ Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal Contrato -->
    <div id="modal-contrato" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; overflow-y: auto;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 700px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); margin: 20px;">
            <h2 style="margin-top: 0; color: #9b59b6;">üìÑ Contrato</h2>
            
            <input type="hidden" id="contrato-id-legacy">
            
            <div class="form-group">
                <label>*N√∫mero do Contrato: <span style="font-size: 12px; color: #666;">(Gerado automaticamente)</span></label>
                <input type="text" id="contrato-numero-legacy" required readonly placeholder="Aguardando..." style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; background-color: #f5f5f5; cursor: not-allowed;">
            </div>
            
            <div class="form-group">
                <label>Cliente:</label>
                <select id="contrato-cliente-id" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
                    <option value="">Selecione o cliente</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>*Descri√ß√£o:</label>
                <textarea id="contrato-descricao-old-unused" required rows="3" placeholder="Descreva o contrato..." style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;"></textarea>
            </div>
            
            <div class="form-group">
                <label>*Valor Total:</label>
                <input type="number" id="contrato-valor-total" step="0.01" min="0" required placeholder="0.00" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
            </div>
            
            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label>*Data In√≠cio:</label>
                    <input type="date" id="contrato-data-inicio" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
                </div>
                <div class="form-group">
                    <label>Data Fim:</label>
                    <input type="date" id="contrato-data-fim" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
                </div>
            </div>
            
            <div class="form-group">
                <label>Status:</label>
                <select id="contrato-status" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
                    <option value="ativo">Ativo</option>
                    <option value="concluido">Conclu√≠do</option>
                    <option value="cancelado">Cancelado</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Observa√ß√µes:</label>
                <textarea id="contrato-observacoes" rows="3" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;"></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeModalContrato()">Cancelar</button>
                <button class="btn btn-success" onclick="salvarContrato()">üíæ Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal Sess√£o -->
    <div id="modal-sessao" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <h2 style="margin-top: 0; color: #9b59b6;">üì∏ Sess√£o Fotogr√°fica</h2>
            
            <input type="hidden" id="sessao-id">
            
            <div class="form-group">
                <label>T√≠tulo:</label>
                <input type="text" id="sessao-titulo" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;" placeholder="Ex: Ensaio Gestante - Maria Silva">
            </div>
            
            <div class="form-group">
                <label>Data da Sess√£o:</label>
                <input type="date" id="sessao-data-sessao" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
            </div>
            
            <div class="form-group">
                <label>Dura√ß√£o (minutos):</label>
                <input type="number" id="sessao-duracao" min="0" step="15" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;" placeholder="Ex: 60">
            </div>
            
            <div class="form-group">
                <label>Tipo de Sess√£o:</label>
                <select id="sessao-tipo-sessao-id" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
                    <option value="">Selecione o tipo (opcional)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Contrato:</label>
                <select id="sessao-contrato-id" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
                    <option value="">Selecione o contrato (opcional)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Cliente:</label>
                <select id="sessao-cliente-id" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
                    <option value="">Selecione o cliente (opcional)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Valor (R$):</label>
                <input type="number" id="sessao-valor" min="0" step="0.01" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;" placeholder="0,00">
            </div>
            
            <div class="form-group">
                <label>Observa√ß√µes:</label>
                <textarea id="sessao-observacoes" rows="3" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;" placeholder="Observa√ß√µes adicionais..."></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeModalSessao()">Cancelar</button>
                <button class="btn btn-success" onclick="salvarSessao()">üíæ Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal Agenda -->
    <div id="modal-agenda" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <h2 style="margin-top: 0; color: #9b59b6;">üìÖ Agendamento</h2>
            
            <input type="hidden" id="agenda-id">
            
            <div class="form-group">
                <label>Cliente:</label>
                <select id="agenda-cliente-id" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
                    <option value="">Selecione o cliente</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Data e Hora:</label>
                <input type="datetime-local" id="agenda-data-hora" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
            </div>
            
            <div class="form-group">
                <label>Local:</label>
                <input type="text" id="agenda-local" placeholder="Ex: Est√∫dio, Externa, Casa do cliente" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
            </div>
            
            <div class="form-group">
                <label>Tipo:</label>
                <input type="text" id="agenda-tipo" placeholder="Ex: Ensaio Fam√≠lia" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
            </div>
            
            <div class="form-group">
                <label>Status:</label>
                <select id="agenda-status" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
                    <option value="confirmado">Confirmado</option>
                    <option value="pendente">Pendente</option>
                    <option value="cancelado">Cancelado</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Observa√ß√µes:</label>
                <textarea id="agenda-observacoes" rows="3" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;"></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeModalAgenda()">Cancelar</button>
                <button class="btn btn-success" onclick="salvarAgenda()">üíæ Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal Produto -->
    <div id="modal-produto" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <h2 style="margin-top: 0; color: #9b59b6;">üì¶ Produto</h2>
            
            <input type="hidden" id="produto-id">
            
            <div class="form-group">
                <label>Nome:</label>
                <input type="text" id="produto-nome" required placeholder="Ex: Papel Fotogr√°fico A4" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
            </div>
            
            <div class="form-group">
                <label>C√≥digo:</label>
                <input type="text" id="produto-codigo" placeholder="Ex: PF-A4-001" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
            </div>
            
            <div class="form-group">
                <label>Quantidade:</label>
                <input type="number" id="produto-quantidade" min="0" step="1" required placeholder="0" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
            </div>
            
            <div class="form-group">
                <label>Unidade:</label>
                <select id="produto-unidade" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
                    <option value="un">Unidade</option>
                    <option value="cx">Caixa</option>
                    <option value="pc">Pacote</option>
                    <option value="kg">Quilograma</option>
                    <option value="l">Litro</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Valor Unit√°rio:</label>
                <input type="number" id="produto-valor-unitario" step="0.01" min="0" placeholder="0.00" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeModalProduto()">Cancelar</button>
                <button class="btn btn-success" onclick="salvarProduto()">üíæ Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal Movimenta√ß√£o -->
    <div id="modal-movimentacao" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <h2 style="margin-top: 0; color: #9b59b6;">üìã Movimenta√ß√£o de Estoque</h2>
            
            <input type="hidden" id="movimentacao-id">
            
            <div class="form-group">
                <label>Produto:</label>
                <select id="movimentacao-produto-id" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
                    <option value="">Selecione o produto</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Tipo:</label>
                <select id="movimentacao-tipo" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
                    <option value="entrada">Entrada</option>
                    <option value="saida">Sa√≠da</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Quantidade:</label>
                <input type="number" id="movimentacao-quantidade" min="1" step="1" required placeholder="0" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
            </div>
            
            <div class="form-group">
                <label>Data:</label>
                <input type="date" id="movimentacao-data" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
            </div>
            
            <div class="form-group">
                <label>Observa√ß√µes:</label>
                <textarea id="movimentacao-observacoes" rows="3" placeholder="Motivo da movimenta√ß√£o..." style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;"></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeModalMovimentacao()">Cancelar</button>
                <button class="btn btn-success" onclick="salvarMovimentacao()">üíæ Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal Kit -->
    <div id="modal-kit" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <h2 style="margin-top: 0; color: #9b59b6;">üéí Kit de Equipamentos</h2>
            
            <input type="hidden" id="kit-id">
            
            <div class="form-group">
                <label>Nome do Kit:</label>
                <input type="text" id="kit-nome" required placeholder="Ex: Kit Ensaio Externo" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
            </div>
            
            <div class="form-group">
                <label>Descri√ß√£o:</label>
                <textarea id="kit-descricao" rows="3" placeholder="Descri√ß√£o dos itens inclu√≠dos no kit..." style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;"></textarea>
            </div>
            
            <div class="form-group">
                <label>Itens (um por linha):</label>
                <textarea id="kit-itens" rows="5" placeholder="C√¢mera Canon 5D&#10;Lente 50mm&#10;Flash Speedlite&#10;Trip√©" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;"></textarea>
            </div>
            
            <div class="form-group">
                <label>Valor Total:</label>
                <input type="number" id="kit-valor-total" step="0.01" min="0" placeholder="0.00" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeModalKit()">Cancelar</button>
                <button class="btn btn-success" onclick="salvarKit()">üíæ Salvar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Comiss√£o -->
    <div id="modal-comissao" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <h2 style="margin-top: 0; color: #9b59b6;">üí∞ Comiss√£o</h2>
            
            <input type="hidden" id="comissao-id">
            
            <div class="form-group">
                <label>Contrato:</label>
                <select id="comissao-contrato-id" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
                    <option value="">Selecione o contrato</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Tipo:</label>
                <select id="comissao-tipo" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
                    <option value="percentual">Percentual</option>
                    <option value="fixo">Valor Fixo</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Valor:</label>
                <input type="number" id="comissao-valor" step="0.01" min="0" placeholder="0.00" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
            </div>
            
            <div class="form-group">
                <label>Percentual (%):</label>
                <input type="number" id="comissao-percentual" step="0.01" min="0" max="100" placeholder="0.00" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeModalComissao()">Cancelar</button>
                <button class="btn btn-success" onclick="salvarComissao()">üíæ Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal Sess√£o Equipe -->
    <div id="modal-sessao-equipe" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <h2 style="margin-top: 0; color: #9b59b6;">üë• Membro da Equipe</h2>
            
            <input type="hidden" id="sessao-equipe-id">
            
            <div class="form-group">
                <label>Sess√£o:</label>
                <select id="sessao-equipe-sessao-id" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
                    <option value="">Selecione a sess√£o</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Membro:</label>
                <input type="text" id="sessao-equipe-membro" required placeholder="Nome do membro" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
            </div>
            
            <div class="form-group">
                <label>Fun√ß√£o:</label>
                <input type="text" id="sessao-equipe-funcao" placeholder="Ex: Fot√≥grafo, Assistente" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
            </div>
            
            <div class="form-group">
                <label>Observa√ß√µes:</label>
                <textarea id="sessao-equipe-observacoes" rows="3" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;"></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeModalSessaoEquipe()">Cancelar</button>
                <button class="btn btn-success" onclick="salvarSessaoEquipe()">üíæ Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal Tag -->
    <div id="modal-tag" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <h2 style="margin-top: 0; color: #9b59b6;">üè∑Ô∏è Tag de Trabalho</h2>
            
            <input type="hidden" id="tag-id">
            
            <div class="form-group">
                <label>Nome:</label>
                <input type="text" id="tag-nome" required placeholder="Ex: Urgente, Revis√£o" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
            </div>
            
            <div class="form-group">
                <label>Cor:</label>
                <input type="color" id="tag-cor" value="#9b59b6" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; height: 50px;">
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeModalTag()">Cancelar</button>
                <button class="btn btn-success" onclick="salvarTag()">üíæ Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal Template -->
    <div id="modal-template" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <h2 style="margin-top: 0; color: #9b59b6;">üë• Template de Equipe</h2>
            
            <input type="hidden" id="template-id">
            
            <div class="form-group">
                <label>Nome do Template:</label>
                <input type="text" id="template-nome" required placeholder="Ex: Equipe Casamento Grande" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
            </div>
            
            <div class="form-group">
                <label>Descri√ß√£o:</label>
                <textarea id="template-descricao" rows="3" placeholder="Descri√ß√£o do template..." style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;"></textarea>
            </div>
            
            <div class="form-group">
                <label>Membros (um por linha):</label>
                <textarea id="template-membros" rows="5" placeholder="Fot√≥grafo Principal&#10;Fot√≥grafo Assistente&#10;Videomaker&#10;Assistente Geral" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;"></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeModalTemplate()">Cancelar</button>
                <button class="btn btn-success" onclick="salvarTemplate()">üíæ Salvar</button>
            </div>
        </div>
    </div>
    
    <script>
        // ====================================
        // HELPER CSRF - INCLUIR TOKEN EM TODAS AS REQUISI√á√ïES
        // ====================================
        
        // Obter token CSRF do meta tag
        function getCSRFToken() {
            const meta = document.querySelector('meta[name="csrf-token"]');
            return meta ? meta.content : '';
        }
        
        // Wrapper para fetch com CSRF autom√°tico
        async function fetchWithCSRF(url, options = {}) {
            const csrfToken = getCSRFToken();
            
            // Configurar headers padr√£o
            const defaultHeaders = {
                'Content-Type': 'application/json'
            };
            
            // Adicionar CSRF token se m√©todo n√£o for GET
            if (!options.method || options.method.toUpperCase() !== 'GET') {
                defaultHeaders['X-CSRFToken'] = csrfToken;
            }
            
            // Mesclar headers
            options.headers = {
                ...defaultHeaders,
                ...options.headers
            };
            
            // Garantir credentials
            if (!options.credentials) {
                options.credentials = 'include';
            }
            
            return fetch(url, options);
        }
        
        // ====================================
        // INTERCEPTADOR GLOBAL DE FETCH - AUTO CSRF
        // ====================================
        
        // Salvar fetch original
        const originalFetch = window.fetch;
        
        // Substituir fetch global para incluir CSRF automaticamente
        window.fetch = function(url, options = {}) {
            // Se for requisi√ß√£o para API interna (n√£o GET), adicionar CSRF
            if (typeof url === 'string' && url.startsWith('/api')) {
                const method = options.method || 'GET';
                if (method.toUpperCase() !== 'GET') {
                    const csrfToken = getCSRFToken();
                    
                    // Inicializar headers como objeto simples se n√£o existir
                    if (!options.headers) {
                        options.headers = {};
                    }
                    
                    // Se for Headers object, converter para objeto simples
                    if (options.headers instanceof Headers) {
                        const headersObj = {};
                        options.headers.forEach((value, key) => {
                            headersObj[key] = value;
                        });
                        options.headers = headersObj;
                    }
                    
                    // Adicionar CSRF token se n√£o existir
                    if (!options.headers['X-CSRFToken'] && csrfToken) {
                        options.headers['X-CSRFToken'] = csrfToken;
                    }
                }
                
                // Garantir credentials
                if (!options.credentials) {
                    options.credentials = 'include';
                }
            }
            
            return originalFetch(url, options);
        };
        
        // ====================================
        // GERENCIAMENTO DE USU√ÅRIOS (ADMIN)
        // ====================================
        
        let currentUsuarioFilter = 'ativos';
        
        // Carregar usu√°rios
        async function loadUsuarios() {
            try {
                const response = await fetch('/api/usuarios');
                const data = await response.json();
                
                if (data.success) {
                    renderUsuarios(data.usuarios);
                } else {
                    showToast('Erro ao carregar usu√°rios: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Erro ao carregar usu√°rios:', error);
                showToast('Erro ao carregar usu√°rios', 'error');
            }
        }
        
        // Renderizar tabela de usu√°rios
        function renderUsuarios(usuarios) {
            const tbody = document.getElementById('tbody-usuarios');
            
            // Filtrar usu√°rios baseado na tab ativa
            let usuariosFiltrados = usuarios;
            if (currentUsuarioFilter === 'ativos') {
                usuariosFiltrados = usuarios.filter(u => u.ativo);
            } else if (currentUsuarioFilter === 'inativos') {
                usuariosFiltrados = usuarios.filter(u => !u.ativo);
            }
            
            if (usuariosFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="loading">Nenhum usu√°rio encontrado</td></tr>';
                return;
            }
            
            tbody.innerHTML = usuariosFiltrados.map(usuario => `
                <tr>
                    <td>${usuario.id}</td>
                    <td>${usuario.username}</td>
                    <td>${usuario.nome_completo || '-'}</td>
                    <td>${usuario.email || '-'}</td>
                    <td><span style="padding: 4px 8px; border-radius: 4px; font-weight: bold; ${usuario.tipo === 'admin' ? 'background: #e74c3c; color: white;' : 'background: #3498db; color: white;'}">${usuario.tipo === 'admin' ? '‚öôÔ∏è Admin' : 'üë§ Cliente'}</span></td>
                    <td>${usuario.cliente_nome || '-'}</td>
                    <td><span style="padding: 4px 8px; border-radius: 4px; font-weight: bold; ${usuario.ativo ? 'background: #27ae60; color: white;' : 'background: #e74c3c; color: white;'}">${usuario.ativo ? '‚úÖ Ativo' : '‚ùå Inativo'}</span></td>
                    <td>${usuario.ultima_sessao ? new Date(usuario.ultima_sessao).toLocaleString('pt-BR') : 'Nunca'}</td>
                    <td>
                        <button class="btn-action" onclick="editUsuario(${usuario.id})" title="Editar">‚úèÔ∏è</button>
                        <button class="btn-action" onclick="toggleUsuarioStatus(${usuario.id}, ${!usuario.ativo})" title="${usuario.ativo ? 'Inativar' : 'Ativar'}">${usuario.ativo ? '‚ùå' : '‚úÖ'}</button>
                        ${usuario.tipo !== 'admin' ? `<button class="btn-action" onclick="deleteUsuario(${usuario.id})" title="Excluir">üóëÔ∏è</button>` : ''}
                    </td>
                </tr>
            `).join('');
        }
        
        // Mudar tab de usu√°rios
        function showUsuariosTab(tipo) {
            currentUsuarioFilter = tipo;
            
            // Atualizar bot√µes
            ['ativos', 'inativos', 'todos'].forEach(t => {
                const btn = document.getElementById(`tab-usuarios-${t}`);
                if (t === tipo) {
                    btn.style.background = t === 'ativos' ? '#27ae60' : (t === 'inativos' ? '#e74c3c' : '#3498db');
                    btn.style.color = 'white';
                } else {
                    btn.style.background = '#bdc3c7';
                    btn.style.color = '#555';
                }
            });
            
            loadUsuarios();
        }
        
        // Abrir modal de usu√°rio
        function openModalUsuario(usuarioId = null) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000;';
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
                    <h2 style="margin: 0 0 20px 0;">${usuarioId ? 'Editar Usu√°rio' : '‚ûï Novo Usu√°rio'}</h2>
                    <form id="form-usuario">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Username:</label>
                            <input type="text" id="usuario-username" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Nome Completo:</label>
                            <input type="text" id="usuario-nome-completo" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">E-mail:</label>
                            <input type="email" id="usuario-email" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Senha:${usuarioId ? ' (deixe em branco para manter)' : ''}</label>
                            <input type="password" id="usuario-senha" ${!usuarioId ? 'required' : ''} style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Tipo:</label>
                            <select id="usuario-tipo" onchange="toggleClienteSelect()" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="cliente">Cliente</option>
                                <option value="admin">Administrador</option>
                            </select>
                        </div>
                        <div id="cliente-select-container" style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Cliente Associado:</label>
                            <select id="usuario-cliente-id" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="">-- Selecione um cliente --</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="submit" class="btn btn-primary" style="flex: 1;">üíæ Salvar</button>
                            <button type="button" class="btn" onclick="this.closest('div[style*=\\'position: fixed\\']').remove()" style="flex: 1; background: #95a5a6; color: white;">‚ùå Cancelar</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Carregar clientes para o select
            loadClientesSelect();
            
            // Se for edi√ß√£o, carregar dados do usu√°rio
            if (usuarioId) {
                loadUsuarioData(usuarioId);
            }
            
            // Submit do formul√°rio
            document.getElementById('form-usuario').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveUsuario(usuarioId, modal);
            });
        }
        
        // Carregar clientes para o select
        async function loadClientesSelect() {
            try {
                const response = await fetch('/api/clientes');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('usuario-cliente-id');
                    select.innerHTML = '<option value="">-- Selecione um cliente --</option>' +
                        data.clientes.filter(c => c.ativo).map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
                }
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
            }
        }
        
        // Toggle visibilidade do select de cliente
        function toggleClienteSelect() {
            const tipo = document.getElementById('usuario-tipo').value;
            const container = document.getElementById('cliente-select-container');
            container.style.display = tipo === 'cliente' ? 'block' : 'none';
        }
        
        // Carregar dados do usu√°rio para edi√ß√£o
        async function loadUsuarioData(usuarioId) {
            try {
                const response = await fetch(`/api/usuarios/${usuarioId}`);
                const data = await response.json();
                
                if (data.success) {
                    const usuario = data.usuario;
                    document.getElementById('usuario-username').value = usuario.username;
                    document.getElementById('usuario-nome-completo').value = usuario.nome_completo || '';
                    document.getElementById('usuario-email').value = usuario.email || '';
                    document.getElementById('usuario-tipo').value = usuario.tipo;
                    if (usuario.cliente_id) {
                        document.getElementById('usuario-cliente-id').value = usuario.cliente_id;
                    }
                    toggleClienteSelect();
                }
            } catch (error) {
                console.error('Erro ao carregar usu√°rio:', error);
            }
        }
        
        // Salvar usu√°rio
        async function saveUsuario(usuarioId, modal) {
            const dados = {
                username: document.getElementById('usuario-username').value,
                nome_completo: document.getElementById('usuario-nome-completo').value,
                email: document.getElementById('usuario-email').value,
                tipo: document.getElementById('usuario-tipo').value,
                cliente_id: document.getElementById('usuario-cliente-id').value || null
            };
            
            const senha = document.getElementById('usuario-senha').value;
            if (senha) {
                dados.password = senha;
            }
            
            try {
                const url = usuarioId ? `/api/usuarios/${usuarioId}` : '/api/usuarios';
                const method = usuarioId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(usuarioId ? 'Usu√°rio atualizado com sucesso!' : 'Usu√°rio criado com sucesso!', 'success');
                    modal.remove();
                    loadUsuarios();
                } else {
                    showToast('Erro: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Erro ao salvar usu√°rio:', error);
                showToast('Erro ao salvar usu√°rio', 'error');
            }
        }
        
        // Editar usu√°rio
        function editUsuario(usuarioId) {
            openModalUsuario(usuarioId);
        }
        
        // Alternar status do usu√°rio
        async function toggleUsuarioStatus(usuarioId, ativar) {
            const confirmado = await showConfirm(
                `Deseja realmente ${ativar ? 'ativar' : 'inativar'} este usu√°rio?`,
                {
                    title: `${ativar ? '‚úÖ' : '‚è∏Ô∏è'} ${ativar ? 'Ativar' : 'Inativar'} Usu√°rio`,
                    confirmText: ativar ? 'Ativar' : 'Inativar',
                    cancelText: 'Cancelar',
                    type: ativar ? 'success' : 'warning'
                }
            );
            if (!confirmado) return;
            
            try {
                const response = await fetch(`/api/usuarios/${usuarioId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ativo: ativar })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(`Usu√°rio ${ativar ? 'ativado' : 'inativado'} com sucesso!`, 'success');
                    loadUsuarios();
                } else {
                    showToast('Erro: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Erro ao alterar status:', error);
                showToast('Erro ao alterar status do usu√°rio', 'error');
            }
        }
        
        // Excluir usu√°rio
        async function deleteUsuario(usuarioId) {
            const confirmado = await showConfirm(
                'Esta a√ß√£o n√£o pode ser desfeita! Todos os dados associados a este usu√°rio ser√£o permanentemente removidos.',
                {
                    title: 'üóëÔ∏è Excluir Usu√°rio',
                    confirmText: 'Excluir Permanentemente',
                    cancelText: 'Cancelar',
                    type: 'error'
                }
            );
            if (!confirmado) return;
            
            try {
                const response = await fetch(`/api/usuarios/${usuarioId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('Usu√°rio exclu√≠do com sucesso!', 'success');
                    loadUsuarios();
                } else {
                    showToast('Erro: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Erro ao excluir usu√°rio:', error);
                showToast('Erro ao excluir usu√°rio', 'error');
            }
        }
        
        // Atualizar lista de usu√°rios
        function refreshUsuarios() {
            loadUsuarios();
            showToast('Lista de usu√°rios atualizada!', 'success');
        }
        
        // ====================================
        // AUTENTICA√á√ÉO E USU√ÅRIO
        // ====================================
        
        // Verificar usu√°rio logado
        async function checkUserAuth() {
            console.log('üîê checkUserAuth: Iniciando verifica√ß√£o de autentica√ß√£o...');
            try {
                // Verificar autentica√ß√£o e carregar dados do usu√°rio
                const response = await fetch('/api/auth/verify');
                console.log('üì° Response status:', response.status);
                
                const data = await response.json();
                console.log('üì¶ Dados recebidos:', data);
                
                if (data.success && data.authenticated && data.usuario) {
                    console.log('‚úÖ Usu√°rio autenticado:', data.usuario.username);
                    
                    // üíæ CR√çTICO: Salvar dados do usu√°rio no sessionStorage para app.js
                    sessionStorage.setItem('usuario', JSON.stringify(data.usuario));
                    console.log('üíæ Usu√°rio salvo no sessionStorage:', data.usuario);
                    
                    // Atualizar nome do usu√°rio na sidebar
                    const userElement = document.getElementById('userNameSidebar');
                    console.log('üë§ Elemento userNameSidebar:', userElement);
                    
                    if (userElement) {
                        const nome = data.usuario.nome_completo || data.usuario.username || 'Usu√°rio';
                        userElement.textContent = `üë§ ${nome}`;
                        console.log('‚úÖ Nome do usu√°rio atualizado para:', nome);
                    } else {
                        console.error('‚ùå Elemento userNameSidebar n√£o encontrado no DOM!');
                    }
                    
                    // Atualizar tipo de usu√°rio
                    const userTypeElement = document.getElementById('userTypeSidebar');
                    if (userTypeElement) {
                        const tipo = data.usuario.tipo === 'admin' ? 'üëë Administrador' : 'üë§ Usu√°rio';
                        userTypeElement.textContent = tipo;
                        console.log('‚úÖ Tipo de usu√°rio atualizado para:', tipo);
                    }
                    
                    // Mostrar bot√£o de admin se for administrador
                    const adminBtn = document.getElementById('adminBtn');
                    if (adminBtn && data.usuario.tipo === 'admin') {
                        adminBtn.style.display = 'block';
                        console.log('‚úÖ Bot√£o de admin exibido');
                    } else {
                        console.log('‚ÑπÔ∏è Bot√£o de admin oculto (usu√°rio n√£o √© admin)');
                    }
                    
                    // üÜï MULTI-EMPRESA: Carregar empresas dispon√≠veis
                    if (data.empresas_disponiveis && data.empresas_disponiveis.length > 0) {
                        console.log('üè¢ Carregando empresas dispon√≠veis:', data.empresas_disponiveis);
                        loadEmpresasSelector(data.empresas_disponiveis, data.empresa_atual);
                    }
                    
                    // üÜï Armazenar empresa_id atual globalmente
                    if (data.empresa_atual && data.empresa_atual.id) {
                        window.currentEmpresaId = data.empresa_atual.id;
                        console.log('üè¢ window.currentEmpresaId definido como:', window.currentEmpresaId);
                    } else if (data.empresas_disponiveis && data.empresas_disponiveis.length > 0) {
                        // FALLBACK: Se empresa_atual n√£o existe, usar primeira empresa dispon√≠vel
                        window.currentEmpresaId = data.empresas_disponiveis[0].id;
                        console.warn('‚ö†Ô∏è Empresa atual n√£o definida! Usando primeira empresa dispon√≠vel:', window.currentEmpresaId);
                    } else {
                        console.error('‚ùå Empresa atual n√£o encontrada e nenhuma empresa dispon√≠vel!');
                    }
                    
                    // üÜï Filtrar menu baseado nas permiss√µes do usu√°rio
                    console.log('üîê Filtrando menu baseado nas permiss√µes...');
                    filterMenuByPermissions(data.usuario);
                    
                    // Carregar permiss√µes se necess√°rio (app.js)
                    if (typeof carregarPermissoesUsuario === 'function') {
                        console.log('üìã Carregando permiss√µes...');
                        await carregarPermissoesUsuario();
                    } else {
                        console.warn('‚ö†Ô∏è Fun√ß√£o carregarPermissoesUsuario n√£o encontrada');
                    }
                } else {
                    console.error('‚ùå Usu√°rio n√£o autenticado');
                    // N√£o autenticado, redirecionar para login
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('‚ùå Erro ao verificar autentica√ß√£o:', error);
                console.error('Stack trace:', error.stack);
                // Em caso de erro, tamb√©m redirecionar para login
                // window.location.href = '/login';
            }
        }
        
        // üÜï Filtrar menu baseado nas permiss√µes do usu√°rio
        function filterMenuByPermissions(usuario) {
            console.log('üîê filterMenuByPermissions iniciada');
            console.log('üë§ Usu√°rio:', usuario);
            console.log('üìã Permiss√µes:', usuario.permissoes);
            console.log('üè∑Ô∏è Tipo:', usuario.tipo);
            
            // Admin tem acesso a tudo
            if (usuario.tipo === 'admin') {
                console.log('üëë Usu√°rio admin - mostrar todos os menus');
                return;
            }
            
            // Array de permiss√µes do usu√°rio
            const permissoes = usuario.permissoes || [];
            console.log('üìù Permiss√µes dispon√≠veis:', permissoes);
            
            // Selecionar todos os bot√µes com data-permission
            const botoes = document.querySelectorAll('[data-permission]');
            console.log('üîç Total de bot√µes com permiss√£o:', botoes.length);
            
            let ocultados = 0;
            let visiveis = 0;
            const menusComItensVisiveis = new Set(); // Rastrear menus que t√™m itens vis√≠veis no submenu
            
            // PRIMEIRA PASSAGEM: Verificar permiss√µes e identificar menus pai com itens vis√≠veis
            botoes.forEach(botao => {
                const permissaoRequerida = botao.getAttribute('data-permission');
                const temPermissao = permissoes.includes(permissaoRequerida);
                
                console.log(`  üìç Bot√£o: ${botao.textContent.trim().substring(0, 30)}...`);
                console.log(`     - Permiss√£o requerida: ${permissaoRequerida}`);
                console.log(`     - Tem permiss√£o? ${temPermissao}`);
                
                if (temPermissao) {
                    visiveis++;
                    // Se este bot√£o est√° dentro de um submenu, marcar o menu pai para ser vis√≠vel
                    const submenuParent = botao.closest('.submenu');
                    if (submenuParent) {
                        const submenuId = submenuParent.id;
                        if (submenuId && submenuId.startsWith('submenu-')) {
                            const menuPaiId = 'btn-' + submenuId.replace('submenu-', '');
                            menusComItensVisiveis.add(menuPaiId);
                            console.log(`     ‚ú® Item de submenu vis√≠vel - menu pai ${menuPaiId} deve ser mostrado`);
                        }
                    }
                } else {
                    // Ocultar bot√£o sem permiss√£o
                    botao.style.display = 'none';
                    ocultados++;
                }
            });
            
            // SEGUNDA PASSAGEM: Processar menus principais
            botoes.forEach(botao => {
                const btnId = botao.id;
                if (btnId && btnId.startsWith('btn-')) {
                    const permissaoRequerida = botao.getAttribute('data-permission');
                    const temPermissao = permissoes.includes(permissaoRequerida);
                    const submenuId = btnId.replace('btn-', 'submenu-');
                    const submenu = document.getElementById(submenuId);
                    
                    // Se o menu pai tem itens vis√≠veis no submenu, mant√™-lo vis√≠vel
                    if (menusComItensVisiveis.has(btnId)) {
                        botao.style.display = 'block';
                        if (submenu) {
                            // N√£o ocultar o submenu, apenas garantir que esteja dispon√≠vel
                            console.log(`     ‚úÖ Menu pai ${btnId} mantido vis√≠vel (tem itens de submenu acess√≠veis)`);
                        }
                    } else if (!temPermissao && submenu) {
                        // S√≥ ocultar submenu se o menu pai n√£o tem permiss√£o E n√£o tem itens vis√≠veis
                        submenu.style.display = 'none';
                        console.log(`     ‚Ü≥ Submenu ${submenuId} ocultado (sem permiss√£o e sem itens vis√≠veis)`);
                    }
                }
            });
            
            console.log(`‚úÖ Filtro conclu√≠do: ${visiveis} vis√≠veis, ${ocultados} ocultados`);
        }
        
        // üÜï MULTI-EMPRESA: Carregar seletor de empresas
        function loadEmpresasSelector(empresas, empresaAtual) {
            console.log('üè¢ loadEmpresasSelector chamada');
            console.log('  üì¶ empresas:', JSON.stringify(empresas, null, 2));
            console.log('  üè¢ empresaAtual:', JSON.stringify(empresaAtual, null, 2));
            
            const container = document.getElementById('empresaSelectorContainer');
            const selector = document.getElementById('empresaSelector');
            
            if (!container || !selector) {
                console.error('‚ùå Elementos do seletor n√£o encontrados!');
                return;
            }
            
            if (!empresas || empresas.length === 0) {
                console.log('‚ÑπÔ∏è Nenhuma empresa dispon√≠vel - seletor n√£o necess√°rio');
                return;
            }
            
            // Limpar op√ß√µes
            selector.innerHTML = '';
            
            // Adicionar empresas ao select
            empresas.forEach((empresa, index) => {
                console.log(`  [${index}] Adicionando empresa:`, empresa);
                const option = document.createElement('option');
                option.value = empresa.id;
                option.textContent = `üè¢ ${empresa.razao_social}`;
                if (empresaAtual && empresa.id === empresaAtual.id) {
                    option.selected = true;
                    console.log(`     ‚úÖ Empresa selecionada por padr√£o`);
                }
                selector.appendChild(option);
            });
            
            // Mostrar container
            container.style.display = 'block';
            console.log(`‚úÖ Seletor de empresas carregado com ${empresas.length} empresa(s)`);
        }
        
        // üÜï MULTI-EMPRESA: Trocar empresa
        async function switchEmpresa() {
            const selector = document.getElementById('empresaSelector');
            const empresaId = parseInt(selector.value);
            
            if (!empresaId) return;
            
            console.log('üîÑ Trocando para empresa:', empresaId);
            
            // Desabilitar seletor
            selector.disabled = true;
            
            try {
                const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
                
                const response = await fetch('/api/auth/switch-empresa', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ empresa_id: empresaId }),
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('‚úÖ Empresa trocada com sucesso');
                    
                    // Atualizar empresa_id global
                    window.currentEmpresaId = empresaId;
                    console.log('üè¢ window.currentEmpresaId atualizado para:', empresaId);
                    
                    showToast('Empresa alterada com sucesso! Recarregando...', 'success');
                    
                    // Recarregar p√°gina ap√≥s 1 segundo
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    console.error('‚ùå Erro ao trocar empresa:', result.error);
                    showToast(result.error || 'Erro ao trocar empresa', 'error');
                    selector.disabled = false;
                }
            } catch (error) {
                console.error('‚ùå Erro ao trocar empresa:', error);
                showToast('Erro de conex√£o com o servidor', 'error');
                selector.disabled = false;
            }
        }
        
        // Carregar primeira p√°gina permitida  
        function carregarPaginaInicial() {
            console.log('üè† Carregando p√°gina inicial...');
            
            // Ocultar todas as se√ß√µes primeiro
            const sections = document.querySelectorAll('.content-card');
            sections.forEach(section => section.classList.add('hidden'));
            
            // Mostrar dashboard como padr√£o
            const dashboardSection = document.getElementById('dashboard-section');
            if (dashboardSection) {
                dashboardSection.classList.remove('hidden');
                console.log('‚úÖ Dashboard carregado');
            }
        }
        
        // Fazer logout
        async function logoutUser() {
            const confirmado = await showConfirm(
                'Voc√™ ser√° desconectado e redirecionado para a tela de login.',
                {
                    title: 'üö™ Sair do Sistema',
                    confirmText: 'Sair',
                    cancelText: 'Continuar Conectado',
                    type: 'info'
                }
            );
            if (!confirmado) return;
            
            try {
                await fetchWithCSRF('/api/auth/logout', {
                    method: 'POST'
                });
                window.location.href = '/login';
            } catch (error) {
                console.error('Erro ao fazer logout:', error);
                window.location.href = '/login';
            }
        }
        
        // ====================================
        // INICIALIZA√á√ÉO
        // ====================================
        
        // Inicializar dados ao carregar a p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOMContentLoaded: P√°gina carregada, iniciando sistema...');
            
            // Verificar se toggleSubmenu est√° dispon√≠vel
            console.log('üîç Verificando fun√ß√£o toggleSubmenu:', typeof toggleSubmenu);
            
            // TESTE: Adicionar listener de click nos bot√µes de submenu para debug
            document.querySelectorAll('[id^="btn-"]').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    console.log('üî¥ CLICK EVENT CAPTURADO no bot√£o:', this.id);
                    console.log('   Target:', e.target);
                    console.log('   CurrentTarget:', e.currentTarget);
                });
            });
            
            // Verificar autentica√ß√£o primeiro
            console.log('üîê Chamando checkUserAuth...');
            checkUserAuth();
            
            // ============================================================================
            // SISTEMA DE HEARTBEAT - Mant√©m sess√£o ativa durante uso
            // ============================================================================
            // Fazer uma requisi√ß√£o leve a cada 5 minutos para renovar a sess√£o
            // e evitar timeout durante per√≠odos de inatividade
            setInterval(async function() {
                try {
                    console.log('üíì Heartbeat: Renovando sess√£o...');
                    const response = await fetch('/api/auth/verify');
                    if (response.ok) {
                        const data = await response.json();
                        if (!data.authenticated) {
                            console.warn('‚ö†Ô∏è Sess√£o expirada - redirecionando para login');
                            window.location.href = '/login';
                        } else {
                            console.log('‚úÖ Heartbeat: Sess√£o renovada com sucesso');
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Erro no heartbeat:', error);
                }
            }, 5 * 60 * 1000); // 5 minutos
            
            console.log('üíì Sistema de heartbeat iniciado (renova√ß√£o a cada 5 minutos)');
            
            // ============================================================================
            // DETECTOR DE INATIVIDADE - Avisa antes da sess√£o expirar
            // ============================================================================
            let ultimaAtividade = Date.now();
            let avisoMostrado = false;
            
            // Atualizar timestamp de atividade quando usu√°rio interagir
            const atualizarAtividade = () => {
                ultimaAtividade = Date.now();
                avisoMostrado = false;
            };
            
            // Monitorar atividade do usu√°rio
            document.addEventListener('mousemove', atualizarAtividade);
            document.addEventListener('keypress', atualizarAtividade);
            document.addEventListener('click', atualizarAtividade);
            document.addEventListener('scroll', atualizarAtividade);
            
            // Verificar inatividade a cada minuto
            setInterval(function() {
                const tempoInativo = Date.now() - ultimaAtividade;
                const minutosInativo = Math.floor(tempoInativo / 60000);
                
                // Avisar ap√≥s 20 minutos de inatividade (apenas uma vez)
                if (minutosInativo >= 20 && !avisoMostrado) {
                    avisoMostrado = true;
                    console.warn('‚ö†Ô∏è Usu√°rio inativo h√° 20 minutos');
                    
                    // Mostrar toast discreto
                    if (typeof showToast === 'function') {
                        showToast('‚è∞ Voc√™ est√° inativo h√° 20 minutos. A sess√£o expira em 4 horas sem atividade.', 'warning');
                    }
                }
            }, 60 * 1000); // Verificar a cada 1 minuto
            
            console.log('üëÅÔ∏è Detector de inatividade iniciado (aviso ap√≥s 20 minutos)');
            
            // Definir ano e m√™s atuais nos filtros do dashboard
            const hoje = new Date();
            const anoAtual = hoje.getFullYear();
            const mesAtual = hoje.getMonth() + 1; // getMonth() retorna 0-11
            
            const inputAno = document.getElementById('filter-ano-dashboard');
            const selectMes = document.getElementById('filter-mes-dashboard');
            
            // N√ÉO preencher ano/m√™s por padr√£o - mostrar √∫ltimos 12 meses
            // Usu√°rio pode selecionar se quiser filtrar por per√≠odo espec√≠fico
            if (inputAno) {
                inputAno.placeholder = anoAtual.toString(); // Apenas sugest√£o no placeholder
            }
            if (selectMes) {
                selectMes.value = ''; // Vazio = sem filtro de m√™s
            }
            
            // Carregar contas banc√°rias no in√≠cio (se tiver permiss√£o)
            const usuario = JSON.parse(sessionStorage.getItem('usuario') || '{}');
            const permissoes = usuario.permissoes || [];
            
            if (typeof loadContasBancarias === 'function' && (permissoes.includes('contas_view') || permissoes.includes('lancamentos_view'))) {
                console.log('Carregando contas banc√°rias...');
                loadContasBancarias();
            } else {
                console.log('‚è≠Ô∏è Contas banc√°rias: Usu√°rio sem permiss√£o, n√£o carregando');
            }
            
            // Carregar dashboard automaticamente (se tiver permiss√£o)
            if (typeof carregarDashboard === 'function' && (permissoes.includes('dashboard') || permissoes.includes('relatorios_view'))) {
                setTimeout(() => {
                    carregarDashboard();
                }, 1000);
            } else {
                console.log('‚è≠Ô∏è Dashboard: Usu√°rio sem permiss√£o, n√£o carregando');
            }
        });

        // ====================================
        // NAVEGA√á√ÉO DE SE√á√ïES
        // ====================================
        
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            const toggleBtn = document.querySelector('.toggle-sidebar-btn');
            
            if (sidebar && mainContent) {
                sidebar.classList.toggle('hidden');
                mainContent.classList.toggle('expanded');
                
                // Mudar o √≠cone do bot√£o
                if (sidebar.classList.contains('hidden')) {
                    toggleBtn.textContent = '¬ª';
                    toggleBtn.title = 'Mostrar Menu';
                } else {
                    toggleBtn.textContent = '¬´';
                    toggleBtn.title = 'Ocultar Menu';
                }
            }
        }
        
        // Fun√ß√£o de Toggle de Tema (Claro/Escuro)
        function toggleTheme() {
            const body = document.body;
            const themeBtn = document.getElementById('themeToggleBtn');
            
            // Toggle da classe dark-mode
            body.classList.toggle('dark-mode');
            
            // Salvar prefer√™ncia no localStorage
            const isDark = body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            
            // Atualizar √≠cone do bot√£o
            if (isDark) {
                themeBtn.innerHTML = '‚òÄÔ∏è Claro';
                themeBtn.title = 'Alternar para Tema Claro';
            } else {
                themeBtn.innerHTML = 'üåì Tema';
                themeBtn.title = 'Alternar Tema Claro/Escuro';
            }
            
            console.log('Tema alterado para:', isDark ? 'escuro' : 'claro');
        }
        
        // Carregar tema salvo ao iniciar
        window.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                const themeBtn = document.getElementById('themeToggleBtn');
                if (themeBtn) {
                    themeBtn.innerHTML = '‚òÄÔ∏è Claro';
                    themeBtn.title = 'Alternar para Tema Claro';
                }
            }
        });
        
        function showSection(sectionId) {
            console.log('%c üîç DEBUG - showSection() chamada ', 'background: #FF6B6B; color: white; font-weight: bold; padding: 4px;');
            console.log('  üìç sectionId:', sectionId);
            console.log('  üìç event.target:', event?.target);
            
            // NOTA: Verifica√ß√£o de permiss√µes temporariamente desabilitada para debug
            // A fun√ß√£o hasPermission n√£o est√° definida ainda
            // TODO: Implementar sistema de permiss√µes completo ou integrar com app.js
            
            // Ocultar todas as se√ß√µes
            const sections = document.querySelectorAll('.content-card');
            console.log('  üìä Total de se√ß√µes encontradas:', sections.length);
            sections.forEach(section => {
                section.classList.add('hidden');
            });
            
            // Mostrar a se√ß√£o selecionada
            const targetSection = document.getElementById(sectionId + '-section');
            console.log('  üéØ Se√ß√£o alvo:', sectionId + '-section', targetSection ? '‚úÖ Encontrada' : '‚ùå N√ÉO ENCONTRADA');
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }
            
            // Atualizar bot√µes de navega√ß√£o
            const navButtons = document.querySelectorAll('.nav-button');
            navButtons.forEach(button => {
                button.classList.remove('active');
            });
            
            // Marcar o bot√£o clicado como ativo
            if (event?.target) {
                event.target.classList.add('active');
            }
            
            // Carregar dados da se√ß√£o se necess√°rio
            console.log('  üîÑ Verificando qual fun√ß√£o carregar para:', sectionId);
            
            if (sectionId === 'clientes') {
                console.log('  ‚û°Ô∏è loadClientes:', typeof loadClientes);
                if (typeof loadClientes === 'function') loadClientes();
            } else if (sectionId === 'fornecedores') {
                console.log('  ‚û°Ô∏è loadFornecedoresTable:', typeof loadFornecedoresTable);
                if (typeof loadFornecedoresTable === 'function') loadFornecedoresTable();
            } else if (sectionId === 'categorias') {
                console.log('  ‚û°Ô∏è loadCategorias:', typeof loadCategorias);
                const usuario = JSON.parse(sessionStorage.getItem('usuario') || '{}');
                const permissoes = usuario.permissoes || [];
                if (typeof loadCategorias === 'function' && (permissoes.includes('categorias_view') || permissoes.includes('lancamentos_view'))) {
                    loadCategorias();
                } else {
                    console.log('  ‚è≠Ô∏è Categorias: Sem permiss√£o');
                }
            } else if (sectionId === 'contas-bancarias') {
                console.log('  ‚û°Ô∏è loadContasBancarias:', typeof loadContasBancarias);
                const usuario = JSON.parse(sessionStorage.getItem('usuario') || '{}');
                const permissoes = usuario.permissoes || [];
                if (typeof loadContasBancarias === 'function' && (permissoes.includes('contas_view') || permissoes.includes('lancamentos_view'))) {
                    loadContasBancarias();
                } else {
                    console.log('  ‚è≠Ô∏è Contas banc√°rias: Sem permiss√£o');
                }
            } else if (sectionId === 'contas-receber') {
                console.log('  ‚û°Ô∏è loadContasReceber:', typeof loadContasReceber);
                if (typeof loadContasReceber === 'function') loadContasReceber();
            } else if (sectionId === 'contas-pagar') {
                console.log('  ‚û°Ô∏è loadContasPagar:', typeof loadContasPagar);
                if (typeof loadContasPagar === 'function') loadContasPagar();
            } else if (sectionId === 'extrato-bancario') {
                console.log('  ‚û°Ô∏è carregarContasBancariasExtrato:', typeof carregarContasBancariasExtrato);
                console.log('  ‚û°Ô∏è loadExtratoTransacoes:', typeof loadExtratoTransacoes);
                if (typeof carregarContasBancariasExtrato === 'function') carregarContasBancariasExtrato();
                if (typeof loadExtratoTransacoes === 'function') loadExtratoTransacoes();
            } else if (sectionId === 'folha-pagamento') {
                console.log('  üéØ CHAMANDO FUN√á√ÉO LOCAL loadFuncionarios (N√ÉO window.loadFuncionarios)');
                // Chama a fun√ß√£o LOCAL definida neste arquivo, n√£o a do app.js
                loadFuncionariosLocal();
            } else if (sectionId === 'eventos') {
                console.log('  ‚û°Ô∏è loadEventos:', typeof loadEventos);
                if (typeof loadEventos === 'function') loadEventos();
            } else if (sectionId === 'fluxo-caixa') {
                console.log('  ‚û°Ô∏è carregarBancosFluxo:', typeof carregarBancosFluxo);
                console.log('  ‚û°Ô∏è carregarFluxoCaixa:', typeof carregarFluxoCaixa);
                if (typeof carregarBancosFluxo === 'function') carregarBancosFluxo();
                if (typeof carregarFluxoCaixa === 'function') carregarFluxoCaixa();
            } else if (sectionId === 'indicadores') {
                console.log('  ‚û°Ô∏è carregarIndicadores:', typeof carregarIndicadores);
                if (typeof carregarIndicadores === 'function') carregarIndicadores();
            } else if (sectionId === 'inadimplencia') {
                console.log('  ‚û°Ô∏è carregarInadimplencia:', typeof carregarInadimplencia);
                if (typeof carregarInadimplencia === 'function') carregarInadimplencia();
            } else if (sectionId === 'nfse') {
                console.log('  ‚û°Ô∏è loadNFSeSection:', typeof loadNFSeSection);
                if (typeof loadNFSeSection === 'function') loadNFSeSection();
            } else if (sectionId === 'plano-contas') {
                console.log('  ‚û°Ô∏è loadPlanoContas:', typeof loadPlanoContas);
                if (typeof loadPlanoContas === 'function') loadPlanoContas();
            } else if (sectionId === 'integra-contador') {
                console.log('  ‚û°Ô∏è Integra Contador: Se√ß√£o carregada');
                // N√£o precisa carregar dados iniciais, apenas mostrar a tela
            } else if (sectionId === 'tipos-sessao') {
                console.log('  ‚û°Ô∏è loadTiposSessao:', typeof loadTiposSessao);
                if (typeof loadTiposSessao === 'function') loadTiposSessao();
            } else if (sectionId === 'contratos') {
                console.log('  ‚û°Ô∏è showContratoTab(resumo):', typeof showContratoTab);
                if (typeof showContratoTab === 'function') showContratoTab('resumo');
            } else if (sectionId === 'agenda-fotografia') {
                console.log('  ‚û°Ô∏è initAgendaCalendar:', typeof initAgendaCalendar);
                // Inicializar calend√°rio apenas uma vez
                if (typeof initAgendaCalendar === 'function' && !window.calendarInitialized) {
                    initAgendaCalendar();
                    window.calendarInitialized = true;
                } else if (window.calendar) {
                    // Recarregar eventos se calend√°rio j√° existe
                    window.calendar.refetchEvents();
                }
            } else if (sectionId === 'gestao-estoque') {
                console.log('  ‚û°Ô∏è loadProdutos:', typeof loadProdutos);
                if (typeof loadProdutos === 'function') loadProdutos();
            } else if (sectionId === 'kits-equipamentos') {
                console.log('  ‚û°Ô∏è loadKitsTable:', typeof loadKitsTable);
                if (typeof loadKitsTable === 'function') loadKitsTable();
            } else if (sectionId === 'tags-trabalho') {
                console.log('  ‚û°Ô∏è loadTagsTable:', typeof loadTagsTable);
                if (typeof loadTagsTable === 'function') loadTagsTable();
            } else if (sectionId === 'templates-equipe') {
                console.log('  ‚û°Ô∏è loadTemplates:', typeof loadTemplates);
                if (typeof loadTemplates === 'function') loadTemplates();
            } else if (sectionId === 'usuarios') {
                console.log('  ‚û°Ô∏è loadUsuarios:', typeof loadUsuarios);
                if (typeof loadUsuarios === 'function') loadUsuarios();
            } else if (sectionId === 'permissoes') {
                console.log('  ‚û°Ô∏è loadPermissoes:', typeof loadPermissoes);
                if (typeof loadPermissoes === 'function') loadPermissoes();
            } else if (sectionId === 'logs') {
                console.log('  ‚û°Ô∏è loadLogs:', typeof loadLogs);
                // if (typeof loadLogs === 'function') loadLogs();
            } else if (sectionId === 'fiscal') {
                console.log('  ‚û°Ô∏è loadFiscalSection:', typeof loadFiscalSection);
                if (typeof loadFiscalSection === 'function') loadFiscalSection();
            } else if (sectionId === 'empresa') {
                console.log('  ‚û°Ô∏è carregarDadosEmpresa:', typeof carregarDadosEmpresa);
                if (typeof carregarDadosEmpresa === 'function') carregarDadosEmpresa();
            } else {
                console.log('  ‚ö†Ô∏è Nenhuma fun√ß√£o de carregamento definida para:', sectionId);
            }
            
            console.log('%c ‚úÖ showSection() finalizada ', 'background: #4CAF50; color: white; font-weight: bold; padding: 4px;');
        }
        
        function showCategoriaTab(tipo) {
            const btnReceita = document.getElementById('tab-receita');
            const btnDespesa = document.getElementById('tab-despesa');
            const containerReceita = document.getElementById('categorias-receita-container');
            const containerDespesa = document.getElementById('categorias-despesa-container');
            
            if (tipo === 'receita') {
                btnReceita.classList.add('active');
                btnReceita.style.background = '#27ae60';
                btnReceita.style.color = 'white';
                btnReceita.style.fontWeight = 'bold';
                
                btnDespesa.classList.remove('active');
                btnDespesa.style.background = '#bdc3c7';
                btnDespesa.style.color = '#555';
                btnDespesa.style.fontWeight = 'normal';
                
                // Mostrar receitas, esconder despesas
                if (containerReceita) containerReceita.classList.remove('hidden');
                if (containerDespesa) containerDespesa.classList.add('hidden');
            } else {
                btnDespesa.classList.add('active');
                btnDespesa.style.background = '#e74c3c';
                btnDespesa.style.color = 'white';
                btnDespesa.style.fontWeight = 'bold';
                
                btnReceita.classList.remove('active');
                btnReceita.style.background = '#bdc3c7';
                btnReceita.style.color = '#555';
                btnReceita.style.fontWeight = 'normal';
                
                // Mostrar despesas, esconder receitas
                if (containerDespesa) containerDespesa.classList.remove('hidden');
                if (containerReceita) containerReceita.classList.add('hidden');
            }
        }
        
        // ====================================
        // FUN√á√ÉO CARREGAR DASHBOARD
        // ====================================
        async function carregarDashboard() {
            try {
                // Verificar permiss√£o antes de carregar
                const usuario = JSON.parse(sessionStorage.getItem('usuario') || '{}');
                const permissoes = usuario.permissoes || [];
                if (!permissoes.includes('dashboard') && !permissoes.includes('relatorios_view')) {
                    console.log('‚è≠Ô∏è Dashboard: Usu√°rio sem permiss√£o');
                    return;
                }
                
                console.log('üìä Carregando Dashboard...');
                
                // Pegar filtros
                const ano = document.getElementById('filter-ano-dashboard')?.value;
                const mes = document.getElementById('filter-mes-dashboard')?.value;
                
                // Construir URL com par√¢metros
                let url = '/api/relatorios/dashboard';
                const params = new URLSearchParams();
                if (ano) params.append('ano', ano);
                if (mes) params.append('mes', mes);
                if (params.toString()) url += '?' + params.toString();
                
                // Fazer requisi√ß√£o
                const response = await fetch(url);
                if (!response.ok) throw new Error('Erro ao carregar dashboard');
                
                const data = await response.json();
                
                // Atualizar cards com valores pendentes
                const formatarMoeda = (valor) => {
                    return new Intl.NumberFormat('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    }).format(valor || 0);
                };
                
                document.getElementById('dashboard-contas-receber').textContent = formatarMoeda(data.contas_receber);
                document.getElementById('dashboard-contas-pagar').textContent = formatarMoeda(data.contas_pagar);
                document.getElementById('dashboard-contas-vencidas').textContent = formatarMoeda(data.contas_vencidas);
                document.getElementById('dashboard-saldo-total').textContent = formatarMoeda(data.saldo_total);
                
                console.log('üìä Valores atualizados:', {
                    'Contas a Receber': formatarMoeda(data.contas_receber),
                    'Contas a Pagar': formatarMoeda(data.contas_pagar),
                    'Contas Vencidas': formatarMoeda(data.contas_vencidas),
                    'Saldo Total': formatarMoeda(data.saldo_total)
                });
                
                // Atualizar conte√∫do de an√°lises se existir
                const analiseContent = document.getElementById('dashboard-analises-content');
                if (analiseContent && data.analises) {
                    analiseContent.innerHTML = data.analises;
                }
                
                // Renderizar gr√°fico se houver dados
                if (data.grafico_dados || data.meses) {
                    renderizarGraficoDashboard(data);
                }
                
                console.log('‚úÖ Dashboard carregado com sucesso');
            } catch (error) {
                console.error('‚ùå Erro ao carregar dashboard:', error);
                // N√£o mostrar mensagem de erro para n√£o poluir a UI
            }
        }
        
        // Fun√ß√£o para renderizar gr√°fico do dashboard
        function renderizarGraficoDashboard(data) {
            const canvas = document.getElementById('grafico-crescimento');
            if (!canvas) {
                console.warn('Canvas grafico-crescimento n√£o encontrado');
                return;
            }
            
            // Destruir gr√°fico anterior se existir
            if (window.dashboardChart) {
                window.dashboardChart.destroy();
            }
            
            const ctx = canvas.getContext('2d');
            
            // Preparar dados (assumindo estrutura do backend)
            const labels = data.meses || [];
            const receitas = data.receitas || [];
            const despesas = data.despesas || [];
            
            window.dashboardChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Receitas',
                            data: receitas,
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Despesas',
                            data: despesas,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('pt-BR', {
                                            style: 'currency',
                                            currency: 'BRL'
                                        }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return new Intl.NumberFormat('pt-BR', {
                                        style: 'currency',
                                        currency: 'BRL',
                                        minimumFractionDigits: 0
                                    }).format(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // ==================== FUN√á√ïES DE EXTRATO BANC√ÅRIO ====================
        
        // Carregar contas banc√°rias nos selects
        async function carregarContasBancariasExtrato() {
            try {
                const response = await fetch('/api/contas', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                if (!response.ok) throw new Error('Erro ao carregar contas');
                
                let contas = await response.json();
                
                // Suporte ao novo formato de resposta { success, data, total, message }
                if (contas && typeof contas === 'object' && 'success' in contas && 'data' in contas) {
                    contas = contas.data;
                }
                
                // Filtrar apenas contas ativas para upload
                const contasAtivas = contas.filter(c => c.ativa !== false);
                
                // Preencher select de upload (apenas contas ativas)
                const selectUpload = document.getElementById('conta-bancaria-extrato');
                selectUpload.innerHTML = '<option value="">Selecione a conta...</option>';
                
                // Preencher select de filtro (todas as contas, mas indicar inativas)
                const selectFiltro = document.getElementById('filtro-conta-extrato');
                selectFiltro.innerHTML = '<option value="">Todas as contas</option>';
                
                contasAtivas.forEach(conta => {
                    const optionUpload = document.createElement('option');
                    optionUpload.value = conta.nome;
                    optionUpload.textContent = `${conta.banco} - ${conta.nome}`;
                    selectUpload.appendChild(optionUpload);
                });
                
                contas.forEach(conta => {
                    const optionFiltro = document.createElement('option');
                    optionFiltro.value = conta.nome;
                    const statusLabel = conta.ativa === false ? ' (INATIVA)' : '';
                    optionFiltro.textContent = `${conta.banco} - ${conta.nome}${statusLabel}`;
                    selectFiltro.appendChild(optionFiltro);
                });
            } catch (error) {
                console.error('Erro ao carregar contas banc√°rias:', error);
            }
        }

        // Upload de arquivo OFX
        async function uploadExtratoOFX(event) {
            console.log('üì§ INICIANDO UPLOAD DE OFX');
            
            const contaId = document.getElementById('conta-bancaria-extrato').value;
            const arquivoInput = document.getElementById('arquivo-ofx');
            const uploadButton = document.querySelector('button[onclick="uploadExtratoOFX(event)"]') || event?.target;
            
            console.log('üìã Dados do formul√°rio:');
            console.log('   üè¶ Conta selecionada:', contaId);
            console.log('   üìÅ Arquivo:', arquivoInput.files[0]?.name);
            
            if (!contaId || contaId === '') {
                Swal.fire({
                    icon: 'warning',
                    title: 'Conta Banc√°ria Obrigat√≥ria',
                    text: 'Por favor, selecione uma conta banc√°ria antes de fazer o upload do arquivo OFX.',
                    confirmButtonText: 'OK'
                });
                console.error('‚ùå Conta n√£o selecionada - value:', contaId);
                return;
            }
            
            if (!arquivoInput.files || arquivoInput.files.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Arquivo Obrigat√≥rio',
                    text: 'Por favor, selecione um arquivo OFX para fazer o upload.',
                    confirmButtonText: 'OK'
                });
                console.error('‚ùå Arquivo n√£o selecionado');
                return;
            }
            
            const arquivo = arquivoInput.files[0];
            
            // Validar extens√£o
            if (!arquivo.name.toLowerCase().endsWith('.ofx')) {
                Swal.fire({
                    icon: 'error',
                    title: 'Formato Inv√°lido',
                    text: 'Por favor, selecione um arquivo com extens√£o .ofx',
                    confirmButtonText: 'OK'
                });
                console.error('‚ùå Extens√£o inv√°lida:', arquivo.name);
                return;
            }
            
            const formData = new FormData();
            formData.append('file', arquivo);
            formData.append('conta_bancaria', contaId);
            
            console.log('üì¶ FormData preparado:');
            console.log('   file:', arquivo.name, '(' + arquivo.size + ' bytes)');
            console.log('   conta_bancaria:', contaId);
            
            try {
                if (uploadButton) {
                    uploadButton.disabled = true;
                    uploadButton.textContent = '‚è≥ Processando...';
                }
                
                console.log('üì° Enviando requisi√ß√£o para /api/extratos/upload...');
                
                const response = await fetch('/api/extratos/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`‚úÖ Arquivo importado com sucesso!\n\nüìä Transa√ß√µes importadas: ${result.transacoes_importadas || 0}`);
                    
                    // Limpar formul√°rio
                    document.getElementById('conta-bancaria-extrato').value = '';
                    arquivoInput.value = '';
                    
                    // Recarregar lista de transa√ß√µes
                    await loadExtratoTransacoes();
                } else {
                    alert(`‚ùå Erro ao importar arquivo:\n${result.error || 'Erro desconhecido'}`);
                }
            } catch (error) {
                console.error('Erro ao fazer upload:', error);
                alert('‚ùå Erro ao enviar arquivo. Verifique sua conex√£o e tente novamente.');
            } finally {
                if (uploadButton) {
                    uploadButton.disabled = false;
                    uploadButton.textContent = '‚¨ÜÔ∏è Enviar Arquivo';
                }
            }
        }

        // Carregar transa√ß√µes do extrato (expor globalmente para uso ap√≥s concilia√ß√£o)
        window.loadExtratoTransacoes = async function() {
            const tbody = document.getElementById('tbody-extrato');
            tbody.innerHTML = '<tr><td colspan="8" class="loading">Carregando transa√ß√µes...</td></tr>';
            
            try {
                // Construir query parameters
                const params = new URLSearchParams();
                
                const contaId = document.getElementById('filtro-conta-extrato').value;
                if (contaId) params.append('conta', contaId);
                
                const dataInicio = document.getElementById('filtro-data-inicio-extrato').value;
                if (dataInicio) params.append('data_inicio', dataInicio);
                
                const dataFim = document.getElementById('filtro-data-fim-extrato').value;
                if (dataFim) params.append('data_fim', dataFim);
                
                const conciliado = document.getElementById('filtro-conciliado-extrato').value;
                if (conciliado) params.append('conciliado', conciliado);
                
                const response = await fetch(`/api/extratos?${params.toString()}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Erro ao carregar transa√ß√µes');
                }
                
                const transacoes = await response.json();
                
                // üîß Salvar transa√ß√µes globalmente para a fun√ß√£o mostrarSugestoesConciliacao
                window.extratos = transacoes;
                console.log('‚úÖ Array window.extratos preenchido com', transacoes.length, 'transa√ß√µes');
                
                // üîç DEBUG: Verificar se transa√ß√£o 3529 est√° conciliada
                const trans3529 = transacoes.find(t => t.id === 3529);
                if (trans3529) {
                    console.log('üîç Transa√ß√£o 3529 na resposta da API:');
                    console.log('   üìå ID:', trans3529.id);
                    console.log('   üìå CONCILIADO:', trans3529.conciliado, typeof trans3529.conciliado);
                    console.log('   üìå LANCAMENTO_ID:', trans3529.lancamento_id);
                    console.log('   üìå VALOR:', trans3529.valor);
                    console.log('   üìå OBJETO COMPLETO:', trans3529);
                    
                    if (trans3529.conciliado === true) {
                        console.log('   ‚úÖ TRANSA√á√ÉO EST√Å CONCILIADA!');
                    } else if (trans3529.conciliado === false) {
                        console.log('   ‚ùå TRANSA√á√ÉO N√ÉO EST√Å CONCILIADA!');
                    } else {
                        console.log('   ‚ö†Ô∏è CAMPO CONCILIADO √â:', trans3529.conciliado);
                    }
                }
                
                if (transacoes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #999;">üì≠ Nenhuma transa√ß√£o encontrada. Importe um arquivo OFX para come√ßar.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = '';
                
                transacoes.forEach(transacao => {
                    const tr = document.createElement('tr');
                    
                    // Data
                    const tdData = document.createElement('td');
                    tdData.textContent = new Date(transacao.data).toLocaleDateString('pt-BR');
                    tr.appendChild(tdData);
                    
                    // Descri√ß√£o
                    const tdDescricao = document.createElement('td');
                    tdDescricao.textContent = transacao.descricao || '-';
                    tdDescricao.style.maxWidth = '350px';
                    tdDescricao.style.overflow = 'hidden';
                    tdDescricao.style.textOverflow = 'ellipsis';
                    tdDescricao.style.whiteSpace = 'nowrap';
                    tr.appendChild(tdDescricao);
                    
                    // Valor
                    const tdValor = document.createElement('td');
                    const valor = parseFloat(transacao.valor);
                    tdValor.textContent = valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                    tdValor.style.color = valor >= 0 ? '#27ae60' : '#e74c3c';
                    tdValor.style.fontWeight = 'bold';
                    tr.appendChild(tdValor);
                    
                    // Tipo
                    const tdTipo = document.createElement('td');
                    const tipoUpper = (transacao.tipo || '').toUpperCase();
                    tdTipo.textContent = tipoUpper === 'CREDITO' ? 'üìà Cr√©dito' : 'üìâ D√©bito';
                    tdTipo.style.fontSize = '12px';
                    tr.appendChild(tdTipo);
                    
                    // Saldo
                    const tdSaldo = document.createElement('td');
                    if (transacao.saldo !== null && transacao.saldo !== undefined) {
                        const saldo = parseFloat(transacao.saldo);
                        tdSaldo.textContent = saldo.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                        tdSaldo.style.color = saldo >= 0 ? '#555' : '#e74c3c';
                    } else {
                        tdSaldo.textContent = '-';
                    }
                    tr.appendChild(tdSaldo);
                    
                    // Conta
                    const tdConta = document.createElement('td');
                    tdConta.textContent = transacao.conta_bancaria || '-';
                    tdConta.style.fontSize = '12px';
                    tr.appendChild(tdConta);
                    
                    // Status
                    const tdStatus = document.createElement('td');
                    if (transacao.conciliado) {
                        tdStatus.innerHTML = '<span style="background: #27ae60; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;">‚úì Conciliado</span>';
                    } else {
                        tdStatus.innerHTML = '<span style="background: #f39c12; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;">‚è≥ Pendente</span>';
                    }
                    tr.appendChild(tdStatus);
                    
                    // A√ß√µes
                    const tdAcoes = document.createElement('td');
                    if (!transacao.conciliado) {
                        const btnConciliar = document.createElement('button');
                        btnConciliar.textContent = 'üîó Conciliar';
                        btnConciliar.className = 'btn btn-sm btn-primary';
                        btnConciliar.style.fontSize = '11px';
                        btnConciliar.style.padding = '4px 8px';
                        btnConciliar.onclick = () => {
                            console.log('üîµ Bot√£o Conciliar clicado! Transa√ß√£o ID:', transacao.id);
                            if (typeof window.mostrarSugestoesConciliacao === 'function') {
                                window.mostrarSugestoesConciliacao(transacao.id);
                            } else {
                                console.error('‚ùå Fun√ß√£o mostrarSugestoesConciliacao n√£o encontrada!');
                            }
                        };
                        tdAcoes.appendChild(btnConciliar);
                    } else {
                        // Bot√£o Desconciliar (quando j√° est√° conciliado)
                        const btnDesconciliar = document.createElement('button');
                        btnDesconciliar.textContent = 'üîô Desconciliar';
                        btnDesconciliar.className = 'btn btn-sm btn-warning';
                        btnDesconciliar.style.fontSize = '11px';
                        btnDesconciliar.style.padding = '4px 8px';
                        btnDesconciliar.onclick = () => {
                            console.log('üîô Bot√£o Desconciliar clicado! Transa√ß√£o ID:', transacao.id);
                            if (typeof window.desconciliarTransacao === 'function') {
                                window.desconciliarTransacao(transacao.id);
                            } else {
                                console.error('‚ùå Fun√ß√£o desconciliarTransacao n√£o encontrada!');
                            }
                        };
                        tdAcoes.appendChild(btnDesconciliar);
                    }
                    tr.appendChild(tdAcoes);
                    
                    tbody.appendChild(tr);
                });
                
            } catch (error) {
                console.error('Erro ao carregar transa√ß√µes:', error);
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px; color: #e74c3c;">‚ùå Erro ao carregar transa√ß√µes</td></tr>';
            }
        };

        // Limpar filtros
        function limparFiltrosExtratoOFX() {
            document.getElementById('filtro-conta-extrato').value = '';
            document.getElementById('filtro-data-inicio-extrato').value = '';
            document.getElementById('filtro-data-fim-extrato').value = '';
            document.getElementById('filtro-conciliado-extrato').value = '';
            window.loadExtratoTransacoes();
        }

        // ==================== CONCILIA√á√ÉO GERAL ====================
        
        // Abrir modal de concilia√ß√£o geral
        async function abrirConciliacaoGeral() {
            console.log('üîÑ Abrindo Concilia√ß√£o Geral...');
            
            try {
                // Buscar transa√ß√µes n√£o conciliadas
                console.log('üì° Buscando transa√ß√µes n√£o conciliadas...');
                const response = await fetch('/api/extratos?conciliado=false', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Erro ao carregar transa√ß√µes');
                }
                
                const transacoes = await response.json();
                console.log('üìä Transa√ß√µes n√£o conciliadas:', transacoes.length);
                
                if (transacoes.length === 0) {
                    alert('‚úÖ N√£o h√° transa√ß√µes pendentes de concilia√ß√£o!');
                    return;
                }
                
                // Buscar categorias do sistema (usar AppState.categorias se dispon√≠vel)
                let categorias = [];
                
                if (window.AppState && window.AppState.categorias && window.AppState.categorias.length > 0) {
                    categorias = window.AppState.categorias;
                    console.log('üìÇ Categorias carregadas de AppState:', categorias.length);
                } else if (window.categorias && window.categorias.length > 0) {
                    categorias = window.categorias;
                    console.log('üìÇ Categorias carregadas de window.categorias:', categorias.length);
                } else {
                    console.log('üì° Buscando categorias via API...');
                    const categoriasResponse = await fetch('/api/categorias', {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    
                    if (!categoriasResponse.ok) {
                        throw new Error('Erro ao carregar categorias');
                    }
                    
                    const categoriasData = await categoriasResponse.json();
                    
                    // Extrair data se vier no formato {success, data}
                    if (categoriasData && typeof categoriasData === 'object' && 'data' in categoriasData) {
                        categorias = categoriasData.data;
                    } else {
                        categorias = categoriasData;
                    }
                    console.log('üìÇ Categorias carregadas via API:', categorias.length);
                }
                
                // Debug: mostrar primeiras categorias
                if (categorias.length > 0) {
                    console.log('üîç Primeira categoria:', categorias[0]);
                    console.log('   - nome:', categorias[0].nome);
                    console.log('   - tipo:', categorias[0].tipo);
                    console.log('   - subcategorias:', categorias[0].subcategorias);
                }
                
                // Buscar clientes
                console.log('üì° Buscando clientes...');
                const clientesResponse = await fetch('/api/clientes', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!clientesResponse.ok) {
                    throw new Error('Erro ao carregar clientes');
                }
                
                const clientesData = await clientesResponse.json();
                let clientes = [];
                
                // Extrair data se vier no formato {success, data}
                if (clientesData && typeof clientesData === 'object' && 'data' in clientesData) {
                    clientes = clientesData.data;
                } else if (Array.isArray(clientesData)) {
                    clientes = clientesData;
                } else {
                    clientes = [];
                }
                console.log('üë• Clientes carregados:', clientes.length);
                
                // Montar HTML com lista de transa√ß√µes
                let html = '<div style="max-height: 500px; overflow-y: auto;">';
                
                transacoes.forEach((transacao, index) => {
                    const valor = parseFloat(transacao.valor);
                    const tipoTransacao = valor >= 0 ? 'receita' : 'despesa';
                    
                    // Filtrar categorias por tipo
                    const categoriasFiltered = categorias.filter(c => {
                        const tipoCategoria = (c.tipo || '').toLowerCase();
                        return tipoCategoria === tipoTransacao;
                    });
                    
                    // Debug para primeira transa√ß√£o
                    if (index === 0) {
                        console.log(`üîç Transa√ß√£o #${transacao.id}:`);
                        console.log('   - Valor:', valor);
                        console.log('   - Tipo detectado:', tipoTransacao);
                        console.log('   - Total categorias:', categorias.length);
                        console.log('   - Categorias filtradas:', categoriasFiltered.length);
                        categoriasFiltered.forEach(c => {
                            console.log(`      ‚Ä¢ ${c.nome} (${c.tipo}) - Subs:`, c.subcategorias);
                        });
                    }
                    
                    html += `
                        <div class="transacao-conciliacao-item" style="background: #f8f9fa; padding: 15px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #ddd;">
                            <div style="display: flex; gap: 15px; align-items: flex-start;">
                                <div style="flex-shrink: 0;">
                                    <input type="checkbox" class="checkbox-transacao-conciliacao" data-transacao-id="${transacao.id}" 
                                           style="width: 20px; height: 20px; cursor: pointer; margin-top: 5px;">
                                </div>
                                
                                <div style="flex: 1;">
                                    <!-- Info da transa√ß√£o -->
                                    <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #ddd;">
                                        <strong style="font-size: 14px; color: #2c3e50;">üìÖ ${new Date(transacao.data).toLocaleDateString('pt-BR')}</strong>
                                        <span style="margin: 0 10px; color: #95a5a6;">|</span>
                                        <span style="font-size: 13px; color: #555;">${transacao.descricao || '-'}</span>
                                        <span style="margin: 0 10px; color: #95a5a6;">|</span>
                                        <strong style="font-size: 14px; color: ${valor >= 0 ? '#27ae60' : '#e74c3c'};">${valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</strong>
                                        <span style="margin: 0 10px; color: #95a5a6;">|</span>
                                        <span style="font-size: 12px; color: #777;">üè¶ ${transacao.conta_bancaria || '-'}</span>
                                    </div>
                                    
                                    <!-- Campos de configura√ß√£o -->
                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                        <div>
                                            <label style="display: block; font-size: 12px; font-weight: bold; color: #555; margin-bottom: 4px;">Categoria:</label>
                                            <select id="categoria-${transacao.id}" class="select-categoria-conciliacao" 
                                                    style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;"
                                                    onchange="atualizarSubcategorias(${transacao.id})">
                                                <option value="">Selecione...</option>
                                                ${categoriasFiltered.map(c => {
                                                    const subcats = Array.isArray(c.subcategorias) ? c.subcategorias : [];
                                                    return `<option value="${c.nome}" data-subcategorias='${JSON.stringify(subcats)}'>${c.nome}</option>`;
                                                }).join('')}
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label style="display: block; font-size: 12px; font-weight: bold; color: #555; margin-bottom: 4px;">Subcategoria:</label>
                                            <select id="subcategoria-${transacao.id}" class="select-subcategoria-conciliacao"
                                                    style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                                                <option value="">Selecione...</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label style="display: block; font-size: 12px; font-weight: bold; color: #555; margin-bottom: 4px;">Cliente/Fornecedor:</label>
                                            <select id="cliente-${transacao.id}" class="select-cliente-conciliacao"
                                                    style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                                                <option value="">Selecione (opcional)...</option>
                                                ${clientes.map(cliente => `<option value="${cliente.razao_social}">${cliente.razao_social}</option>`).join('')}
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-top: 8px;">
                                        <label style="display: block; font-size: 12px; font-weight: bold; color: #555; margin-bottom: 4px;">üìù Descri√ß√£o:</label>
                                        <input type="text" id="descricao-${transacao.id}" class="input-descricao-conciliacao" 
                                               placeholder="Descri√ß√£o personalizada (opcional)" 
                                               value="${(transacao.descricao || '').replace(/"/g, '&quot;')}"
                                               style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; background: #fffef7;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                // Inserir no modal
                console.log('‚úÖ HTML da Concilia√ß√£o Geral montado com campo Descri√ß√£o');
                document.getElementById('conciliacao-transacoes-lista').innerHTML = html;
                
                // Mostrar modal
                document.getElementById('modal-conciliacao-geral').style.display = 'flex';
                
            } catch (error) {
                console.error('‚ùå Erro ao abrir concilia√ß√£o geral:', error);
                alert('‚ùå Erro ao carregar transa√ß√µes para concilia√ß√£o. Verifique o console.');
            }
        }
        
        // Fechar modal de concilia√ß√£o geral
        function fecharConciliacaoGeral() {
            document.getElementById('modal-conciliacao-geral').style.display = 'none';
        }
        
        // Atualizar subcategorias quando categoria √© selecionada
        function atualizarSubcategorias(transacaoId) {
            const selectCategoria = document.getElementById(`categoria-${transacaoId}`);
            const selectSubcategoria = document.getElementById(`subcategoria-${transacaoId}`);
            
            if (!selectCategoria || !selectSubcategoria) return;
            
            // Limpar subcategorias
            selectSubcategoria.innerHTML = '<option value="">Selecione...</option>';
            
            const selectedOption = selectCategoria.options[selectCategoria.selectedIndex];
            if (!selectedOption || !selectedOption.value) return;
            
            try {
                const subcategorias = JSON.parse(selectedOption.dataset.subcategorias || '[]');
                subcategorias.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub;
                    option.textContent = sub;
                    selectSubcategoria.appendChild(option);
                });
            } catch (e) {
                console.error('Erro ao parsear subcategorias:', e);
            }
        }
        
        // Processar concilia√ß√£o geral (criar lan√ßamentos em massa)
        async function processarConciliacaoGeral() {
            console.log('‚öôÔ∏è Processando concilia√ß√£o geral...');
            
            const checkboxes = document.querySelectorAll('.checkbox-transacao-conciliacao:checked');
            
            if (checkboxes.length === 0) {
                alert('‚ö†Ô∏è Selecione pelo menos uma transa√ß√£o para conciliar!');
                return;
            }
            
            const transacoesSelecionadas = [];
            const erros = [];
            
            // Validar e coletar dados
            checkboxes.forEach(checkbox => {
                const transacaoId = parseInt(checkbox.dataset.transacaoId);
                const categoria = document.getElementById(`categoria-${transacaoId}`).value;
                const subcategoria = document.getElementById(`subcategoria-${transacaoId}`).value;
                const cliente = document.getElementById(`cliente-${transacaoId}`).value;
                const descricao = document.getElementById(`descricao-${transacaoId}`).value;
                
                if (!categoria) {
                    erros.push(`Transa√ß√£o #${transacaoId}: categoria n√£o selecionada`);
                    return;
                }
                
                if (!subcategoria) {
                    erros.push(`Transa√ß√£o #${transacaoId}: subcategoria n√£o selecionada`);
                    return;
                }
                
                transacoesSelecionadas.push({
                    transacao_id: transacaoId,
                    categoria: categoria,
                    subcategoria: subcategoria,
                    razao_social: cliente || null,
                    descricao: descricao || null
                });
            });
            
            // Mostrar erros se houver
            if (erros.length > 0) {
                alert('‚ö†Ô∏è Corrija os seguintes erros antes de continuar:\n\n' + erros.join('\n'));
                return;
            }
            
            console.log('üì§ Enviando', transacoesSelecionadas.length, 'transa√ß√µes para concilia√ß√£o...');
            
            // Confirmar a√ß√£o
            if (!confirm(`Confirma a concilia√ß√£o em massa de ${transacoesSelecionadas.length} transa√ß√£o(√µes)?\n\nSer√£o criados lan√ßamentos automaticamente para cada transa√ß√£o selecionada.`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/extratos/conciliacao-geral', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        transacoes: transacoesSelecionadas
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    const mensagem = `‚úÖ Concilia√ß√£o em massa conclu√≠da!\n\nüìä Lan√ßamentos criados: ${result.criados || 0}`;
                    if (result.erros && result.erros.length > 0) {
                        alert(mensagem + `\n\n‚ö†Ô∏è Erros encontrados:\n${result.erros.join('\n')}`);
                        console.error('Detalhes dos erros:', result.erros);
                    } else {
                        alert(mensagem);
                    }
                    
                    // Fechar modal e recarregar transa√ß√µes
                    fecharConciliacaoGeral();
                    await window.loadExtratoTransacoes();
                    
                } else {
                    alert(`‚ùå Erro ao processar concilia√ß√£o em massa:\n${result.error || result.message || 'Erro desconhecido'}`);
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao processar concilia√ß√£o:', error);
                alert('‚ùå Erro ao processar concilia√ß√£o. Verifique sua conex√£o e tente novamente.');
            }
        }
        
        // üîß Expor fun√ß√µes no escopo global
        window.abrirConciliacaoGeral = abrirConciliacaoGeral;
        window.fecharConciliacaoGeral = fecharConciliacaoGeral;
        window.atualizarSubcategorias = atualizarSubcategorias;
        window.processarConciliacaoGeral = processarConciliacaoGeral;
        console.log('‚úÖ Fun√ß√µes de Concilia√ß√£o Geral expostas no window');

        // Deletar extratos filtrados
        async function deletarExtratoFiltradoOFX() {
            const contaId = document.getElementById('filtro-conta-extrato').value;
            const dataInicio = document.getElementById('filtro-data-inicio-extrato').value;
            const dataFim = document.getElementById('filtro-data-fim-extrato').value;
            
            // Verificar se h√° filtros aplicados
            if (!contaId && !dataInicio && !dataFim) {
                alert('‚ö†Ô∏è Por favor, aplique pelo menos um filtro (conta ou per√≠odo) antes de deletar!\n\nIsso evita deletar todos os extratos acidentalmente.');
                return;
            }
            
            // Confirma√ß√£o
            let mensagem = '‚ö†Ô∏è ATEN√á√ÉO: Esta a√ß√£o n√£o pode ser desfeita!\n\nVoc√™ est√° prestes a deletar os extratos com os seguintes filtros:\n';
            if (contaId) {
                const contaSelect = document.getElementById('filtro-conta-extrato');
                const contaNome = contaSelect.options[contaSelect.selectedIndex].text;
                mensagem += `\nüìå Conta: ${contaNome}`;
            }
            if (dataInicio) mensagem += `\nüìÖ Data in√≠cio: ${new Date(dataInicio).toLocaleDateString('pt-BR')}`;
            if (dataFim) mensagem += `\nüìÖ Data fim: ${new Date(dataFim).toLocaleDateString('pt-BR')}`;
            mensagem += '\n\nDeseja continuar?';
            
            if (!confirm(mensagem)) {
                return;
            }
            
            try {
                // Construir query parameters
                const params = new URLSearchParams();
                if (contaId) params.append('conta', contaId);
                if (dataInicio) params.append('data_inicio', dataInicio);
                if (dataFim) params.append('data_fim', dataFim);
                
                const response = await fetch(`/api/extratos/deletar-filtrado?${params.toString()}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`‚úÖ Extratos deletados com sucesso!\n\nüìä Total deletado: ${result.deletados || 0} transa√ß√£o(√µes)`);
                    
                    // Limpar filtros e recarregar
                    limparFiltrosExtratoOFX();
                } else {
                    alert(`‚ùå Erro ao deletar extratos:\n${result.error || 'Erro desconhecido'}`);
                }
            } catch (error) {
                console.error('Erro ao deletar extratos:', error);
                alert('‚ùå Erro ao deletar extratos. Verifique sua conex√£o e tente novamente.');
            }
        }

        // Conciliar transa√ß√£o individual
        async function mostrarSugestoesConciliacao(transacaoId) {
            console.log('üîó Abrindo modal de concilia√ß√£o para transa√ß√£o:', transacaoId);
            
            try {
                // Buscar dados da transa√ß√£o
                const transacao = window.extratos?.find(t => t.id === transacaoId);
                if (!transacao) {
                    alert('‚ùå Transa√ß√£o n√£o encontrada');
                    return;
                }
                
                // Buscar categorias
                let categorias = [];
                if (window.AppState && window.AppState.categorias && window.AppState.categorias.length > 0) {
                    categorias = window.AppState.categorias;
                } else if (window.categorias && window.categorias.length > 0) {
                    categorias = window.categorias;
                } else {
                    const categoriasResponse = await fetch('/api/categorias', {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    
                    if (categoriasResponse.ok) {
                        const categoriasData = await categoriasResponse.json();
                        categorias = categoriasData.data || categoriasData;
                    }
                }
                
                // Buscar clientes
                const clientesResponse = await fetch('/api/clientes', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                let clientes = [];
                if (clientesResponse.ok) {
                    const clientesData = await clientesResponse.json();
                    clientes = clientesData.data || clientesData;
                }
                
                // Filtrar categorias por tipo (receita/despesa)
                const valor = parseFloat(transacao.valor);
                const tipoTransacao = valor >= 0 ? 'receita' : 'despesa';
                const categoriasFiltered = categorias.filter(c => {
                    const tipoCategoria = (c.tipo || '').toLowerCase();
                    return tipoCategoria === tipoTransacao;
                });
                
                // Preencher formul√°rio do modal
                const form = document.getElementById('transacao-conciliacao-form');
                form.innerHTML = `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 10px 0; color: #2c3e50; font-size: 16px;">üìã Dados da Transa√ß√£o</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 14px;">
                            <div><strong>Data:</strong> ${new Date(transacao.data).toLocaleDateString('pt-BR')}</div>
                            <div><strong>Valor:</strong> <span style="color: ${valor >= 0 ? '#27ae60' : '#e74c3c'}; font-weight: bold;">${valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span></div>
                            <div style="grid-column: 1 / -1;"><strong>Descri√ß√£o Original:</strong> ${transacao.descricao || '-'}</div>
                            <div style="grid-column: 1 / -1;"><strong>Conta:</strong> ${transacao.conta_bancaria || '-'}</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #555;">Categoria: *</label>
                            <select id="conciliacao-categoria" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" onchange="atualizarSubcategoriasModal()">
                                <option value="">Selecione...</option>
                                ${categoriasFiltered.map(c => {
                                    const subcats = Array.isArray(c.subcategorias) ? c.subcategorias : [];
                                    return `<option value="${c.nome}" data-subcategorias='${JSON.stringify(subcats)}'>${c.nome}</option>`;
                                }).join('')}
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #555;">Subcategoria: *</label>
                            <select id="conciliacao-subcategoria" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #555;">üìù Descri√ß√£o:</label>
                        <input type="text" id="conciliacao-descricao" value="${(transacao.descricao || '').replace(/"/g, '&quot;')}" 
                               placeholder="Descri√ß√£o personalizada (opcional)" 
                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; background: #fffef7;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #555;">Cliente/Fornecedor:</label>
                        <select id="conciliacao-cliente" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                            <option value="">Selecione (opcional)...</option>
                            ${Array.isArray(clientes) ? clientes.map(cliente => `<option value="${cliente.razao_social}">${cliente.razao_social}</option>`).join('') : ''}
                        </select>
                    </div>
                    
                    <input type="hidden" id="conciliacao-transacao-id" value="${transacaoId}">
                `;
                
                console.log('‚úÖ Modal de concilia√ß√£o individual montado com campo Descri√ß√£o');
                
                // Expor fun√ß√£o de atualiza√ß√£o de subcategorias
                window.atualizarSubcategoriasModal = function() {
                    const selectCategoria = document.getElementById('conciliacao-categoria');
                    const selectSubcategoria = document.getElementById('conciliacao-subcategoria');
                    
                    if (!selectCategoria || !selectSubcategoria) return;
                    
                    selectSubcategoria.innerHTML = '<option value="">Selecione...</option>';
                    
                    const selectedOption = selectCategoria.options[selectCategoria.selectedIndex];
                    if (selectedOption && selectedOption.value) {
                        try {
                            const subcategorias = JSON.parse(selectedOption.dataset.subcategorias || '[]');
                            subcategorias.forEach(sub => {
                                const option = document.createElement('option');
                                option.value = sub;
                                option.textContent = sub;
                                selectSubcategoria.appendChild(option);
                            });
                        } catch (e) {
                            console.error('Erro ao parsear subcategorias:', e);
                        }
                    }
                };
                
                // Abrir modal
                document.getElementById('modal-conciliacao').style.display = 'flex';
                
            } catch (error) {
                console.error('‚ùå Erro ao abrir modal de concilia√ß√£o:', error);
                alert('‚ùå Erro ao abrir modal de concilia√ß√£o. Verifique o console.');
            }
        }
        
        // Salvar concilia√ß√£o individual
        async function conciliarTransacaoIndividual() {
            try {
                const transacaoId = document.getElementById('conciliacao-transacao-id').value;
                const categoria = document.getElementById('conciliacao-categoria').value;
                const subcategoria = document.getElementById('conciliacao-subcategoria').value;
                const descricao = document.getElementById('conciliacao-descricao').value;
                const cliente = document.getElementById('conciliacao-cliente').value;
                
                // Validar campos obrigat√≥rios
                if (!categoria) {
                    alert('‚ö†Ô∏è Por favor, selecione uma categoria');
                    return;
                }
                
                if (!subcategoria) {
                    alert('‚ö†Ô∏è Por favor, selecione uma subcategoria');
                    return;
                }
                
                // Confirmar
                if (!confirm('Confirma a concilia√ß√£o desta transa√ß√£o?\n\nSer√° criado um lan√ßamento autom√°tico no sistema.')) {
                    return;
                }
                
                // Enviar para API (usar endpoint de concilia√ß√£o geral com 1 transa√ß√£o)
                const response = await fetch('/api/extratos/conciliacao-geral', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        transacoes: [{
                            transacao_id: parseInt(transacaoId),
                            categoria: categoria,
                            subcategoria: subcategoria,
                            descricao: descricao || null,
                            razao_social: cliente || null
                        }]
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ Transa√ß√£o conciliada com sucesso!');
                    
                    // Fechar modal e recarregar transa√ß√µes
                    closeModal('modal-conciliacao');
                    await window.loadExtratoTransacoes();
                } else {
                    alert(`‚ùå Erro ao conciliar transa√ß√£o:\n${result.error || result.message || 'Erro desconhecido'}`);
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao conciliar transa√ß√£o:', error);
                alert('‚ùå Erro ao conciliar transa√ß√£o. Verifique sua conex√£o e tente novamente.');
            }
        }
        
        // Expor fun√ß√µes no escopo global
        window.mostrarSugestoesConciliacao = mostrarSugestoesConciliacao;
        window.conciliarTransacaoIndividual = conciliarTransacaoIndividual;

        // ====================================
        // FOLHA DE PAGAMENTO - FUNCION√ÅRIOS
        // ====================================

        // M√°scara de CPF
        document.addEventListener('DOMContentLoaded', function() {
            const cpfInput = document.getElementById('funcionario-cpf');
            if (cpfInput) {
                cpfInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length <= 11) {
                        value = value.replace(/(\d{3})(\d)/, '$1.$2');
                        value = value.replace(/(\d{3})(\d)/, '$1.$2');
                        value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                        e.target.value = value;
                    }
                });
            }
        });

        function abrirModalFuncionario(funcionario = null) {
            const modal = document.getElementById('modal-funcionario');
            const title = document.getElementById('modal-funcionario-title');
            
            if (funcionario) {
                title.textContent = 'Editar Funcion√°rio';
                document.getElementById('funcionario-id').value = funcionario.id;
                document.getElementById('funcionario-nome').value = funcionario.nome;
                document.getElementById('funcionario-cpf').value = funcionario.cpf;
                document.getElementById('funcionario-endereco').value = funcionario.endereco || '';
                document.getElementById('funcionario-email').value = funcionario.email || '';
                document.getElementById('funcionario-tipo-pix').value = funcionario.tipo_chave_pix;
                document.getElementById('funcionario-chave-pix').value = funcionario.chave_pix || '';
                document.getElementById('funcionario-data-admissao').value = funcionario.data_admissao || '';
                document.getElementById('funcionario-observacoes').value = funcionario.observacoes || '';
            } else {
                title.textContent = 'Novo Funcion√°rio';
                document.getElementById('form-funcionario').reset();
                document.getElementById('funcionario-id').value = '';
            }
            
            modal.style.display = 'block';
        }

        function fecharModalFuncionario() {
            document.getElementById('modal-funcionario').style.display = 'none';
            document.getElementById('form-funcionario').reset();
        }

        async function salvarFuncionario(event) {
            event.preventDefault();
            
            const id = document.getElementById('funcionario-id').value;
            const dados = {
                nome: document.getElementById('funcionario-nome').value,
                cpf: document.getElementById('funcionario-cpf').value.replace(/\D/g, ''),
                endereco: document.getElementById('funcionario-endereco').value,
                email: document.getElementById('funcionario-email').value,
                tipo_chave_pix: document.getElementById('funcionario-tipo-pix').value,
                chave_pix: document.getElementById('funcionario-chave-pix').value,
                data_admissao: document.getElementById('funcionario-data-admissao').value || null,
                observacoes: document.getElementById('funcionario-observacoes').value
            };

            try {
                const url = id ? `/api/funcionarios/${id}` : '/api/funcionarios';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dados)
                });

                const result = await response.json();

                if (response.ok) {
                    showToast(`‚úÖ Funcion√°rio ${id ? 'atualizado' : 'cadastrado'} com sucesso!`, 'success');
                    fecharModalFuncionario();
                    // Recarregar a lista de funcion√°rios na tabela RH
                    if (typeof loadFuncionariosRH === 'function') {
                        loadFuncionariosRH();
                    }
                } else {
                    showToast(`‚ùå Erro: ${result.error || 'Erro desconhecido'}`, 'error');
                }
            } catch (error) {
                console.error('Erro ao salvar funcion√°rio:', error);
                showToast('‚ùå Erro ao salvar funcion√°rio. Verifique sua conex√£o.', 'error');
            }
        }

        let funcionariosGlobal = [];

        async function loadFuncionariosLocal() {
            console.log('üîµüîµüîµ loadFuncionariosLocal() do INTERFACE_NOVA.HTML sendo executada');
            try {
                const response = await fetch('/api/funcionarios', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `Erro ${response.status}`);
                }
                
                const result = await response.json();
                funcionariosGlobal = result.funcionarios || [];
                
                console.log('üéØ Dados recebidos:', funcionariosGlobal.length, 'funcion√°rios');
                
                // DEBUG: Mostrar primeiro funcion√°rio completo
                if (funcionariosGlobal.length > 0) {
                    console.log('üìä Primeiro funcion√°rio recebido:', funcionariosGlobal[0]);
                    console.log('   Nome:', funcionariosGlobal[0].nome);
                    console.log('   CPF:', funcionariosGlobal[0].cpf);
                    console.log('   Nacionalidade:', funcionariosGlobal[0].nacionalidade);
                    console.log('   Estado Civil:', funcionariosGlobal[0].estado_civil);
                    console.log('   Email:', funcionariosGlobal[0].email);
                }

                // Atualizar estat√≠sticas
                const total = funcionariosGlobal.length;
                const ativos = funcionariosGlobal.filter(f => f.ativo).length;
                const inativos = total - ativos;
                
                document.getElementById('total-funcionarios').textContent = total;
                document.getElementById('total-ativos').textContent = ativos;
                document.getElementById('total-inativos').textContent = inativos;

                renderFuncionarios(funcionariosGlobal);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar funcion√°rios:', error);
                showToast(error.message || 'Erro ao carregar funcion√°rios', 'error');
                document.getElementById('tbody-funcionarios').innerHTML = '<tr><td colspan="15" style="text-align: center; color: #e74c3c;">Erro ao carregar dados</td></tr>';
            }
        }

        function renderFuncionarios(funcionarios) {
            console.log('üé® renderFuncionarios chamada com', funcionarios.length, 'funcion√°rios');
            const tbody = document.getElementById('tbody-funcionarios');

            if (funcionarios && funcionarios.length > 0) {
                console.log('üìä Primeiro funcion√°rio:', funcionarios[0]);
                tbody.innerHTML = funcionarios.map(func => {
                    const ativoStatus = func.ativo ? true : false;
                    
                    // Montar endere√ßo completo
                    const enderecoCompleto = [
                        func.rua_av,
                        func.numero_residencia,
                        func.complemento,
                        func.bairro,
                        func.cidade,
                        func.estado
                    ].filter(Boolean).join(', ') || '-';
                    
                    // Formatar data de nascimento
                    const dataNasc = func.data_nascimento ? new Date(func.data_nascimento + 'T00:00:00').toLocaleDateString('pt-BR') : '-';
                    
                    return `
                    <tr>
                        <td style="color: #000000 !important; font-weight: 500; padding: 8px; position: sticky; left: 0; background: white; z-index: 9;">${func.nome || '-'}</td>
                        <td style="color: #000000 !important; font-weight: 500; padding: 8px;">${formatarCPF(func.cpf)}</td>
                        <td style="color: #000000 !important; font-weight: 500; padding: 8px;">${func.nacionalidade || '-'}</td>
                        <td style="color: #000000 !important; font-weight: 500; padding: 8px;">${func.estado_civil || '-'}</td>
                        <td style="color: #000000 !important; font-weight: 500; padding: 8px;">${dataNasc}</td>
                        <td style="color: #000000 !important; font-weight: 500; padding: 8px; text-align: center;">${func.idade || '-'}</td>
                        <td style="color: #000000 !important; font-weight: 500; padding: 8px;">${func.profissao || '-'}</td>
                        <td style="color: #000000 !important; font-weight: 500; padding: 8px; font-size: 12px;">${enderecoCompleto}</td>
                        <td style="color: #000000 !important; font-weight: 500; padding: 8px;">${func.cep || '-'}</td>
                        <td style="color: #000000 !important; font-weight: 500; padding: 8px; font-size: 12px;">${func.email || '-'}</td>
                        <td style="color: #000000 !important; font-weight: 500; padding: 8px;">${func.celular || '-'}</td>
                        <td style="color: #000000 !important; font-weight: 500; padding: 8px;">${func.chave_pix || '-'}</td>
                        <td style="color: #000000 !important; font-weight: 500; padding: 8px;">${func.pis_pasep || '-'}</td>
                        <td style="text-align: center; padding: 8px;"><span class="badge badge-${ativoStatus ? 'success' : 'danger'}" style="padding: 4px 8px; border-radius: 12px; font-size: 11px; background: ${ativoStatus ? '#27ae60' : '#e74c3c'}; color: white;">${ativoStatus ? 'ATIVO' : 'INATIVO'}</span></td>
                        <td style="text-align: center; padding: 8px;">
                            <button onclick='editarFuncionarioRH(${func.id})' class="btn btn-sm btn-primary" title="Editar">‚úèÔ∏è</button>
                            <button onclick="toggleAtivoFuncionarioRH(${func.id}, ${ativoStatus})" class="btn btn-sm btn-${ativoStatus ? 'warning' : 'success'}" title="${ativoStatus ? 'Inativar' : 'Ativar'}">
                                ${ativoStatus ? 'üö´' : '‚úÖ'}
                            </button>
                        </td>
                    </tr>`;
                }).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="15" style="text-align: center; padding: 30px; color: #999;">Nenhum funcion√°rio cadastrado</td></tr>';
            }
        }

        function filtrarFuncionariosRH() {
            console.log('üîçüîç filtrarFuncionariosRH chamada');
            const busca = document.getElementById('busca-funcionario')?.value.toLowerCase() || '';
            const status = document.getElementById('filtro-status-funcionario')?.value || '';
            
            console.log('   Busca:', busca);
            console.log('   Status:', status);
            console.log('   Total funcion√°rios:', funcionariosGlobal.length);
            
            let filtered = [...funcionariosGlobal];
            
            // Filtro de busca (nome, CPF, email, celular, profiss√£o, endere√ßo)
            if (busca) {
                console.log('   üîç Aplicando filtro de busca...');
                let primeiroMatch = true;
                filtered = filtered.filter(f => {
                    const nome = (f.nome || '').toLowerCase();
                    const cpf = (f.cpf || '').replace(/\D/g, '');
                    const email = (f.email || '').toLowerCase();
                    const celular = (f.celular || '').replace(/\D/g, '');
                    const profissao = (f.profissao || '').toLowerCase();
                    const cidade = (f.cidade || '').toLowerCase();
                    const estado = (f.estado || '').toLowerCase();
                    const buscaSemFormatacao = busca.replace(/\D/g, '');
                    
                    const nomeMatch = nome.includes(busca);
                    const cpfMatch = cpf.includes(buscaSemFormatacao);
                    const emailMatch = email.includes(busca);
                    const celularMatch = celular.includes(buscaSemFormatacao);
                    const profissaoMatch = profissao.includes(busca);
                    const cidadeMatch = cidade.includes(busca);
                    const estadoMatch = estado.includes(busca);
                    
                    const match = nomeMatch || cpfMatch || emailMatch || celularMatch || profissaoMatch || cidadeMatch || estadoMatch;
                    
                    // Debug detalhado do primeiro match
                    if (match && primeiroMatch) {
                        console.log('   ‚úÖ Primeiro match:', nome);
                        console.log('      - Nome:', nomeMatch, '(', nome, ')');
                        console.log('      - CPF:', cpfMatch, '(', cpf, ')');
                        console.log('      - Email:', emailMatch, '(', email, ')');
                        console.log('      - Celular:', celularMatch, '(', celular, ')');
                        console.log('      - Profiss√£o:', profissaoMatch, '(', profissao, ')');
                        console.log('      - Cidade:', cidadeMatch, '(', cidade, ')');
                        console.log('      - Estado:', estadoMatch, '(', estado, ')');
                        primeiroMatch = false;
                    }
                    
                    return match;
                });
                console.log('   üìä Ap√≥s filtro de busca:', filtered.length);
            }
            
            // Filtro de status
            if (status !== '') {
                const isAtivo = status === 'true';
                filtered = filtered.filter(f => f.ativo === isAtivo);
            }
            
            console.log('   Filtrados:', filtered.length);
            if (filtered.length > 0 && filtered.length < 10) {
                console.log('   üìã Funcion√°rios filtrados:', filtered.map(f => f.nome).join(', '));
            }
            renderFuncionarios(filtered);
        }

        async function toggleAtivoFuncionarioRH(id, ativoAtual) {
            const acao = ativoAtual ? 'inativar' : 'ativar';
            if (!confirm(`Deseja realmente ${acao} este funcion√°rio?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/funcionarios/${id}`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ ativo: !ativoAtual })
                });

                const result = await response.json();

                if (response.ok) {
                    showToast(`‚úÖ Funcion√°rio ${acao}do com sucesso!`, 'success');
                    loadFuncionariosLocal();
                } else {
                    showToast(`‚ùå Erro: ${result.error || 'Erro desconhecido'}`, 'error');
                }
            } catch (error) {
                console.error('Erro ao atualizar funcion√°rio:', error);
                showToast('‚ùå Erro ao atualizar funcion√°rio.', 'error');
            }
        }

        function formatarCPF(cpf) {
            if (!cpf) return '-';
            cpf = cpf.replace(/\D/g, '');
            return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        }

        function mudarAbaFuncionario(aba) {
            console.log('üîÑ Mudando para aba:', aba);
            
            // Ocultar todas as abas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remover classe active de todos os bot√µes
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.style.borderBottom = '3px solid transparent';
                btn.style.background = 'transparent';
            });
            
            // Mostrar aba selecionada
            const abaElement = document.getElementById(`aba-${aba}`);
            if (abaElement) {
                abaElement.style.display = 'block';
            }
            
            // Ativar bot√£o (buscar pelo data-aba)
            const btn = document.querySelector(`[data-aba="${aba}"]`);
            if (btn) {
                btn.style.borderBottom = '3px solid #3498db';
                btn.style.background = 'rgba(52, 152, 219, 0.1)';
            }
        }

        function abrirModalFuncionario(funcionarioId = null) {
            console.log('üìÇ abrirModalFuncionario chamada com ID:', funcionarioId);
            const modal = document.getElementById('modal-funcionario');
            const title = document.getElementById('modal-funcionario-title');
            
            // SEMPRE resetar para primeira aba e mostr√°-la
            setTimeout(() => {
                mudarAbaFuncionario('dados-pessoais');
            }, 50);
            
            if (funcionarioId) {
                title.textContent = '‚úèÔ∏è Editar Funcion√°rio';
                // Preencher os campos com os dados do funcion√°rio
                const funcionario = funcionariosGlobal.find(f => f.id === funcionarioId);
                if (funcionario) {
                    document.getElementById('funcionario-id').value = funcionario.id || '';
                    document.getElementById('funcionario-nome').value = funcionario.nome || '';
                    document.getElementById('funcionario-cpf').value = funcionario.cpf || '';
                    document.getElementById('funcionario-email').value = funcionario.email || '';
                    document.getElementById('funcionario-celular').value = funcionario.celular || '';
                    document.getElementById('funcionario-data-nascimento').value = funcionario.data_nascimento || '';
                    document.getElementById('funcionario-nacionalidade').value = funcionario.nacionalidade || '';
                    document.getElementById('funcionario-estado-civil').value = funcionario.estado_civil || '';
                    
                    document.getElementById('funcionario-rua').value = funcionario.rua_av || '';
                    document.getElementById('funcionario-numero').value = funcionario.numero_residencia || '';
                    document.getElementById('funcionario-complemento').value = funcionario.complemento || '';
                    document.getElementById('funcionario-bairro').value = funcionario.bairro || '';
                    document.getElementById('funcionario-cidade').value = funcionario.cidade || '';
                    document.getElementById('funcionario-estado').value = funcionario.estado || '';
                    document.getElementById('funcionario-cep').value = funcionario.cep || '';
                    
                    document.getElementById('funcionario-profissao').value = funcionario.profissao || '';
                    document.getElementById('funcionario-data-admissao').value = funcionario.data_admissao || '';
                    document.getElementById('funcionario-data-demissao').value = funcionario.data_demissao || '';
                    document.getElementById('funcionario-observacoes').value = funcionario.observacoes || '';
                    document.getElementById('funcionario-ativo').checked = funcionario.ativo !== false;
                    
                    document.getElementById('funcionario-pis').value = funcionario.pis_pasep || '';
                    document.getElementById('funcionario-chave-pix').value = funcionario.chave_pix || '';
                }
            } else {
                title.textContent = '‚ûï Novo Funcion√°rio';
                document.getElementById('form-funcionario').reset();
                document.getElementById('funcionario-id').value = '';
                document.getElementById('funcionario-ativo').checked = true;
            }
            
            modal.style.display = 'flex';
        }

        async function editarFuncionarioRH(id) {
            console.log('‚úèÔ∏è editarFuncionarioRH chamada para ID:', id);
            // Delega para abrirModalFuncionario que j√° faz tudo
            abrirModalFuncionario(id);
        }

        function fecharModalFuncionario() {
            document.getElementById('modal-funcionario').style.display = 'none';
            document.getElementById('form-funcionario').reset();
        }

        async function salvarFuncionario(event) {
            event.preventDefault();
            
            const id = document.getElementById('funcionario-id').value;
            const dados = {
                nome: document.getElementById('funcionario-nome').value,
                cpf: document.getElementById('funcionario-cpf').value.replace(/\D/g, ''),
                email: document.getElementById('funcionario-email').value || null,
                celular: document.getElementById('funcionario-celular').value || null,
                data_nascimento: document.getElementById('funcionario-data-nascimento').value || null,
                nacionalidade: document.getElementById('funcionario-nacionalidade').value || null,
                estado_civil: document.getElementById('funcionario-estado-civil').value || null,
                
                rua_av: document.getElementById('funcionario-rua').value || null,
                numero_residencia: document.getElementById('funcionario-numero').value || null,
                complemento: document.getElementById('funcionario-complemento').value || null,
                bairro: document.getElementById('funcionario-bairro').value || null,
                cidade: document.getElementById('funcionario-cidade').value || null,
                estado: document.getElementById('funcionario-estado').value || null,
                cep: document.getElementById('funcionario-cep').value || null,
                
                profissao: document.getElementById('funcionario-profissao').value || null,
                data_admissao: document.getElementById('funcionario-data-admissao').value || null,
                data_demissao: document.getElementById('funcionario-data-demissao').value || null,
                observacoes: document.getElementById('funcionario-observacoes').value || null,
                ativo: document.getElementById('funcionario-ativo').checked,
                
                pis_pasep: document.getElementById('funcionario-pis').value || null,
                chave_pix: document.getElementById('funcionario-chave-pix').value || null
            };

            try {
                const url = id ? `/api/funcionarios/${id}` : '/api/funcionarios';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dados)
                });

                const result = await response.json();

                if (response.ok) {
                    showToast(`‚úÖ Funcion√°rio ${id ? 'atualizado' : 'cadastrado'} com sucesso!`, 'success');
                    fecharModalFuncionario();
                    loadFuncionariosLocal();
                } else {
                    showToast(`‚ùå Erro: ${result.error || 'Erro desconhecido'}`, 'error');
                }
            } catch (error) {
                console.error('Erro ao salvar funcion√°rio:', error);
                showToast('‚ùå Erro ao salvar funcion√°rio.', 'error');
            }
        }

        async function exportarFuncionariosExcel() {
            try {
                const response = await fetch('/api/funcionarios/exportar', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Erro ao exportar');
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `funcionarios_${new Date().toISOString().split('T')[0]}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showToast('‚úÖ Funcion√°rios exportados com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao exportar:', error);
                showToast('‚ùå Erro ao exportar funcion√°rios', 'error');
            }
        }

        // Expor fun√ß√µes globalmente (exceto loadFuncionariosLocal - usamos diretamente no showSection)
        window.abrirModalFuncionario = abrirModalFuncionario;
        window.fecharModalFuncionario = fecharModalFuncionario;
        window.salvarFuncionario = salvarFuncionario;
        window.toggleAtivoFuncionarioRH = toggleAtivoFuncionarioRH;
        window.formatarCPF = formatarCPF;
        window.filtrarFuncionariosRH = filtrarFuncionariosRH;
        window.mudarAbaFuncionario = mudarAbaFuncionario;
        window.editarFuncionarioRH = editarFuncionarioRH;
        window.exportarFuncionariosExcel = exportarFuncionariosExcel;

        console.log('‚úÖ Fun√ß√µes de Folha de Pagamento carregadas (TODAS com sufixo RH - sem conflito)');


        // ====================================
        // EVENTOS OPERACIONAIS
        // ====================================

        // Guarda os dados originais do evento para comparar depois
        var _eventoOriginal = null;

        function abrirModalEvento(evento = null) {
            const modal = document.getElementById('modal-evento');
            const title = document.getElementById('modal-evento-title');
            
            if (evento) {
                console.log('üîç [DEBUG EVENTO] Abrindo modal para edi√ß√£o:', evento);
                console.log('üîç [DEBUG EVENTO] data_evento original:', evento.data_evento);
                
                // Guardar dados originais para comparar ao salvar
                _eventoOriginal = JSON.parse(JSON.stringify(evento));
                
                title.textContent = 'Editar Evento';
                document.getElementById('evento-id').value = evento.id;
                document.getElementById('evento-nome').value = evento.nome_evento;
                
                // Garante que a data esteja no formato YYYY-MM-DD para input type="date"
                let dataFormatada = evento.data_evento;
                if (dataFormatada && dataFormatada.includes('/')) {
                    // Se vier em formato DD/MM/YYYY, converte para YYYY-MM-DD
                    const partes = dataFormatada.split('/');
                    dataFormatada = `${partes[2]}-${partes[1]}-${partes[0]}`;
                }
                document.getElementById('evento-data').value = dataFormatada;
                console.log('üîç [DEBUG EVENTO] data_evento formatada para input:', dataFormatada);
                
                document.getElementById('evento-nf').value = evento.nf_associada || '';
                document.getElementById('evento-valor-liquido').value = evento.valor_liquido_nf || '';
                document.getElementById('evento-custo').value = evento.custo_evento || '';
                document.getElementById('evento-margem').value = evento.margem || '';
                document.getElementById('evento-tipo').value = evento.tipo_evento || '';
                document.getElementById('evento-status').value = evento.status || 'PENDENTE';
                document.getElementById('evento-observacoes').value = evento.observacoes || '';
                
                // Listener para detectar mudan√ßa na data
                const dateInput = document.getElementById('evento-data');
                dateInput.onchange = function() {
                    console.log('üìÖ [MUDANCA] Usuario alterou data de', _eventoOriginal?.data_evento, 'para', this.value);
                };
            } else {
                _eventoOriginal = null;
                title.textContent = 'Novo Evento';
                document.getElementById('form-evento').reset();
                document.getElementById('evento-id').value = '';
                document.getElementById('evento-status').value = 'PENDENTE';
            }
            
            modal.style.display = 'block';
        }

        function fecharModalEvento() {
            document.getElementById('modal-evento').style.display = 'none';
            document.getElementById('form-evento').reset();
        }

        function calcularMargemEvento() {
            const valorLiquido = parseFloat(document.getElementById('evento-valor-liquido').value) || 0;
            const custo = parseFloat(document.getElementById('evento-custo').value) || 0;
            const margem = valorLiquido - custo;
            document.getElementById('evento-margem').value = margem.toFixed(2);
        }

        async function salvarEvento(event) {
            event.preventDefault();
            
            const id = document.getElementById('evento-id').value;
            const dataInput = document.getElementById('evento-data').value;
            
            console.log('üîç [DEBUG EVENTO] Salvando evento...');
            console.log('üîç [DEBUG EVENTO] ID:', id);
            console.log('üîç [DEBUG EVENTO] data_evento do input:', dataInput);
            
            // Comparar com valores originais
            if (_eventoOriginal && id) {
                console.log('üìä [COMPARACAO] Data original:', _eventoOriginal.data_evento, '=> Nova:', dataInput);
                if (_eventoOriginal.data_evento === dataInput) {
                    console.log('‚ö†Ô∏è [COMPARACAO] DATA NAO FOI ALTERADA! Valor igual ao original.');
                } else {
                    console.log('‚úÖ [COMPARACAO] DATA FOI ALTERADA!', _eventoOriginal.data_evento, '->', dataInput);
                }
            }
            
            const dados = {
                nome_evento: document.getElementById('evento-nome').value,
                data_evento: dataInput,
                nf_associada: document.getElementById('evento-nf').value || null,
                valor_liquido_nf: parseFloat(document.getElementById('evento-valor-liquido').value) || null,
                custo_evento: parseFloat(document.getElementById('evento-custo').value) || null,
                margem: parseFloat(document.getElementById('evento-margem').value) || null,
                tipo_evento: document.getElementById('evento-tipo').value || null,
                status: document.getElementById('evento-status').value,
                observacoes: document.getElementById('evento-observacoes').value || null
            };
            
            console.log('üîç [DEBUG EVENTO] Dados a enviar:', JSON.stringify(dados, null, 2));

            try {
                const url = id ? `/api/eventos/${id}` : '/api/eventos';
                const method = id ? 'PUT' : 'POST';
                
                console.log(`üîç [DEBUG EVENTO] Enviando ${method} para ${url}`);
                
                const response = await fetch(url, {
                    method: method,
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dados)
                });

                const result = await response.json();
                console.log('üîç [DEBUG EVENTO] Resposta COMPLETA do servidor:', JSON.stringify(result, null, 2));
                
                if (result.evento) {
                    console.log('üîç [DEBUG EVENTO] Evento retornado - data_evento:', result.evento.data_evento);
                    console.log('üîç [DEBUG EVENTO] Data ANTES:', result.data_antes, '=> DEPOIS:', result.data_depois);
                }

                if (response.ok) {
                    // Mostrar detalhes da mudan√ßa
                    if (id && result.data_antes && result.data_depois) {
                        if (result.data_antes !== result.data_depois) {
                            showToast(`‚úÖ Evento atualizado! Data: ${result.data_antes} ‚Üí ${result.data_depois}`, 'success');
                        } else {
                            showToast(`‚úÖ Evento atualizado com sucesso!`, 'success');
                        }
                    } else {
                        showToast(`‚úÖ Evento ${id ? 'atualizado' : 'cadastrado'} com sucesso!`, 'success');
                    }
                    fecharModalEvento();
                    _eventoOriginal = null;
                    await loadEventos();
                } else {
                    showToast(`‚ùå Erro: ${result.error || 'Erro desconhecido'}`, 'error');
                }
            } catch (error) {
                console.error('‚ùå [DEBUG EVENTO] Erro ao salvar evento:', error);
                showToast('‚ùå Erro ao salvar evento. Verifique sua conex√£o.', 'error');
            }
        }

        async function loadEventos() {
            try {
                console.log('üîÑ [DEBUG LOAD] Recarregando eventos...');
                
                const dataInicio = document.getElementById('filtro-data-inicio-evento').value;
                const dataFim = document.getElementById('filtro-data-fim-evento').value;
                const status = document.getElementById('filtro-status-evento').value;

                const params = new URLSearchParams();
                if (dataInicio) params.append('data_inicio', dataInicio);
                if (dataFim) params.append('data_fim', dataFim);
                if (status) params.append('status', status);

                const url = `/api/eventos?${params.toString()}&_t=${Date.now()}`; // Cache buster
                console.log('üîÑ [DEBUG LOAD] URL:', url);
                
                const response = await fetch(url, {
                    credentials: 'include',
                    cache: 'no-cache' // For√ßar buscar do servidor
                });
                const result = await response.json();
                
                console.log('üîÑ [DEBUG LOAD] Eventos recebidos do servidor:', result.eventos?.length || 0);
                if (result.eventos?.length > 0) {
                    result.eventos.forEach((ev, i) => {
                        console.log(`üîÑ [DEBUG LOAD] Evento[${i}] id=${ev.id} nome="${ev.nome_evento}" data=${ev.data_evento}`);
                    });
                }

                const tbody = document.getElementById('tbody-eventos');

                if (result.eventos && result.eventos.length > 0) {
                    tbody.innerHTML = result.eventos.map(evt => {
                        const statusBadge = {
                            'PENDENTE': '<span class="badge badge-warning">Pendente</span>',
                            'EM_ANDAMENTO': '<span class="badge badge-info">Em Andamento</span>',
                            'CONCLUIDO': '<span class="badge badge-success">Conclu√≠do</span>',
                            'CANCELADO': '<span class="badge badge-danger">Cancelado</span>'
                        };
                        
                        return `
                            <tr>
                                <td>${evt.nome_evento}</td>
                                <td>${formatarData(evt.data_evento)}</td>
                                <td>${evt.nf_associada || '-'}</td>
                                <td>${evt.valor_liquido_nf ? formatarMoeda(evt.valor_liquido_nf) : '-'}</td>
                                <td>${evt.custo_evento ? formatarMoeda(evt.custo_evento) : '-'}</td>
                                <td>${evt.margem ? formatarMoeda(evt.margem) : '-'}</td>
                                <td>${(() => {
                                    if (evt.valor_liquido_nf && evt.custo_evento && evt.valor_liquido_nf > 0) {
                                        const lucroPercent = ((evt.valor_liquido_nf - evt.custo_evento) / evt.valor_liquido_nf) * 100;
                                        const cor = lucroPercent >= 0 ? '#27ae60' : '#e74c3c';
                                        return `<span style="color: ${cor}; font-weight: bold;">${lucroPercent.toFixed(2)}%</span>`;
                                    }
                                    return '-';
                                })()}</td>
                                <td>${evt.tipo_evento || '-'}</td>
                                <td>${statusBadge[evt.status] || evt.status}</td>
                                <td>
                                    <button onclick='abrirModalEquipeEvento(${evt.id}, "${evt.nome_evento}", "${evt.data_evento}", ${evt.custo_evento || 0})' class="btn btn-sm btn-info" title="Alocar Equipe" style="background: #9b59b6; margin-right: 5px;">üë•</button>
                                    <button onclick='abrirModalEvento(${JSON.stringify(evt)})' class="btn btn-sm btn-primary" title="Editar">‚úèÔ∏è</button>
                                    <button onclick="deletarEvento(${evt.id})" class="btn btn-sm btn-danger" title="Deletar">üóëÔ∏è</button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 30px; color: #999;">Nenhum evento encontrado</td></tr>';
                }
            } catch (error) {
                console.error('Erro ao carregar eventos:', error);
                document.getElementById('tbody-eventos').innerHTML = '<tr><td colspan="10" style="text-align: center; color: #e74c3c;">Erro ao carregar dados</td></tr>';
            }
        }

        async function deletarEvento(id) {
            if (!confirm('Deseja realmente deletar este evento?')) {
                return;
            }

            try {
                const response = await fetch(`/api/eventos/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                const result = await response.json();

                if (response.ok) {
                    showToast('‚úÖ Evento deletado com sucesso!', 'success');
                    loadEventos();
                } else {
                    showToast(`‚ùå Erro: ${result.error || 'Erro desconhecido'}`, 'error');
                }
            } catch (error) {
                console.error('Erro ao deletar evento:', error);
                showToast('‚ùå Erro ao deletar evento.', 'error');
            }
        }

        function limparFiltrosEvento() {
            document.getElementById('filtro-data-inicio-evento').value = '';
            document.getElementById('filtro-data-fim-evento').value = '';
            document.getElementById('filtro-status-evento').value = '';
            loadEventos();
        }

        // ==========================================
        // ALOCA√á√ÉO DE EQUIPE EM EVENTOS
        // ==========================================
        
        async function abrirModalEquipeEvento(eventoId, nomeEvento, dataEvento, custoAtual) {
            document.getElementById('equipe-evento-id').value = eventoId;
            document.getElementById('equipe-evento-nome').textContent = nomeEvento;
            document.getElementById('equipe-evento-data').textContent = formatarData(dataEvento);
            document.getElementById('equipe-evento-custo-atual').textContent = formatarMoeda(custoAtual || 0);
            
            // Carregar funcion√°rios dispon√≠veis
            await carregarFuncionariosDisponiveis();
            
            // Carregar fun√ß√µes dispon√≠veis
            await carregarFuncoesDisponiveis();
            
            // Carregar setores dispon√≠veis
            await carregarSetoresDisponiveis();
            
            // Carregar equipe j√° alocada
            await carregarEquipeEvento(eventoId);
            
            document.getElementById('modal-equipe-evento').style.display = 'flex';
        }

        function fecharModalEquipeEvento() {
            document.getElementById('modal-equipe-evento').style.display = 'none';
            document.getElementById('form-adicionar-funcionario-evento').reset();
        }

        async function carregarFuncionariosDisponiveis() {
            try {
                const response = await fetch('/api/funcionarios', {
                    credentials: 'include'
                });
                const result = await response.json();

                // Select individual
                const select = document.getElementById('equipe-select-funcionario');
                select.innerHTML = '<option value="">Selecione...</option>';

                // Select m√∫ltiplo (em massa)
                const selectMassa = document.getElementById('equipe-select-funcionarios-massa');
                selectMassa.innerHTML = '';

                if (result.funcionarios && result.funcionarios.length > 0) {
                    // Filtrar apenas funcion√°rios ativos
                    const funcionariosAtivos = result.funcionarios.filter(func => func.ativo !== false);
                    
                    funcionariosAtivos.forEach(func => {
                        // Individual
                        const option = document.createElement('option');
                        option.value = func.id;
                        option.textContent = func.nome;
                        select.appendChild(option);

                        // Em massa
                        const optionMassa = document.createElement('option');
                        optionMassa.value = func.id;
                        optionMassa.textContent = func.nome;
                        selectMassa.appendChild(optionMassa);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar funcion√°rios:', error);
                showToast('‚ùå Erro ao carregar funcion√°rios', 'error');
            }
        }

        async function carregarFuncoesDisponiveis() {
            try {
                const response = await fetch('/api/funcoes-evento', {
                    credentials: 'include'
                });
                const result = await response.json();

                // Select individual
                const select = document.getElementById('equipe-select-funcao');
                select.innerHTML = '<option value="">Selecione...</option>';

                // Select em massa
                const selectMassa = document.getElementById('equipe-select-funcao-massa');
                selectMassa.innerHTML = '<option value="">Selecione...</option>';

                if (result.funcoes && result.funcoes.length > 0) {
                    result.funcoes.forEach(funcao => {
                        // Individual
                        const option = document.createElement('option');
                        option.value = funcao.id;
                        option.textContent = funcao.nome;
                        select.appendChild(option);

                        // Em massa
                        const optionMassa = document.createElement('option');
                        optionMassa.value = funcao.id;
                        optionMassa.textContent = funcao.nome;
                        selectMassa.appendChild(optionMassa);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar fun√ß√µes:', error);
                showToast('‚ùå Erro ao carregar fun√ß√µes', 'error');
            }
        }

        async function carregarSetoresDisponiveis() {
            try {
                const response = await fetch('/api/setores', {
                    credentials: 'include'
                });
                const result = await response.json();

                // Select individual
                const select = document.getElementById('equipe-select-setor');
                select.innerHTML = '<option value="">Nenhum</option>';

                // Select em massa
                const selectMassa = document.getElementById('equipe-select-setor-massa');
                selectMassa.innerHTML = '<option value="">Nenhum</option>';

                if (result.setores && result.setores.length > 0) {
                    // Filtrar apenas setores ativos
                    const setoresAtivos = result.setores.filter(setor => setor.ativo);
                    
                    setoresAtivos.forEach(setor => {
                        // Individual
                        const option = document.createElement('option');
                        option.value = setor.id;
                        option.textContent = setor.nome;
                        select.appendChild(option);

                        // Em massa
                        const optionMassa = document.createElement('option');
                        optionMassa.value = setor.id;
                        optionMassa.textContent = setor.nome;
                        selectMassa.appendChild(optionMassa);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar setores:', error);
                showToast('‚ùå Erro ao carregar setores', 'error');
            }
        }

        async function carregarEquipeEvento(eventoId) {
            try {
                const response = await fetch(`/api/eventos/${eventoId}/equipe`, {
                    credentials: 'include'
                });
                const result = await response.json();

                const tbody = document.getElementById('tbody-equipe-evento');

                if (result.equipe && result.equipe.length > 0) {
                    tbody.innerHTML = result.equipe.map(membro => {
                        // Calcular saldo de horas
                        let saldoHoras = '--:--';
                        if (membro.hora_inicio && membro.hora_fim) {
                            const [h1, m1] = membro.hora_inicio.split(':').map(Number);
                            const [h2, m2] = membro.hora_fim.split(':').map(Number);
                            const inicio = h1 * 60 + m1;
                            const fim = h2 * 60 + m2;
                            let diferenca = fim - inicio;
                            if (diferenca < 0) diferenca += 24 * 60;
                            const horas = Math.floor(diferenca / 60);
                            const minutos = diferenca % 60;
                            saldoHoras = `${String(horas).padStart(2, '0')}:${String(minutos).padStart(2, '0')}`;
                        }
                        
                        return `
                        <tr data-setor-id="${membro.setor_id || ''}" data-chave-pix="${membro.funcionario_chave_pix || '-'}">
                            <td style="padding: 10px;">${membro.funcionario_nome}</td>
                            <td style="padding: 10px;">${membro.funcao_nome}</td>
                            <td style="padding: 10px; color: #555;">${membro.setor_nome || '-'}</td>
                            <td style="padding: 10px; text-align: center; font-weight: bold; color: #3498db;">${saldoHoras}</td>
                            <td style="padding: 10px; text-align: right; font-weight: bold; color: #27ae60;">${formatarMoeda(membro.valor)}</td>
                            <td style="padding: 10px; text-align: center;">
                                <button onclick="removerFuncionarioEvento(${membro.id})" class="btn btn-sm btn-danger" title="Remover">üóëÔ∏è</button>
                            </td>
                        </tr>
                        `;
                    }).join('');

                    // Calcular total
                    const total = result.equipe.reduce((sum, m) => sum + parseFloat(m.valor || 0), 0);
                    document.getElementById('equipe-custo-total').textContent = formatarMoeda(total);
                    document.getElementById('equipe-evento-custo-atual').textContent = formatarMoeda(total);
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: #999;">Nenhum funcion√°rio alocado</td></tr>';
                    document.getElementById('equipe-custo-total').textContent = 'R$ 0,00';
                    document.getElementById('equipe-evento-custo-atual').textContent = 'R$ 0,00';
                }
                
                // ‚úÖ FIX: Atualizar lista de assinatura sempre que equipe mudar
                carregarListaAssinatura();
            } catch (error) {
                console.error('Erro ao carregar equipe:', error);
                showToast('‚ùå Erro ao carregar equipe do evento', 'error');
            }
        }

        async function adicionarFuncionarioEvento(event) {
            event.preventDefault();

            const eventoId = document.getElementById('equipe-evento-id').value;
            const funcionarioId = document.getElementById('equipe-select-funcionario').value;
            const funcaoId = document.getElementById('equipe-select-funcao').value;
            const setorId = document.getElementById('equipe-select-setor').value;
            const valor = parseFloat(document.getElementById('equipe-valor').value);
            const horaInicio = document.getElementById('equipe-hora-inicio').value;
            const horaFim = document.getElementById('equipe-hora-fim').value;

            if (!funcionarioId || !funcaoId || !valor) {
                showToast('‚ö†Ô∏è Preencha todos os campos obrigat√≥rios', 'warning');
                return;
            }

            try {
                const dados = {
                    funcionario_id: parseInt(funcionarioId),
                    funcao_id: parseInt(funcaoId),
                    valor: valor
                };
                
                if (setorId) {
                    dados.setor_id = parseInt(setorId);
                }
                
                if (horaInicio) {
                    dados.hora_inicio = horaInicio;
                }
                
                if (horaFim) {
                    dados.hora_fim = horaFim;
                }
                
                const response = await fetch(`/api/eventos/${eventoId}/equipe`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dados)
                });

                const result = await response.json();

                if (response.ok) {
                    showToast('‚úÖ Cooperado adicionado √† equipe!', 'success');
                    document.getElementById('form-adicionar-funcionario-evento').reset();
                    document.getElementById('equipe-saldo-horas').value = '--:--'; // Limpar saldo
                    await carregarEquipeEvento(eventoId);
                    // ‚úÖ FIX: carregarEquipeEvento j√° atualiza lista de assinatura
                    await loadEventos(); // Atualizar tabela principal
                } else {
                    showToast(`‚ùå ${result.error || 'Erro ao adicionar cooperado'}`, 'error');
                }
            } catch (error) {
                console.error('Erro ao adicionar cooperado:', error);
                showToast('‚ùå Erro ao adicionar cooperado', 'error');
            }
        }

        async function removerFuncionarioEvento(alocacaoId) {
            if (!confirm('Deseja remover este funcion√°rio da equipe?')) {
                return;
            }

            const eventoId = document.getElementById('equipe-evento-id').value;

            try {
                const response = await fetch(`/api/eventos/equipe/${alocacaoId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                const result = await response.json();

                if (response.ok) {
                    showToast('‚úÖ Funcion√°rio removido da equipe!', 'success');
                    await carregarEquipeEvento(eventoId);
                    // ‚úÖ FIX: carregarEquipeEvento j√° atualiza lista de assinatura
                    await loadEventos(); // Atualizar tabela principal
                } else {
                    showToast(`‚ùå ${result.error || 'Erro ao remover funcion√°rio'}`, 'error');
                }
            } catch (error) {
                console.error('Erro ao remover funcion√°rio:', error);
                showToast('‚ùå Erro ao remover funcion√°rio', 'error');
            }
        }

        // ==========================================
        // CADASTRO EM MASSA E ASSINATURA
        // ==========================================

        // Fun√ß√£o para calcular o saldo de horas (individual)
        function calcularSaldoHoras() {
            const horaInicio = document.getElementById('equipe-hora-inicio').value;
            const horaFim = document.getElementById('equipe-hora-fim').value;
            const saldoField = document.getElementById('equipe-saldo-horas');

            if (!horaInicio || !horaFim) {
                saldoField.value = '--:--';
                return;
            }

            try {
                const [h1, m1] = horaInicio.split(':').map(Number);
                const [h2, m2] = horaFim.split(':').map(Number);
                
                const inicio = h1 * 60 + m1;
                const fim = h2 * 60 + m2;
                
                let diferenca = fim - inicio;
                if (diferenca < 0) {
                    diferenca += 24 * 60; // Adiciona 24h se passou da meia-noite
                }
                
                const horas = Math.floor(diferenca / 60);
                const minutos = diferenca % 60;
                
                saldoField.value = `${String(horas).padStart(2, '0')}:${String(minutos).padStart(2, '0')}`;
            } catch (error) {
                saldoField.value = '--:--';
            }
        }

        // Fun√ß√£o para calcular o saldo de horas (massa)
        function calcularSaldoHorasMassa() {
            const horaInicio = document.getElementById('equipe-hora-inicio-massa').value;
            const horaFim = document.getElementById('equipe-hora-fim-massa').value;
            const saldoField = document.getElementById('equipe-saldo-horas-massa');

            if (!horaInicio || !horaFim) {
                saldoField.value = '--:--';
                return;
            }

            try {
                const [h1, m1] = horaInicio.split(':').map(Number);
                const [h2, m2] = horaFim.split(':').map(Number);
                
                const inicio = h1 * 60 + m1;
                const fim = h2 * 60 + m2;
                
                let diferenca = fim - inicio;
                if (diferenca < 0) {
                    diferenca += 24 * 60; // Adiciona 24h se passou da meia-noite
                }
                
                const horas = Math.floor(diferenca / 60);
                const minutos = diferenca % 60;
                
                saldoField.value = `${String(horas).padStart(2, '0')}:${String(minutos).padStart(2, '0')}`;
            } catch (error) {
                saldoField.value = '--:--';
            }
        }

        function trocarAbaEquipe(aba) {
            const tabIndividual = document.getElementById('tab-individual');
            const tabMassa = document.getElementById('tab-massa');
            const tabFornecedores = document.getElementById('tab-fornecedores');
            const tabAssinatura = document.getElementById('tab-assinatura');
            const tabCredenciamento = document.getElementById('tab-credenciamento');
            const formIndividual = document.getElementById('form-container-individual');
            const formMassa = document.getElementById('form-container-massa');
            const formFornecedores = document.getElementById('form-container-fornecedores');
            const formAssinatura = document.getElementById('form-container-assinatura');
            const formCredenciamento = document.getElementById('form-container-credenciamento');

            // Reset todos
            [tabIndividual, tabMassa, tabFornecedores, tabAssinatura, tabCredenciamento].forEach(tab => {
                tab.style.background = '#ecf0f1';
                tab.style.color = '#555';
                tab.style.borderBottom = '3px solid transparent';
            });

            [formIndividual, formMassa, formFornecedores, formAssinatura, formCredenciamento].forEach(form => {
                form.style.display = 'none';
            });

            // Ativar aba selecionada
            if (aba === 'individual') {
                tabIndividual.style.background = '#3498db';
                tabIndividual.style.color = 'white';
                tabIndividual.style.borderBottom = '3px solid #3498db';
                formIndividual.style.display = 'block';
            } else if (aba === 'massa') {
                tabMassa.style.background = '#9b59b6';
                tabMassa.style.color = 'white';
                tabMassa.style.borderBottom = '3px solid #9b59b6';
                formMassa.style.display = 'block';
            } else if (aba === 'fornecedores') {
                tabFornecedores.style.background = '#f39c12';
                tabFornecedores.style.color = 'white';
                tabFornecedores.style.borderBottom = '3px solid #f39c12';
                formFornecedores.style.display = 'block';
                carregarFornecedoresEvento(); // Carregar fornecedores do evento
            } else if (aba === 'assinatura') {
                tabAssinatura.style.background = '#e67e22';
                tabAssinatura.style.color = 'white';
                tabAssinatura.style.borderBottom = '3px solid #e67e22';
                formAssinatura.style.display = 'block';
                carregarListaAssinatura(); // Carregar dados ao abrir
            } else if (aba === 'credenciamento') {
                tabCredenciamento.style.background = '#16a085';
                tabCredenciamento.style.color = 'white';
                tabCredenciamento.style.borderBottom = '3px solid #16a085';
                formCredenciamento.style.display = 'block';
                // Buscar o ID do evento atual selecionado
                const eventoId = document.getElementById('equipe-evento-id').value;
                carregarCredenciamento(eventoId); // Carregar credenciamento APENAS do evento atual
            }
        }

        // ============================================================================
        // FUN√á√ïES PARA GERENCIAR FORNECEDORES DO EVENTO
        // ============================================================================

        async function carregarFornecedoresEvento() {
            const eventoId = document.getElementById('equipe-evento-id').value;
            
            try {
                // Carregar lista de fornecedores cadastrados no sistema
                const responseFornecedores = await fetch('/api/fornecedores?ativos=true', {
                    credentials: 'include'
                });
                const resultFornecedores = await responseFornecedores.json();
                
                const selectFornecedor = document.getElementById('fornecedor-select-fornecedor');
                selectFornecedor.innerHTML = '<option value="">Selecione...</option>';
                
                if (resultFornecedores.success && resultFornecedores.data) {
                    resultFornecedores.data.forEach(fornecedor => {
                        const option = document.createElement('option');
                        option.value = fornecedor.id;
                        option.textContent = fornecedor.nome;
                        selectFornecedor.appendChild(option);
                    });
                }
                
                // Carregar categorias
                await carregarCategoriasFornecedorEvento();
                
                // Carregar fornecedores j√° vinculados ao evento
                await carregarFornecedoresDoEvento(eventoId);
                
            } catch (error) {
                console.error('Erro ao carregar fornecedores:', error);
                showToast('‚ùå Erro ao carregar fornecedores', 'error');
            }
        }

        async function carregarCategoriasFornecedorEvento() {
            try {
                const response = await fetch('/api/categorias', {
                    credentials: 'include'
                });
                const result = await response.json();
                
                const selectCategoria = document.getElementById('fornecedor-select-categoria');
                selectCategoria.innerHTML = '<option value="">Selecione...</option>';
                
                // ‚úÖ FIX: API retorna 'data', n√£o 'categorias'
                if (result.success && result.data && result.data.length > 0) {
                    result.data.forEach(categoria => {
                        const option = document.createElement('option');
                        option.value = categoria.id; // ‚úÖ Usar ID num√©rico
                        option.textContent = categoria.nome;
                        selectCategoria.appendChild(option);
                    });
                } else {
                    console.warn('Nenhuma categoria encontrada');
                }
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
            }
        }

        async function carregarSubcategoriasFornecedorEvento() {
            const categoriaId = document.getElementById('fornecedor-select-categoria').value;
            const selectSubcategoria = document.getElementById('fornecedor-select-subcategoria');
            
            selectSubcategoria.innerHTML = '<option value="">Selecione...</option>';
            
            if (!categoriaId) {
                return;
            }
            
            // ‚úÖ FIX: Fazer requisi√ß√£o √† API de subcategorias
            try {
                const response = await fetch(`/api/subcategorias?categoria_id=${categoriaId}`, {
                    credentials: 'include'
                });
                const result = await response.json();
                
                if (result.success && result.subcategorias && result.subcategorias.length > 0) {
                    result.subcategorias.forEach(subcategoria => {
                        const option = document.createElement('option');
                        option.value = subcategoria.id; // ‚úÖ Usar ID num√©rico
                        option.textContent = subcategoria.nome;
                        selectSubcategoria.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar subcategorias:', error);
            }
        }

        async function carregarFornecedoresDoEvento(eventoId) {
            try {
                const response = await fetch(`/api/eventos/${eventoId}/fornecedores`, {
                    credentials: 'include'
                });
                const result = await response.json();
                
                const tbody = document.getElementById('tbody-fornecedores-evento');
                
                if (result.success && result.fornecedores && result.fornecedores.length > 0) {
                    tbody.innerHTML = result.fornecedores.map(fornecedor => `
                        <tr>
                            <td style="padding: 10px;">${fornecedor.fornecedor_nome}</td>
                            <td style="padding: 10px;">${fornecedor.categoria_nome || '-'}</td>
                            <td style="padding: 10px;">${fornecedor.subcategoria_nome || '-'}</td>
                            <td style="padding: 10px; text-align: right; font-weight: bold; color: #f39c12;">${formatarMoeda(fornecedor.valor)}</td>
                            <td style="padding: 10px; color: #666;">${fornecedor.observacao || '-'}</td>
                            <td style="padding: 10px; text-align: center;">
                                <button onclick="removerFornecedorEvento(${fornecedor.id})" class="btn btn-sm btn-danger" title="Remover">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `).join('');
                    
                    // Calcular total
                    const total = result.fornecedores.reduce((sum, f) => sum + parseFloat(f.valor || 0), 0);
                    document.getElementById('fornecedores-custo-total').textContent = formatarMoeda(total);
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: #999;">Nenhum fornecedor adicionado</td></tr>';
                    document.getElementById('fornecedores-custo-total').textContent = 'R$ 0,00';
                }
            } catch (error) {
                console.error('Erro ao carregar fornecedores do evento:', error);
                showToast('‚ùå Erro ao carregar fornecedores do evento', 'error');
            }
        }

        async function adicionarFornecedorEvento(event) {
            event.preventDefault();
            
            const eventoId = document.getElementById('equipe-evento-id').value;
            const fornecedorId = document.getElementById('fornecedor-select-fornecedor').value;
            const categoriaId = document.getElementById('fornecedor-select-categoria').value;
            const subcategoriaId = document.getElementById('fornecedor-select-subcategoria').value;
            const valor = parseFloat(document.getElementById('fornecedor-valor').value);
            const observacao = document.getElementById('fornecedor-observacao').value;
            
            if (!fornecedorId || !valor) {
                showToast('‚ö†Ô∏è Preencha os campos obrigat√≥rios (Fornecedor e Valor)', 'warning');
                return;
            }
            
            try {
                const dados = {
                    fornecedor_id: parseInt(fornecedorId),
                    valor: valor
                };
                
                if (categoriaId) dados.categoria_id = parseInt(categoriaId);
                if (subcategoriaId) dados.subcategoria_id = parseInt(subcategoriaId);
                if (observacao) dados.observacao = observacao;
                
                const response = await fetch(`/api/eventos/${eventoId}/fornecedores`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dados)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showToast('‚úÖ Fornecedor adicionado ao evento!', 'success');
                    document.getElementById('form-adicionar-fornecedor-evento').reset();
                    await carregarFornecedoresDoEvento(eventoId);
                    await loadEventos(); // Atualizar tabela principal
                } else {
                    showToast(`‚ùå ${result.error || 'Erro ao adicionar fornecedor'}`, 'error');
                }
            } catch (error) {
                console.error('Erro ao adicionar fornecedor:', error);
                showToast('‚ùå Erro ao adicionar fornecedor', 'error');
            }
        }

        async function removerFornecedorEvento(fornecedorEventoId) {
            if (!confirm('Deseja remover este fornecedor do evento?')) {
                return;
            }
            
            const eventoId = document.getElementById('equipe-evento-id').value;
            
            try {
                const response = await fetch(`/api/eventos/fornecedores/${fornecedorEventoId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showToast('‚úÖ Fornecedor removido do evento!', 'success');
                    await carregarFornecedoresDoEvento(eventoId);
                    await loadEventos(); // Atualizar tabela principal
                } else {
                    showToast(`‚ùå ${result.error || 'Erro ao remover fornecedor'}`, 'error');
                }
            } catch (error) {
                console.error('Erro ao remover fornecedor:', error);
                showToast('‚ùå Erro ao remover fornecedor', 'error');
            }
        }

        // ============================================================================
        // FIM DAS FUN√á√ïES DE FORNECEDORES
        // ============================================================================

        function carregarListaAssinatura() {
            const eventoNome = document.getElementById('equipe-evento-nome').textContent;
            const eventoData = document.getElementById('equipe-evento-data').textContent;
            
            // Atualizar cabe√ßalho
            document.getElementById('assinatura-evento-nome').textContent = eventoNome;
            document.getElementById('assinatura-evento-data').textContent = `Data: ${eventoData}`;
            
            // Data de gera√ß√£o
            const agora = new Date();
            const dataFormatada = agora.toLocaleString('pt-BR');
            document.getElementById('assinatura-data-geracao').textContent = dataFormatada;
            
            // Carregar equipe
            const tbody = document.getElementById('tbody-assinatura-evento');
            const tbodyEquipe = document.getElementById('tbody-equipe-evento');
            
            // Clonar dados da tabela principal
            const linhasEquipe = tbodyEquipe.querySelectorAll('tr');
            
            if (linhasEquipe.length === 1 && linhasEquipe[0].cells.length === 1) {
                // ‚ö†Ô∏è IMPORTANTE: 6 colunas agora (com Chave PIX)
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: #999;">Nenhum funcion√°rio alocado</td></tr>';
                return;
            }
            
            let html = '';
            linhasEquipe.forEach((linha, index) => {
                const cells = linha.cells;
                if (cells.length >= 5) {
                    const funcionario = cells[0].textContent;
                    const chavePix = linha.getAttribute('data-chave-pix') || '-';
                    const funcao = cells[1].textContent;
                    const setor = cells[2].textContent;
                    // ‚ö†Ô∏è REMOVIDO: const valor = cells[4].textContent; - N√£o mostrar valor na aba Assinatura!
                    const setorId = linha.getAttribute('data-setor-id') || '';
                    
                    html += `
                        <tr style="page-break-inside: avoid;" data-setor-id="${setorId}" data-chave-pix="${chavePix}">
                            <td style="padding: 15px 12px; border: 1px solid #ddd; text-align: center; font-weight: bold;">${index + 1}</td>
                            <td style="padding: 15px 12px; border: 1px solid #ddd;">${funcionario}</td>
                            <td style="padding: 15px 12px; border: 1px solid #ddd; font-family: monospace; font-size: 11px;">${chavePix}</td>
                            <td style="padding: 15px 12px; border: 1px solid #ddd;">${funcao}</td>
                            <td style="padding: 15px 12px; border: 1px solid #ddd;">${setor}</td>
                            <!-- ‚ö†Ô∏è REMOVIDA coluna Valor (R$) - S√≥ no Excel! -->
                            <td style="padding: 15px 12px; border: 1px solid #ddd; text-align: center;"></td>
                        </tr>
                    `;
                }
            });
            
            tbody.innerHTML = html || '<tr><td colspan="6" style="text-align: center; padding: 30px; color: #999;">Nenhum funcion√°rio alocado</td></tr>';
        }

        function toggleValorMassa() {
            const checkbox = document.getElementById('equipe-aplicar-valor-massa');
            const input = document.getElementById('equipe-valor-massa');
            
            if (checkbox.checked) {
                input.disabled = false;
                input.required = true;
                input.focus();
            } else {
                input.disabled = true;
                input.required = false;
                input.value = '';
            }
        }

        function filtrarFuncionarios(tipo) {
            let searchInput, select;
            
            if (tipo === 'individual') {
                searchInput = document.getElementById('equipe-search-funcionario');
                select = document.getElementById('equipe-select-funcionario');
            } else {
                searchInput = document.getElementById('equipe-search-funcionarios-massa');
                select = document.getElementById('equipe-select-funcionarios-massa');
            }
            
            const searchTerm = searchInput.value.toLowerCase().trim();
            const options = select.querySelectorAll('option');
            
            let visibleCount = 0;
            
            options.forEach(option => {
                if (option.value === '') {
                    // Op√ß√£o "Selecione..." sempre vis√≠vel (apenas no individual)
                    if (tipo === 'individual') {
                        option.style.display = '';
                    }
                    return;
                }
                
                const text = option.textContent.toLowerCase();
                
                if (searchTerm === '' || text.includes(searchTerm)) {
                    option.style.display = '';
                    visibleCount++;
                } else {
                    option.style.display = 'none';
                }
            });
            
            // Feedback visual se nenhum resultado
            if (visibleCount === 0 && searchTerm !== '') {
                if (tipo === 'individual') {
                    // Criar op√ß√£o tempor√°ria com mensagem
                    let noResultOption = select.querySelector('.no-result-message');
                    if (!noResultOption) {
                        noResultOption = document.createElement('option');
                        noResultOption.className = 'no-result-message';
                        noResultOption.disabled = true;
                        noResultOption.style.fontStyle = 'italic';
                        noResultOption.style.color = '#999';
                        select.appendChild(noResultOption);
                    }
                    noResultOption.textContent = '‚ùå Nenhum funcion√°rio encontrado';
                    noResultOption.style.display = '';
                } else {
                    // Para massa, apenas deixar vazio (j√° est√° filtrado)
                }
            } else {
                // Remover mensagem de "n√£o encontrado"
                const noResultOption = select.querySelector('.no-result-message');
                if (noResultOption) {
                    noResultOption.style.display = 'none';
                }
            }
        }

        // ==========================================
        // EXPORTA√á√ÉO DE ASSINATURA
        // ==========================================

        function exportarAssinaturaPDF() {
            const { jsPDF } = window.jspdf;
            
            // Obter dados
            const eventoNome = document.getElementById('assinatura-evento-nome').textContent;
            const eventoData = document.getElementById('assinatura-evento-data').textContent;
            const tbody = document.getElementById('tbody-assinatura-evento');
            const linhas = tbody.querySelectorAll('tr');
            
            // Verificar se h√° dados
            if (linhas.length === 1 && linhas[0].cells.length === 1) {
                showToast('‚ö†Ô∏è Nenhum funcion√°rio para exportar', 'warning');
                return;
            }
            
            // Coletar setores √∫nicos
            const setores = new Map(); // Map<setorId, {nome, funcionarios[]}>
            
            linhas.forEach((linha, index) => {
                const cells = linha.cells;
                if (cells.length >= 6) {
                    const setorId = linha.getAttribute('data-setor-id') || 'sem-setor';
                    const setorNome = cells[4].textContent.trim() || 'Sem Setor';
                    const chavePix = linha.getAttribute('data-chave-pix') || '-';
                    
                    if (!setores.has(setorId)) {
                        setores.set(setorId, { nome: setorNome, funcionarios: [] });
                    }
                    
                    setores.get(setorId).funcionarios.push({
                        funcionario: cells[1].textContent,
                        chave_pix: chavePix,
                        funcao: cells[3].textContent,
                        setor: setorNome
                    });
                }
            });
            
            // Gerar um PDF para cada setor
            let totalPDFs = 0;
            const agora = new Date().toLocaleString('pt-BR');
            
            setores.forEach((setor, setorId) => {
                const doc = new jsPDF();
                
                // Cabe√ßalho
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('Lista de Presen√ßa - Evento', 105, 20, { align: 'center' });
                
                doc.setFontSize(14);
                doc.setFont(undefined, 'normal');
                doc.text(eventoNome, 105, 30, { align: 'center' });
                
                doc.setFontSize(12);
                doc.text(eventoData, 105, 38, { align: 'center' });
                
                // Setor
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(52, 152, 219);
                doc.text(`Setor: ${setor.nome}`, 105, 45, { align: 'center' });
                doc.setTextColor(0, 0, 0);
                
                // Preparar dados da tabela
                // ‚ö†Ô∏è IMPORTANTE: PDF DEVE TER CHAVE PIX mas N√ÉO coluna "VALOR (R$)" - Apenas Excel deve ter valor!
                const tableData = setor.funcionarios.map((func, idx) => [
                    idx + 1,
                    func.funcionario,
                    func.chave_pix,
                    func.funcao,
                    func.setor,
                    '' // Coluna de Assinatura (removido Valor - n√£o vai no PDF!)
                ]);
                
                // Gerar tabela
                doc.autoTable({
                    startY: 52,
                    // ‚ö†Ô∏è IMPORTANTE: PDF TEM CHAVE PIX mas N√ÉO TEM COLUNA "VALOR (R$)" - Apenas no Excel!
                    head: [['#', 'Funcion√°rio', 'Chave PIX', 'Fun√ß√£o', 'Setor', 'Assinatura']],
                    body: tableData,
                    theme: 'grid',
                    headStyles: { fillColor: [52, 152, 219], fontSize: 10, fontStyle: 'bold' },
                    bodyStyles: { fontSize: 9 },
                    columnStyles: {
                        0: { halign: 'center', cellWidth: 10 },  // #
                        1: { cellWidth: 45 },                     // Funcion√°rio
                        2: { cellWidth: 35, fontSize: 8 },       // Chave PIX
                        3: { cellWidth: 35 },                     // Fun√ß√£o
                        4: { cellWidth: 25 },                     // Setor
                        5: { halign: 'center', cellWidth: 40 }    // Assinatura (sem Valor!)
                    },
                    margin: { top: 52, bottom: 20 }
                });
                
                // Rodap√©
                doc.setFontSize(9);
                doc.setTextColor(150);
                doc.text(`Documento gerado em ${agora} - ${tableData.length} funcion√°rio(s)`, 105, doc.internal.pageSize.height - 10, { align: 'center' });
                
                // Salvar
                const nomeArquivo = `Lista_Assinatura_${eventoNome.replace(/[^a-z0-9]/gi, '_')}_${setor.nome.replace(/[^a-z0-9]/gi, '_')}.pdf`;
                doc.save(nomeArquivo);
                
                totalPDFs++;
            });
            
            showToast(`‚úÖ ${totalPDFs} PDF(s) exportado(s) com sucesso! (1 por setor)`, 'success');
        }

        function exportarAssinaturaExcel() {
            // ‚úÖ IMPORTANTE: Excel DEVE TER coluna "Valor (R$)" - Apenas PDF n√£o tem!
            // Obter dados
            const eventoNome = document.getElementById('assinatura-evento-nome').textContent;
            const eventoData = document.getElementById('assinatura-evento-data').textContent;
            const tbody = document.getElementById('tbody-equipe-evento'); // Pegar da tabela principal para ter o valor
            const linhas = tbody.querySelectorAll('tr');
            
            // Verificar se h√° dados
            if (linhas.length === 1 && linhas[0].cells.length === 1) {
                showToast('‚ö†Ô∏è Nenhum funcion√°rio para exportar', 'warning');
                return;
            }
            
            // Preparar dados
            const dados = [];
            
            // Cabe√ßalho
            dados.push(['Lista de Equipe - Evento']);
            dados.push([eventoNome]);
            dados.push([eventoData]);
            dados.push([]); // Linha vazia
            // ‚úÖ IMPORTANTE: Excel DEVE TER colunas "Chave PIX" e "Valor (R$)"!
            dados.push(['#', 'Funcion√°rio', 'Chave PIX', 'Fun√ß√£o', 'Setor', 'Valor (R$)']);
            
            // Dados
            linhas.forEach((linha, index) => {
                const cells = linha.cells;
                if (cells.length >= 5) {
                    const funcionario = cells[0].textContent;
                    const chavePix = linha.getAttribute('data-chave-pix') || '-';
                    const funcao = cells[1].textContent;
                    const setor = cells[2].textContent;
                    // cells[4] √© o Valor (cells[3] √© Saldo de Horas)
                    const valorTexto = cells[4].textContent.replace('R$', '').replace(/\./g, '').replace(',', '.').trim();
                    const valor = parseFloat(valorTexto) || 0;
                    
                    dados.push([
                        index + 1,
                        funcionario,
                        chavePix,
                        funcao,
                        setor,
                        valor
                    ]);
                }
            });
            
            // Criar workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(dados);
            
            // Estilizar (largura das colunas)
            ws['!cols'] = [
                { wch: 5 },  // #
                { wch: 30 }, // Funcion√°rio
                { wch: 25 }, // Chave PIX
                { wch: 25 }, // Fun√ß√£o
                { wch: 20 }, // Setor
                { wch: 15 }  // Valor
            ];
            
            // Adicionar worksheet
            XLSX.utils.book_append_sheet(wb, ws, 'Equipe');
            
            // Salvar
            const nomeArquivo = `Lista_Equipe_${eventoNome.replace(/[^a-z0-9]/gi, '_')}.xlsx`;
            XLSX.writeFile(wb, nomeArquivo);
            
            showToast('‚úÖ Excel exportado com sucesso!', 'success');
        }

        async function adicionarFuncionariosMassa(event) {
            event.preventDefault();

            const eventoId = document.getElementById('equipe-evento-id').value;
            const funcaoId = document.getElementById('equipe-select-funcao-massa').value;
            const setorId = document.getElementById('equipe-select-setor-massa').value;
            const selectFuncionarios = document.getElementById('equipe-select-funcionarios-massa');
            const aplicarValor = document.getElementById('equipe-aplicar-valor-massa').checked;
            const valor = aplicarValor ? parseFloat(document.getElementById('equipe-valor-massa').value) : 0;
            const horaInicio = document.getElementById('equipe-hora-inicio-massa').value;
            const horaFim = document.getElementById('equipe-hora-fim-massa').value;

            // Pegar funcion√°rios selecionados
            const funcionariosSelecionados = Array.from(selectFuncionarios.selectedOptions).map(opt => parseInt(opt.value));

            if (!funcaoId) {
                showToast('‚ö†Ô∏è Selecione uma fun√ß√£o', 'warning');
                return;
            }

            if (funcionariosSelecionados.length === 0) {
                showToast('‚ö†Ô∏è Selecione pelo menos um cooperado', 'warning');
                return;
            }

            if (aplicarValor && (!valor || valor < 0)) {
                showToast('‚ö†Ô∏è Valor inv√°lido', 'warning');
                return;
            }

            // Confirmar
            const nomeFuncao = selectFuncionarios.options[selectFuncionarios.selectedIndex].parentElement.label || 'cooperados';
            if (!confirm(`Adicionar ${funcionariosSelecionados.length} cooperado(s) na fun√ß√£o selecionada?`)) {
                return;
            }

            // Enviar em lote
            let sucessos = 0;
            let erros = [];
            let duplicados = 0;

            showToast(`‚è≥ Adicionando ${funcionariosSelecionados.length} cooperado(s)...`, 'info');

            for (const funcId of funcionariosSelecionados) {
                try {
                    const dados = {
                        funcionario_id: funcId,
                        funcao_id: parseInt(funcaoId),
                        valor: valor
                    };
                    
                    if (setorId) {
                        dados.setor_id = parseInt(setorId);
                    }
                    
                    if (horaInicio) {
                        dados.hora_inicio = horaInicio;
                    }
                    
                    if (horaFim) {
                        dados.hora_fim = horaFim;
                    }
                    
                    console.log('[MASSA] Enviando dados:', dados); // DEBUG
                    
                    const response = await fetch(`/api/eventos/${eventoId}/equipe`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(dados)
                    });

                    if (response.ok) {
                        sucessos++;
                    } else {
                        const errorData = await response.json();
                        console.error('[MASSA] Erro:', response.status, errorData); // DEBUG
                        
                        // Verificar se √© erro de duplica√ß√£o
                        if (errorData.error && errorData.error.includes('j√° est√° alocado')) {
                            duplicados++;
                        } else {
                            erros.push(`${errorData.error || 'Erro desconhecido'}`);
                        }
                    }
                } catch (error) {
                    console.error('[MASSA] Exce√ß√£o:', error);
                    erros.push(error.message);
                }
            }

            // Resultado
            if (sucessos > 0) {
                showToast(`‚úÖ ${sucessos} cooperado(s) adicionado(s) com sucesso!`, 'success');
                document.getElementById('form-adicionar-massa-evento').reset();
                document.getElementById('equipe-saldo-horas-massa').value = '--:--'; // Limpar saldo
                await carregarEquipeEvento(eventoId);
                await loadEventos();
            }

            if (duplicados > 0) {
                showToast(`‚ö†Ô∏è ${duplicados} cooperado(s) j√° estava(m) alocado(s) neste evento`, 'warning');
            }

            if (erros.length > 0) {
                console.error('[MASSA] Lista de erros:', erros);
                showToast(`‚ùå ${erros.length} erro(s): ${erros[0]}`, 'error');
                // Mostrar todos os erros no console para debug
                erros.forEach((erro, index) => {
                    console.error(`[MASSA] Erro ${index + 1}:`, erro);
                });
            }
        }

        // ==========================================
        // CREDENCIAMENTO
        // ==========================================

        async function carregarCredenciamento(eventoId) {
            const tbody = document.getElementById('tbody-credenciamento-evento');
            const totalElement = document.getElementById('credenciamento-total-cooperados');

            console.log('[CREDENCIAMENTO] Carregando evento ID:', eventoId);
            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 30px; color: #999;">Carregando...</td></tr>';

            try {
                // Buscar equipe APENAS do evento atual, n√£o de todos os eventos
                const response = await fetch(`/api/eventos/${eventoId}/equipe`, {
                    method: 'GET',
                    credentials: 'include'
                });

                console.log('[CREDENCIAMENTO] Response status:', response.status);

                if (!response.ok) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 30px; color: #e74c3c;">Erro ao carregar equipe do evento</td></tr>';
                    totalElement.textContent = '0';
                    return;
                }

                const result = await response.json();
                const equipe = result.equipe || result;

                console.log('[CREDENCIAMENTO] Equipe recebida:', equipe);
                console.log('[CREDENCIAMENTO] Quantidade de membros:', equipe?.length);

                if (!equipe || equipe.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 30px; color: #999;">Nenhum cooperado alocado neste evento</td></tr>';
                    totalElement.textContent = '0';
                    return;
                }

                let html = '';
                
                equipe.forEach((item) => {
                    const horaInicio = item.hora_inicio || '--:--';
                    const horaFim = item.hora_fim || '--:--';
                    let totalTrabalhado = '--:--';

                    // Calcular total trabalhado se ambos os hor√°rios existirem
                    if (item.hora_inicio && item.hora_fim) {
                        try {
                            const [h1, m1] = item.hora_inicio.split(':').map(Number);
                            const [h2, m2] = item.hora_fim.split(':').map(Number);
                            
                            const inicio = h1 * 60 + m1;
                            const fim = h2 * 60 + m2;
                            
                            let diferenca = fim - inicio;
                            if (diferenca < 0) diferenca += 24 * 60;
                            
                            const horas = Math.floor(diferenca / 60);
                            const minutos = diferenca % 60;
                            
                            totalTrabalhado = `${String(horas).padStart(2, '0')}:${String(minutos).padStart(2, '0')}`;
                        } catch (error) {
                            totalTrabalhado = '--:--';
                        }
                    }

                    html += `
                        <tr>
                            <td style="padding: 12px; border: 1px solid #ddd;">${item.funcionario_nome || 'N/A'}</td>
                            <td style="padding: 12px; border: 1px solid #ddd;">${item.funcionario_cpf || 'N/A'}</td>
                            <td style="padding: 12px; border: 1px solid #ddd; font-family: monospace; font-size: 11px;">${item.funcionario_chave_pix || '-'}</td>
                            <td style="padding: 12px; border: 1px solid #ddd;">${item.funcionario_email || 'N/A'}</td>
                            <td style="padding: 12px; border: 1px solid #ddd;">${item.funcao_nome || 'N/A'}</td>
                            <td style="padding: 12px; border: 1px solid #ddd;">${item.setor_nome || 'N/A'}</td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${horaInicio}</td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${horaFim}</td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: center; font-weight: bold; color: #27ae60;">${totalTrabalhado}</td>
                        </tr>
                    `;
                });

                tbody.innerHTML = html;
                totalElement.textContent = equipe.length;
                
                console.log('[CREDENCIAMENTO] ‚úÖ Tabela renderizada com', equipe.length, 'cooperados');
                
            } catch (error) {
                console.error('[CREDENCIAMENTO] ‚ùå Erro ao carregar:', error);
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 30px; color: #e74c3c;">Erro ao carregar dados</td></tr>';
                totalElement.textContent = '0';
            }
        }

        function exportarCredenciamento() {
            const tbody = document.getElementById('tbody-credenciamento-evento');
            const rows = tbody.querySelectorAll('tr');
            
            if (rows.length === 0 || rows[0].querySelector('td[colspan]')) {
                showToast('‚ö†Ô∏è N√£o h√° dados para exportar', 'warning');
                return;
            }

            // Criar HTML formatado para Excel (formato HTML table funciona perfeitamente no Excel)
            const totalCooperados = document.getElementById('credenciamento-total-cooperados').textContent;
            const dataAtual = new Date().toLocaleDateString('pt-BR');
            const horaAtual = new Date().toLocaleTimeString('pt-BR');
            
            let html = `
                <html xmlns:x="urn:schemas-microsoft-com:office:excel">
                <head>
                    <meta charset="UTF-8">
                    <style>
                        table { border-collapse: collapse; width: 100%; }
                        th { 
                            background-color: #4472C4; 
                            color: white; 
                            font-weight: bold; 
                            padding: 10px; 
                            border: 1px solid #000;
                            text-align: center;
                        }
                        td { 
                            padding: 8px; 
                            border: 1px solid #D0D0D0;
                        }
                        tr:nth-child(even) { background-color: #F2F2F2; }
                        .header { 
                            font-size: 18pt; 
                            font-weight: bold; 
                            text-align: center; 
                            margin-bottom: 10px;
                            color: #1F4E78;
                        }
                        .info { 
                            text-align: center; 
                            font-size: 10pt; 
                            color: #595959;
                            margin-bottom: 20px;
                        }
                        .total {
                            font-weight: bold;
                            background-color: #E7E6E6;
                            text-align: right;
                            padding: 10px;
                            margin-top: 10px;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">üé´ CREDENCIAMENTO - LISTA DE COOPERADOS</div>
                    <div class="info">
                        Emitido em: ${dataAtual} √†s ${horaAtual}<br>
                        Sistema Financeiro DWM
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Cooperado</th>
                                <th>CPF</th>
                                <th>Chave PIX</th>
                                <th>E-mail</th>
                                <th>Fun√ß√£o</th>
                                <th>Setor</th>
                                <th>Hora In√≠cio</th>
                                <th>Hora Fim</th>
                                <th>Total Trabalhado</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                
                // Apenas processar linhas de dados (9 c√©lulas agora com Chave PIX)
                if (cells.length === 9) {
                    html += `
                        <tr>
                            <td>${cells[0].textContent.trim()}</td>
                            <td style="mso-number-format:'\\@';">${cells[1].textContent.trim()}</td>
                            <td style="mso-number-format:'\\@'; font-family: monospace;">${cells[2].textContent.trim()}</td>
                            <td>${cells[3].textContent.trim()}</td>
                            <td>${cells[4].textContent.trim()}</td>
                            <td>${cells[5].textContent.trim()}</td>
                            <td style="text-align: center;">${cells[6].textContent.trim()}</td>
                            <td style="text-align: center;">${cells[7].textContent.trim()}</td>
                            <td style="text-align: center; font-weight: bold; color: #27AE60;">${cells[8].textContent.trim()}</td>
                        </tr>
                    `;
                }
            });
            
            html += `
                        </tbody>
                    </table>
                    
                    <div class="total">
                        Total de Cooperados: ${totalCooperados}
                    </div>
                </body>
                </html>
            `;

            // Criar blob com formato XLS (Excel abre nativamente arquivos HTML com extens√£o .xls)
            const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const dataArquivo = new Date().toISOString().split('T')[0];
            link.setAttribute('href', url);
            link.setAttribute('download', `Credenciamento_${dataArquivo}.xls`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('‚úÖ Arquivo Excel exportado com sucesso!', 'success');
        }

        function imprimirCredenciamento() {
            const tbody = document.getElementById('tbody-credenciamento-evento');
            const rows = tbody.querySelectorAll('tr');
            
            if (rows.length === 0 || rows[0].querySelector('td[colspan]')) {
                showToast('‚ö†Ô∏è N√£o h√° dados para imprimir', 'warning');
                return;
            }

            // Preparar HTML para impress√£o
            let html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Credenciamento - Lista de Cooperados</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 15mm;
                        }
                        
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 10pt;
                            margin: 0;
                            padding: 0;
                        }
                        
                        h1 {
                            text-align: center;
                            font-size: 18pt;
                            margin-bottom: 10px;
                            color: #2c3e50;
                        }
                        
                        .info {
                            text-align: center;
                            font-size: 9pt;
                            color: #7f8c8d;
                            margin-bottom: 20px;
                        }
                        
                        .evento-header {
                            background: #3498db;
                            color: white;
                            padding: 8px;
                            font-weight: bold;
                            font-size: 11pt;
                            margin-top: 15px;
                            page-break-after: avoid;
                        }
                        
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 20px;
                            page-break-inside: auto;
                        }
                        
                        thead {
                            display: table-header-group;
                        }
                        
                        tr {
                            page-break-inside: avoid;
                            page-break-after: auto;
                        }
                        
                        th {
                            background: #ecf0f1;
                            padding: 6px 4px;
                            text-align: left;
                            font-size: 9pt;
                            border: 1px solid #bdc3c7;
                            font-weight: bold;
                        }
                        
                        td {
                            padding: 5px 4px;
                            border: 1px solid #ddd;
                            font-size: 9pt;
                        }
                        
                        tbody tr:nth-child(even) {
                            background: #f9f9f9;
                        }
                        
                        .footer {
                            margin-top: 30px;
                            text-align: center;
                            font-size: 8pt;
                            color: #95a5a6;
                        }
                        
                        @media print {
                            .no-print {
                                display: none;
                            }
                        }
                    </style>
                </head>
                <body>
                    <h1>üé´ Credenciamento - Lista de Cooperados</h1>
                    <div class="info">
                        Data de Emiss√£o: ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}
                    </div>
            `;

            // Criar tabela √∫nica com todos os dados
            html += `
                <table>
                    <thead>
                        <tr>
                            <th>Cooperado</th>
                            <th>CPF</th>
                            <th>Chave PIX</th>
                            <th>E-mail</th>
                            <th>Fun√ß√£o</th>
                            <th>Setor</th>
                            <th style="text-align: center;">H. In√≠cio</th>
                            <th style="text-align: center;">H. Fim</th>
                            <th style="text-align: center;">Total</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                
                // Apenas processar linhas de dados (9 c√©lulas agora com Chave PIX)
                if (cells.length === 9) {
                    html += `
                        <tr>
                            <td>${cells[0].textContent.trim()}</td>
                            <td style="font-size: 8pt;">${cells[1].textContent.trim()}</td>
                            <td style="font-size: 8pt; font-family: monospace;">${cells[2].textContent.trim()}</td>
                            <td style="font-size: 8pt;">${cells[3].textContent.trim()}</td>
                            <td>${cells[4].textContent.trim()}</td>
                            <td>${cells[5].textContent.trim()}</td>
                            <td style="text-align: center;">${cells[6].textContent.trim()}</td>
                            <td style="text-align: center;">${cells[7].textContent.trim()}</td>
                            <td style="text-align: center; font-weight: bold;">${cells[8].textContent.trim()}</td>
                        </tr>
                    `;
                }
            });
            
            // Fechar tabela
            html += '</tbody></table>';
            
            const totalCooperados = document.getElementById('credenciamento-total-cooperados').textContent;
            html += `
                    <div class="footer">
                        <strong>Total de Cooperados: ${totalCooperados}</strong><br>
                        Sistema Financeiro DWM - Credenciamento de Eventos
                    </div>
                </body>
                </html>
            `;

            // Abrir nova janela e imprimir
            const printWindow = window.open('', '_blank');
            printWindow.document.write(html);
            printWindow.document.close();
            
            // Aguardar carregamento e imprimir
            printWindow.onload = function() {
                printWindow.focus();
                printWindow.print();
            };
            
            showToast('‚úÖ Abrindo visualiza√ß√£o de impress√£o...', 'success');
        }

        // ==========================================
        // CADASTRO DE NOVAS FUN√á√ïES
        // ==========================================

        function abrirModalNovaFuncao() {
            document.getElementById('modal-nova-funcao').style.display = 'flex';
        }

        function fecharModalNovaFuncao() {
            document.getElementById('modal-nova-funcao').style.display = 'none';
            document.getElementById('form-nova-funcao').reset();
        }

        async function salvarNovaFuncao(event) {
            event.preventDefault();

            const nome = document.getElementById('nova-funcao-nome').value;
            const descricao = document.getElementById('nova-funcao-descricao').value;

            try {
                const response = await fetch('/api/funcoes-evento', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        nome: nome,
                        descricao: descricao
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showToast('‚úÖ Fun√ß√£o cadastrada com sucesso!', 'success');
                    fecharModalNovaFuncao();
                    await carregarFuncoesDisponiveis(); // Recarregar lista de fun√ß√µes
                } else {
                    showToast(`‚ùå ${result.error || 'Erro ao cadastrar fun√ß√£o'}`, 'error');
                }
            } catch (error) {
                console.error('Erro ao salvar fun√ß√£o:', error);
                showToast('‚ùå Erro ao salvar fun√ß√£o', 'error');
            }
        }

        // ==========================================
        // GERENCIAMENTO DE SETORES
        // ==========================================

        // ====================================
        // FUN√á√ïES DE EVENTOS
        // ====================================

        function abrirModalFuncoes() {
            document.getElementById('modal-funcoes').style.display = 'flex';
            carregarFuncoes();
        }

        function fecharModalFuncoes() {
            document.getElementById('modal-funcoes').style.display = 'none';
            document.getElementById('form-nova-funcao').reset();
        }

        async function carregarFuncoes() {
            try {
                const response = await fetch('/api/funcoes-evento', {
                    credentials: 'include'
                });
                const result = await response.json();

                const tbody = document.getElementById('tbody-funcoes');

                if (result.funcoes && result.funcoes.length > 0) {
                    tbody.innerHTML = result.funcoes.map(funcao => `
                        <tr>
                            <td style="padding: 10px;">${funcao.nome}</td>
                            <td style="padding: 10px;">${funcao.descricao || '-'}</td>
                            <td style="padding: 10px; text-align: center;">
                                <button onclick="editarFuncao(${funcao.id}, '${funcao.nome.replace(/'/g, "\\'")}', '${(funcao.descricao || '').replace(/'/g, "\\'")}', ${funcao.ativo})" class="btn btn-sm" style="background: #3498db; padding: 5px 10px; color: white; margin-right: 5px;" title="Editar">
                                    ‚úèÔ∏è
                                </button>
                                <button onclick="excluirFuncao(${funcao.id}, '${funcao.nome.replace(/'/g, "\\'")}')" class="btn btn-sm" style="background: #c0392b; padding: 5px 10px; color: white;" title="Excluir">
                                    üóëÔ∏è
                                </button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 30px; color: #999;">Nenhuma fun√ß√£o cadastrada</td></tr>';
                }
            } catch (error) {
                console.error('Erro ao carregar fun√ß√µes:', error);
                showToast('‚ùå Erro ao carregar fun√ß√µes', 'error');
            }
        }

        async function salvarNovaFuncao(event) {
            event.preventDefault();

            const nome = document.getElementById('nova-funcao-nome').value;
            const descricao = document.getElementById('nova-funcao-descricao').value;

            try {
                const response = await fetch('/api/funcoes-evento', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        nome: nome,
                        descricao: descricao
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showToast('‚úÖ Fun√ß√£o cadastrada com sucesso!', 'success');
                    document.getElementById('form-nova-funcao').reset();
                    await carregarFuncoes();
                } else {
                    showToast(`‚ùå ${result.error || 'Erro ao cadastrar fun√ß√£o'}`, 'error');
                }
            } catch (error) {
                console.error('Erro ao salvar fun√ß√£o:', error);
                showToast('‚ùå Erro ao salvar fun√ß√£o', 'error');
            }
        }

        async function editarFuncao(funcaoId, nomeAtual, descricaoAtual, ativoAtual) {
            const novoNome = prompt('Nome da fun√ß√£o:', nomeAtual);
            if (!novoNome) return;

            const novaDescricao = prompt('Descri√ß√£o da fun√ß√£o:', descricaoAtual);

            try {
                const response = await fetch(`/api/funcoes-evento/${funcaoId}`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        nome: novoNome,
                        descricao: novaDescricao,
                        ativo: ativoAtual
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showToast('‚úÖ Fun√ß√£o atualizada com sucesso!', 'success');
                    await carregarFuncoes();
                    // Recarregar fun√ß√µes dispon√≠veis em outros selects
                    if (typeof carregarFuncoesDisponiveis === 'function') {
                        await carregarFuncoesDisponiveis();
                    }
                } else {
                    showToast(`‚ùå ${result.error || 'Erro ao atualizar fun√ß√£o'}`, 'error');
                }
            } catch (error) {
                console.error('Erro ao atualizar fun√ß√£o:', error);
                showToast('‚ùå Erro ao atualizar fun√ß√£o', 'error');
            }
        }

        async function excluirFuncao(funcaoId, nomeFuncao) {
            if (!confirm(`Tem certeza que deseja excluir a fun√ß√£o "${nomeFuncao}"?\n\nEsta a√ß√£o n√£o pode ser desfeita e s√≥ ser√° poss√≠vel se a fun√ß√£o n√£o estiver em uso.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/funcoes-evento/${funcaoId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                const result = await response.json();

                if (response.ok) {
                    showToast('‚úÖ Fun√ß√£o exclu√≠da com sucesso!', 'success');
                    await carregarFuncoes();
                    // Recarregar fun√ß√µes dispon√≠veis em outros selects
                    if (typeof carregarFuncoesDisponiveis === 'function') {
                        await carregarFuncoesDisponiveis();
                    }
                } else {
                    showToast(`‚ùå ${result.error || 'Erro ao excluir fun√ß√£o'}`, 'error');
                }
            } catch (error) {
                console.error('Erro ao excluir fun√ß√£o:', error);
                showToast('‚ùå Erro ao excluir fun√ß√£o', 'error');
            }
        }

        // Expor fun√ß√µes globalmente
        window.abrirModalFuncoes = abrirModalFuncoes;
        window.fecharModalFuncoes = fecharModalFuncoes;
        window.carregarFuncoes = carregarFuncoes;
        window.salvarNovaFuncao = salvarNovaFuncao;
        window.editarFuncao = editarFuncao;
        window.excluirFuncao = excluirFuncao;

        // ====================================
        // SETORES
        // ====================================

        function abrirModalSetores() {
            document.getElementById('modal-setores').style.display = 'flex';
            carregarSetores();
        }

        function fecharModalSetores() {
            document.getElementById('modal-setores').style.display = 'none';
            document.getElementById('form-novo-setor').reset();
        }

        async function carregarSetores() {
            try {
                const response = await fetch('/api/setores', {
                    credentials: 'include'
                });
                const result = await response.json();

                const tbody = document.getElementById('tbody-setores');

                if (result.setores && result.setores.length > 0) {
                    tbody.innerHTML = result.setores.map(setor => `
                        <tr>
                            <td style="padding: 10px;">${setor.nome}</td>
                            <td style="padding: 10px; text-align: center;">
                                ${setor.ativo ? '<span style="color: #27ae60; font-weight: bold;">‚úì Ativo</span>' : '<span style="color: #95a5a6;">Inativo</span>'}
                            </td>
                            <td style="padding: 10px; text-align: center;">
                                <button onclick="toggleStatusSetor(${setor.id}, ${!setor.ativo})" class="btn btn-sm" style="background: ${setor.ativo ? '#e74c3c' : '#27ae60'}; padding: 5px 10px; color: white; margin-right: 5px;" title="${setor.ativo ? 'Desativar' : 'Ativar'}">
                                    ${setor.ativo ? 'üö´' : '‚úì'}
                                </button>
                                <button onclick="excluirSetor(${setor.id}, '${setor.nome}')" class="btn btn-sm" style="background: #c0392b; padding: 5px 10px; color: white;" title="Excluir">
                                    üóëÔ∏è
                                </button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 30px; color: #999;">Nenhum setor cadastrado</td></tr>';
                }
            } catch (error) {
                console.error('Erro ao carregar setores:', error);
                showToast('‚ùå Erro ao carregar setores', 'error');
            }
        }

        async function salvarNovoSetor(event) {
            event.preventDefault();

            const nome = document.getElementById('novo-setor-nome').value;

            try {
                const response = await fetch('/api/setores', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        nome: nome
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showToast('‚úÖ Setor cadastrado com sucesso!', 'success');
                    document.getElementById('form-novo-setor').reset();
                    await carregarSetores();
                } else {
                    showToast(`‚ùå ${result.error || 'Erro ao cadastrar setor'}`, 'error');
                }
            } catch (error) {
                console.error('Erro ao salvar setor:', error);
                showToast('‚ùå Erro ao salvar setor', 'error');
            }
        }

        async function toggleStatusSetor(setorId, novoStatus) {
            try {
                const response = await fetch(`/api/setores/${setorId}`, {
                    method: 'PATCH',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ativo: novoStatus
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showToast(`‚úÖ Setor ${novoStatus ? 'ativado' : 'desativado'} com sucesso!`, 'success');
                    await carregarSetores();
                } else {
                    showToast(`‚ùå ${result.error || 'Erro ao atualizar setor'}`, 'error');
                }
            } catch (error) {
                console.error('Erro ao atualizar status do setor:', error);
                showToast('‚ùå Erro ao atualizar setor', 'error');
            }
        }

        async function excluirSetor(setorId, nomeSetor) {
            if (!confirm(`Tem certeza que deseja excluir o setor "${nomeSetor}"?\n\nEsta a√ß√£o n√£o pode ser desfeita.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/setores/${setorId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                const result = await response.json();

                if (response.ok) {
                    showToast('‚úÖ Setor exclu√≠do com sucesso!', 'success');
                    await carregarSetores();
                } else {
                    showToast(`‚ùå ${result.error || 'Erro ao excluir setor'}`, 'error');
                }
            } catch (error) {
                console.error('Erro ao excluir setor:', error);
                showToast('‚ùå Erro ao excluir setor', 'error');
            }
        }

        function formatarData(data) {
            if (!data) return '-';
            // Formatar YYYY-MM-DD para DD/MM/YYYY sem usar Date (evita bug de timezone)
            if (typeof data === 'string' && data.match(/^\d{4}-\d{2}-\d{2}/)) {
                const parts = data.substring(0, 10).split('-');
                return `${parts[2]}/${parts[1]}/${parts[0]}`;
            }
            // Fallback para outros formatos
            const d = new Date(data + 'T12:00:00');
            const resultado = d.toLocaleDateString('pt-BR');
            return resultado;
        }

        function formatarMoeda(valor) {
            if (!valor && valor !== 0) return '-';
            return `R$ ${parseFloat(valor).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        // toggleSubmenu() j√° definida no HEAD - n√£o redefinir aqui

        // ====================================
        // SISTEMA DE NOTIFICA√á√ïES TOAST
        // ====================================
        
        function showToast(message, type = 'success') {
            // Criar container se n√£o existir
            let container = document.querySelector('.toast-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'toast-container';
                document.body.appendChild(container);
            }
            
            // Criar toast
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            // Definir √≠cone baseado no tipo
            let icon = '';
            switch(type) {
                case 'success':
                    icon = '‚úì';
                    break;
                case 'error':
                    icon = '‚úï';
                    break;
                case 'warning':
                    icon = '‚ö†';
                    break;
                case 'info':
                    icon = '‚Ñπ';
                    break;
                default:
                    icon = '‚úì';
            }
            
            toast.innerHTML = `
                <span class="toast-icon">${icon}</span>
                <span class="toast-message">${message}</span>
            `;
            
            container.appendChild(toast);
            
            // Animar entrada
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(0)';
            }, 10);
            
            // Remover ap√≥s 3 segundos
            setTimeout(() => {
                toast.classList.add('hiding');
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                
                setTimeout(() => {
                    // Verificar se toast ainda √© filho do container
                    if (toast.parentNode === container) {
                        container.removeChild(toast);
                    }
                    
                    // Remover container se vazio e ainda estiver no body
                    if (container.children.length === 0 && container.parentNode === document.body) {
                        document.body.removeChild(container);
                    }
                }, 300);
            }, 3000);
        }

        // ====================================
        // SISTEMA DE CONFIRMA√á√ÉO INTELIGENTE
        // ====================================
        
        function showConfirm(message, options = {}) {
            return new Promise((resolve) => {
                const {
                    title = '‚ö†Ô∏è Confirma√ß√£o',
                    confirmText = 'Confirmar',
                    cancelText = 'Cancelar',
                    type = 'warning' // success, error, warning, info
                } = options;
                
                // Criar overlay
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                `;
                
                // Definir cores baseado no tipo
                let colors = {
                    success: '#27ae60',
                    error: '#e74c3c',
                    warning: '#f39c12',
                    info: '#3498db'
                };
                const color = colors[type] || colors.warning;
                
                // Criar modal de confirma√ß√£o
                const modal = document.createElement('div');
                modal.style.cssText = `
                    background: white;
                    padding: 30px;
                    border-radius: 15px;
                    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
                    max-width: 450px;
                    width: 90%;
                    transform: scale(0.7);
                    transition: transform 0.3s ease;
                `;
                
                modal.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 50px; margin-bottom: 20px;">${title.split(' ')[0]}</div>
                        <h2 style="margin: 0 0 10px 0; color: #2c3e50;">${title.replace(/^[^\s]+\s/, '')}</h2>
                        <p style="color: #7f8c8d; font-size: 16px; margin-bottom: 30px;">${message}</p>
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button id="confirm-cancel" style="
                                flex: 1;
                                padding: 12px 24px;
                                border: 2px solid #bdc3c7;
                                background: white;
                                color: #7f8c8d;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 15px;
                                font-weight: 600;
                                transition: all 0.3s ease;
                            ">${cancelText}</button>
                            <button id="confirm-ok" style="
                                flex: 1;
                                padding: 12px 24px;
                                border: none;
                                background: ${color};
                                color: white;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 15px;
                                font-weight: 600;
                                transition: all 0.3s ease;
                            ">${confirmText}</button>
                        </div>
                    </div>
                `;
                
                overlay.appendChild(modal);
                document.body.appendChild(overlay);
                
                // Animar entrada
                setTimeout(() => {
                    overlay.style.opacity = '1';
                    modal.style.transform = 'scale(1)';
                }, 10);
                
                // Adicionar hover nos bot√µes
                const cancelBtn = modal.querySelector('#confirm-cancel');
                const okBtn = modal.querySelector('#confirm-ok');
                
                cancelBtn.addEventListener('mouseenter', () => {
                    cancelBtn.style.background = '#ecf0f1';
                    cancelBtn.style.transform = 'translateY(-2px)';
                });
                cancelBtn.addEventListener('mouseleave', () => {
                    cancelBtn.style.background = 'white';
                    cancelBtn.style.transform = 'translateY(0)';
                });
                
                okBtn.addEventListener('mouseenter', () => {
                    okBtn.style.transform = 'translateY(-2px)';
                    okBtn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
                });
                okBtn.addEventListener('mouseleave', () => {
                    okBtn.style.transform = 'translateY(0)';
                    okBtn.style.boxShadow = 'none';
                });
                
                // Fun√ß√£o para fechar o modal
                const closeModal = (result) => {
                    overlay.style.opacity = '0';
                    modal.style.transform = 'scale(0.7)';
                    setTimeout(() => {
                        if (overlay.parentNode) {
                            document.body.removeChild(overlay);
                        }
                        resolve(result);
                    }, 300);
                };
                
                // Event listeners
                cancelBtn.addEventListener('click', () => closeModal(false));
                okBtn.addEventListener('click', () => closeModal(true));
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) closeModal(false);
                });
                
                // ESC para cancelar
                const escHandler = (e) => {
                    if (e.key === 'Escape') {
                        closeModal(false);
                        document.removeEventListener('keydown', escHandler);
                    }
                };
                document.addEventListener('keydown', escHandler);
            });
        }

        // ====================================
        // FORMATA√á√ÉO AUTOM√ÅTICA DE MOEDA (R$)
        // ====================================
        
        function formatarMoedaBR(input) {
            let valor = input.value.replace(/\D/g, ''); // Remove tudo que n√£o √© d√≠gito
            
            if (valor === '' || valor === '0') {
                input.value = '';
                input.dataset.valorReal = '0';
                return;
            }
            
            // Converte para n√∫mero com 2 casas decimais
            valor = (parseInt(valor) / 100).toFixed(2);
            
            // Salva o valor real (sem formata√ß√£o) no dataset
            input.dataset.valorReal = valor;
            
            // Formata com ponto como separador de milhar e v√≠rgula como decimal
            let partes = valor.split('.');
            partes[0] = partes[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            input.value = partes.join(',');
        }
        
        function aplicarFormatacaoMoeda(input) {
            // Quando o campo perde foco, aplica a formata√ß√£o
            input.addEventListener('blur', function() {
                // Limpa e converte para n√∫mero
                let valor = this.value.replace(/\./g, '').replace(',', '.');
                let numero = parseFloat(valor);
                
                if (isNaN(numero) || numero === 0) {
                    this.value = '';
                    this.dataset.valorReal = '0';
                    return;
                }
                
                // Salva o valor real
                this.dataset.valorReal = numero.toFixed(2);
                
                // Formata para exibi√ß√£o: 1.234,56
                this.value = numero.toLocaleString('pt-BR', { 
                    minimumFractionDigits: 2, 
                    maximumFractionDigits: 2 
                });
            });
            
            // Formata√ß√£o em tempo real enquanto digita
            input.addEventListener('input', function(e) {
                // Permite n√∫meros, v√≠rgula e ponto
                let valor = this.value;
                // Remove caracteres n√£o permitidos (mant√©m apenas n√∫meros, v√≠rgula e ponto)
                valor = valor.replace(/[^\d.,]/g, '');
                // Permite apenas uma v√≠rgula ou um ponto
                let temVirgula = valor.indexOf(',');
                let temPonto = valor.indexOf('.');
                
                if (temVirgula !== -1 && temPonto !== -1) {
                    // Se tem ambos, remove o √∫ltimo digitado
                    if (temVirgula > temPonto) {
                        valor = valor.replace(/\./g, '');
                    } else {
                        valor = valor.replace(/,/g, '');
                    }
                }
                
                this.value = valor;
            });
            
            // Trata colagem
            input.addEventListener('paste', function(e) {
                e.preventDefault();
                let texto = (e.clipboardData || window.clipboardData).getData('text');
                // Limpa e normaliza
                texto = texto.replace(/[^\d.,]/g, '');
                this.value = texto;
                // Dispara evento input para validar
                this.dispatchEvent(new Event('input'));
            });
        }
        
        // Fun√ß√£o para obter o valor real (sem formata√ß√£o) de um campo
        function obterValorReal(input) {
            if (input.dataset.valorReal) {
                return parseFloat(input.dataset.valorReal);
            }
            // Fallback: tenta converter o valor do campo
            // Aceita tanto formato brasileiro (1.234,56) quanto americano (1234.56)
            let valor = input.value;
            
            // Se tem ponto e v√≠rgula, assume formato brasileiro
            if (valor.includes('.') && valor.includes(',')) {
                valor = valor.replace(/\./g, '').replace(',', '.');
            }
            // Se tem apenas v√≠rgula, assume decimal brasileiro
            else if (valor.includes(',') && !valor.includes('.')) {
                valor = valor.replace(',', '.');
            }
            // Se tem apenas ponto, pode ser milhar ou decimal
            else if (valor.includes('.') && !valor.includes(',')) {
                // Se tem mais de um ponto, √© separador de milhar
                if ((valor.match(/\./g) || []).length > 1) {
                    valor = valor.replace(/\./g, '');
                }
                // Se √© apenas um ponto, pode ser decimal (aceita ambos formatos)
            }
            
            return parseFloat(valor) || 0;
        }
        
        // ====================================
        // CONVERS√ÉO AUTOM√ÅTICA PARA MAI√öSCULAS
        // ====================================
        
        function aplicarMaiusculas(input) {
            // Ignora campos de tipo espec√≠fico que n√£o devem ser mai√∫sculos
            const tiposIgnorados = ['date', 'month', 'email', 'password', 'number'];
            
            if (tiposIgnorados.includes(input.type)) {
                return;
            }
            
            // Ignora campos de valor/saldo/juros que j√° t√™m formata√ß√£o de moeda
            if (input.id.includes('valor') || input.id.includes('saldo') || input.id.includes('juros')) {
                return;
            }
            
            input.addEventListener('input', function() {
                const inicio = this.selectionStart;
                const fim = this.selectionEnd;
                this.value = this.value.toUpperCase();
                this.setSelectionRange(inicio, fim);
            });
        }
        
        // Aplica formata√ß√£o autom√°tica a todos os campos quando a p√°gina carrega
        document.addEventListener('DOMContentLoaded', function() {
            // Observer para detectar novos campos adicionados dinamicamente (modals)
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1) { // Element node
                            // Busca campos de valor no novo conte√∫do
                            const camposValor = node.querySelectorAll 
                                ? node.querySelectorAll('input[id*="valor"], input[id*="saldo"], input[id*="juros"]')
                                : [];
                            
                            camposValor.forEach(function(campo) {
                                if (campo.type === 'number' || campo.id.includes('valor') || campo.id.includes('saldo') || campo.id.includes('juros')) {
                                    // Converte para tipo text para permitir formata√ß√£o
                                    campo.type = 'text';
                                    campo.inputMode = 'numeric';
                                    campo.placeholder = '0,00';
                                    aplicarFormatacaoMoeda(campo);
                                }
                            });
                            
                            // Busca todos os campos de texto e textarea para aplicar mai√∫sculas
                            const camposTexto = node.querySelectorAll 
                                ? node.querySelectorAll('input[type="text"], textarea')
                                : [];
                            
                            camposTexto.forEach(function(campo) {
                                aplicarMaiusculas(campo);
                            });
                        }
                    });
                });
            });
            
            // Inicia observa√ß√£o no body inteiro
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
            
            // Aplica mai√∫sculas em campos j√° existentes na p√°gina
            document.querySelectorAll('input[type="text"], textarea').forEach(function(campo) {
                aplicarMaiusculas(campo);
            });
        });
    </script>
    
    <!-- ============================================================================
         RELAT√ìRIO DE VALIDA√á√ÉO DE CPFs - FOLHA DE PAGAMENTO
         ============================================================================ -->
    <script>
        // üîê Fun√ß√£o para abrir o relat√≥rio de valida√ß√£o de CPFs
        async function abrirRelatorioCPFs() {
            try {
                // Abrir modal
                const modal = document.getElementById('modal-relatorio-cpfs');
                modal.style.display = 'block';
                
                // Mostrar loading
                document.getElementById('cpf-relatorio-loading').style.display = 'block';
                document.getElementById('cpf-relatorio-conteudo').style.display = 'none';
                
                // Chamar API
                console.log('üîç [CPF RELATORIO] Iniciando an√°lise de CPFs...');
                const response = await fetch('/api/funcionarios/cpf/relatorio', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ [CPF RELATORIO] Dados recebidos:', data);
                
                if (data.success) {
                    // Ocultar loading, mostrar conte√∫do
                    document.getElementById('cpf-relatorio-loading').style.display = 'none';
                    document.getElementById('cpf-relatorio-conteudo').style.display = 'block';
                    
                    // Preencher estat√≠sticas
                    document.getElementById('cpf-total').textContent = data.total_funcionarios;
                    document.getElementById('cpf-validos').textContent = data.total_cpfs_validos;
                    document.getElementById('cpf-invalidos').textContent = data.total_cpfs_invalidos;
                    document.getElementById('cpf-ausentes').textContent = data.total_cpfs_ausentes;
                    document.getElementById('cpf-taxa-validos').textContent = data.taxa_validos.toFixed(1) + '%';
                    document.getElementById('cpf-taxa-invalidos').textContent = data.taxa_erro.toFixed(1) + '%';
                    
                    // Atualizar data da an√°lise
                    const agora = new Date();
                    document.getElementById('cpf-data-analise').textContent = 
                        `An√°lise realizada em: ${agora.toLocaleDateString('pt-BR')} √†s ${agora.toLocaleTimeString('pt-BR')}`;
                    
                    // Verificar se h√° problemas
                    const totalProblemas = data.total_cpfs_invalidos + data.total_cpfs_ausentes;
                    
                    if (totalProblemas === 0) {
                        // Todos v√°lidos! Mostrar mensagem de sucesso
                        document.getElementById('cpf-todos-validos').style.display = 'block';
                        document.getElementById('cpf-problemas-container').style.display = 'none';
                        document.getElementById('btn-corrigir-cpfs').style.display = 'none';
                    } else {
                        // H√° problemas - mostrar tabela e bot√£o de corre√ß√£o
                        document.getElementById('cpf-todos-validos').style.display = 'none';
                        document.getElementById('cpf-problemas-container').style.display = 'block';
                        document.getElementById('btn-corrigir-cpfs').style.display = 'inline-block';
                        
                        // Renderizar lista de problemas
                        const tbody = document.getElementById('cpf-problemas-lista');
                        tbody.innerHTML = data.funcionarios_com_problemas.map((func, index) => {
                            const isInvalido = func.tipo_erro === 'invalido';
                            const isAusente = func.tipo_erro === 'ausente';
                            
                            return `
                                <tr style="background: ${index % 2 === 0 ? '#fff' : '#f9f9f9'};">
                                    <td style="padding: 12px;">${func.nome}</td>
                                    <td style="padding: 12px; font-family: monospace;">
                                        ${func.cpf || '<span style="color: #999;">--</span>'}
                                    </td>
                                    <td style="padding: 12px; font-size: 12px; color: #666;">
                                        ${func.email || '<span style="color: #999;">--</span>'}
                                    </td>
                                    <td style="padding: 12px; text-align: center;">
                                        <span style="padding: 6px 12px; border-radius: 4px; font-size: 11px; font-weight: bold; 
                                                     background: ${isInvalido ? '#e74c3c' : '#f39c12'}; color: white;">
                                            ${isInvalido ? '‚ùå INV√ÅLIDO' : '‚ö†Ô∏è AUSENTE'}
                                        </span>
                                    </td>
                                    <td style="padding: 12px; font-size: 12px; color: #e74c3c;">
                                        ${func.erro}
                                    </td>
                                    <td style="padding: 12px; text-align: center;">
                                        <button onclick="editarFuncionarioCPF(${func.id})" 
                                                class="btn" 
                                                style="padding: 6px 12px; background: #3498db; color: white; font-size: 11px;">
                                            ‚úèÔ∏è Corrigir
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    }
                    
                } else {
                    throw new Error(data.message || 'Erro desconhecido');
                }
                
            } catch (error) {
                console.error('‚ùå [CPF RELATORIO] Erro:', error);
                showToast('Erro ao carregar relat√≥rio: ' + error.message, 'error');
                fecharModalRelatorioCPFs();
            }
        }
        
        // üîê Fechar modal de relat√≥rio
        function fecharModalRelatorioCPFs() {
            document.getElementById('modal-relatorio-cpfs').style.display = 'none';
        }
        
        // üîê Editar funcion√°rio com problema no CPF
        function editarFuncionarioCPF(funcionarioId) {
            // Fechar modal de relat√≥rio
            fecharModalRelatorioCPFs();
            
            // Abrir modal de edi√ß√£o (fun√ß√£o j√° existente)
            // Assumindo que existe uma fun√ß√£o para abrir o modal de funcion√°rio
            if (typeof abrirModalEditarFuncionario === 'function') {
                abrirModalEditarFuncionario(funcionarioId);
            } else {
                console.warn('‚ö†Ô∏è Fun√ß√£o abrirModalEditarFuncionario n√£o encontrada');
            }
        }
        
        // Fechar modal ao clicar fora dele
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('modal-relatorio-cpfs');
            if (event.target === modal) {
                fecharModalRelatorioCPFs();
            }
        });
        
        // ============================================================================
        // SISTEMA DE CORRE√á√ÉO AUTOM√ÅTICA DE CPF
        // ============================================================================
        
        // üîß Abrir modal de corre√ß√£o autom√°tica
        async function abrirCorrecaoAutomatica() {
            try {
                // Fechar modal de relat√≥rio
                fecharModalRelatorioCPFs();
                
                // Abrir modal de corre√ß√£o
                const modal = document.getElementById('modal-correcao-cpfs');
                modal.style.display = 'block';
                
                // Mostrar loading
                document.getElementById('correcao-loading').style.display = 'block';
                document.getElementById('correcao-conteudo').style.display = 'none';
                
                // Chamar API de corre√ß√£o
                console.log('üîß [CORRECAO CPF] Iniciando an√°lise de corre√ß√µes...');
                const response = await fetch('/api/funcionarios/cpf/correcao', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ [CORRECAO CPF] Dados de corre√ß√£o recebidos:', data);
                
                if (data.success) {
                    // Ocultar loading, mostrar conte√∫do
                    document.getElementById('correcao-loading').style.display = 'none';
                    document.getElementById('correcao-conteudo').style.display = 'block';
                    
                    // Preencher estat√≠sticas
                    document.getElementById('correcao-total-invalidos').textContent = data.total_cpfs_invalidos;
                    document.getElementById('correcao-corrigidos').textContent = data.total_corrigidos;
                    document.getElementById('correcao-nao-corrigidos').textContent = data.total_nao_corrigidos;
                    document.getElementById('correcao-taxa').textContent = data.taxa_correcao.toFixed(1) + '%';
                    
                    // Atualizar data da an√°lise
                    const agora = new Date();
                    document.getElementById('correcao-data-analise').textContent = 
                        `An√°lise realizada em: ${agora.toLocaleDateString('pt-BR')} √†s ${agora.toLocaleTimeString('pt-BR')}`;
                    
                    // Verificar se h√° corre√ß√µes dispon√≠veis
                    if (data.total_corrigidos === 0) {
                        // Nenhuma corre√ß√£o poss√≠vel
                        document.getElementById('sem-correcoes').style.display = 'block';
                        document.getElementById('correcoes-container').style.display = 'none';
                        document.getElementById('btn-aplicar-todas-correcoes').style.display = 'none';
                    } else {
                        // H√° corre√ß√µes - mostrar tabela
                        document.getElementById('sem-correcoes').style.display = 'none';
                        document.getElementById('correcoes-container').style.display = 'block';
                        
                        // Mostrar bot√£o "Aplicar Corre√ß√µes Seguras" se h√° corre√ß√µes com alta confian√ßa
                        const correcoes_seguras = data.correcoes_sugeridas.filter(c => c.confianca >= 0.90);
                        if (correcoes_seguras.length > 0) {
                            document.getElementById('btn-aplicar-todas-correcoes').style.display = 'inline-block';
                        } else {
                            document.getElementById('btn-aplicar-todas-correcoes').style.display = 'none';
                        }
                        
                        // Renderizar lista de corre√ß√µes
                        const tbody = document.getElementById('correcoes-lista');
                        tbody.innerHTML = data.correcoes_sugeridas.map((correcao, index) => {
                            return `
                                <tr style="background: ${index % 2 === 0 ? '#fff' : '#f9f9f9'};">
                                    <td style="padding: 12px;">${correcao.funcionario_nome}</td>
                                    <td style="padding: 12px; font-family: monospace; text-align: center; color: #e74c3c;">
                                        ${correcao.cpf_original}
                                    </td>
                                    <td style="padding: 12px; font-family: monospace; text-align: center; color: #27ae60;">
                                        ${correcao.cpf_corrigido}
                                    </td>
                                    <td style="padding: 12px; text-align: center; font-size: 11px;">
                                        ${getTipoCorrecaoLabel(correcao.tipo_correcao)}
                                    </td>
                                    <td style="padding: 12px; text-align: center;">
                                        <div style="display: flex; align-items: center; justify-content: center; gap: 5px;">
                                            <div style="width: 50px; height: 8px; background: #ddd; border-radius: 4px; overflow: hidden;">
                                                <div style="width: ${correcao.confianca * 100}%; height: 100%; 
                                                           background: ${correcao.confianca >= 0.90 ? '#27ae60' : correcao.confianca >= 0.75 ? '#f39c12' : '#e74c3c'};">
                                                </div>
                                            </div>
                                            <span style="font-size: 11px; font-weight: bold;">${(correcao.confianca * 100).toFixed(0)}%</span>
                                        </div>
                                    </td>
                                    <td style="padding: 12px; text-align: center; font-size: 11px;">
                                        ${correcao.recomendacao}
                                    </td>
                                    <td style="padding: 12px; text-align: center;">
                                        <button onclick="aplicarCorrecaoIndividual(${correcao.funcionario_id}, '${correcao.cpf_corrigido}', '${correcao.funcionario_nome}', ${index})" 
                                                data-funcionario-id="${correcao.funcionario_id}"
                                                data-cpf="${correcao.cpf_corrigido}"
                                                class="btn" 
                                                style="padding: 6px 12px; background: ${correcao.confianca >= 0.90 ? '#27ae60' : '#f39c12'}; color: white; font-size: 11px;">
                                            ${correcao.confianca >= 0.90 ? '‚úÖ Aplicar' : '‚ö†Ô∏è Aplicar'}
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    }
                    
                } else {
                    throw new Error(data.message || 'Erro desconhecido');
                }
                
            } catch (error) {
                console.error('‚ùå [CORRECAO CPF] Erro:', error);
                showToast('Erro ao carregar corre√ß√µes: ' + error.message, 'error');
                fecharModalCorrecaoCPFs();
            }
        }
        
        // üîß Fechar modal de corre√ß√£o
        function fecharModalCorrecaoCPFs() {
            document.getElementById('modal-correcao-cpfs').style.display = 'none';
        }
        
        // üîß Aplicar corre√ß√£o individual
        async function aplicarCorrecaoIndividual(funcionarioId, cpfCorrigido, nomeFunc, rowIndex) {
            try {
                console.log(`üîß [CORRECAO] Aplicando corre√ß√£o para ${nomeFunc}: ${cpfCorrigido}`);
                
                const response = await fetch(`/api/funcionarios/${funcionarioId}/cpf`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        cpf: cpfCorrigido
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(`‚úÖ CPF de ${nomeFunc} corrigido com sucesso!`, 'success');
                    
                    // Marcar linha como aplicada
                    const row = document.querySelectorAll('#correcoes-lista tr')[rowIndex];
                    if (row) {
                        row.style.background = '#d5f4e6';
                        row.style.opacity = '0.7';
                        const button = row.querySelector('button');
                        button.innerHTML = '‚úÖ Aplicado';
                        button.disabled = true;
                        button.style.background = '#95a5a6';
                    }
                    
                } else {
                    throw new Error(data.error || 'Erro desconhecido');
                }
                
            } catch (error) {
                console.error('‚ùå [CORRECAO] Erro ao aplicar corre√ß√£o:', error);
                showToast(`‚ùå Erro ao corrigir CPF de ${nomeFunc}: ${error.message}`, 'error');
            }
        }
        
        // üîß Aplicar todas as corre√ß√µes seguras (confian√ßa >= 90%)
        async function aplicarTodasCorrecoes() {
            const confirmacao = confirm('üîß Aplicar todas as corre√ß√µes com alta confian√ßa (‚â•90%)?\n\nEsta a√ß√£o ir√° alterar automaticamente os CPFs dos funcion√°rios.');
            
            if (!confirmacao) {
                return;
            }
            
            try {
                console.log('üîß [CORRECAO] Aplicando corre√ß√µes em lote...');
                
                // Coletar todas as corre√ß√µes com alta confian√ßa (‚â•90%)
                const correcoes = [];
                const rows = document.querySelectorAll('#correcoes-lista tr');
                
                rows.forEach(row => {
                    const button = row.querySelector('button');
                    
                    // Verificar se √© corre√ß√£o segura (bot√£o verde - confian√ßa ‚â•90%)
                    if (button && button.style.background.includes('39, 174, 96')) {
                        const funcId = button.getAttribute('data-funcionario-id');
                        const cpf = button.getAttribute('data-cpf');
                        
                        if (funcId && cpf) {
                            correcoes.push({
                                funcionario_id: parseInt(funcId),
                                cpf: cpf
                            });
                        }
                    }
                });
                
                if (correcoes.length === 0) {
                    showToast('‚ö†Ô∏è Nenhuma corre√ß√£o com alta confian√ßa encontrada', 'warning');
                    return;
                }
                
                console.log(`üîß [CORRECAO] Enviando ${correcoes.length} corre√ß√µes em lote...`);
                showToast(`‚è≥ Processando ${correcoes.length} corre√ß√µes...`, 'info');
                
                // Enviar todas as corre√ß√µes em uma √∫nica requisi√ß√£o
                const response = await fetch('/api/funcionarios/cpf/corrigir-lote', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ correcoes })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                console.log('‚úÖ [CORRECAO] Resultado:', result);
                
                // Mostrar resultado
                if (result.success) {
                    showToast(
                        `‚úÖ ${result.total_sucesso} corre√ß√£o(√µes) aplicada(s) com sucesso!${
                            result.total_falhas > 0 ? ` (${result.total_falhas} erro(s))` : ''
                        }`, 
                        'success'
                    );
                    
                    // Ocultar bot√£o ap√≥s aplica√ß√£o
                    document.getElementById('btn-aplicar-todas-correcoes').style.display = 'none';
                    
                    // Atualizar tabela removendo as corre√ß√µes aplicadas
                    result.resultados.forEach((res, index) => {
                        if (res.success && rows[index]) {
                            const row = rows[index];
                            const button = row.querySelector('button');
                            if (button) {
                                button.innerHTML = '‚úÖ Aplicado';
                                button.disabled = true;
                                button.style.background = '#95a5a6'; // Cinza
                            }
                        }
                    });
                    
                    // Recarregar lista de funcion√°rios ap√≥s 2 segundos
                    setTimeout(() => {
                        loadFuncionariosLocal();
                    }, 2000);
                } else {
                    showToast('‚ö†Ô∏è Erro ao aplicar corre√ß√µes: ' + (result.error || 'Erro desconhecido'), 'error');
                }
                
            } catch (error) {
                console.error('‚ùå [CORRECAO] Erro ao aplicar corre√ß√µes em lote:', error);
                showToast('‚ùå Erro ao aplicar corre√ß√µes: ' + error.message, 'error');
            }
        }
        
        // üè∑Ô∏è Converter tipo de corre√ß√£o para r√≥tulo amig√°vel
        function getTipoCorrecaoLabel(tipo) {
            const labels = {
                'formatacao_apenas': 'üé® Formata√ß√£o',
                'formatacao_e_zeros': 'üî¢ Formata√ß√£o + Zeros',
                'digitos_verificadores': 'üîç D√≠gitos Verificadores',
                'transposicao_digitos': 'üîÑ Transposi√ß√£o',
                'digito_simples': 'üéØ D√≠gito Simples'
            };
            return labels[tipo] || tipo;
        }
        
        // Fechar modais ao clicar fora deles
        window.addEventListener('click', function(event) {
            const modalCorrecao = document.getElementById('modal-correcao-cpfs');
            if (event.target === modalCorrecao) {
                fecharModalCorrecaoCPFs();
            }
        });
    </script>
    
    <!-- Modal de Subcategorias -->
    <div id="modal-subcategorias" class="modal-subcategorias-overlay">
        <div class="modal-subcategorias-content">
            <div class="modal-subcategorias-header">
                <h3 id="modal-subcategorias-titulo">üìã Subcategorias</h3>
                <button class="modal-subcategorias-close" onclick="fecharModalSubcategorias()">√ó</button>
            </div>
            <div class="modal-subcategorias-body">
                <ul id="modal-subcategorias-lista" class="subcategorias-list"></ul>
            </div>
        </div>
    </div>

    <!-- ============================================================================
         SCRIPTS DO COMPARATIVO DE PER√çODOS
         ============================================================================ -->
    <script>
        // Fun√ß√£o para carregar comparativo de per√≠odos
        async function carregarComparativoPeriodos() {
            const ano1 = document.getElementById('filter-ano1').value;
            const mes1 = document.getElementById('filter-mes1').value;
            const ano2 = document.getElementById('filter-ano2').value;
            const mes2 = document.getElementById('filter-mes2').value;
            
            if (!ano1 || !ano2) {
                showToast('Por favor, preencha os anos dos dois per√≠odos', 'error');
                return;
            }
            
            // Calcular datas de in√≠cio e fim para cada per√≠odo
            let dataInicio1, dataFim1, dataInicio2, dataFim2;
            
            if (mes1) {
                // Per√≠odo 1 - m√™s espec√≠fico
                dataInicio1 = `${ano1}-${mes1.padStart(2, '0')}-01`;
                const ultimoDia1 = new Date(parseInt(ano1), parseInt(mes1), 0).getDate();
                dataFim1 = `${ano1}-${mes1.padStart(2, '0')}-${ultimoDia1}`;
            } else {
                // Per√≠odo 1 - ano inteiro
                dataInicio1 = `${ano1}-01-01`;
                dataFim1 = `${ano1}-12-31`;
            }
            
            if (mes2) {
                // Per√≠odo 2 - m√™s espec√≠fico
                dataInicio2 = `${ano2}-${mes2.padStart(2, '0')}-01`;
                const ultimoDia2 = new Date(parseInt(ano2), parseInt(mes2), 0).getDate();
                dataFim2 = `${ano2}-${mes2.padStart(2, '0')}-${ultimoDia2}`;
            } else {
                // Per√≠odo 2 - ano inteiro
                dataInicio2 = `${ano2}-01-01`;
                dataFim2 = `${ano2}-12-31`;
            }
            
            try {
                const contentDiv = document.getElementById('comparativo-periodos-content');
                contentDiv.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loading">‚è≥ Carregando comparativo...</div></div>';
                
                const params = new URLSearchParams({
                    data_inicio1: dataInicio1,
                    data_fim1: dataFim1,
                    data_inicio2: dataInicio2,
                    data_fim2: dataFim2
                });
                
                const response = await fetch(`/api/relatorios/comparativo-periodos?${params.toString()}`);
                
                if (!response.ok) {
                    throw new Error('Erro ao carregar comparativo');
                }
                
                const data = await response.json();
                renderizarComparativo(data);
                
            } catch (error) {
                console.error('Erro ao carregar comparativo:', error);
                document.getElementById('comparativo-periodos-content').innerHTML = 
                    '<div style="text-align: center; padding: 40px; color: #e74c3c;">‚ùå Erro ao carregar comparativo. Tente novamente.</div>';
                showToast('Erro ao carregar comparativo de per√≠odos', 'error');
            }
        }
        
        // Fun√ß√£o para renderizar o comparativo
        function renderizarComparativo(data) {
            const contentDiv = document.getElementById('comparativo-periodos-content');
            
            const periodo1 = data.periodo1;
            const periodo2 = data.periodo2;
            const variacoes = data.variacoes;
            
            // Formatar datas
            const formatarPeriodo = (inicio, fim) => {
                const dtInicio = new Date(inicio);
                const dtFim = new Date(fim);
                return `${dtInicio.toLocaleDateString('pt-BR')} at√© ${dtFim.toLocaleDateString('pt-BR')}`;
            };
            
            // Fun√ß√£o auxiliar para √≠cone de varia√ß√£o
            const iconeVariacao = (valor) => {
                if (valor > 0) return 'üìà';
                if (valor < 0) return 'üìâ';
                return '‚û°Ô∏è';
            };
            
            const corVariacao = (valor, invertido = false) => {
                if (invertido) {
                    if (valor > 0) return '#e74c3c';
                    if (valor < 0) return '#27ae60';
                } else {
                    if (valor > 0) return '#27ae60';
                    if (valor < 0) return '#e74c3c';
                }
                return '#95a5a6';
            };
            
            const html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <!-- Card Per√≠odo 1 -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; color: white;">
                        <h3 style="margin: 0 0 10px 0; font-size: 18px;">üìÖ Per√≠odo 1</h3>
                        <p style="margin: 0 0 20px 0; font-size: 13px; opacity: 0.9;">${formatarPeriodo(periodo1.datas.inicio, periodo1.datas.fim)}</p>
                        <div style="display: grid; gap: 10px;">
                            <div>
                                <div style="font-size: 11px; opacity: 0.8;">Receitas:</div>
                                <div style="font-size: 24px; font-weight: bold;">R$ ${periodo1.dados.receitas.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; opacity: 0.8;">Despesas:</div>
                                <div style="font-size: 24px; font-weight: bold;">R$ ${periodo1.dados.despesas.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; opacity: 0.8;">Saldo:</div>
                                <div style="font-size: 28px; font-weight: bold;">R$ ${periodo1.dados.saldo.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card Per√≠odo 2 -->
                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 12px; color: white;">
                        <h3 style="margin: 0 0 10px 0; font-size: 18px;">üìÖ Per√≠odo 2</h3>
                        <p style="margin: 0 0 20px 0; font-size: 13px; opacity: 0.9;">${formatarPeriodo(periodo2.datas.inicio, periodo2.datas.fim)}</p>
                        <div style="display: grid; gap: 10px;">
                            <div>
                                <div style="font-size: 11px; opacity: 0.8;">Receitas:</div>
                                <div style="font-size: 24px; font-weight: bold;">R$ ${periodo2.dados.receitas.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; opacity: 0.8;">Despesas:</div>
                                <div style="font-size: 24px; font-weight: bold;">R$ ${periodo2.dados.despesas.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; opacity: 0.8;">Saldo:</div>
                                <div style="font-size: 28px; font-weight: bold;">R$ ${periodo2.dados.saldo.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Varia√ß√µes -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                    <h3 style="margin: 0 0 20px 0; color: #2c3e50;">üìä Varia√ß√µes (Per√≠odo 2 vs Per√≠odo 1)</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                            <div style="font-size: 13px; color: #666; margin-bottom: 8px;">Receitas</div>
                            <div style="font-size: 32px; color: ${corVariacao(variacoes.receitas)}; font-weight: bold;">
                                ${iconeVariacao(variacoes.receitas)} ${variacoes.receitas > 0 ? '+' : ''}${variacoes.receitas.toFixed(2)}%
                            </div>
                            <div style="font-size: 12px; color: #999; margin-top: 5px;">
                                ${variacoes.receitas > 0 ? 'Crescimento' : variacoes.receitas < 0 ? 'Queda' : 'Est√°vel'}
                            </div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                            <div style="font-size: 13px; color: #666; margin-bottom: 8px;">Despesas</div>
                            <div style="font-size: 32px; color: ${corVariacao(variacoes.despesas, true)}; font-weight: bold;">
                                ${iconeVariacao(variacoes.despesas)} ${variacoes.despesas > 0 ? '+' : ''}${variacoes.despesas.toFixed(2)}%
                            </div>
                            <div style="font-size: 12px; color: #999; margin-top: 5px;">
                                ${variacoes.despesas > 0 ? 'Aumento' : variacoes.despesas < 0 ? 'Redu√ß√£o' : 'Est√°vel'}
                            </div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                            <div style="font-size: 13px; color: #666; margin-bottom: 8px;">Saldo</div>
                            <div style="font-size: 32px; color: ${corVariacao(variacoes.saldo)}; font-weight: bold;">
                                ${iconeVariacao(variacoes.saldo)} ${variacoes.saldo > 0 ? '+' : ''}${variacoes.saldo.toFixed(2)}%
                            </div>
                            <div style="font-size: 12px; color: #999; margin-top: 5px;">
                                ${variacoes.saldo > 0 ? 'Melhor' : variacoes.saldo < 0 ? 'Pior' : 'Igual'}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Top Categorias - Comparativo -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <!-- Receitas -->
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <h4 style="margin: 0 0 15px 0; color: #27ae60;">üíö Top 3 Receitas por Categoria</h4>
                        
                        <div style="margin-bottom: 20px;">
                            <h5 style="margin: 0 0 10px 0; font-size: 13px; color: #3498db;">Per√≠odo 1</h5>
                            ${periodo1.dados.top_receitas.map((item, idx) => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 6px; margin-bottom: 8px;">
                                    <div style="flex: 1;">
                                        <span style="font-weight: bold; color: #27ae60;">#${idx + 1}</span>
                                        <span style="margin-left: 10px;">${item.categoria}</span>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-weight: bold; color: #27ae60;">R$ ${item.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                                        <div style="font-size: 11px; color: #999;">${item.percentual.toFixed(1)}%</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div>
                            <h5 style="margin: 0 0 10px 0; font-size: 13px; color: #e74c3c;">Per√≠odo 2</h5>
                            ${periodo2.dados.top_receitas.map((item, idx) => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 6px; margin-bottom: 8px;">
                                    <div style="flex: 1;">
                                        <span style="font-weight: bold; color: #27ae60;">#${idx + 1}</span>
                                        <span style="margin-left: 10px;">${item.categoria}</span>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-weight: bold; color: #27ae60;">R$ ${item.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                                        <div style="font-size: 11px; color: #999;">${item.percentual.toFixed(1)}%</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Despesas -->
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <h4 style="margin: 0 0 15px 0; color: #e74c3c;">üíî Top 3 Despesas por Categoria</h4>
                        
                        <div style="margin-bottom: 20px;">
                            <h5 style="margin: 0 0 10px 0; font-size: 13px; color: #3498db;">Per√≠odo 1</h5>
                            ${periodo1.dados.top_despesas.map((item, idx) => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 6px; margin-bottom: 8px;">
                                    <div style="flex: 1;">
                                        <span style="font-weight: bold; color: #e74c3c;">#${idx + 1}</span>
                                        <span style="margin-left: 10px;">${item.categoria}</span>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-weight: bold; color: #e74c3c;">R$ ${item.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                                        <div style="font-size: 11px; color: #999;">${item.percentual.toFixed(1)}%</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div>
                            <h5 style="margin: 0 0 10px 0; font-size: 13px; color: #e74c3c;">Per√≠odo 2</h5>
                            ${periodo2.dados.top_despesas.map((item, idx) => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 6px; margin-bottom: 8px;">
                                    <div style="flex: 1;">
                                        <span style="font-weight: bold; color: #e74c3c;">#${idx + 1}</span>
                                        <span style="margin-left: 10px;">${item.categoria}</span>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-weight: bold; color: #e74c3c;">R$ ${item.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                                        <div style="font-size: 11px; color: #999;">${item.percentual.toFixed(1)}%</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                
                <!-- Resumo Estat√≠stico -->
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                    <h4 style="margin: 0 0 15px 0; color: #2c3e50;">üìà Resumo Estat√≠stico</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Maior Receita (Per√≠odo 1)</div>
                            <div style="font-weight: bold; color: #27ae60;">${periodo1.dados.maior_receita.categoria}</div>
                            <div style="font-size: 14px; color: #27ae60;">R$ ${periodo1.dados.maior_receita.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                        </div>
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Maior Receita (Per√≠odo 2)</div>
                            <div style="font-weight: bold; color: #27ae60;">${periodo2.dados.maior_receita.categoria}</div>
                            <div style="font-size: 14px; color: #27ae60;">R$ ${periodo2.dados.maior_receita.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                        </div>
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Maior Despesa (Per√≠odo 1)</div>
                            <div style="font-weight: bold; color: #e74c3c;">${periodo1.dados.maior_despesa.categoria}</div>
                            <div style="font-size: 14px; color: #e74c3c;">R$ ${periodo1.dados.maior_despesa.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                        </div>
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Maior Despesa (Per√≠odo 2)</div>
                            <div style="font-weight: bold; color: #e74c3c;">${periodo2.dados.maior_despesa.categoria}</div>
                            <div style="font-size: 14px; color: #e74c3c;">R$ ${periodo2.dados.maior_despesa.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                        </div>
                    </div>
                </div>
            `;
            
            contentDiv.innerHTML = html;
        }
        
        // Fun√ß√µes de exporta√ß√£o (stubs por enquanto)
        function exportarComparativoPDF() {
            showToast('Exporta√ß√£o PDF em desenvolvimento', 'info');
        }
        
        function exportarComparativoExcel() {
            showToast('Exporta√ß√£o Excel em desenvolvimento', 'info');
        }
    </script>

    <!-- ============================================================================
         SCRIPTS DE INDICADORES FINANCEIROS
         ============================================================================ -->
    <script>
        // Fun√ß√£o para aplicar filtro de per√≠odo aos indicadores
        window.aplicarFiltroPeriodoIndicadores = function() {
            const periodo = document.getElementById('filter-periodo-indicadores').value;
            const divInicio = document.getElementById('filtro-data-inicio-indicadores');
            const divFim = document.getElementById('filtro-data-fim-indicadores');
            
            if (periodo === 'custom') {
                divInicio.style.display = 'block';
                divFim.style.display = 'block';
            } else {
                divInicio.style.display = 'none';
                divFim.style.display = 'none';
                carregarIndicadores();
            }
        };
        
        // Fun√ß√£o para carregar indicadores financeiros
        window.carregarIndicadores = async function() {
            try {
                const contentDiv = document.getElementById('indicadores-content');
                contentDiv.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loading">‚è≥ Carregando indicadores...</div></div>';
                
                // Calcular datas baseadas no per√≠odo selecionado
                const periodo = document.getElementById('filter-periodo-indicadores').value;
                let dataInicio, dataFim;
                
                const hoje = new Date();
                dataFim = hoje.toISOString().split('T')[0];
                
                if (periodo === 'custom') {
                    dataInicio = document.getElementById('filter-data-inicio-indicadores').value;
                    dataFim = document.getElementById('filter-data-fim-indicadores').value;
                    
                    if (!dataInicio || !dataFim) {
                        showToast('Selecione ambas as datas para per√≠odo personalizado', 'warning');
                        return;
                    }
                } else {
                    const diasAtras = parseInt(periodo);
                    const dataInicioObj = new Date(hoje);
                    dataInicioObj.setDate(dataInicioObj.getDate() - diasAtras);
                    dataInicio = dataInicioObj.toISOString().split('T')[0];
                }
                
                const params = new URLSearchParams({
                    data_inicio: dataInicio,
                    data_fim: dataFim
                });
                
                const response = await fetch(`/api/relatorios/indicadores?${params.toString()}`);
                
                if (!response.ok) {
                    throw new Error('Erro ao carregar indicadores');
                }
                
                const data = await response.json();
                renderizarIndicadores(data, dataInicio, dataFim);
                
            } catch (error) {
                console.error('Erro ao carregar indicadores:', error);
                document.getElementById('indicadores-content').innerHTML = 
                    '<div style="text-align: center; padding: 40px; color: #e74c3c;">‚ùå Erro ao carregar indicadores. Tente novamente.</div>';
                showToast('Erro ao carregar indicadores financeiros', 'error');
            }
        };
        
        // Fun√ß√£o para renderizar os indicadores
        function renderizarIndicadores(data, dataInicio, dataFim) {
            const contentDiv = document.getElementById('indicadores-content');
            
            const formatDate = (dateStr) => {
                const date = new Date(dateStr);
                return date.toLocaleDateString('pt-BR');
            };
            
            const formatCurrency = (value) => {
                return value.toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            };
            
            const getCorSaldo = (valor) => {
                return valor >= 0 ? '#27ae60' : '#e74c3c';
            };
            
            const html = `
                <!-- Cabe√ßalho do Per√≠odo -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; margin-bottom: 30px; color: white; text-align: center;">
                    <h3 style="margin: 0 0 10px 0; font-size: 18px;">üìÖ Per√≠odo Analisado</h3>
                    <p style="margin: 0; font-size: 14px; opacity: 0.9;">${formatDate(dataInicio)} at√© ${formatDate(dataFim)}</p>
                </div>
                
                <!-- Saldo em Caixa -->
                <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 25px; border-radius: 12px; margin-bottom: 30px; color: white; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">üí∞ Saldo em Caixa (Contas Banc√°rias)</div>
                    <div style="font-size: 36px; font-weight: bold;">R$ ${formatCurrency(data.saldo_caixa)}</div>
                </div>
                
                <!-- Receitas e Despesas do Per√≠odo -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center;">
                        <div style="font-size: 13px; color: #666; margin-bottom: 8px;">üíö Receitas</div>
                        <div style="font-size: 28px; font-weight: bold; color: #27ae60;">R$ ${formatCurrency(data.mes_atual.receitas)}</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center;">
                        <div style="font-size: 13px; color: #666; margin-bottom: 8px;">üíî Despesas</div>
                        <div style="font-size: 28px; font-weight: bold; color: #e74c3c;">R$ ${formatCurrency(data.mes_atual.despesas)}</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center;">
                        <div style="font-size: 13px; color: #666; margin-bottom: 8px;">üìä Saldo do Per√≠odo</div>
                        <div style="font-size: 28px; font-weight: bold; color: ${getCorSaldo(data.mes_atual.saldo)};">R$ ${formatCurrency(data.mes_atual.saldo)}</div>
                    </div>
                </div>
                
                <!-- Contas Pendentes -->
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 30px;">
                    <h4 style="margin: 0 0 20px 0; color: #2c3e50; display: flex; align-items: center; gap: 10px;">
                        <span>üìã</span> Contas Pendentes
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                        <div>
                            <div style="font-size: 13px; color: #666; margin-bottom: 8px;">üí∞ A Receber</div>
                            <div style="font-size: 24px; font-weight: bold; color: #27ae60;">R$ ${formatCurrency(data.pendentes.receber)}</div>
                        </div>
                        <div>
                            <div style="font-size: 13px; color: #666; margin-bottom: 8px;">üí∏ A Pagar</div>
                            <div style="font-size: 24px; font-weight: bold; color: #e74c3c;">R$ ${formatCurrency(data.pendentes.pagar)}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Contas Vencidas (Alerta) -->
                ${(data.vencidos.receber > 0 || data.vencidos.pagar > 0) ? `
                <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                    <h4 style="margin: 0 0 15px 0; color: #856404; display: flex; align-items: center; gap: 10px;">
                        <span>‚ö†Ô∏è</span> Aten√ß√£o: Contas Vencidas
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                        ${data.vencidos.receber > 0 ? `
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 13px; color: #856404; margin-bottom: 5px;">üí∞ A Receber Vencido</div>
                            <div style="font-size: 22px; font-weight: bold; color: #d9534f;">R$ ${formatCurrency(data.vencidos.receber)}</div>
                        </div>
                        ` : ''}
                        ${data.vencidos.pagar > 0 ? `
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 13px; color: #856404; margin-bottom: 5px;">üí∏ A Pagar Vencido</div>
                            <div style="font-size: 22px; font-weight: bold; color: #d9534f;">R$ ${formatCurrency(data.vencidos.pagar)}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}
                
                <!-- Indicadores-Chave -->
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                    <h4 style="margin: 0 0 20px 0; color: #2c3e50; display: flex; align-items: center; gap: 10px;">
                        <span>üìà</span> Indicadores-Chave de Performance
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                        <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; text-align: center;">
                            <div style="font-size: 13px; color: #666; margin-bottom: 10px;">üíß √çndice de Liquidez</div>
                            <div style="font-size: 32px; font-weight: bold; color: ${data.indicadores.liquidez >= 1 ? '#27ae60' : '#e74c3c'};">
                                ${data.indicadores.liquidez.toFixed(2)}
                            </div>
                            <div style="font-size: 11px; color: #999; margin-top: 8px;">
                                ${data.indicadores.liquidez >= 1.5 ? '‚úÖ Excelente' : data.indicadores.liquidez >= 1 ? '‚ö†Ô∏è Adequado' : '‚ùå Cr√≠tico'}
                            </div>
                            <div style="font-size: 10px; color: #999; margin-top: 5px;">
                                (Saldo + A Receber) √∑ A Pagar
                            </div>
                        </div>
                        <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; text-align: center;">
                            <div style="font-size: 13px; color: #666; margin-bottom: 10px;">üìä Margem L√≠quida</div>
                            <div style="font-size: 32px; font-weight: bold; color: ${data.indicadores.margem_liquida >= 0 ? '#27ae60' : '#e74c3c'};">
                                ${data.indicadores.margem_liquida.toFixed(2)}%
                            </div>
                            <div style="font-size: 11px; color: #999; margin-top: 8px;">
                                ${data.indicadores.margem_liquida >= 20 ? '‚úÖ √ìtima' : data.indicadores.margem_liquida >= 10 ? '‚ö†Ô∏è Razo√°vel' : data.indicadores.margem_liquida >= 0 ? '‚ö†Ô∏è Baixa' : '‚ùå Preju√≠zo'}
                            </div>
                            <div style="font-size: 10px; color: #999; margin-top: 5px;">
                                (Receitas - Despesas) √∑ Receitas √ó 100
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            contentDiv.innerHTML = html;
        }
        
        // Fun√ß√µes de exporta√ß√£o (stubs)
        window.exportarIndicadoresPDF = function() {
            showToast('Exporta√ß√£o PDF em desenvolvimento', 'info');
        };
        
        window.exportarIndicadoresExcel = function() {
            showToast('Exporta√ß√£o Excel em desenvolvimento', 'info');
        };
        
        // Carregar indicadores automaticamente ao abrir a se√ß√£o (padr√£o: √∫ltimos 30 dias)
        document.addEventListener('DOMContentLoaded', function() {
            // Observar quando a se√ß√£o de indicadores √© mostrada
            const indicadoresSection = document.getElementById('indicadores-section');
            if (indicadoresSection) {
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.attributeName === 'class') {
                            if (!indicadoresSection.classList.contains('hidden')) {
                                // Verificar se ainda n√£o foi carregado
                                const content = document.getElementById('indicadores-content');
                                if (content && content.innerHTML.includes('Selecione o per√≠odo')) {
                                    carregarIndicadores();
                                }
                            }
                        }
                    });
                });
                
                observer.observe(indicadoresSection, { attributes: true });
            }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="/static/utils.js?v={{ build_timestamp }}"></script>
    <script src="/static/lazy-loader.js?v={{ build_timestamp }}"></script>
    <script src="/static/app.js?v={{ build_timestamp }}"></script>
    <script src="/static/agenda_calendar.js?v={{ build_timestamp }}"></script>
    <script src="/static/lazy-integration.js?v={{ build_timestamp }}"></script>
    <script src="/static/pdf_functions.js?v={{ build_timestamp }}"></script>
    <script src="/static/excel_functions.js?v={{ build_timestamp }}"></script>
    <script src="/static/analise_functions.js?v={{ build_timestamp }}"></script>
    <script src="/static/modals.js?v={{ build_timestamp }}"></script>
    
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <!-- M√≥dulos DRE e Dashboard Gerencial -->
    <script src="/static/dre_module.js?v={{ build_timestamp }}"></script>
    <script src="/static/dashboard_module.js?v={{ build_timestamp }}"></script>
    
    <!-- Inicializa√ß√£o dos m√≥dulos DRE e Dashboard -->
    <script>
        // Interceptar showSection para inicializar m√≥dulos quando necess√°rio
        (function() {
            const originalShowSection = window.showSection;
            
            window.showSection = async function(sectionName) {
                // Chamar a fun√ß√£o original
                if (originalShowSection) {
                    originalShowSection(sectionName);
                }
                
                // Inicializar m√≥dulos espec√≠ficos quando suas se√ß√µes s√£o abertas
                if (sectionName === 'dre' && typeof window.inicializarModuloDRE === 'function') {
                    console.log('üéØ Inicializando m√≥dulo DRE...');
                    await window.inicializarModuloDRE();
                } else if (sectionName === 'dashboard-gerencial' && typeof window.inicializarModuloDashboard === 'function') {
                    console.log('üéØ Inicializando m√≥dulo Dashboard Gerencial...');
                    await window.inicializarModuloDashboard();
                }
            };
            
            console.log('‚úÖ Interceptor de se√ß√µes DRE e Dashboard configurado');
        })();
    </script>
    
    <!-- Service Worker para controle de cache -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/static/service-worker.js?v={{ build_timestamp }}')
                .then(reg => console.log('‚úÖ Service Worker registrado'))
                .catch(err => console.warn('‚ö†Ô∏è Service Worker erro:', err));
        }
    </script>
    
    <!-- Modal: Importar Categorias de Outra Empresa -->
    <div id="modal-importar-categorias" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 10px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <h3 style="margin-top: 0; color: #333;">üì• Importar Categorias de Outra Empresa</h3>
            
            <div id="empresas-list-container">
                <p style="color: #666;">Carregando empresas...</p>
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="fecharModalImportarCategorias()">Cancelar</button>
            </div>
        </div>
    </div>
    
    <script>
        // === IMPORTA√á√ÉO DE CATEGORIAS ENTRE EMPRESAS ===
        
        async function abrirModalImportarCategorias() {
            const modal = document.getElementById('modal-importar-categorias');
            const container = document.getElementById('empresas-list-container');
            
            modal.style.display = 'flex';
            container.innerHTML = '<p style="color: #666;">üîÑ Carregando empresas...</p>';
            
            try {
                const response = await fetch('/api/categorias/empresas-disponiveis', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const data = await response.json();
                
                if (!data.success || !data.data || data.data.length === 0) {
                    container.innerHTML = '<p style="color: #999;">‚ÑπÔ∏è Nenhuma outra empresa com categorias cadastradas.</p>';
                    return;
                }
                
                // Renderizar lista de empresas
                let html = '';
                for (const empresa of data.data) {
                    html += `
                        <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div>
                                    <h4 style="margin: 0; color: #333;">${empresa.razao_social}</h4>
                                    <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">
                                        ${empresa.total_categorias} categoria(s) dispon√≠vel(is)
                                    </p>
                                </div>
                                <button class="btn btn-primary" onclick="importarCategoriasDeEmpresa(${empresa.empresa_id}, '${empresa.razao_social}')">
                                    üì• Importar Todas
                                </button>
                            </div>
                            
                            <!-- Lista de categorias -->
                            <details style="margin-top: 10px;">
                                <summary style="cursor: pointer; color: #0066cc; font-size: 14px;">
                                    Ver categorias
                                </summary>
                                <div style="margin-top: 10px; padding-left: 15px;">
                                    ${empresa.categorias.map(cat => `
                                        <div style="margin: 5px 0; font-size: 14px;">
                                            <strong>${cat.nome}</strong> 
                                            <span style="color: #666;">(${cat.tipo === 'receita' ? 'üí∞ Receita' : 'üí∏ Despesa'})</span>
                                            ${cat.subcategorias && cat.subcategorias.length > 0 ? 
                                                `<br><span style="font-size: 12px; color: #999; padding-left: 20px;">
                                                    Subcategorias: ${cat.subcategorias.join(', ')}
                                                </span>` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </details>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar empresas:', error);
                container.innerHTML = '<p style="color: #d9534f;">‚ùå Erro ao carregar empresas. Tente novamente.</p>';
            }
        }
        
        async function importarCategoriasDeEmpresa(empresaId, razaoSocial) {
            if (!confirm(`Deseja importar TODAS as categorias da empresa "${razaoSocial}"?\n\nCategorias duplicadas ser√£o ignoradas.`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/categorias/importar-de-empresa', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        empresa_origem_id: empresaId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (typeof Swal !== 'undefined') {
                        await Swal.fire({
                            icon: 'success',
                            title: 'Importa√ß√£o Conclu√≠da!',
                            html: `
                                <p><strong>‚úÖ ${data.importadas}</strong> categoria(s) importada(s)</p>
                                ${data.duplicadas > 0 ? `<p><strong>‚è≠Ô∏è ${data.duplicadas}</strong> categoria(s) j√° existiam</p>` : ''}
                                ${data.erros && data.erros.length > 0 ? `<p style="color: #d9534f;"><strong>‚ùå Erros:</strong><br>${data.erros.join('<br>')}</p>` : ''}
                            `,
                            confirmButtonText: 'OK'
                        });
                    } else {
                        alert(`‚úÖ Importa√ß√£o Conclu√≠da!\n\n${data.importadas} categoria(s) importada(s)\n${data.duplicadas > 0 ? data.duplicadas + ' j√° existiam' : ''}`);
                    }
                    
                    // Recarregar categorias
                    if (typeof carregarCategorias === 'function') {
                        carregarCategorias();
                    } else if (typeof loadCategorias === 'function') {
                        loadCategorias();
                    }
                    
                    fecharModalImportarCategorias();
                } else {
                    if (typeof Swal !== 'undefined') {
                        Swal.fire({
                            icon: 'error',
                            title: 'Erro ao Importar',
                            text: data.error || 'Erro desconhecido',
                            confirmButtonText: 'OK'
                        });
                    } else {
                        alert('‚ùå Erro ao Importar: ' + (data.error || 'Erro desconhecido'));
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao importar categorias:', error);
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'error',
                        title: 'Erro ao Importar',
                        text: 'Erro ao processar a importa√ß√£o. Tente novamente.',
                        confirmButtonText: 'OK'
                    });
                } else {
                    alert('‚ùå Erro ao Importar: Erro ao processar a importa√ß√£o. Tente novamente.');
                }
            }
        }
        
        function fecharModalImportarCategorias() {
            document.getElementById('modal-importar-categorias').style.display = 'none';
        }
        
        // Fechar modal ao clicar fora
        document.getElementById('modal-importar-categorias').addEventListener('click', function(e) {
            if (e.target === this) {
                fecharModalImportarCategorias();
            }
        });
    </script>
    
    <script>
        // Garantir que contas sejam carregadas ao abrir a se√ß√£o (se tiver permiss√£o)
        setTimeout(() => {
            const usuario = JSON.parse(sessionStorage.getItem('usuario') || '{}');
            const permissoes = usuario.permissoes || [];
            if (typeof loadContasBancarias === 'function' && (permissoes.includes('contas_view') || permissoes.includes('lancamentos_view'))) {
                loadContasBancarias();
            } else {
                console.log('‚è≠Ô∏è Contas banc√°rias (setTimeout): Sem permiss√£o');
            }
        }, 500);
    </script>

    <!-- SISTEMA DE GERENCIAMENTO DE PERMISS√ïES -->
    <script>
        // Lista completa de permiss√µes dispon√≠veis organizadas por TIPO DE A√á√ÉO
        const PERMISSOES_DISPONIVEIS = {
            'üëÅÔ∏è Ver / Visualizar': [
                'dashboard',
                'lancamentos_view',
                'relatorios_view',
                'cadastros_view',
                'contas_view',
                'categorias_view',
                'clientes_view',
                'fornecedores_view',
                'operacional_view',
                'contratos_view',
                'ver_contratos',
                'agenda_view',
                'ver_agenda',
                'estoque_view',
                'ver_estoque',
                'eventos_view',
                'ver_eventos',
                'folha_pagamento_view',
                'ver_folha_de_pagamento'
            ],
            '‚ûï Criar / Cadastrar': [
                'lancamentos_create',
                'contas_create',
                'categorias_create',
                'clientes_create',
                'fornecedores_create',
                'contratos_create',
                'criar_contratos',
                'eventos_create',
                'criar_eventos',
                'criar_sessoes',
                'criar_produtos',
                'folha_pagamento_create',
                'criar_folha_de_pagamento'
            ],
            '‚úèÔ∏è Editar / Alterar': [
                'lancamentos_edit',
                'contas_edit',
                'categorias_edit',
                'clientes_edit',
                'fornecedores_edit',
                'contratos_edit',
                'editar_contratos',
                'editar_estoque',
                'eventos_edit',
                'editar_eventos',
                'editar_sessoes',
                'folha_pagamento_edit',
                'editar_folha_de_pagamento'
            ],
            'üóëÔ∏è Excluir / Deletar': [
                'lancamentos_delete',
                'contas_delete',
                'categorias_delete',
                'clientes_delete',
                'fornecedores_delete',
                'contratos_delete',
                'excluir_contratos',
                'eventos_delete',
                'excluir_eventos',
                'excluir_sessoes',
                'excluir_produtos',
                'folha_pagamento_delete',
                'excluir_folha_de_pagamento'
            ],
            'üì§ Exportar': [
                'exportar_excel',
                'exportar_pdf'
            ],
            '‚öôÔ∏è Sistema': [
                'configuracoes',
                'gerenciar_usuarios'
            ]
        };

        // Tradu√ß√£o de nomes de permiss√µes para exibi√ß√£o
        const NOMES_PERMISSOES = {
            'dashboard': 'Dashboard',
            'lancamentos_view': 'Ver Lan√ßamentos',
            'lancamentos_create': 'Criar Lan√ßamentos',
            'lancamentos_edit': 'Editar Lan√ßamentos',
            'lancamentos_delete': 'Excluir Lan√ßamentos',
            'relatorios_view': 'Ver Relat√≥rios',
            'exportar_excel': 'Exportar Excel',
            'exportar_pdf': 'Exportar PDF',
            'cadastros_view': 'Ver Cadastros',
            'contas_view': 'Ver Contas',
            'contas_create': 'Criar Contas',
            'contas_edit': 'Editar Contas',
            'contas_delete': 'Excluir Contas',
            'categorias_view': 'Ver Categorias',
            'categorias_create': 'Criar Categorias',
            'categorias_edit': 'Editar Categorias',
            'categorias_delete': 'Excluir Categorias',
            'clientes_view': 'Ver Clientes',
            'clientes_create': 'Criar Clientes',
            'clientes_edit': 'Editar Clientes',
            'clientes_delete': 'Excluir Clientes',
            'fornecedores_view': 'Ver Fornecedores',
            'fornecedores_create': 'Criar Fornecedores',
            'fornecedores_edit': 'Editar Fornecedores',
            'fornecedores_delete': 'Excluir Fornecedores',
            'operacional_view': 'Ver Operacional',
            'contratos_view': 'Ver Contratos',
            'contratos_create': 'Criar Contratos',
            'contratos_edit': 'Editar Contratos',
            'contratos_delete': 'Excluir Contratos',
            'criar_contratos': 'Criar Contratos',
            'editar_contratos': 'Editar Contratos',
            'excluir_contratos': 'Excluir Contratos',
            'ver_contratos': 'Ver Contratos',
            'agenda_view': 'Ver Agenda',
            'ver_agenda': 'Ver Agenda',
            'estoque_view': 'Ver Estoque',
            'editar_estoque': 'Editar Estoque',
            'ver_estoque': 'Ver Estoque',
            'eventos_view': 'Ver Eventos',
            'eventos_create': 'Criar Eventos',
            'eventos_edit': 'Editar Eventos',
            'eventos_delete': 'Excluir Eventos',
            'criar_eventos': 'Criar Eventos',
            'editar_eventos': 'Editar Eventos',
            'excluir_eventos': 'Excluir Eventos',
            'ver_eventos': 'Ver Eventos',
            'criar_sessoes': 'Criar Sess√µes',
            'editar_sessoes': 'Editar Sess√µes',
            'excluir_sessoes': 'Excluir Sess√µes',
            'criar_produtos': 'Criar Produtos',
            'excluir_produtos': 'Excluir Produtos',
            'folha_pagamento_view': 'Ver Folha de Pagamento',
            'folha_pagamento_create': 'Criar Folha de Pagamento',
            'folha_pagamento_edit': 'Editar Folha de Pagamento',
            'folha_pagamento_delete': 'Excluir Folha de Pagamento',
            'criar_folha_de_pagamento': 'Criar Folha',
            'editar_folha_de_pagamento': 'Editar Folha',
            'excluir_folha_de_pagamento': 'Excluir Folha',
            'ver_folha_de_pagamento': 'Ver Folha',
            'configuracoes': 'Configura√ß√µes',
            'gerenciar_usuarios': 'Gerenciar Usu√°rios'
        };

        let usuarioAtualPermissoes = null;

        // Carregar lista de usu√°rios no select
        async function loadPermissoes() {
            console.log('üîê Carregando lista de usu√°rios para permiss√µes...');
            try {
                const response = await fetch('/api/usuarios', {
                    credentials: 'include'
                });
                
                const data = await response.json();
                console.log('üë• Usu√°rios recebidos:', data);
                
                const select = document.getElementById('select-usuario-permissao');
                select.innerHTML = '<option value="">-- Selecione um usu√°rio --</option>';
                
                if (data.usuarios && data.usuarios.length > 0) {
                    data.usuarios.forEach(usuario => {
                        const option = document.createElement('option');
                        option.value = usuario.id;
                        option.textContent = `${usuario.nome} (${usuario.email})`;
                        select.appendChild(option);
                    });
                    console.log(`‚úÖ ${data.usuarios.length} usu√°rio(s) carregado(s)`);
                } else {
                    console.warn('‚ö†Ô∏è Nenhum usu√°rio encontrado');
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar usu√°rios:', error);
                showToast('‚ùå Erro ao carregar lista de usu√°rios', 'error');
            }
        }

        // Carregar permiss√µes de um usu√°rio espec√≠fico
        async function loadUsuarioPermissoes() {
            const select = document.getElementById('select-usuario-permissao');
            const usuarioId = select.value;
            
            if (!usuarioId) {
                document.getElementById('permissoes-usuario-container').style.display = 'none';
                return;
            }
            
            console.log(`üîç Carregando permiss√µes do usu√°rio ID: ${usuarioId}`);
            
            try {
                const response = await fetch(`/api/usuarios/${usuarioId}`, {
                    credentials: 'include'
                });
                
                const data = await response.json();
                console.log('üìã Dados do usu√°rio:', data);
                
                if (data.success) {
                    usuarioAtualPermissoes = data.usuario;
                    renderizarPermissoes(usuarioAtualPermissoes);
                    document.getElementById('permissoes-usuario-container').style.display = 'block';
                } else {
                    showToast('‚ùå Erro ao carregar permiss√µes do usu√°rio', 'error');
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar permiss√µes:', error);
                showToast('‚ùå Erro ao carregar permiss√µes do usu√°rio', 'error');
            }
        }

        // Renderizar checkboxes de permiss√µes
        function renderizarPermissoes(usuario) {
            const container = document.getElementById('permissoes-list');
            container.innerHTML = '';
            
            const permissoesUsuario = usuario.permissoes || [];
            console.log('üîë Permiss√µes atuais:', permissoesUsuario);
            
            // Renderizar por categoria
            for (const [categoria, permissoes] of Object.entries(PERMISSOES_DISPONIVEIS)) {
                const categoriaDiv = document.createElement('div');
                categoriaDiv.style.cssText = 'background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #ddd;';
                
                // T√≠tulo da categoria com "Selecionar Todos"
                const headerDiv = document.createElement('div');
                headerDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid #3498db;';
                
                const tituloH4 = document.createElement('h4');
                tituloH4.textContent = categoria;
                tituloH4.style.cssText = 'margin: 0; color: #2c3e50; font-size: 16px;';
                
                const btnSelecionarTodos = document.createElement('button');
                btnSelecionarTodos.textContent = 'Selecionar Todos';
                btnSelecionarTodos.className = 'btn-sm';
                btnSelecionarTodos.style.cssText = 'font-size: 12px; padding: 5px 10px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;';
                btnSelecionarTodos.onclick = () => selecionarTodosCategoria(categoria);
                
                headerDiv.appendChild(tituloH4);
                headerDiv.appendChild(btnSelecionarTodos);
                categoriaDiv.appendChild(headerDiv);
                
                // Checkboxes das permiss√µes
                permissoes.forEach(permissao => {
                    const label = document.createElement('label');
                    label.style.cssText = 'display: flex; align-items: center; margin-bottom: 8px; cursor: pointer;';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = permissao;
                    checkbox.checked = permissoesUsuario.includes(permissao);
                    checkbox.style.cssText = 'width: 18px; height: 18px; margin-right: 10px; cursor: pointer;';
                    checkbox.className = `permissao-checkbox categoria-${categoria.replace(/ /g, '-')}`;
                    
                    const span = document.createElement('span');
                    span.textContent = NOMES_PERMISSOES[permissao] || permissao;
                    span.style.cssText = 'color: #555; font-size: 14px;';
                    
                    label.appendChild(checkbox);
                    label.appendChild(span);
                    categoriaDiv.appendChild(label);
                });
                
                container.appendChild(categoriaDiv);
            }
        }

        // Selecionar todos de uma categoria
        function selecionarTodosCategoria(categoria) {
            const checkboxes = document.querySelectorAll(`.categoria-${categoria.replace(/ /g, '-')}`);
            const todosMarcados = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(cb => {
                cb.checked = !todosMarcados;
            });
        }

        // Salvar permiss√µes alteradas
        async function salvarPermissoes() {
            if (!usuarioAtualPermissoes) {
                showToast('‚ö†Ô∏è Nenhum usu√°rio selecionado', 'warning');
                return;
            }
            
            // Coletar permiss√µes marcadas
            const checkboxes = document.querySelectorAll('.permissao-checkbox');
            const permissoesNovas = [];
            
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    permissoesNovas.push(cb.value);
                }
            });
            
            console.log('üíæ Salvando permiss√µes:', permissoesNovas);
            
            try {
                const response = await fetch(`/api/usuarios/${usuarioAtualPermissoes.id}/permissoes`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        permissoes: permissoesNovas
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('‚úÖ Permiss√µes atualizadas com sucesso!', 'success');
                    
                    // Se for o pr√≥prio usu√°rio, recarregar permiss√µes do menu
                    const usuarioLogado = JSON.parse(sessionStorage.getItem('usuario') || '{}');
                    if (usuarioLogado.id === usuarioAtualPermissoes.id) {
                        console.log('üîÑ Atualizando permiss√µes do usu√°rio logado...');
                        await checkUserAuth(); // Recarrega dados do usu√°rio
                    }
                } else {
                    showToast(`‚ùå Erro: ${data.error || 'Erro desconhecido'}`, 'error');
                }
            } catch (error) {
                console.error('‚ùå Erro ao salvar permiss√µes:', error);
                showToast('‚ùå Erro ao salvar permiss√µes', 'error');
            }
        }

        // Cancelar edi√ß√£o de permiss√µes
        function cancelarEdicaoPermissoes() {
            document.getElementById('select-usuario-permissao').value = '';
            document.getElementById('permissoes-usuario-container').style.display = 'none';
            usuarioAtualPermissoes = null;
        }

        // NFS-e: M√≥dulo movido para app.js (window.loadNFSeSection, etc.)

        // ============================================
        // NF-e / CT-e - DOCUMENTOS FISCAIS
        // ============================================

        // Fun√ß√£o de carregamento da se√ß√£o fiscal (registrada no mapa de loaders)
        window.loadFiscalSection = function() {
            carregarEstatisticasFiscais();
            carregarDocumentosFiscais();
        };

        // Controle de Tabs Fiscais
        function showFiscalTab(tabName) {
            // Ocultar todos os conte√∫dos
            document.querySelectorAll('.fiscal-tab-content').forEach(el => el.classList.add('hidden'));
            
            // Remover active de todos os bot√µes
            document.querySelectorAll('[id^="fiscal-tab-"]').forEach(btn => btn.classList.remove('active'));
            
            // Mostrar conte√∫do selecionado
            document.getElementById(`fiscal-content-${tabName}`).classList.remove('hidden');
            document.getElementById(`fiscal-tab-${tabName}`).classList.add('active');
            
            // Carregar dados espec√≠ficos da tab
            if (tabName === 'documentos') carregarDocumentosFiscais();
            if (tabName === 'nsu') carregarNSUStatusFiscal();
        }

        // Inicializar se√ß√£o fiscal e empresa quando exibidas
        const originalShowSection = window.showSection || showSection;
        window.showSection = function(sectionId) {
            if (typeof originalShowSection === 'function') {
                originalShowSection(sectionId);
            }
            
            if (sectionId === 'fiscal') {
                carregarEstatisticasFiscais();
                carregarDocumentosFiscais();
            }
            
            if (sectionId === 'empresa') {
                carregarDadosEmpresa();
            }
        };

        // Fun√ß√µes auxiliares
        function formatarMoedaFiscal(valor) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(valor || 0);
        }

        function formatarDataFiscal(data) {
            if (!data) return '-';
            return new Date(data).toLocaleDateString('pt-BR');
        }

        function showToastFiscal(message, type = 'success') {
            if (typeof showToast === 'function') {
                showToast(message, type);
            } else {
                console.log(`[Fiscal] ${type}: ${message}`);
            }
        }

        // Estat√≠sticas
        function carregarEstatisticasFiscais() {
            fetch('/api/relatorios/estatisticas')
                .then(r => r.json())
                .then(response => {
                    if (response.success && response.estatisticas) {
                        const stats = response.estatisticas;
                        document.getElementById('fiscal-statTotalDocs').textContent = stats.total_documentos || 0;
                        document.getElementById('fiscal-statTotalNFes').textContent = stats.total_nfes || 0;
                        document.getElementById('fiscal-statValorTotal').textContent = formatarMoedaFiscal(stats.valor_total_nfes);
                    }
                })
                .catch(err => console.error('Erro ao carregar estat√≠sticas fiscais:', err));
        }

        // Certificados
        function carregarCertificadosFiscais() {
            fetch('/api/relatorios/certificados')
                .then(r => r.json())
                .then(response => {
                    if (response.success) {
                        const certificados = response.certificados;
                        const container = document.getElementById('fiscal-certificadosContainer');
                        
                        if (certificados.length === 0) {
                            container.innerHTML = `
                                <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                                    <p style="color: #999; margin-bottom: 15px;">Nenhum certificado cadastrado.</p>
                                    <button class="btn btn-primary" onclick="abrirModalNovoCertificadoFiscal()">
                                        Cadastrar Primeiro Certificado
                                    </button>
                                </div>
                            `;
                        } else {
                            container.innerHTML = certificados.map(cert => {
                                const ativo = cert.ativo ? 'Ativo' : 'Inativo';
                                const corBadge = cert.ativo ? '#27ae60' : '#e74c3c';
                                const ultimaBusca = cert.data_ultima_busca ? formatarDataFiscal(cert.data_ultima_busca) : 'Nunca';
                                
                                // ‚úÖ Verifica√ß√£o de senha inv√°lida
                                const senhaInvalida = cert.senha_valida === false;
                                const borderColor = senhaInvalida ? '#e74c3c' : '#e0e0e0';
                                const bgColor = senhaInvalida ? '#fff5f5' : 'white';
                                
                                return `
                                    <div style="background: ${bgColor}; padding: 15px; border-radius: 8px; border: 2px solid ${borderColor};">
                                        ${senhaInvalida ? `
                                            <div style="background: #e74c3c; color: white; padding: 8px; border-radius: 4px; margin-bottom: 10px; font-size: 12px;">
                                                <strong>‚ö†Ô∏è ATEN√á√ÉO:</strong> ${cert.erro_senha || 'Certificado precisa ser recadastrado'}
                                            </div>
                                        ` : ''}
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                            <h4 style="margin: 0; font-size: 16px;">${cert.nome_certificado}</h4>
                                            <span style="background: ${corBadge}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">${ativo}</span>
                                        </div>
                                        <p style="margin: 0; font-size: 13px; color: #666; line-height: 1.6;">
                                            <strong>CNPJ:</strong> ${cert.cnpj}<br>
                                            <strong>Ambiente:</strong> ${cert.ambiente}<br>
                                            <strong>√öltima Busca:</strong> ${ultimaBusca}<br>
                                            <strong>NSU Atual:</strong> ${cert.ultimo_nsu || '000000000000000'}<br>
                                            <strong>Docs Baixados:</strong> ${cert.total_documentos_baixados || 0}
                                        </p>
                                        <div style="margin-top: 10px;">
                                            ${senhaInvalida ? `
                                                <button class="btn btn-warning btn-sm" onclick="abrirModalRecadastrarCertificado(${cert.id})" style="margin-right: 5px; font-size: 12px;">
                                                    üîÑ Recadastrar Certificado
                                                </button>
                                            ` : ''}
                                            ${cert.ativo ? `
                                                <button class="btn btn-danger btn-sm" onclick="desativarCertificadoFiscal(${cert.id})" style="font-size: 12px;">
                                                    ‚ùå Desativar
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('');
                        }
                        
                        preencherSelectsCertificadosFiscais();
                    }
                })
                .catch(err => console.error('Erro ao carregar certificados:', err));
        }

        function preencherSelectsCertificadosFiscais() {
            fetch('/api/relatorios/certificados')
                .then(r => r.json())
                .then(response => {
                    if (response.success) {
                        // ‚úÖ Filtra apenas certificados ativos E com senha v√°lida
                        const certificados = response.certificados.filter(c => c.ativo && c.senha_valida !== false);
                        let options = '<option value="">Selecione um certificado...</option>';
                        
                        if (certificados.length === 0) {
                            options = '<option value="">Nenhum certificado v√°lido dispon√≠vel</option>';
                        } else {
                            certificados.forEach(cert => {
                                options += `<option value="${cert.id}">${cert.nome_certificado} (${cert.cnpj})</option>`;
                            });
                        }
                        
                        document.getElementById('fiscal-buscaAutoCertificado').innerHTML = options;
                        document.getElementById('fiscal-buscaChaveCertificado').innerHTML = options;
                    }
                });
        }

        // Modal Certificado
        function abrirModalNovoCertificadoFiscal() {
            document.getElementById('modal-novo-certificado-fiscal').classList.add('show');
        }

        function fecharModalNovoCertificadoFiscal() {
            document.getElementById('modal-novo-certificado-fiscal').classList.remove('show');
        }

        // Extrair dados do certificado automaticamente
        window.extrairDadosCertificado = async function() {
            const arquivo = document.getElementById('fiscal-certArquivo').files[0];
            const senha = document.getElementById('fiscal-certSenha').value;
            
            if (!arquivo || !senha) {
                return; // Precisa de ambos para extrair
            }
            
            // Mostra loading
            document.getElementById('fiscal-cert-loading').style.display = 'block';
            document.getElementById('fiscal-cert-info').style.display = 'none';
            
            try {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const base64 = e.target.result.split(',')[1];
                    
                    const response = await fetch('/api/relatorios/certificados/extrair-dados', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            pfx_base64: base64,
                            senha: senha
                        })
                    });
                    
                    const data = await response.json();
                    
                    document.getElementById('fiscal-cert-loading').style.display = 'none';
                    
                    if (data.sucesso) {
                        // Preenche campos automaticamente
                        document.getElementById('fiscal-certNome').value = data.dados.nome_certificado || '';
                        document.getElementById('fiscal-certCNPJ').value = data.dados.cnpj || '';
                        
                        // Preenche UF com c√≥digo e sigla (pode ser vazio se n√£o detectado)
                        const cuf = data.dados.cuf || '';
                        const uf_sigla = data.dados.uf_sigla || '';
                        const cufInput = document.getElementById('fiscal-certCUF');
                        if (cuf && uf_sigla) {
                            cufInput.value = `${cuf} (${uf_sigla})`;
                            cufInput.style.background = '#f5f5f5';
                            document.getElementById('fiscal-certUF-hint').textContent = `Estado: ${uf_sigla} - C√≥digo IBGE: ${cuf}`;
                        } else {
                            cufInput.value = '';
                            cufInput.style.background = '#fff9e6';
                            cufInput.style.border = '1px solid #f39c12';
                            document.getElementById('fiscal-certUF-hint').textContent = '‚ö†Ô∏è UF n√£o detectada no certificado. Informe o c√≥digo UF manualmente (ex: 31 para MG, 35 para SP, 41 para PR).';
                        }
                        
                        // Mostra informa√ß√µes do certificado
                        const valido_de = data.dados.valido_de ? new Date(data.dados.valido_de).toLocaleDateString('pt-BR') : 'N/A';
                        const valido_ate = data.dados.valido_ate ? new Date(data.dados.valido_ate).toLocaleDateString('pt-BR') : 'N/A';
                        
                        document.getElementById('fiscal-cert-info').innerHTML = `
                            ‚úÖ Certificado v√°lido<br>
                            <strong>V√°lido de:</strong> ${valido_de}<br>
                            <strong>V√°lido at√©:</strong> ${valido_ate}
                        `;
                        document.getElementById('fiscal-cert-info').style.display = 'block';
                        
                        showToastFiscal('‚úÖ Dados do certificado extra√≠dos com sucesso!', 'success');
                    } else {
                        document.getElementById('fiscal-cert-info').innerHTML = `‚ùå ${data.erro}`;
                        document.getElementById('fiscal-cert-info').style.background = '#f8d7da';
                        document.getElementById('fiscal-cert-info').style.display = 'block';
                        showToastFiscal('Erro ao extrair dados: ' + data.erro, 'error');
                    }
                };
                
                reader.readAsDataURL(arquivo);
            } catch (error) {
                document.getElementById('fiscal-cert-loading').style.display = 'none';
                showToastFiscal('Erro ao processar certificado', 'error');
            }
        };

        function salvarCertificadoFiscal() {
            const arquivo = document.getElementById('fiscal-certArquivo').files[0];
            const senha = document.getElementById('fiscal-certSenha').value;
            const nome = document.getElementById('fiscal-certNome').value;
            const cnpj = document.getElementById('fiscal-certCNPJ').value;
            const cufTexto = document.getElementById('fiscal-certCUF').value;
            // Extrai apenas o c√≥digo num√©rico (remove a sigla entre par√™nteses se houver)
            const cuf = cufTexto.includes('(') ? cufTexto.split(' ')[0] : cufTexto;
            
            if (!arquivo) {
                showToastFiscal('Selecione um arquivo .PFX', 'error');
                return;
            }
            
            if (!senha) {
                showToastFiscal('Digite a senha do certificado', 'error');
                return;
            }

            // Se estiver recadastrando um cert existente por ID, n√£o exige extra√ß√£o pr√©via
            const certIdRecadastrar = window._certIdParaRecadastrar;

            if (!certIdRecadastrar && (!nome || !cnpj)) {
                showToastFiscal('Aguarde a extra√ß√£o autom√°tica dos dados do certificado', 'warning');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result.split(',')[1];

                // Recadastrar por ID: atualiza pfx+senha sem depender de CNPJ
                if (certIdRecadastrar) {
                    fetch(`/api/relatorios/certificados/${certIdRecadastrar}/recadastrar`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ pfx_base64: base64, senha: senha })
                    })
                    .then(r => r.json())
                    .then(response => {
                        if (response.success) {
                            window._certIdParaRecadastrar = null;
                            showToastFiscal('‚úÖ Certificado recadastrado com sucesso!');
                            fecharModalNovoCertificadoFiscal();
                            carregarCertificadosFiscais();
                            carregarEstatisticasFiscais();
                        } else {
                            showToastFiscal('Erro: ' + (response.error || response.erro), 'error');
                        }
                    })
                    .catch(err => showToastFiscal('Erro ao recadastrar certificado', 'error'));
                    return;
                }
                
                const dados = {
                    nome_certificado: nome,
                    cnpj: cnpj,
                    pfx_base64: base64,
                    senha: senha,
                    cuf: parseInt(cuf) || 0,
                    ambiente: document.getElementById('fiscal-certAmbiente').value
                };

                fetch('/api/relatorios/certificados/novo', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(dados)
                })
                .then(r => r.json())
                .then(response => {
                    if (response.sucesso) {
                        showToastFiscal('Certificado cadastrado com sucesso!');
                        fecharModalNovoCertificadoFiscal();
                        carregarCertificadosFiscais();
                        carregarEstatisticasFiscais();
                    } else {
                        showToastFiscal('Erro: ' + response.erro, 'error');
                    }
                })
                .catch(err => showToastFiscal('Erro ao cadastrar certificado', 'error'));
            };
            
            reader.readAsDataURL(arquivo);
        }

        function abrirModalNovoCertificadoFiscal() {
            // Limpa campos e certId armazenado (novo cadastro)
            window._certIdParaRecadastrar = null;
            document.getElementById('fiscal-certArquivo').value = '';
            document.getElementById('fiscal-certSenha').value = '';
            document.getElementById('fiscal-certNome').value = '';
            document.getElementById('fiscal-certCNPJ').value = '';
            document.getElementById('fiscal-certCUF').value = '';  // Come√ßa vazio
            document.getElementById('fiscal-certUF-hint').textContent = 'UF da empresa ser√° detectada automaticamente';
            document.getElementById('fiscal-certAmbiente').value = 'producao';
            document.getElementById('fiscal-cert-loading').style.display = 'none';
            document.getElementById('fiscal-cert-info').style.display = 'none';
            
            document.getElementById('modal-novo-certificado-fiscal').style.display = 'flex';
        }

        function fecharModalNovoCertificadoFiscal() {
            document.getElementById('modal-novo-certificado-fiscal').style.display = 'none';
        }

        function abrirModalRecadastrarCertificado(certificadoId) {
            // Abre o modal e armazena o ID para atualizar diretamente
            abrirModalNovoCertificadoFiscal();
            window._certIdParaRecadastrar = certificadoId;
            
            // Mostra mensagem de recadastramento
            showToastFiscal('‚ö†Ô∏è Selecione o arquivo .PFX e informe a senha para recadastrar o certificado', 'warning');
        }

        function desativarCertificadoFiscal(id) {
            if (!confirm('Deseja realmente desativar este certificado?')) return;

            fetch(`/api/relatorios/certificados/${id}/desativar`, {method: 'POST'})
                .then(r => r.json())
                .then(response => {
                    if (response.success) {
                        showToastFiscal('Certificado desativado!');
                        carregarCertificadosFiscais();
                        carregarEstatisticasFiscais();
                    }
                })
                .catch(err => showToastFiscal('Erro ao desativar certificado', 'error'));
        }

        // Buscar Documentos
        async function executarBuscaAutomaticaFiscal() {
            const resultDiv = document.getElementById('fiscal-buscaAutoResultado');
            const token = localStorage.getItem('token');
            const empresaId = window.currentEmpresaId;

            // ‚îÄ‚îÄ 1. Info inicial ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            console.group('üîç executarBuscaAutomaticaFiscal() ‚Äî DEBUG');
            console.log('üìç empresa_id:', empresaId);
            console.log('üîë token presente:', !!token, token ? `(${token.length} chars)` : '(VAZIO!)');

            resultDiv.innerHTML = `
                <div style="background:#fff3cd;border:1px solid #ffc107;padding:12px;border-radius:6px;font-size:12px;font-family:monospace;">
                    <strong>üîç DEBUG ‚Äî Iniciando busca...</strong><br>
                    empresa_id: <strong>${empresaId}</strong><br>
                    token: <strong>${token ? '‚úÖ presente (' + token.length + ' chars)' : '‚ùå AUSENTE'}</strong><br>
                    <span id="_dbg_status">‚è≥ Enviando POST /api/relatorios/buscar-documentos ...</span>
                </div>`;

            const payload = {};
            console.log('üì§ Payload enviado:', JSON.stringify(payload));

            let httpStatus, rawText, parsed;
            try {
                // ‚îÄ‚îÄ 2. Fetch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                const resp = await fetch('/api/relatorios/buscar-documentos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(token ? {'Authorization': `Bearer ${token}`} : {})
                    },
                    body: JSON.stringify(payload)
                });

                httpStatus = resp.status;
                rawText = await resp.text();
                console.log('üì• HTTP Status:', httpStatus);
                console.log('üì• Resposta bruta:', rawText);

                document.getElementById('_dbg_status').textContent =
                    `‚úÖ Resposta recebida ‚Äî HTTP ${httpStatus}`;

                // ‚îÄ‚îÄ 3. Parse JSON ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                try {
                    parsed = JSON.parse(rawText);
                    console.log('üì¶ JSON parseado:', parsed);
                } catch (parseErr) {
                    console.error('‚ùå N√£o foi poss√≠vel parsear JSON:', parseErr);
                    resultDiv.innerHTML = `
                        <div style="background:#f8d7da;border:1px solid #f5c6cb;padding:12px;border-radius:6px;font-size:12px;font-family:monospace;">
                            <strong>‚ùå Resposta n√£o √© JSON v√°lido (HTTP ${httpStatus})</strong><br>
                            <pre style="white-space:pre-wrap;margin:8px 0 0 0;">${rawText.substring(0, 800)}</pre>
                        </div>`;
                    console.groupEnd();
                    return;
                }

                // ‚îÄ‚îÄ 4. Exibir resultado completo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                const sucesso = parsed.sucesso || parsed.success;
                const erro = parsed.erro || parsed.error || '(campo erro/error ausente)';

                if (sucesso) {
                    console.log('‚úÖ Busca bem-sucedida:', parsed);
                    resultDiv.innerHTML = `
                        <div style="background:#d4edda;border:1px solid #c3e6cb;padding:15px;border-radius:6px;margin-top:10px;">
                            <h6 style="margin:0 0 10px 0;">‚úÖ Busca conclu√≠da!</h6>
                            <ul style="margin:0;padding-left:20px;font-size:13px;">
                                <li>Documentos baixados: <strong>${parsed.total_baixados || 0}</strong></li>
                                <li>NF-es processadas: <strong>${parsed.nfes_processadas || 0}</strong></li>
                                <li>CT-es processados: <strong>${parsed.ctes_processados || 0}</strong></li>
                                <li>Eventos processados: <strong>${parsed.eventos_processados || 0}</strong></li>
                                <li>Erros: <strong>${parsed.erros || 0}</strong></li>
                                <li>Novo NSU: <strong>${parsed.novo_nsu}</strong></li>
                            </ul>
                        </div>`;
                    carregarEstatisticasFiscais();
                } else {
                    console.warn('‚ö†Ô∏è Busca retornou erro:', parsed);
                    resultDiv.innerHTML = `
                        <div style="background:#f8d7da;border:1px solid #f5c6cb;padding:12px;border-radius:6px;font-size:12px;font-family:monospace;">
                            <strong>‚ùå Erro retornado pelo servidor (HTTP ${httpStatus})</strong><br><br>
                            <strong>Mensagem:</strong> ${erro}<br><br>
                            <strong>Resposta completa:</strong><br>
                            <pre style="white-space:pre-wrap;margin:4px 0 0 0;font-size:11px;">${JSON.stringify(parsed, null, 2)}</pre>
                        </div>`;
                }

            } catch (fetchErr) {
                console.error('‚ùå Erro de rede/fetch:', fetchErr);
                resultDiv.innerHTML = `
                    <div style="background:#f8d7da;border:1px solid #f5c6cb;padding:12px;border-radius:6px;font-size:12px;font-family:monospace;">
                        <strong>‚ùå Erro de rede (fetch falhou)</strong><br>
                        <pre style="white-space:pre-wrap;margin:4px 0 0 0;">${fetchErr}</pre>
                    </div>`;
            }
            console.groupEnd();
        }

        function consultarPorChaveFiscal() {
            const chave = document.getElementById('fiscal-buscaChave').value.trim();

            if (!chave) {
                showToastFiscal('Informe a chave de acesso', 'error');
                return;
            }

            if (chave.length !== 44) {
                showToastFiscal('A chave deve ter 44 d√≠gitos', 'error');
                return;
            }

            document.getElementById('fiscal-buscaChaveResultado').innerHTML = '<p style="color: #3498db;">‚è≥ Consultando chave...</p>';

            fetch('/api/relatorios/consultar-chave', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    chave: chave
                })
            })
            .then(r => r.json())
            .then(response => {
                if (response.sucesso) {
                    const tipoDoc = chave.length >= 22 && chave.substring(20, 22) === '57' ? 'CT-e' : 'NF-e';
                    const html = `
                        <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; border-radius: 6px; margin-top: 10px;">
                            <h6 style="margin: 0 0 10px 0;">‚úÖ ${tipoDoc} Encontrada!</h6>
                            <ul style="margin: 0; padding-left: 20px; font-size: 13px;">
                                <li>Chave: <strong>${response.chave}</strong></li>
                                <li>Situa√ß√£o: <strong>${response.situacao}</strong></li>
                                <li>C√≥digo SEFAZ: <strong>${response.codigo_sefaz}</strong></li>
                                <li>Mensagem: <strong>${response.mensagem_sefaz}</strong></li>
                            </ul>
                        </div>
                    `;
                    document.getElementById('fiscal-buscaChaveResultado').innerHTML = html;
                } else {
                    document.getElementById('fiscal-buscaChaveResultado').innerHTML = `
                        <div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 6px; margin-top: 10px;">
                            <strong>Erro:</strong> ${response.erro || response.mensagem_sefaz}
                        </div>
                    `;
                }
            })
            .catch(err => {
                document.getElementById('fiscal-buscaChaveResultado').innerHTML = '<p style="color: #e74c3c;">‚ùå Erro ao consultar chave</p>';
            });
        }

        // Documentos
        function carregarDocumentosFiscais() {
            const dataInicio = document.getElementById('fiscal-filtroDataInicio').value;
            const dataFim = document.getElementById('fiscal-filtroDataFim').value;
            const tipo = document.getElementById('fiscal-filtroTipo').value;

            let url = '/api/relatorios/documentos?';
            if (dataInicio) url += `data_inicio=${dataInicio}&`;
            if (dataFim) url += `data_fim=${dataFim}&`;
            if (tipo) url += `tipo=${tipo}&`;

            fetch(url)
                .then(r => r.json())
                .then(response => {
                    if (response.success) {
                        const docs = response.documentos;
                        const tbody = document.getElementById('fiscal-tabelaDocumentosBody');
                        
                        if (docs.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #999;">Nenhum documento encontrado</td></tr>';
                        } else {
                            tbody.innerHTML = docs.map(doc => `
                                <tr>
                                    <td>${doc.nsu}</td>
                                    <td style="font-family: monospace; font-size: 11px;">${doc.chave || '-'}</td>
                                    <td><span style="background: #3498db; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">${doc.tipo_documento}</span></td>
                                    <td>${doc.numero_documento || '-'}</td>
                                    <td>${doc.serie || '-'}</td>
                                    <td>${formatarMoedaFiscal(doc.valor_total)}</td>
                                    <td style="font-size: 12px;">${doc.nome_emitente || '-'}</td>
                                    <td>${formatarDataFiscal(doc.data_emissao)}</td>
                                    <td>
                                        <a href="/api/relatorios/documento/${doc.id}/xml" class="btn btn-sm btn-success" title="Download XML" style="padding: 4px 8px; font-size: 11px;">
                                            üì• XML
                                        </a>
                                    </td>
                                </tr>
                            `).join('');
                        }
                    }
                })
                .catch(err => console.error('Erro ao carregar documentos:', err));
        }

        function exportarExcelFiscal() {
            const dataInicio = document.getElementById('fiscal-filtroDataInicio').value;
            const dataFim = document.getElementById('fiscal-filtroDataFim').value;
            const tipo = document.getElementById('fiscal-filtroTipo').value;

            fetch('/api/relatorios/exportar-excel', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    data_inicio: dataInicio,
                    data_fim: dataFim,
                    tipo: tipo
                })
            })
            .then(r => r.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `documentos_fiscais_${new Date().getTime()}.xlsx`;
                a.click();
                showToastFiscal('Excel exportado com sucesso!');
            })
            .catch(err => showToastFiscal('Erro ao exportar Excel', 'error'));
        }

        // Status NSU
        function carregarNSUStatusFiscal() {
            fetch('/api/relatorios/nsu-status')
                .then(r => r.json())
                .then(response => {
                    if (response.success) {
                        const certificados = response.certificados;
                        const container = document.getElementById('fiscal-nsuStatusContainer');
                        
                        if (certificados.length === 0) {
                            container.innerHTML = '<p style="color: #999;">Nenhum certificado ativo.</p>';
                        } else {
                            container.innerHTML = `
                                <div class="table-scroll-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Certificado</th>
                                                <th>CNPJ</th>
                                                <th>Ambiente</th>
                                                <th>√öltimo NSU</th>
                                                <th>M√°ximo NSU</th>
                                                <th>NSUs Pendentes</th>
                                                <th>√öltima Busca</th>
                                                <th>Docs Baixados</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${certificados.map(cert => {
                                                const pendentes = cert.nsus_pendentes || 0;
                                                const corBadge = pendentes > 0 ? '#f39c12' : '#27ae60';
                                                
                                                return `
                                                    <tr>
                                                        <td><strong>${cert.nome_certificado}</strong></td>
                                                        <td>${cert.cnpj}</td>
                                                        <td><span style="background: #95a5a6; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">${cert.ambiente}</span></td>
                                                        <td>${cert.ultimo_nsu || '000000000000000'}</td>
                                                        <td>${cert.max_nsu || '-'}</td>
                                                        <td><span style="background: ${corBadge}; color: white; padding: 2px 8px; border-radius: 3px; font-size: 11px;">${pendentes}</span></td>
                                                        <td>${formatarDataFiscal(cert.data_ultima_busca)}</td>
                                                        <td>${cert.total_documentos_baixados || 0}</td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            `;
                        }
                    }
                })
                .catch(err => console.error('Erro ao carregar NSU status:', err));
        }

        // ============================================
        // EMPRESA - CERTIFICADO DIGITAL
        // ============================================

        function carregarDadosEmpresa() {
            // Obter empresa_id da sess√£o (window.currentEmpresaId √© definido no login)
            const empresaId = window.currentEmpresaId || sessionStorage.getItem('empresa_id');
            
            if (!empresaId) {
                console.error('empresa_id n√£o encontrado');
                return;
            }

            // Carregar dados da empresa
            fetch(`/api/empresas/${empresaId}`)
                .then(r => r.json())
                .then(response => {
                    if (response.success && response.empresa) {
                        const emp = response.empresa;
                        document.getElementById('empresa-razao-social').textContent = emp.razao_social || '-';
                        document.getElementById('empresa-cnpj').textContent = emp.cnpj ? formatarCNPJ(emp.cnpj) : '-';
                        document.getElementById('empresa-email').textContent = emp.email || '-';
                        document.getElementById('empresa-telefone').textContent = emp.telefone || '-';
                        document.getElementById('empresa-plano').textContent = emp.plano || '-';
                        
                        // üÜï Mostra UF/Estado
                        const estadoSpan = document.getElementById('empresa-estado');
                        if (emp.estado) {
                            estadoSpan.textContent = emp.estado.toUpperCase();
                            estadoSpan.style.color = '#fff';
                        } else {
                            estadoSpan.textContent = 'N√ÉO CADASTRADO';
                            estadoSpan.style.color = '#ffeb3b';
                            estadoSpan.title = 'Clique em Editar para cadastrar o UF';
                        }
                        
                        // Salva dados globalmente para uso posterior
                        window.currentEmpresaData = emp;
                    }
                })
                .catch(err => console.error('Erro ao carregar empresa:', err));

            // Carregar certificado da empresa
            carregarCertificadoEmpresa();
        }

        function formatarCNPJ(cnpj) {
            if (!cnpj) return '-';
            const num = cnpj.replace(/\D/g, '');
            return num.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
        }

        function carregarCertificadoEmpresa() {
            // Mapeamento UF
            const cufParaUf = {
                11: 'RO', 12: 'AC', 13: 'AM', 14: 'RR', 15: 'PA', 16: 'AP', 17: 'TO',
                21: 'MA', 22: 'PI', 23: 'CE', 24: 'RN', 25: 'PB', 26: 'PE', 27: 'AL',
                28: 'SE', 29: 'BA', 31: 'MG', 32: 'ES', 33: 'RJ', 35: 'SP',
                41: 'PR', 42: 'SC', 43: 'RS', 50: 'MS', 51: 'MT', 52: 'GO', 53: 'DF'
            };
            
            fetch('/api/relatorios/certificados')
                .then(r => r.json())
                .then(response => {
                    if (response.success && response.certificados) {
                        const cert = response.certificados.find(c => c.ativo);
                        const container = document.getElementById('empresa-cert-container');
                        
                        if (cert) {
                            const validadeInicio = cert.valido_de ? new Date(cert.valido_de).toLocaleDateString('pt-BR') : 'N/A';
                            const validadeFim = cert.valido_ate ? new Date(cert.valido_ate).toLocaleDateString('pt-BR') : 'N√£o informado';
                            const diasRestantes = cert.valido_ate ? Math.ceil((new Date(cert.valido_ate) - new Date()) / (1000 * 60 * 60 * 24)) : 0;
                            const statusTexto = diasRestantes > 0 ? `V√°lido (${diasRestantes} dias)` : 'Vencido';
                            const corStatus = diasRestantes > 30 ? '#27ae60' : diasRestantes > 7 ? '#f39c12' : '#e74c3c';
                            const ufSigla = cufParaUf[cert.cuf] || `C√≥digo ${cert.cuf}`;
                            
                            container.innerHTML = `
                                <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 20px; border-radius: 10px; color: white;">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div style="flex: 1;">
                                            <h4 style="margin: 0 0 15px 0;">‚úÖ Certificado Ativo</h4>
                                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; font-size: 14px;">
                                                <div>
                                                    <strong style="opacity: 0.8;">Nome:</strong><br>
                                                    <span style="font-size: 15px;">${cert.nome_certificado || 'N√£o informado'}</span>
                                                </div>
                                                <div>
                                                    <strong style="opacity: 0.8;">CNPJ:</strong><br>
                                                    <span style="font-size: 15px;">${formatarCNPJ(cert.cnpj)}</span>
                                                </div>
                                                <div>
                                                    <strong style="opacity: 0.8;">Ambiente:</strong><br>
                                                    <span style="font-size: 15px; text-transform: uppercase;">${cert.ambiente || 'PRODU√á√ÉO'}</span>
                                                </div>
                                                <div>
                                                    <strong style="opacity: 0.8;">Validade:</strong><br>
                                                    <span style="font-size: 13px;">${validadeInicio} at√© ${validadeFim}</span>
                                                </div>
                                                <div>
                                                    <strong style="opacity: 0.8;">UF:</strong><br>
                                                    <span style="font-size: 15px;">${ufSigla}</span>
                                                </div>
                                                <div>
                                                    <strong style="opacity: 0.8;">Status:</strong><br>
                                                    <span style="font-size: 14px; padding: 3px 8px; background: ${corStatus}; border-radius: 4px; display: inline-block;">${statusTexto}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.3);">
                                        <strong>üìä Uso:</strong> Este certificado est√° sendo usado para buscar NF-e, CT-e e NFS-e automaticamente.
                                    </div>
                                    
                                    <div style="margin-top: 15px; text-align: center;">
                                        <button class="btn btn-danger" onclick="desativarCertificadoEmpresa(${cert.id})" style="margin-right: 10px;">
                                            ‚ùå Desativar Certificado
                                        </button>
                                        <button class="btn btn-primary" onclick="abrirModalCertificadoEmpresa()">
                                            üîÑ Atualizar Certificado
                                        </button>
                                    </div>
                                </div>
                            `;
                        } else {
                            container.innerHTML = `
                                <p style="text-align: center; color: #999; padding: 40px 0;">
                                    <span style="font-size: 48px; display: block; margin-bottom: 10px;">üîí</span>
                                    Nenhum certificado cadastrado.<br>
                                    <small>Cadastre um certificado A1 para come√ßar a importar documentos fiscais.</small>
                                </p>
                            `;
                        }
                    }
                })
                .catch(err => console.error('Erro ao carregar certificado:', err));
        }

        function abrirModalCertificadoEmpresa() {
            // Limpa CNPJ detectado anteriormente
            window._certCNPJDetectado = '';
            // Limpar campos
            const inputNome = document.getElementById('cert-emp-nome');
            const inputCuf = document.getElementById('cert-emp-cuf');
            
            inputNome.value = '';
            inputNome.readOnly = false;
            inputNome.style.background = '';
            inputNome.style.borderColor = '';
            
            document.getElementById('cert-emp-arquivo').value = '';
            document.getElementById('cert-emp-senha').value = '';
            
            // üî• BUSCAR UF DA EMPRESA ao inv√©s de hardcode '35'
            const empresaData = window.currentEmpresaData || {};
            const estadoEmpresa = (empresaData.estado || '').toUpperCase();
            
            // Mapa de UF para c√≥digo IBGE
            const ufParaCuf = {
                'AC': '12', 'AL': '27', 'AP': '16', 'AM': '13', 'BA': '29',
                'CE': '23', 'DF': '53', 'ES': '32', 'GO': '52', 'MA': '21',
                'MT': '51', 'MS': '50', 'MG': '31', 'PA': '15', 'PB': '25',
                'PR': '41', 'PE': '26', 'PI': '22', 'RJ': '33', 'RN': '24',
                'RS': '43', 'RO': '11', 'RR': '14', 'SC': '42', 'SP': '35',
                'SE': '28', 'TO': '17'
            };
            
            const cufEmpresa = ufParaCuf[estadoEmpresa] || '';
            
            if (cufEmpresa) {
                inputCuf.value = cufEmpresa;  // UF da empresa
                console.log(`‚úÖ UF da empresa: ${estadoEmpresa} (c√≥digo ${cufEmpresa})`);
            } else {
                inputCuf.value = '';  // Vazio se n√£o encontrar
                console.warn(`‚ö†Ô∏è UF da empresa n√£o cadastrado ou inv√°lido: "${estadoEmpresa}"`);
            }
            
            inputCuf.disabled = false;
            inputCuf.style.background = '';
            inputCuf.style.borderColor = '';
            
            document.getElementById('cert-emp-ambiente').value = 'producao';
            
            // Preencher CNPJ automaticamente
            const cnpj = document.getElementById('empresa-cnpj').textContent.replace(/\D/g, '');
            
            // Adicionar listener para validar certificado ao selecionar arquivo
            const inputArquivo = document.getElementById('cert-emp-arquivo');
            const inputSenha = document.getElementById('cert-emp-senha');
            
            inputArquivo.onchange = () => validarCertificadoAoSelecionar();
            inputSenha.onblur = () => validarCertificadoAoSelecionar();
            inputSenha.onkeypress = (e) => {
                if (e.key === 'Enter') validarCertificadoAoSelecionar();
            };
            
            document.getElementById('modal-certificado-empresa').classList.add('show');
        }

        function validarCertificadoAoSelecionar() {
            const arquivo = document.getElementById('cert-emp-arquivo').files[0];
            const senha = document.getElementById('cert-emp-senha').value;
            
            // S√≥ valida se tiver arquivo E senha
            if (!arquivo || !senha) {
                return;
            }
            
            // Mapeamento de UF (sigla) para c√≥digo IBGE
            const ufParaCuf = {
                'RO': '11', 'AC': '12', 'AM': '13', 'RR': '14', 'PA': '15', 'AP': '16', 'TO': '17',
                'MA': '21', 'PI': '22', 'CE': '23', 'RN': '24', 'PB': '25', 'PE': '26', 'AL': '27', 'SE': '28', 'BA': '29',
                'MG': '31', 'ES': '32', 'RJ': '33', 'SP': '35',
                'PR': '41', 'SC': '42', 'RS': '43',
                'MS': '50', 'MT': '51', 'GO': '52', 'DF': '53'
            };
            
            // Mostrar indicador de carregamento
            const inputNome = document.getElementById('cert-emp-nome');
            const inputCuf = document.getElementById('cert-emp-cuf');
            const btnSalvar = document.getElementById('btn-salvar-cert-empresa');
            
            // ‚úÖ N√ÉO colocar texto de valida√ß√£o no input (evita salvar por engano)
            inputNome.value = '';
            inputNome.placeholder = '‚è≥ Validando certificado...';
            inputNome.disabled = true;
            inputNome.style.background = '#fff3cd';
            inputNome.style.borderColor = '#ffc107';
            
            // ‚úÖ Desabilitar bot√£o de salvar durante valida√ß√£o
            if (btnSalvar) {
                btnSalvar.disabled = true;
                btnSalvar.style.opacity = '0.5';
                btnSalvar.innerHTML = '‚è≥ Aguarde valida√ß√£o...';
            }
            
            // Ler arquivo
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result.split(',')[1];
                
                fetch('/api/certificado/validar', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        pfx_base64: base64,
                        senha: senha
                    })
                })
                .then(r => r.json())
                .then(response => {
                    if (response.sucesso && response.certificado) {
                        const cert = response.certificado;
                        
                        // ‚úÖ Preencher nome automaticamente com raz√£o social
                        if (cert.razao_social) {
                            inputNome.value = cert.razao_social;
                        } else {
                            inputNome.value = 'Certificado ' + (cert.cnpj || 'Digital');
                        }
                        
                        // Salva CNPJ do cert para usar no momento de salvar
                        window._certCNPJDetectado = cert.cnpj || '';
                        console.log('üìã CNPJ detectado no cert:', window._certCNPJDetectado);
                        
                        // ‚úÖ Limpar placeholder e habilitar input
                        inputNome.placeholder = '';
                        inputNome.disabled = false;
                        
                        // ‚úÖ Preencher UF automaticamente (se dispon√≠vel)
                        let ufDetectada = false;
                        if (cert.uf && ufParaCuf[cert.uf]) {
                            inputCuf.value = ufParaCuf[cert.uf];
                            inputCuf.style.background = '#e8f5e9';
                            inputCuf.style.borderColor = '#4caf50';
                            ufDetectada = true;
                            console.log(`‚úÖ UF detectada automaticamente: ${cert.uf} (c√≥digo ${ufParaCuf[cert.uf]})`);
                        } else {
                            console.warn('‚ö†Ô∏è UF n√£o detectada no certificado/CNPJ - usu√°rio precisar√° selecionar manualmente');
                            inputCuf.style.background = '#fff3cd';
                            inputCuf.style.borderColor = '#ffc107';
                        }
                        
                        // ‚úÖ Tornar campos readonly (preenchidos automaticamente)
                        inputNome.readOnly = true;
                        inputNome.style.background = '#e8f5e9';
                        inputNome.style.borderColor = '#4caf50';
                        
                        // ‚úÖ Se UF n√£o foi detectada, deixar select ativo para sele√ß√£o manual
                        if (ufDetectada) {
                            inputCuf.disabled = true;
                        } else {
                            inputCuf.disabled = false;
                            // Focar no select para facilitar sele√ß√£o
                            setTimeout(() => {
                                inputCuf.focus();
                            }, 100);
                        }
                        
                        // ‚úÖ Reabilitar bot√£o de salvar ap√≥s valida√ß√£o bem-sucedida
                        if (btnSalvar) {
                            btnSalvar.disabled = false;
                            btnSalvar.style.opacity = '1';
                            btnSalvar.innerHTML = 'üíæ Salvar Certificado';
                        }
                        
                        // Mostrar informa√ß√µes do certificado
                        const validade = cert.validade_fim ? new Date(cert.validade_fim).toLocaleDateString('pt-BR') : '-';
                        console.log('‚úÖ Certificado validado:', {
                            razao_social: cert.razao_social,
                            cnpj: cert.cnpj,
                            uf: cert.uf || '(n√£o detectada)',
                            cuf: ufParaCuf[cert.uf] || '(n√£o preenchido)',
                            validade: validade,
                            emitente: cert.emitente,
                            uf_origem: cert.uf ? 'certificado/CNPJ' : 'sele√ß√£o manual'
                        });
                    } else {
                        // ‚úÖ Resetar estado do campo
                        inputNome.value = '';
                        inputNome.placeholder = '';
                        inputNome.disabled = false;
                        inputNome.style.background = '';
                        inputNome.style.borderColor = '#e74c3c';
                        
                        // ‚úÖ Reabilitar bot√£o de salvar ap√≥s erro de valida√ß√£o
                        if (btnSalvar) {
                            btnSalvar.disabled = false;
                            btnSalvar.style.opacity = '1';
                            btnSalvar.innerHTML = 'üíæ Salvar Certificado';
                        }
                        
                        alert('‚ùå ' + (response.erro || 'Erro ao validar certificado'));
                    }
                })
                .catch(err => {
                    // ‚úÖ Resetar estado do campo
                    inputNome.value = '';
                    inputNome.placeholder = '';
                    inputNome.disabled = false;
                    inputNome.style.background = '';
                    inputNome.style.borderColor = '#e74c3c';
                    
                    // ‚úÖ Reabilitar bot√£o de salvar ap√≥s erro de rede
                    if (btnSalvar) {
                        btnSalvar.disabled = false;
                        btnSalvar.style.opacity = '1';
                        btnSalvar.innerHTML = 'üíæ Salvar Certificado';
                    }
                    
                    alert('‚ùå Erro ao validar certificado');
                    console.error(err);
                });
            };
            
            reader.readAsDataURL(arquivo);
        }

        function fecharModalCertificadoEmpresa() {
            document.getElementById('modal-certificado-empresa').classList.remove('show');
        }

        // ============================================
        // EDI√á√ÉO DO UF/ESTADO DA EMPRESA
        // ============================================
        
        function editarEstadoEmpresa() {
            const empresaId = window.currentEmpresaId || sessionStorage.getItem('empresa_id');
            const empresaData = window.currentEmpresaData || {};
            const ufAtual = empresaData.estado || '';
            
            const ufsValidos = ['AC', 'AL', 'AP', 'AM', 'BA', 'CE', 'DF', 'ES', 'GO', 'MA',
                               'MT', 'MS', 'MG', 'PA', 'PB', 'PR', 'PE', 'PI', 'RJ', 'RN',
                               'RS', 'RO', 'RR', 'SC', 'SP', 'SE', 'TO'];
            
            const novoUF = prompt(
                `üåé EDITAR ESTADO/UF DA EMPRESA\n\n` +
                `UF atual: ${ufAtual || 'N√ÉO CADASTRADO'}\n\n` +
                `Digite o novo UF (sigla com 2 letras):\n` +
                `Exemplos: MG, SP, RJ, RS, PR, etc.\n\n` +
                `Estados v√°lidos:\n${ufsValidos.join(', ')}`,
                ufAtual
            );
            
            if (novoUF === null) {
                // Usu√°rio cancelou
                return;
            }
            
            const novoUFUpper = novoUF.trim().toUpperCase();
            
            if (novoUFUpper.length !== 2) {
                alert('‚ùå UF deve ter exatamente 2 letras! Exemplo: MG');
                return;
            }
            
            if (!ufsValidos.includes(novoUFUpper)) {
                alert(`‚ùå "${novoUFUpper}" n√£o √© um UF v√°lido!\n\nUse uma das siglas:\n${ufsValidos.join(', ')}`);
                return;
            }
            
            if (novoUFUpper === ufAtual) {
                alert('‚ÑπÔ∏è O UF informado j√° √© o atual.');
                return;
            }
            
            // Confirma altera√ß√£o
            if (!confirm(`Confirma altera√ß√£o do UF de "${ufAtual}" para "${novoUFUpper}"?`)) {
                return;
            }
            
            // Envia para o backend
            fetch(`/api/empresas/${empresaId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    estado: novoUFUpper
                })
            })
            .then(r => r.json())
            .then(response => {
                if (response.success) {
                    alert(`‚úÖ UF atualizado com sucesso para ${novoUFUpper}!\n\nüí° Agora voc√™ pode recadastrar o certificado digital e ele usar√° o UF correto automaticamente.`);
                    // Recarrega dados da empresa
                    carregarDadosEmpresa();
                } else {
                    alert(`‚ùå Erro ao atualizar UF: ${response.error || 'Erro desconhecido'}`);
                }
            })
            .catch(err => {
                console.error('Erro ao atualizar UF:', err);
                alert('‚ùå Erro ao comunicar com servidor');
            });
        }

        function salvarCertificadoEmpresa() {
            const nome = document.getElementById('cert-emp-nome').value.trim();
            const arquivo = document.getElementById('cert-emp-arquivo').files[0];
            const senha = document.getElementById('cert-emp-senha').value;
            const cuf = document.getElementById('cert-emp-cuf').value;
            const ambiente = document.getElementById('cert-emp-ambiente').value;
            const btnSalvar = document.getElementById('btn-salvar-cert-empresa');
            
            console.log('üîç salvarCertificadoEmpresa - Valores capturados:', {
                nome, 
                arquivo: arquivo ? arquivo.name : 'Nenhum', 
                senha: senha ? '***' : 'Vazia',
                cuf,
                ambiente
            });

            // ‚úÖ PROTE√á√ÉO 1: Verificar se valida√ß√£o ainda est√° em andamento
            if (btnSalvar && btnSalvar.disabled) {
                alert('‚ö†Ô∏è Aguarde a valida√ß√£o do certificado concluir antes de salvar.');
                return;
            }

            // Valida√ß√µes
            if (!nome) {
                alert('‚ùå Digite um nome para o certificado');
                return;
            }

            // ‚úÖ PROTE√á√ÉO 2: Impedir salvar com texto de loading
            if (nome.includes('‚è≥') || nome.includes('Validando')) {
                alert('‚ö†Ô∏è Aguarde a valida√ß√£o do certificado concluir antes de salvar.');
                return;
            }
            
            // ‚úÖ PROTE√á√ÉO 3: Verificar se o placeholder ainda est√° ativo
            const inputNome = document.getElementById('cert-emp-nome');
            if (inputNome.placeholder.includes('Validando')) {
                alert('‚ö†Ô∏è Aguarde a valida√ß√£o do certificado concluir antes de salvar.');
                return;
            }

            if (!arquivo) {
                alert('‚ùå Selecione o arquivo do certificado (.PFX ou .P12)');
                return;
            }

            if (!senha) {
                alert('‚ùå Digite a senha do certificado');
                return;
            }

            if (!cuf) {
                alert('‚ùå Selecione o estado (UF)');
                return;
            }

            // Obter CNPJ da empresa: tenta do span, fallback do cert validado
            let cnpj = document.getElementById('empresa-cnpj').textContent.replace(/\D/g, '');
            if (!cnpj && window._certCNPJDetectado) {
                cnpj = window._certCNPJDetectado.replace(/\D/g, '');
                console.log('üìã CNPJ do span vazio, usando CNPJ do certificado:', cnpj);
            }

            // Ler arquivo
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result.split(',')[1];
                
                const dados = {
                    nome_certificado: nome,
                    cnpj: cnpj,
                    pfx_base64: base64,
                    senha: senha,
                    cuf: parseInt(cuf) || 0,  // parseInt extrai apenas o n√∫mero de "31 (MG)"
                    ambiente: ambiente
                };
                
                console.log('üì§ Enviando dados para backend:', {
                    nome_certificado: dados.nome_certificado,
                    cnpj: dados.cnpj,
                    cuf: dados.cuf,
                    ambiente: dados.ambiente,
                    pfx_size: base64.length + ' chars',
                    senha: '***'
                });

                // Mostrar loading
                const btnSalvarRef = document.getElementById('btn-salvar-cert-empresa');
                const textoOriginal = btnSalvarRef.textContent;
                btnSalvarRef.textContent = '‚è≥ Salvando...';
                btnSalvarRef.disabled = true;

                fetch('/api/relatorios/certificados/novo', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(dados)
                })
                .then(r => r.json())
                .then(response => {
                    console.log('üì• Resposta do backend:', response);
                    
                    btnSalvarRef.textContent = textoOriginal;
                    btnSalvarRef.disabled = false;

                    if (response.sucesso) {
                        alert('‚úÖ Certificado cadastrado com sucesso!');
                        fecharModalCertificadoEmpresa();
                        carregarCertificadoEmpresa();
                        carregarEstatisticasFiscais();
                    } else {
                        alert('‚ùå Erro: ' + response.erro);
                    }
                })
                .catch(err => {
                    console.error('‚ùå Erro ao cadastrar certificado:', err);
                    btnSalvarRef.textContent = textoOriginal;
                    btnSalvarRef.disabled = false;
                    alert('‚ùå Erro ao cadastrar certificado');
                });
            };
            
            reader.readAsDataURL(arquivo);
        }

        function desativarCertificadoEmpresa(id) {
            if (!confirm('‚ö†Ô∏è Deseja realmente desativar este certificado?\n\nIsso impedir√° a busca autom√°tica de NF-e, CT-e e NFS-e at√© que um novo certificado seja cadastrado.')) {
                return;
            }

            fetch(`/api/relatorios/certificados/${id}/desativar`, {method: 'POST'})
                .then(r => r.json())
                .then(response => {
                    if (response.success) {
                        alert('‚úÖ Certificado desativado com sucesso!');
                        carregarCertificadoEmpresa();
                    } else {
                        alert('‚ùå Erro ao desativar certificado');
                    }
                })
                .catch(err => {
                    alert('‚ùå Erro ao desativar certificado');
                    console.error(err);
                });
        }

    </script>
    
    <!-- Script M√≥dulo Remessa Pagamento -->
    <script src="/static/remessa_pagamento.js?v={{ build_timestamp }}"></script>
    <script src="/static/regras_conciliacao.js?v={{ build_timestamp }}"></script>
</body>
</html>
