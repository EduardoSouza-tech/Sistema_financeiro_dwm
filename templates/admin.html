<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Painel Administrativo - Sistema Financeiro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 28px;
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-info {
            text-align: right;
        }

        .user-info strong {
            color: #333;
            display: block;
        }

        .user-info span {
            color: #666;
            font-size: 14px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 25px;
            margin-bottom: 20px;
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 22px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: transparent;
            color: #666;
            font-size: 16px;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .table th {
            background: #f8f9fa;
            color: #333;
            font-weight: 600;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-admin {
            background: #ff6b6b;
            color: white;
        }

        .badge-client {
            background: #4ecdc4;
            color: white;
        }

        .badge-active {
            background: #51cf66;
            color: white;
        }

        .badge-inactive {
            background: #adb5bd;
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #333;
            font-size: 24px;
        }

        .modal-footer {
            margin-top: 25px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .permissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .permission-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .permission-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .permission-item label {
            font-size: 14px;
            color: #555;
            cursor: pointer;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.active {
            display: block;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 14px;
            opacity: 0.9;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>‚öôÔ∏è Painel Administrativo</h1>
            <div class="header-info">
                <div class="user-info">
                    <strong id="userName">Carregando...</strong>
                    <span id="userType">Admin</span>
                </div>
                <a href="/" class="btn btn-primary">üìä Dashboard</a>
                <button onclick="logout()" class="btn btn-danger">üö™ Sair</button>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats">
            <div class="stat-card">
                <h3 id="totalUsers">0</h3>
                <p>Total de Usu√°rios</p>
            </div>
            <div class="stat-card">
                <h3 id="activeUsers">0</h3>
                <p>Usu√°rios Ativos</p>
            </div>
            <div class="stat-card">
                <h3 id="totalPermissions">30</h3>
                <p>Permiss√µes Dispon√≠veis</p>
            </div>
        </div>

        <!-- Alert -->
        <div id="alert" class="alert"></div>

        <!-- Main Card -->
        <div class="card">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('users')">üë• Usu√°rios</button>
                <button class="tab" onclick="switchTab('companies')">üè¢ Empresas</button>
                <button class="tab" onclick="switchTab('access')">üîó Acessos Multi-Empresa</button>
                <button class="tab" onclick="switchTab('permissions')">üîê Permiss√µes</button>
                <button class="tab" onclick="switchTab('logs')">üìã Logs de Acesso</button>
                <button class="tab" onclick="switchTab('export')">üì¶ Exportar Dados</button>
                <button class="tab" onclick="switchTab('debug')">üîß Debug DB</button>
            </div>

            <!-- Tab: Usu√°rios -->
            <div id="usersTab" class="tab-content active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Gerenciar Usu√°rios</h2>
                    <button onclick="openNewUserModal()" class="btn btn-success">‚ûï Novo Usu√°rio</button>
                </div>

                <div id="usersLoading" class="loading">
                    <div class="spinner"></div>
                    <p>Carregando usu√°rios...</p>
                </div>

                <table class="table" id="usersTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Usu√°rio</th>
                            <th>Nome</th>
                            <th>Empresa</th>
                            <th>Tipo</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                    </tbody>
                </table>
            </div>

            <!-- Tab: Empresas -->
            <div id="companiesTab" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Gerenciar Empresas</h2>
                    <button onclick="openNewCompanyModal()" class="btn btn-success">‚ûï Nova Empresa</button>
                </div>

                <div id="companiesLoading" class="loading">
                    <div class="spinner"></div>
                    <p>Carregando empresas...</p>
                </div>

                <table class="table" id="companiesTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Raz√£o Social</th>
                            <th>CNPJ</th>
                            <th>Email</th>
                            <th>Plano</th>
                            <th>Usu√°rios</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="companiesTableBody">
                    </tbody>
                </table>
            </div>

            <!-- Tab: Acessos Multi-Empresa -->
            <div id="accessTab" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h2>Gerenciar Acessos Multi-Empresa</h2>
                        <p style="color: #666; margin-top: 5px;">Vincule usu√°rios a empresas com permiss√µes espec√≠ficas</p>
                    </div>
                    <button onclick="openNewAccessModal()" class="btn btn-success">‚ûï Novo V√≠nculo</button>
                </div>

                <div id="accessLoading" class="loading">
                    <div class="spinner"></div>
                    <p>Carregando acessos...</p>
                </div>

                <table id="accessTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Usu√°rio</th>
                            <th>Empresa</th>
                            <th>Papel</th>
                            <th>Empresa Padr√£o</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="accessTableBody"></tbody>
                </table>
            </div>

            <!-- Tab: Permiss√µes -->
            <div id="permissionsTab" class="tab-content">
                <h2>Permiss√µes do Sistema</h2>
                <p style="color: #666; margin-bottom: 20px;">Lista de todas as permiss√µes dispon√≠veis no sistema (30 permiss√µes)</p>
                
                <div id="permissionsLoading" class="loading">
                    <div class="spinner"></div>
                    <p>Carregando permiss√µes...</p>
                </div>

                <div id="permissionsGrid" class="permissions-grid"></div>
            </div>

            <!-- Tab: Logs -->
            <div id="logsTab" class="tab-content">
                <h2>Logs de Acesso</h2>
                <p style="color: #666; margin-bottom: 20px;">Hist√≥rico de logins e acessos ao sistema</p>
                <div class="empty-state">
                    <p>Em desenvolvimento - Logs de acesso ser√£o exibidos aqui</p>
                </div>
            </div>

            <!-- Tab: Exportar Dados -->
            <div id="exportTab" class="tab-content">
                <h2>Exportar Dados de Cliente</h2>
                <p style="color: #666; margin-bottom: 20px;">Selecione um cliente para exportar todos os seus dados em formato JSON</p>
                
                <div id="exportLoading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Carregando clientes...</p>
                </div>

                <div id="exportContent" style="display: none;">
                    <div class="form-group">
                        <label for="clientSelect">Selecione o Cliente:</label>
                        <select id="clientSelect" class="form-control" style="width: 100%; padding: 10px; font-size: 14px;">
                            <option value="">-- Selecione um cliente --</option>
                        </select>
                    </div>

                    <div id="clienteInfo" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0;">
                        <h4 style="margin-bottom: 10px;">Informa√ß√µes do Cliente:</h4>
                        <p><strong>Nome:</strong> <span id="infoNome"></span></p>
                        <p><strong>Email:</strong> <span id="infoEmail"></span></p>
                        <p><strong>Tipo:</strong> <span id="infoTipo"></span></p>
                        <p style="color: #666; margin-top: 10px; font-size: 13px;">
                            ‚ö†Ô∏è A exporta√ß√£o incluir√° TODOS os dados deste cliente:<br>
                            ‚Ä¢ Clientes registrados<br>
                            ‚Ä¢ Fornecedores<br>
                            ‚Ä¢ Categorias<br>
                            ‚Ä¢ Contas banc√°rias<br>
                            ‚Ä¢ Lan√ßamentos financeiros
                        </p>
                    </div>

                    <button id="exportBtn" class="btn btn-primary" onclick="exportarDadosCliente()" style="width: 100%; padding: 12px;" disabled>
                        üì¶ Exportar Dados do Cliente
                    </button>

                    <div id="exportStatus" style="display: none; margin-top: 20px; padding: 15px; border-radius: 5px;">
                    </div>
                </div>
            </div>

            <!-- Tab: Debug DB -->
            <div id="debugTab" class="tab-content">
                <h2>üîß Debug - Schema do Banco de Dados</h2>
                <p style="color: #666; margin-bottom: 20px;">Visualize todas as tabelas e colunas do PostgreSQL</p>
                
                <button onclick="carregarSchema()" class="btn btn-primary" style="margin-bottom: 20px;">
                    üîç Carregar Schema Completo
                </button>
                
                <div id="schemaLoading" style="display: none; text-align: center; padding: 40px;">
                    <div class="spinner"></div>
                    <p>Carregando schema do banco de dados...</p>
                </div>
                
                <div id="schemaContent" style="display: none;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                        <strong>Total de Tabelas:</strong> <span id="totalTabelas">0</span>
                    </div>
                    
                    <div id="schemaTabelas" style="max-height: 600px; overflow-y: auto;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Novo/Editar Usu√°rio -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Novo Usu√°rio</h3>
            </div>

            <form id="userForm">
                <input type="hidden" id="userId">
                
                <div class="form-group">
                    <label>Nome de Usu√°rio *</label>
                    <input type="text" id="username" class="form-control" required>
                </div>

                <div class="form-group">
                    <label>Nome Completo *</label>
                    <input type="text" id="fullName" class="form-control" required>
                </div>

                <div class="form-group">
                    <label>Empresa *</label>
                    <select id="empresaSelect" class="form-control" required>
                        <option value="">Carregando empresas...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Senha *</label>
                    <input type="password" id="password" class="form-control">
                    <small style="color: #666;">Deixe em branco para manter a senha atual (ao editar)</small>
                </div>

                <div class="form-group">
                    <label>Tipo de Usu√°rio *</label>
                    <select id="userTypeSelect" class="form-control">
                        <option value="admin">Administrador</option>
                        <option value="cliente">Cliente</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Permiss√µes</label>
                    <div id="modalPermissionsGrid" class="permissions-grid"></div>
                </div>

                <div class="modal-footer">
                    <button type="button" onclick="closeUserModal()" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Nova/Editar Empresa -->
    <div id="companyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="companyModalTitle">Nova Empresa</h3>
            </div>

            <form id="companyForm">
                <input type="hidden" id="companyId">
                
                <div class="form-group">
                    <label>Raz√£o Social *</label>
                    <input type="text" id="razaoSocial" class="form-control" required>
                </div>

                <div class="form-group">
                    <label>Nome Fantasia</label>
                    <input type="text" id="nomeFantasia" class="form-control">
                </div>

                <div class="form-group">
                    <label>CNPJ</label>
                    <input type="text" id="cnpj" class="form-control" maxlength="18">
                </div>

                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="emailEmpresa" class="form-control" required>
                </div>

                <div class="form-group">
                    <label>Telefone</label>
                    <input type="text" id="telefoneEmpresa" class="form-control">
                </div>

                <div class="form-group">
                    <label>Plano</label>
                    <select id="plano" class="form-control">
                        <option value="basico">B√°sico</option>
                        <option value="profissional">Profissional</option>
                        <option value="empresarial">Empresarial</option>
                    </select>
                </div>

                <div class="modal-footer">
                    <button type="button" onclick="closeCompanyModal()" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Novo/Editar Acesso Multi-Empresa -->
    <div id="accessModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="accessModalTitle">Novo V√≠nculo Usu√°rio-Empresa</h3>
            </div>

            <form id="accessForm">
                <input type="hidden" id="accessId">
                
                <div class="form-group">
                    <label>Usu√°rio *</label>
                    <select id="accessUsuarioSelect" class="form-control" required>
                        <option value="">Selecione um usu√°rio...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Empresa *</label>
                    <select id="accessEmpresaSelect" class="form-control" required>
                        <option value="">Selecione uma empresa...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Papel *</label>
                    <select id="accessPapelSelect" class="form-control" required>
                        <option value="usuario">Usu√°rio (acesso conforme permiss√µes)</option>
                        <option value="admin_empresa">Admin da Empresa (acesso total)</option>
                        <option value="visualizador">Visualizador (somente leitura)</option>
                    </select>
                    <small style="color: #666;">Define o n√≠vel de acesso do usu√°rio nesta empresa espec√≠fica</small>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="accessPadraoCheck">
                        Definir como empresa padr√£o (selecionada no login)
                    </label>
                </div>

                <div class="form-group">
                    <label>Permiss√µes Espec√≠ficas</label>
                    <div id="accessPermissionsGrid" class="permissions-grid" style="max-height: 300px; overflow-y: auto;"></div>
                    <small style="color: #666;">Permiss√µes espec√≠ficas para esta empresa. Se vazio, usa permiss√µes globais do usu√°rio.</small>
                </div>

                <div class="modal-footer">
                    <button type="button" onclick="closeAccessModal()" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let allPermissions = [];
        let allUsers = [];
        let allClients = [];
        let allCompanies = [];
        let allAccess = [];

        // Verificar autentica√ß√£o
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/verify', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    window.location.href = '/login';
                    return;
                }

                const data = await response.json();
                
                console.log('üîç DEBUG - Resposta de /api/auth/verify:', data);
                console.log('üîç DEBUG - data.usuario:', data.usuario);
                console.log('üîç DEBUG - data.usuario.tipo:', data.usuario?.tipo);
                
                // Verificar se √© admin (corrigido: acessar data.usuario.tipo ao inv√©s de data.tipo)
                if (data.usuario?.tipo !== 'admin') {
                    alert('Acesso negado! Apenas administradores podem acessar esta p√°gina.');
                    window.location.href = '/';
                    return;
                }

                document.getElementById('userName').textContent = data.usuario.nome_completo;
                document.getElementById('userType').textContent = data.usuario.tipo === 'admin' ? 'Administrador' : 'Cliente';
                
                // Carregar dados
                await loadPermissions();
                // N√ÉO carregar empresas aqui - ser√° carregado ao clicar na aba
                await loadUsers();
            } catch (error) {
                console.error('Erro ao verificar autentica√ß√£o:', error);
                window.location.href = '/login';
            }
        }

        // Carregar permiss√µes
        async function loadPermissions() {
            document.getElementById('permissionsLoading').classList.add('active');
            
            try {
                const response = await fetch('/api/permissoes', {
                    credentials: 'include'
                });
                
                allPermissions = await response.json();
                renderPermissionsGrid();
                renderModalPermissions();
                
                document.getElementById('totalPermissions').textContent = allPermissions.length;
            } catch (error) {
                console.error('Erro ao carregar permiss√µes:', error);
                showAlert('Erro ao carregar permiss√µes', 'error');
            } finally {
                document.getElementById('permissionsLoading').classList.remove('active');
            }
        }

        // Renderizar grid de permiss√µes (tab)
        function renderPermissionsGrid() {
            const grid = document.getElementById('permissionsGrid');
            grid.innerHTML = '';

            allPermissions.forEach(perm => {
                const item = document.createElement('div');
                item.className = 'permission-item';
                item.innerHTML = `
                    <input type="checkbox" disabled checked>
                    <label>${perm.nome}</label>
                `;
                grid.appendChild(item);
            });
        }

        // Renderizar permiss√µes no modal
        function renderModalPermissions(selectedPermissions = []) {
            const grid = document.getElementById('modalPermissionsGrid');
            grid.innerHTML = '';

            // Agrupar permiss√µes por categoria
            const grouped = {};
            allPermissions.forEach(perm => {
                const categoria = perm.categoria || 'Outras';
                if (!grouped[categoria]) {
                    grouped[categoria] = [];
                }
                grouped[categoria].push(perm);
            });

            // Renderizar por categoria
            Object.keys(grouped).sort().forEach(categoria => {
                const categoryDiv = document.createElement('div');
                categoryDiv.style.marginBottom = '20px';
                
                const categoryHeader = document.createElement('div');
                categoryHeader.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 2px solid #667eea; padding-bottom: 5px;';
                
                const categoryTitle = document.createElement('h4');
                categoryTitle.textContent = categoria.charAt(0).toUpperCase() + categoria.slice(1);
                categoryTitle.style.cssText = 'color: #667eea; margin: 0; font-size: 14px; font-weight: 600;';
                
                const selectAllContainer = document.createElement('div');
                selectAllContainer.style.cssText = 'display: flex; align-items: center; gap: 5px;';
                
                const selectAllCheckbox = document.createElement('input');
                selectAllCheckbox.type = 'checkbox';
                selectAllCheckbox.id = `selectAll_${categoria}`;
                selectAllCheckbox.style.cssText = 'cursor: pointer; width: 16px; height: 16px;';
                
                const selectAllLabel = document.createElement('label');
                selectAllLabel.htmlFor = `selectAll_${categoria}`;
                selectAllLabel.textContent = 'Selecionar Todos';
                selectAllLabel.style.cssText = 'color: #667eea; font-size: 12px; font-weight: 500; cursor: pointer; user-select: none;';
                
                selectAllContainer.appendChild(selectAllCheckbox);
                selectAllContainer.appendChild(selectAllLabel);
                
                categoryHeader.appendChild(categoryTitle);
                categoryHeader.appendChild(selectAllContainer);
                categoryDiv.appendChild(categoryHeader);
                
                const categoryGrid = document.createElement('div');
                categoryGrid.style.cssText = 'display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;';
                categoryGrid.className = `category-permissions category-${categoria}`;
                
                grouped[categoria].forEach(perm => {
                    const item = document.createElement('div');
                    item.className = 'permission-item';
                    const checked = selectedPermissions.includes(perm.codigo) ? 'checked' : '';
                    item.innerHTML = `
                        <input type="checkbox" name="permissions" value="${perm.codigo}" ${checked} id="perm_${perm.codigo}" class="perm-checkbox">
                        <label for="perm_${perm.codigo}">${perm.nome}</label>
                    `;
                    categoryGrid.appendChild(item);
                });
                
                // Event listener para "Selecionar Todos"
                selectAllCheckbox.addEventListener('change', function() {
                    const checkboxes = categoryGrid.querySelectorAll('.perm-checkbox');
                    checkboxes.forEach(cb => {
                        cb.checked = this.checked;
                    });
                });
                
                // Event listener para atualizar o estado do "Selecionar Todos"
                categoryGrid.addEventListener('change', function(e) {
                    if (e.target.classList.contains('perm-checkbox')) {
                        const checkboxes = categoryGrid.querySelectorAll('.perm-checkbox');
                        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                        const someChecked = Array.from(checkboxes).some(cb => cb.checked);
                        selectAllCheckbox.checked = allChecked;
                        selectAllCheckbox.indeterminate = someChecked && !allChecked;
                    }
                });
                
                // Verificar estado inicial do "Selecionar Todos"
                setTimeout(() => {
                    const checkboxes = categoryGrid.querySelectorAll('.perm-checkbox');
                    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                    const someChecked = Array.from(checkboxes).some(cb => cb.checked);
                    selectAllCheckbox.checked = allChecked;
                    selectAllCheckbox.indeterminate = someChecked && !allChecked;
                }, 0);
                
                categoryDiv.appendChild(categoryGrid);
                grid.appendChild(categoryDiv);
            });
        }

        // Carregar usu√°rios
        async function loadUsers() {
            document.getElementById('usersLoading').classList.add('active');
            document.getElementById('usersTable').style.display = 'none';
            
            try {
                const response = await fetch('/api/usuarios', {
                    credentials: 'include'
                });
                
                // Verificar se a resposta foi bem-sucedida
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`‚ùå Erro HTTP ${response.status}:`, errorText);
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üîç DEBUG - Resposta de /api/usuarios:', data);
                
                // Verificar se houve erro na resposta
                if (data.success === false) {
                    console.error('‚ùå Erro no servidor:', data.error);
                    throw new Error(data.error || 'Erro desconhecido no servidor');
                }
                
                // Verificar se veio no formato {success: true, usuarios: [...]}
                if (data.success && Array.isArray(data.usuarios)) {
                    allUsers = data.usuarios;
                } else if (Array.isArray(data)) {
                    // Formato antigo (array direto)
                    allUsers = data;
                } else {
                    console.error('‚ùå Formato de resposta inv√°lido:', data);
                    allUsers = [];
                }
                
                console.log('‚úÖ Usu√°rios carregados:', allUsers.length);
                renderUsersTable();
                updateStats();
            } catch (error) {
                console.error('‚ùå Erro ao carregar usu√°rios:', error);
                showAlert(`Erro ao carregar usu√°rios: ${error.message}`, 'error');
                allUsers = [];
                renderUsersTable();
            } finally {
                document.getElementById('usersLoading').classList.remove('active');
            }
        }

        // Renderizar tabela de usu√°rios
        function renderUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            allUsers.forEach(user => {
                console.log('üë§ [renderUsersTable] Usu√°rio:', {
                    id: user.id,
                    username: user.username,
                    empresa_id: user.empresa_id,
                    empresa_nome: user.empresa_nome
                });
                
                const tr = document.createElement('tr');
                const typeBadge = user.tipo === 'admin' ? 'badge-admin' : 'badge-client';
                const statusBadge = user.ativo ? 'badge-active' : 'badge-inactive';
                
                // Usar empresa_nome se vier do backend, sen√£o buscar em allCompanies
                let empresaNome = user.empresa_nome || 'N√£o atribu√≠da';
                if (!user.empresa_nome && user.empresa_id) {
                    const empresa = allCompanies.find(c => c.id === user.empresa_id);
                    empresaNome = empresa ? empresa.razao_social : 'N√£o atribu√≠da';
                }
                
                tr.innerHTML = `
                    <td>${user.id}</td>
                    <td><strong>${user.username}</strong></td>
                    <td>${user.nome_completo || 'N√£o informado'}</td>
                    <td>${empresaNome}</td>
                    <td><span class="badge ${typeBadge}">${user.tipo === 'admin' ? 'Admin' : 'Cliente'}</span></td>
                    <td><span class="badge ${statusBadge}">${user.ativo ? 'Ativo' : 'Inativo'}</span></td>
                    <td>
                        <button onclick="editUser(${user.id})" class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;">‚úèÔ∏è Editar</button>
                        <button onclick="deleteUser(${user.id})" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;">üóëÔ∏è Excluir</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('usersTable').style.display = 'table';
        }

        // Atualizar estat√≠sticas
        function updateStats() {
            document.getElementById('totalUsers').textContent = allUsers.length;
            document.getElementById('activeUsers').textContent = allUsers.filter(u => u.ativo).length;
        }

        // === CSRF TOKEN ===
        function getCsrfToken() {
            return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        }

        // === FUN√á√ïES DE EMPRESAS ===

        // Carregar empresas
        async function loadCompanies() {
            console.log('==========================================');
            console.log('[loadCompanies] INICIO');
            
            document.getElementById('companiesLoading').classList.add('active');
            document.getElementById('companiesTable').style.display = 'none';
            
            try {
                console.log('[loadCompanies] Fazendo fetch para /api/empresas...');
                const response = await fetch('/api/empresas', {
                    credentials: 'include'
                });
                
                console.log('[loadCompanies] Response status:', response.status);
                console.log('[loadCompanies] Response ok:', response.ok);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[loadCompanies] Erro HTTP:', errorText);
                    throw new Error(`Erro ${response.status}`);
                }
                
                console.log('[loadCompanies] Parseando JSON...');
                const data = await response.json();
                console.log('[loadCompanies] Data recebido:', data);
                console.log('[loadCompanies] Tipo de data:', typeof data);
                console.log('[loadCompanies] Array.isArray(data):', Array.isArray(data));
                
                allCompanies = Array.isArray(data) ? data : (data.empresas || []);
                console.log('[loadCompanies] allCompanies definido:', allCompanies);
                console.log('[loadCompanies] Total empresas:', allCompanies.length);
                
                if (allCompanies.length > 0) {
                    console.log('[loadCompanies] Primeira empresa:', allCompanies[0]);
                }
                
                console.log('[loadCompanies] Chamando renderCompaniesTable...');
                renderCompaniesTable();
                
                console.log('[loadCompanies] Chamando populateEmpresaSelect...');
                populateEmpresaSelect();
                
                console.log('[loadCompanies] FIM - Sucesso');
                console.log('==========================================');
            } catch (error) {
                console.error('==========================================');
                console.error('[loadCompanies] ERRO CAPTURADO');
                console.error('[loadCompanies] Error:', error);
                console.error('[loadCompanies] Error message:', error.message);
                console.error('[loadCompanies] Error stack:', error.stack);
                console.error('==========================================');
                showAlert(`Erro ao carregar empresas: ${error.message}`, 'error');
                allCompanies = [];
            } finally {
                document.getElementById('companiesLoading').classList.remove('active');
            }
        }

        // Renderizar tabela de empresas
        function renderCompaniesTable() {
            console.log('[renderCompaniesTable] INICIO');
            console.log('[renderCompaniesTable] allCompanies:', allCompanies);
            console.log('[renderCompaniesTable] Total empresas:', allCompanies.length);
            
            const tbody = document.getElementById('companiesTableBody');
            tbody.innerHTML = '';

            allCompanies.forEach((company, index) => {
                console.log(`[renderCompaniesTable] Empresa ${index}:`, company);
                console.log(`[renderCompaniesTable] company.id:`, company.id, 'tipo:', typeof company.id);
                
                const tr = document.createElement('tr');
                const statusBadge = company.ativo ? 'badge-active' : 'badge-inactive';
                
                // Contar usu√°rios desta empresa
                const userCount = allUsers.filter(u => u.empresa_id === company.id).length;
                
                tr.innerHTML = `
                    <td>${company.id}</td>
                    <td><strong>${company.razao_social}</strong></td>
                    <td>${company.cnpj || '-'}</td>
                    <td>${company.email}</td>
                    <td>${company.plano || 'b√°sico'}</td>
                    <td>${userCount}</td>
                    <td><span class="badge ${statusBadge}">${company.ativo ? 'Ativo' : 'Inativo'}</span></td>
                    <td>
                        <button onclick="editCompany(${company.id})" class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;">‚úèÔ∏è Editar</button>
                        <button onclick="deleteCompany(${company.id})" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;">üóëÔ∏è Excluir</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('companiesTable').style.display = 'table';
            console.log('[renderCompaniesTable] FIM');
        }

        // Popula o select de empresas no formul√°rio de usu√°rio
        function populateEmpresaSelect() {
            const select = document.getElementById('empresaSelect');
            select.innerHTML = '<option value="">Selecione uma empresa...</option>';
            
            allCompanies.filter(c => c.ativo).forEach(company => {
                const option = document.createElement('option');
                option.value = company.id;
                option.textContent = company.razao_social;
                select.appendChild(option);
            });
        }

        // Abrir modal de nova empresa
        function openNewCompanyModal() {
            document.getElementById('companyModalTitle').textContent = 'Nova Empresa';
            document.getElementById('companyForm').reset();
            document.getElementById('companyId').value = '';
            document.getElementById('companyModal').classList.add('active');
        }

        // Editar empresa
        async function editCompany(companyId) {
            console.log('==========================================');
            console.log('[editCompany] INICIO');
            console.log('[editCompany] companyId:', companyId);
            console.log('[editCompany] tipo:', typeof companyId);
            
            try {
                const url = `/api/empresas/${companyId}`;
                console.log('[editCompany] URL:', url);
                console.log('[editCompany] Fazendo fetch...');
                
                const response = await fetch(url, {
                    credentials: 'include'
                });
                
                console.log('[editCompany] Response status:', response.status);
                console.log('[editCompany] Response ok:', response.ok);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[editCompany] Erro HTTP:', errorText);
                    throw new Error(`Erro ${response.status}`);
                }
                
                console.log('[editCompany] Parseando JSON...');
                const data = await response.json();
                console.log('[editCompany] Data recebido:', data);
                
                const company = data.empresa || data;
                console.log('[editCompany] Company extraido:', company);
                
                if (!company || !company.id) {
                    console.error('[editCompany] Company invalido:', company);
                    throw new Error('Dados da empresa inv√°lidos');
                }
                
                console.log('[editCompany] Preenchendo formulario...');
                document.getElementById('companyModalTitle').textContent = 'Editar Empresa';
                document.getElementById('companyId').value = company.id;
                document.getElementById('razaoSocial').value = company.razao_social;
                document.getElementById('nomeFantasia').value = company.nome_fantasia || '';
                document.getElementById('cnpj').value = company.cnpj || '';
                document.getElementById('emailEmpresa').value = company.email;
                document.getElementById('telefoneEmpresa').value = company.telefone || '';
                document.getElementById('plano').value = company.plano || 'basico';
                
                console.log('[editCompany] Abrindo modal...');
                document.getElementById('companyModal').classList.add('active');
                console.log('[editCompany] FIM - Sucesso');
                console.log('==========================================');
            } catch (error) {
                console.error('==========================================');
                console.error('[editCompany] ERRO CAPTURADO');
                console.error('[editCompany] Error:', error);
                console.error('[editCompany] Error message:', error.message);
                console.error('[editCompany] Error stack:', error.stack);
                console.error('==========================================');
                showAlert('Erro ao carregar dados da empresa', 'error');
            }
        }

        // Excluir empresa
        async function deleteCompany(companyId) {
            // Verificar se tem usu√°rios vinculados
            const userCount = allUsers.filter(u => u.empresa_id === companyId).length;
            
            if (userCount > 0) {
                showAlert(`‚ùå N√£o √© poss√≠vel excluir! Esta empresa possui ${userCount} usu√°rio(s) vinculado(s).`, 'error');
                return;
            }
            
            if (!confirm('Tem certeza que deseja excluir esta empresa?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/empresas/${companyId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCsrfToken()
                    },
                    credentials: 'include'
                });
                
                if (response.ok) {
                    showAlert('Empresa exclu√≠da com sucesso!', 'success');
                    await loadCompanies();
                } else {
                    const error = await response.json();
                    showAlert(error.error || 'Erro ao excluir empresa', 'error');
                }
            } catch (error) {
                console.error('Erro ao excluir empresa:', error);
                showAlert('Erro ao excluir empresa', 'error');
            }
        }

        // Fechar modal de empresa
        function closeCompanyModal() {
            document.getElementById('companyModal').classList.remove('active');
        }

        // ===================================================================
        // FUN√á√ïES DE ACESSOS MULTI-EMPRESA
        // ===================================================================

        async function loadAccess() {
            console.log('[loadAccess] Carregando acessos...');
            document.getElementById('accessLoading').classList.add('active');
            document.getElementById('accessTable').style.display = 'none';
            
            try {
                // Carregar usu√°rios e empresas se ainda n√£o foram carregados
                if (allUsers.length === 0) {
                    await loadUsers();
                }
                if (allCompanies.length === 0) {
                    await loadCompanies();
                }
                
                // Buscar todos os v√≠nculos usuario-empresa
                allAccess = [];
                for (const user of allUsers) {
                    if (user.tipo !== 'admin') {  // Super admin n√£o tem v√≠nculos
                        const response = await fetch(`/api/admin/usuarios/${user.id}/empresas`, {
                            credentials: 'include'
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.empresas && data.empresas.length > 0) {
                                data.empresas.forEach(emp => {
                                    allAccess.push({
                                        usuario_id: user.id,
                                        usuario_nome: user.nome_completo || user.username,
                                        empresa_id: emp.id,
                                        empresa_nome: emp.razao_social,
                                        papel: emp.papel,
                                        is_padrao: emp.is_empresa_padrao,
                                        ativo: emp.acesso_ativo,
                                        permissoes: emp.permissoes_empresa
                                    });
                                });
                            }
                        }
                    }
                }
                
                console.log('[loadAccess] Acessos carregados:', allAccess.length);
                renderAccessTable();
            } catch (error) {
                console.error('Erro ao carregar acessos:', error);
                showAlert('Erro ao carregar acessos', 'error');
            } finally {
                document.getElementById('accessLoading').classList.remove('active');
            }
        }

        function renderAccessTable() {
            const tbody = document.getElementById('accessTableBody');
            tbody.innerHTML = '';

            if (allAccess.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Nenhum v√≠nculo encontrado</td></tr>';
                document.getElementById('accessTable').style.display = 'table';
                return;
            }

            allAccess.forEach((access, index) => {
                const tr = document.createElement('tr');
                
                const papelBadge = {
                    'admin_empresa': '<span class="badge badge-admin">Admin Empresa</span>',
                    'usuario': '<span class="badge badge-client">Usu√°rio</span>',
                    'visualizador': '<span class="badge" style="background: #6c757d;">Visualizador</span>'
                };
                
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td><strong>${access.usuario_nome}</strong></td>
                    <td>${access.empresa_nome}</td>
                    <td>${papelBadge[access.papel] || access.papel}</td>
                    <td>${access.is_padrao ? '‚≠ê Sim' : 'N√£o'}</td>
                    <td><span class="badge ${access.ativo ? 'badge-active' : 'badge-inactive'}">${access.ativo ? 'Ativo' : 'Inativo'}</span></td>
                    <td>
                        <button onclick="editAccess(${access.usuario_id}, ${access.empresa_id})" class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;">‚úèÔ∏è Editar</button>
                        <button onclick="deleteAccess(${access.usuario_id}, ${access.empresa_id})" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;">üóëÔ∏è Remover</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('accessTable').style.display = 'table';
        }

        async function openNewAccessModal() {
            document.getElementById('accessModalTitle').textContent = 'Novo V√≠nculo Usu√°rio-Empresa';
            document.getElementById('accessForm').reset();
            document.getElementById('accessId').value = '';
            
            // Popul usu√°rios e empresas
            await populateAccessUsuarios();
            await populateAccessEmpresas();
            
            // Carregar permiss√µes para sele√ß√£o
            await renderAccessPermissions([]);
            
            document.getElementById('accessModal').classList.add('active');
        }

        async function populateAccessUsuarios() {
            const select = document.getElementById('accessUsuarioSelect');
            select.innerHTML = '<option value="">Selecione um usu√°rio...</option>';
            
            if (allUsers.length === 0) {
                await loadUsers();
            }
            
            allUsers.filter(u => u.tipo !== 'admin').forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.nome_completo || user.username} (${user.username})`;
                select.appendChild(option);
            });
        }

        async function populateAccessEmpresas() {
            const select = document.getElementById('accessEmpresaSelect');
            select.innerHTML = '<option value="">Selecione uma empresa...</option>';
            
            if (allCompanies.length === 0) {
                await loadCompanies();
            }
            
            allCompanies.filter(c => c.ativo).forEach(company => {
                const option = document.createElement('option');
                option.value = company.id;
                option.textContent = company.razao_social;
                select.appendChild(option);
            });
        }

        async function renderAccessPermissions(selectedPermissions = []) {
            const grid = document.getElementById('accessPermissionsGrid');
            grid.innerHTML = '';
            
            if (allPermissions.length === 0) {
                await loadPermissions();
            }
            
            allPermissions.forEach(perm => {
                const isChecked = selectedPermissions.includes(perm.codigo);
                const checkbox = `
                    <label class="permission-item">
                        <input type="checkbox" name="accessPermissions" value="${perm.codigo}" ${isChecked ? 'checked' : ''}>
                        <span>${perm.nome}</span>
                    </label>
                `;
                grid.innerHTML += checkbox;
            });
        }

        function closeAccessModal() {
            document.getElementById('accessModal').classList.remove('active');
        }

        // Submeter formul√°rio de acesso
        document.getElementById('accessForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const usuario_id = parseInt(document.getElementById('accessUsuarioSelect').value);
            const empresa_id = parseInt(document.getElementById('accessEmpresaSelect').value);
            const papel = document.getElementById('accessPapelSelect').value;
            const is_padrao = document.getElementById('accessPadraoCheck').checked;
            
            // Obter permiss√µes selecionadas
            const permissionsCheckboxes = document.querySelectorAll('input[name="accessPermissions"]:checked');
            const permissoes = Array.from(permissionsCheckboxes).map(cb => cb.value);
            
            const data = {
                usuario_id,
                empresa_id,
                papel,
                permissoes,
                is_padrao
            };
            
            try {
                const accessId = document.getElementById('accessId').value;
                let response;
                
                if (accessId) {
                    // Atualizar existente
                    response = await fetch(`/api/admin/usuario-empresas/${usuario_id}/${empresa_id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken()
                        },
                        credentials: 'include',
                        body: JSON.stringify({ papel, permissoes, is_padrao })
                    });
                } else {
                    // Criar novo
                    response = await fetch('/api/admin/usuario-empresas', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken()
                        },
                        credentials: 'include',
                        body: JSON.stringify(data)
                    });
                }
                
                if (response.ok) {
                    showAlert('V√≠nculo salvo com sucesso!', 'success');
                    closeAccessModal();
                    await loadAccess();
                } else {
                    const error = await response.json();
                    showAlert(error.error || 'Erro ao salvar v√≠nculo', 'error');
                }
            } catch (error) {
                console.error('Erro ao salvar v√≠nculo:', error);
                showAlert('Erro ao salvar v√≠nculo', 'error');
            }
        });

        async function editAccess(usuario_id, empresa_id) {
            try {
                // Buscar dados do v√≠nculo
                const access = allAccess.find(a => a.usuario_id === usuario_id && a.empresa_id === empresa_id);
                
                if (!access) {
                    showAlert('V√≠nculo n√£o encontrado', 'error');
                    return;
                }
                
                document.getElementById('accessModalTitle').textContent = 'Editar V√≠nculo Usu√°rio-Empresa';
                document.getElementById('accessId').value = `${usuario_id}_${empresa_id}`;
                
                await populateAccessUsuarios();
                await populateAccessEmpresas();
                
                document.getElementById('accessUsuarioSelect').value = usuario_id;
                document.getElementById('accessUsuarioSelect').disabled = true;
                document.getElementById('accessEmpresaSelect').value = empresa_id;
                document.getElementById('accessEmpresaSelect').disabled = true;
                document.getElementById('accessPapelSelect').value = access.papel;
                document.getElementById('accessPadraoCheck').checked = access.is_padrao;
                
                await renderAccessPermissions(access.permissoes || []);
                
                document.getElementById('accessModal').classList.add('active');
            } catch (error) {
                console.error('Erro ao editar v√≠nculo:', error);
                showAlert('Erro ao carregar dados do v√≠nculo', 'error');
            }
        }

        async function deleteAccess(usuario_id, empresa_id) {
            if (!confirm('Tem certeza que deseja remover este v√≠nculo?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/usuario-empresas/${usuario_id}/${empresa_id}`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCsrfToken()
                    },
                    credentials: 'include'
                });
                
                if (response.ok) {
                    showAlert('V√≠nculo removido com sucesso!', 'success');
                    await loadAccess();
                } else {
                    const error = await response.json();
                    showAlert(error.error || 'Erro ao remover v√≠nculo', 'error');
                }
            } catch (error) {
                console.error('Erro ao remover v√≠nculo:', error);
                showAlert('Erro ao remover v√≠nculo', 'error');
            }
        }

        // ===== FIM DAS FUN√á√ïES DE ACESSOS MULTI-EMPRESA =====


        // Submit form de empresa
        document.getElementById('companyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const companyId = document.getElementById('companyId').value;
            const data = {
                razao_social: document.getElementById('razaoSocial').value,
                nome_fantasia: document.getElementById('nomeFantasia').value,
                cnpj: document.getElementById('cnpj').value,
                email: document.getElementById('emailEmpresa').value,
                telefone: document.getElementById('telefoneEmpresa').value,
                plano: document.getElementById('plano').value
            };
            
            console.log('üì§ [saveCompany] Dados a enviar:', data);
            console.log('üì§ [saveCompany] CSRF Token:', getCsrfToken());
            
            try {
                let response;
                
                if (companyId) {
                    console.log('üìù [saveCompany] Editando empresa ID:', companyId);
                    response = await fetch(`/api/empresas/${companyId}`, {
                        method: 'PUT',
                        headers: { 
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken()
                        },
                        credentials: 'include',
                        body: JSON.stringify(data)
                    });
                } else {
                    console.log('‚ûï [saveCompany] Criando nova empresa');
                    response = await fetch('/api/empresas', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken()
                        },
                        credentials: 'include',
                        body: JSON.stringify(data)
                    });
                }
                
                console.log('üì• [saveCompany] Response status:', response.status);
                console.log('üì• [saveCompany] Response ok:', response.ok);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ [saveCompany] Resultado:', result);
                    showAlert('Empresa salva com sucesso!', 'success');
                    closeCompanyModal();
                    await loadCompanies();
                    await loadUsers(); // Recarregar usu√°rios para atualizar rela√ß√µes
                } else {
                    const error = await response.json();
                    console.error('‚ùå [saveCompany] Erro do servidor:', error);
                    console.error('‚ùå [saveCompany] error.error:', error.error);
                    console.error('‚ùå [saveCompany] error.message:', error.message);
                    console.error('‚ùå [saveCompany] JSON completo:', JSON.stringify(error, null, 2));
                    showAlert(error.error || error.message || 'Erro ao salvar empresa', 'error');
                }
            } catch (error) {
                console.error('Erro ao salvar empresa:', error);
                showAlert('Erro ao salvar empresa', 'error');
            }
        });

        // === FIM FUN√á√ïES DE EMPRESAS ===

        // Carregar clientes
        async function loadClients() {
            try {
                const response = await fetch('/api/clientes', {
                    credentials: 'include'
                });
                
                allClients = await response.json();
                
                const select = document.getElementById('clientId');
                select.innerHTML = '<option value="">Selecione um cliente...</option>';
                
                allClients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.nome;
                    option.textContent = client.razao_social || client.nome_fantasia || client.nome;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
            }
        }

        // Abrir modal de novo usu√°rio
        async function openNewUserModal() {
            // Carregar empresas se ainda n√£o foram carregadas
            if (allCompanies.length === 0) {
                console.log('üîç [openNewUserModal] Empresas n√£o carregadas, carregando...');
                await loadCompanies();
            } else {
                console.log('üîç [openNewUserModal] Empresas j√° carregadas:', allCompanies.length);
                // Garantir que o select est√° populado
                populateEmpresaSelect();
            }
            
            document.getElementById('modalTitle').textContent = 'Novo Usu√°rio';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            renderModalPermissions();
            document.getElementById('userModal').classList.add('active');
        }

        // Editar usu√°rio
        async function editUser(userId) {
            try {
                // Carregar empresas se ainda n√£o foram carregadas
                if (allCompanies.length === 0) {
                    console.log('üîç [editUser] Empresas n√£o carregadas, carregando...');
                    await loadCompanies();
                } else {
                    console.log('üîç [editUser] Empresas j√° carregadas:', allCompanies.length);
                    // Garantir que o select est√° populado
                    populateEmpresaSelect();
                }
                
                const response = await fetch(`/api/usuarios/${userId}`, {
                    credentials: 'include'
                });
                
                const user = await response.json();
                
                console.log('üîç DEBUG - Usu√°rio carregado:', user);
                console.log('üîç DEBUG - Nome completo:', user.nome_completo);
                console.log('üîç DEBUG - Empresa ID:', user.empresa_id);
                console.log('üîç DEBUG - Empresa Nome:', user.empresa_nome);
                
                document.getElementById('modalTitle').textContent = 'Editar Usu√°rio';
                document.getElementById('userId').value = user.id;
                document.getElementById('username').value = user.username;
                document.getElementById('fullName').value = user.nome_completo || user.nome || '';
                document.getElementById('empresaSelect').value = user.empresa_id || '';
                document.getElementById('userTypeSelect').value = user.tipo;
                document.getElementById('password').value = '';
                
                renderModalPermissions(user.permissoes || []);
                
                document.getElementById('userModal').classList.add('active');
            } catch (error) {
                console.error('Erro ao carregar usu√°rio:', error);
                showAlert('Erro ao carregar dados do usu√°rio', 'error');
            }
        }

        // Deletar usu√°rio
        async function deleteUser(userId) {
            if (!confirm('Tem certeza que deseja excluir este usu√°rio?')) return;
            
            try {
                const response = await fetch(`/api/usuarios/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCsrfToken()
                    },
                    credentials: 'include'
                });
                
                if (response.ok) {
                    showAlert('Usu√°rio exclu√≠do com sucesso!', 'success');
                    await loadUsers();
                } else {
                    const error = await response.json();
                    showAlert(error.error || 'Erro ao excluir usu√°rio', 'error');
                }
            } catch (error) {
                console.error('Erro ao excluir usu√°rio:', error);
                showAlert('Erro ao excluir usu√°rio', 'error');
            }
        }

        // Fechar modal
        function closeUserModal() {
            document.getElementById('userModal').classList.remove('active');
        }

        // Campo de cliente removido - n√£o √© mais necess√°rio

        // Submit form de usu√°rio
        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const userId = document.getElementById('userId').value;
            const username = document.getElementById('username').value;
            const nome = document.getElementById('fullName').value;
            const senha = document.getElementById('password').value;
            const tipo = document.getElementById('userTypeSelect').value;
            const empresaId = document.getElementById('empresaSelect').value;
            
            // Validar empresa
            if (!empresaId) {
                showAlert('Selecione uma empresa', 'error');
                return;
            }
            
            // Obter permiss√µes selecionadas
            const permissionsCheckboxes = document.querySelectorAll('input[name="permissions"]:checked');
            const permissoes = Array.from(permissionsCheckboxes).map(cb => cb.value);
            
            const data = {
                username,
                nome_completo: nome,
                email: `${username}@sistema.com`,  // Email gerado automaticamente
                tipo,
                empresa_id: parseInt(empresaId),
                permissoes
            };
            
            if (senha) {
                data.password = senha;  // Backend espera 'password'
            }
            
            try {
                let response;
                
                if (userId) {
                    // Atualizar usu√°rio existente
                    response = await fetch(`/api/usuarios/${userId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken()
                        },
                        credentials: 'include',
                        body: JSON.stringify(data)
                    });
                } else {
                    // Criar novo usu√°rio
                    if (!senha) {
                        showAlert('Senha √© obrigat√≥ria para novo usu√°rio', 'error');
                        return;
                    }
                    
                    response = await fetch('/api/usuarios', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken()
                        },
                        credentials: 'include',
                        body: JSON.stringify(data)
                    });
                }
                
                if (response.ok) {
                    showAlert('Usu√°rio salvo com sucesso!', 'success');
                    closeUserModal();
                    await loadUsers();
                } else {
                    const error = await response.json();
                    showAlert(error.error || 'Erro ao salvar usu√°rio', 'error');
                }
            } catch (error) {
                console.error('Erro ao salvar usu√°rio:', error);
                showAlert('Erro ao salvar usu√°rio', 'error');
            }
        });

        // Switch tab
        function switchTab(tabName) {
            // Remover active de todas as tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Adicionar active na tab selecionada
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Carregar dados espec√≠ficos da tab
            if (tabName === 'companies') {
                if (allCompanies.length === 0) {
                    loadCompanies();
                }
            }
            
            // Carregar acessos multi-empresa
            if (tabName === 'access') {
                loadAccess();
            }
            
            // Se a aba de exporta√ß√£o foi selecionada, carregar os clientes
            if (tabName === 'export') {
                loadProprietarios();
            }
            
            // Se a aba de debug foi selecionada, carregar schema automaticamente
            if (tabName === 'debug') {
                const schemaContent = document.getElementById('schemaContent');
                if (schemaContent.style.display === 'none') {
                    carregarSchema();
                }
            }
        }

        // Carregar propriet√°rios para exporta√ß√£o
        async function loadProprietarios() {
            const loading = document.getElementById('exportLoading');
            const content = document.getElementById('exportContent');
            const select = document.getElementById('clientSelect');
            
            loading.style.display = 'block';
            content.style.display = 'none';
            
            try {
                const response = await fetch('/api/admin/listar-proprietarios', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Erro ao carregar propriet√°rios');
                }
                
                const data = await response.json();
                
                // Limpar select
                select.innerHTML = '<option value="">-- Selecione um cliente --</option>';
                
                // Adicionar propriet√°rios
                data.proprietarios.forEach(prop => {
                    const option = document.createElement('option');
                    option.value = prop.proprietario_id;
                    option.textContent = `${prop.nome} (ID: ${prop.proprietario_id}) - ${prop.email}`;
                    option.dataset.nome = prop.nome;
                    option.dataset.email = prop.email;
                    option.dataset.tipo = prop.tipo;
                    select.appendChild(option);
                });
                
                loading.style.display = 'none';
                content.style.display = 'block';
                
                console.log(`‚úÖ Carregados ${data.proprietarios.length} propriet√°rios`);
            } catch (error) {
                console.error('Erro ao carregar propriet√°rios:', error);
                loading.style.display = 'none';
                showAlert('Erro ao carregar lista de clientes', 'error');
            }
        }

        // Atualizar informa√ß√µes do cliente selecionado
        document.addEventListener('DOMContentLoaded', () => {
            const select = document.getElementById('clientSelect');
            if (select) {
                select.addEventListener('change', function() {
                    const clienteInfo = document.getElementById('clienteInfo');
                    const exportBtn = document.getElementById('exportBtn');
                    
                    if (this.value) {
                        const selectedOption = this.options[this.selectedIndex];
                        document.getElementById('infoNome').textContent = selectedOption.dataset.nome;
                        document.getElementById('infoEmail').textContent = selectedOption.dataset.email;
                        document.getElementById('infoTipo').textContent = selectedOption.dataset.tipo;
                        
                        clienteInfo.style.display = 'block';
                        exportBtn.disabled = false;
                    } else {
                        clienteInfo.style.display = 'none';
                        exportBtn.disabled = true;
                    }
                });
            }
        });

        // Exportar dados do cliente
        async function exportarDadosCliente() {
            const select = document.getElementById('clientSelect');
            const clienteId = select.value;
            
            if (!clienteId) {
                showAlert('Selecione um cliente primeiro', 'error');
                return;
            }
            
            const exportBtn = document.getElementById('exportBtn');
            const exportStatus = document.getElementById('exportStatus');
            
            // Desabilitar bot√£o
            exportBtn.disabled = true;
            exportBtn.textContent = '‚è≥ Exportando...';
            
            // Mostrar status
            exportStatus.style.display = 'block';
            exportStatus.style.background = '#e3f2fd';
            exportStatus.style.color = '#1976d2';
            exportStatus.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div class="spinner" style="width: 20px; height: 20px;"></div>
                    <span>Exportando dados do cliente ${clienteId}...</span>
                </div>
            `;
            
            try {
                const response = await fetch(`/api/admin/exportar-cliente/${clienteId}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    try {
                        const errorJson = JSON.parse(errorText);
                        throw new Error(errorJson.error || 'Erro ao exportar dados');
                    } catch {
                        throw new Error('Erro ao exportar dados');
                    }
                }
                
                // Obter o texto da resposta
                const texto = await response.text();
                
                // Contar estat√≠sticas do texto
                const linhas = texto.split('\n');
                let stats = {
                    clientes: 0,
                    fornecedores: 0,
                    categorias: 0,
                    contas: 0,
                    lancamentos: 0
                };
                
                linhas.forEach(linha => {
                    if (linha.startsWith('Clientes:')) stats.clientes = parseInt(linha.split(':')[1]) || 0;
                    if (linha.startsWith('Fornecedores:')) stats.fornecedores = parseInt(linha.split(':')[1]) || 0;
                    if (linha.startsWith('Categorias:')) stats.categorias = parseInt(linha.split(':')[1]) || 0;
                    if (linha.startsWith('Contas Banc√°rias:')) stats.contas = parseInt(linha.split(':')[1]) || 0;
                    if (linha.startsWith('Lan√ßamentos:')) stats.lancamentos = parseInt(linha.split(':')[1]) || 0;
                });
                
                // Criar blob e fazer download
                const blob = new Blob([texto], { type: 'text/plain; charset=utf-8' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `export_cliente_${clienteId}_${new Date().toISOString().slice(0,10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                // Mostrar sucesso
                exportStatus.style.background = '#d4edda';
                exportStatus.style.color = '#155724';
                exportStatus.innerHTML = `
                    ‚úÖ Exporta√ß√£o conclu√≠da com sucesso!<br>
                    <small style="margin-top: 10px; display: block;">
                        ‚Ä¢ ${stats.clientes} clientes<br>
                        ‚Ä¢ ${stats.fornecedores} fornecedores<br>
                        ‚Ä¢ ${stats.categorias} categorias<br>
                        ‚Ä¢ ${stats.contas} contas banc√°rias<br>
                        ‚Ä¢ ${stats.lancamentos} lan√ßamentos<br>
                        <br>
                        üìÑ Arquivo TXT baixado com sucesso!
                    </small>
                `;
                
                showAlert('Dados exportados com sucesso!', 'success');
                
                // Habilitar bot√£o novamente ap√≥s 3 segundos
                setTimeout(() => {
                    exportBtn.disabled = false;
                    exportBtn.textContent = 'üì¶ Exportar Dados do Cliente';
                }, 3000);
                
            } catch (error) {
                console.error('Erro ao exportar dados:', error);
                
                // Mostrar erro
                exportStatus.style.background = '#f8d7da';
                exportStatus.style.color = '#721c24';
                exportStatus.innerHTML = `‚ùå Erro: ${error.message}`;
                
                showAlert('Erro ao exportar dados: ' + error.message, 'error');
                
                // Habilitar bot√£o novamente
                exportBtn.disabled = false;
                exportBtn.textContent = 'üì¶ Exportar Dados do Cliente';
            }
        }

        // Carregar schema do banco de dados
        async function carregarSchema() {
            const loading = document.getElementById('schemaLoading');
            const content = document.getElementById('schemaContent');
            const tabelasDiv = document.getElementById('schemaTabelas');
            
            loading.style.display = 'block';
            content.style.display = 'none';
            
            try {
                const response = await fetch('/api/admin/debug/schema', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Erro ao carregar schema');
                }
                
                const data = await response.json();
                
                document.getElementById('totalTabelas').textContent = data.total_tabelas;
                
                // Limpar conte√∫do
                tabelasDiv.innerHTML = '';
                
                // Criar cards para cada tabela
                const tabelas = Object.keys(data.schema).sort();
                
                tabelas.forEach(tabela => {
                    const colunas = data.schema[tabela];
                    
                    const card = document.createElement('div');
                    card.style.cssText = 'background: white; border: 1px solid #ddd; border-radius: 5px; padding: 15px; margin-bottom: 15px;';
                    
                    const titulo = document.createElement('h3');
                    titulo.textContent = `üìã ${tabela.toUpperCase()}`;
                    titulo.style.cssText = 'color: #667eea; margin-bottom: 10px; font-size: 18px;';
                    card.appendChild(titulo);
                    
                    const stats = document.createElement('p');
                    stats.textContent = `${colunas.length} colunas`;
                    stats.style.cssText = 'color: #666; margin-bottom: 10px; font-size: 14px;';
                    card.appendChild(stats);
                    
                    const table = document.createElement('table');
                    table.style.cssText = 'width: 100%; border-collapse: collapse; font-family: monospace; font-size: 13px;';
                    
                    const thead = document.createElement('thead');
                    thead.innerHTML = `
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd;">Coluna</th>
                            <th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd;">Tipo</th>
                            <th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd;">Nullable</th>
                        </tr>
                    `;
                    table.appendChild(thead);
                    
                    const tbody = document.createElement('tbody');
                    colunas.forEach((col, index) => {
                        const tr = document.createElement('tr');
                        tr.style.background = index % 2 === 0 ? 'white' : '#f8f9fa';
                        tr.innerHTML = `
                            <td style="padding: 6px; border-bottom: 1px solid #eee;"><strong>${col.nome}</strong></td>
                            <td style="padding: 6px; border-bottom: 1px solid #eee; color: #666;">${col.tipo}</td>
                            <td style="padding: 6px; border-bottom: 1px solid #eee;">
                                <span style="color: ${col.nullable ? '#dc3545' : '#28a745'};">
                                    ${col.nullable ? 'NULL' : 'NOT NULL'}
                                </span>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                    table.appendChild(tbody);
                    
                    card.appendChild(table);
                    tabelasDiv.appendChild(card);
                });
                
                loading.style.display = 'none';
                content.style.display = 'block';
                
                console.log(`‚úÖ Schema carregado: ${data.total_tabelas} tabelas`);
                showAlert(`Schema carregado: ${data.total_tabelas} tabelas`, 'success');
                
            } catch (error) {
                console.error('Erro ao carregar schema:', error);
                loading.style.display = 'none';
                showAlert('Erro ao carregar schema do banco de dados', 'error');
            }
        }

        // Mostrar alerta
        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert alert-${type} active`;
            
            setTimeout(() => {
                alert.classList.remove('active');
            }, 5000);
        }

        // Logout
        async function logout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCsrfToken()
                    },
                    credentials: 'include'
                });
                window.location.href = '/login';
            } catch (error) {
                console.error('Erro ao fazer logout:', error);
                window.location.href = '/login';
            }
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
        });
    </script>
</body>
</html>
